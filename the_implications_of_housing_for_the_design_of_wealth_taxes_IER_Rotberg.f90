    module Wealth_Tax_Global_Vars

		implicit none
                
        ! Used to save different files

        character*25 :: file_number='clib21' ! 
        character*15 :: benchmark_simulation='clib17' ! 
        character*15 :: long_run_simulation='clib17' ! 
        character*15 :: old_transition_resuls='clib17' ! 
        
        integer, parameter :: life_span=61
                
        integer, parameter :: retirement_span=20
                
        integer, parameter :: is_hidden_wealth_offshore=0 
        integer, parameter :: uniform_wealth_tax=0
        integer, parameter :: partial_eqilibrium=0
        integer, parameter :: different_progressive_wealth_taxes=0
        integer, parameter :: tax_imputed_rent=0
        integer, parameter :: robustness_check=0
        integer, parameter :: higher_nu=robustness_check*0
        integer, parameter :: lower_nu=robustness_check*0
        integer, parameter :: looser_lambda=robustness_check*0
        integer, parameter :: smaller_rental=robustness_check*0
        integer, parameter :: lump_sum_construction_profits=robustness_check*1
        
        integer, parameter :: shut_down_housing_market=different_progressive_wealth_taxes*0+&
                                                       (1-different_progressive_wealth_taxes)*1
        
        integer, parameter :: is_there_mortgage_debt_premium=(1-shut_down_housing_market)*1
        integer, parameter :: add_utility_from_child=shut_down_housing_market*0+&
                                                     (1-shut_down_housing_market)*0
        integer, parameter :: calibrate_weight_on_bequests=0
                                                        ! 0=household does not care about their child
                                                        ! 1=households cares about their child
        
        integer, parameter :: exogenous_interest_rate=0
        
        integer, parameter :: exogenous_wages=shut_down_housing_market*0+&
                                              (1-shut_down_housing_market)*0
                                                                                                    
        integer, parameter :: have_unemployment=0 ! 0=no complete unemployment
                                                  ! 1=add unemployment to the model
                                                                                                    
        integer, parameter :: multiple_household_members=(1-exogenous_wages)*0+&
                                                         exogenous_wages*0
                                                         ! 0=only 1 household member
                                                         ! 1=multiple household members
                                                
        real(8), parameter :: chi=have_unemployment*0+&
                                  (1-have_unemployment)*0 !0.0307553462
                                                  
        integer, parameter :: disutility_of_landlords_function_of_total_supply=1
        integer, parameter :: use_average_rental_size=1
                                                  
        integer, parameter :: bailout_household_if_net_equity_is_negative=have_unemployment*1+&
                                                                          (1-have_unemployment)*1
                                                                         ! 0=bailout household only if they 
                                                                         ! do not have enough resource to pay the mortgage
                                                                         ! 1=bailout the household if their equity is negative
        
        integer, parameter :: endogenous_rental_market=shut_down_housing_market*0+&
                                                       (1-shut_down_housing_market)*0
                                                       ! 1=rental market owned by locals
                                                       ! 0=rental market owned by foreiners
        
        integer, parameter :: do_internal_computations=shut_down_housing_market*1+&
                                                       (1-shut_down_housing_market)*&
                                                       ((1-endogenous_rental_market)*1+&
                                                       endogenous_rental_market*1)
                                                       
        integer, parameter :: readjust_financial_position=1
                                                                  
        integer, parameter :: property_tax_is_paid_on_current_period_tax=1
        
        integer, parameter :: minimum_downpayment_below_20_perc=endogenous_rental_market*&
                                                                (have_unemployment*1+&
                                                                (1-have_unemployment)*0)+&
                                                                (1-endogenous_rental_market)*&
                                                                (have_unemployment*1+&
                                                                (1-have_unemployment)*0)
        
        integer, parameter :: power_to_raise_to_disutility_to=minimum_downpayment_below_20_perc*1+&
                                                              (1-minimum_downpayment_below_20_perc)*1
                                                                        
        integer, parameter :: use_alternative_lenders=&
                                            (1-exogenous_wages)*0+&
                                            exogenous_wages*&
                                            ((minimum_downpayment_below_20_perc*0+&
                                            (1-minimum_downpayment_below_20_perc)*0))
                                            
        integer, parameter :: what_is_the_program_solving=shut_down_housing_market*0+&
                                                          (1-shut_down_housing_market)*&
                                                          (endogenous_rental_market*&
                                                          ((minimum_downpayment_below_20_perc*0+&
                                                          (1-minimum_downpayment_below_20_perc)*0))+&
                                                          (1-endogenous_rental_market)*&
                                                          ((minimum_downpayment_below_20_perc*0+&
                                                          (1-minimum_downpayment_below_20_perc)*1)))
                              
        integer, parameter :: re_do_simulation_with_fixed_parameters=&
                                             shut_down_housing_market*1+&
                                             (1-shut_down_housing_market)*&
                                             (endogenous_rental_market*&
                                             (minimum_downpayment_below_20_perc*1+&
                                             (1-minimum_downpayment_below_20_perc)*1)+&
                                             (1-endogenous_rental_market)*&
                                             (minimum_downpayment_below_20_perc*0+&
                                             (1-minimum_downpayment_below_20_perc)*1))
        
        integer, parameter :: have_fixed_productivity=0
        
        integer, parameter :: all_low_z_households_get_into_0_lane=0 ! 0=all get into 1
                                                                     ! 1=all get into 0 right away
        integer, parameter :: only_two_productivity_shocks=0 ! 0=3 productivity shocks
                                                             ! 1=2 productivity shocks
           
        integer, parameter :: wealth_tax_system_type=(1-exogenous_wages)*&
                                                     (shut_down_housing_market*4+&
                                                     (1-shut_down_housing_market)*&
                                                     (different_progressive_wealth_taxes*6+&
                                                     (1-different_progressive_wealth_taxes)*3))+&
                                                     exogenous_wages*&
                                                     (minimum_downpayment_below_20_perc*1+&
                                                     (1-minimum_downpayment_below_20_perc)*&
                                                     (endogenous_rental_market*2+&
                                                     (1-endogenous_rental_market)*3))                                                   
                                                     
        integer, parameter :: solve_transition_dynamics=what_is_the_program_solving*&
                                                        ((shut_down_housing_market*0)+&
                                                        (1-shut_down_housing_market)*&
                                                        (endogenous_rental_market*&
                                                        ((minimum_downpayment_below_20_perc*0+&
                                                        (1-minimum_downpayment_below_20_perc)*0))+&
                                                        (1-endogenous_rental_market)*&
                                                        ((minimum_downpayment_below_20_perc*0+&
                                                        (1-minimum_downpayment_below_20_perc)*0))))
                                                        ! 0=does not solve the transition dynamics
                                                        ! 1=solve the whole transition dynamics
                                                                                                                
        ! This variable is the degree of deductibility of mortgage interest payments from taxable income
        real(8), parameter :: mortgage_deductibility=(1-exogenous_wages)*0+&
                                                     exogenous_wages*&
                                                     ((1-what_is_the_program_solving)*&
                                                     (minimum_downpayment_below_20_perc*0+&
                                                     (1-minimum_downpayment_below_20_perc)*& 
                                                     (multiple_household_members*0+&
                                                     (1-multiple_household_members)*0))+&
                                                     what_is_the_program_solving*&
                                                     (minimum_downpayment_below_20_perc*1+&
                                                     (1-minimum_downpayment_below_20_perc)*&
                                                     (multiple_household_members*0+&
                                                     (1-multiple_household_members)*0)))
                                                                                                             
        integer, parameter :: use_old_transition_results=endogenous_rental_market*1+&
                                                         (1-endogenous_rental_market)*0
                                                         
        integer, parameter :: policy_will_be_implemented_in_x_years=2 ! tells how many years from now the policy will be implemented
        
        integer, parameter :: transition_length=(1-solve_transition_dynamics)*1+&
                                                solve_transition_dynamics*&
                                                (minimum_downpayment_below_20_perc*102+&
                                                (1-minimum_downpayment_below_20_perc)*102)
                                                
        integer, dimension(transition_length) :: high_unemployment=0 ! 0=no unemployment
                                                                     ! 1=have unemployment
                                                                                                    
        integer, parameter :: can_get_mortgage_in_retirement=1
                                                               ! 0=cannot get a mortgage during retirement
                                                               ! 1=can get a mortgage during retirement
        integer :: negative_consumption
        
        real(8), parameter :: minimum_downpayment=(1-minimum_downpayment_below_20_perc)*0.2+&
                                                  minimum_downpayment_below_20_perc*0.05 ! U.S. banking system
        integer, parameter :: include_housing_depreciation_in_housing_costs=&
                                                    (1-minimum_downpayment_below_20_perc)*0+&
                                                    minimum_downpayment_below_20_perc*0
                                                                    ! To decide if to include housing depreciation costs
                                                                    ! in mortgage approval
        real(8), parameter :: SCF_fraction_of_wealth_of_top_1_perc=0.33
                                                                   ! 0.3 (1991) (0.33) (average) Fraction of net wealth held by top 1% (from SCF) 0.2 (from Saez & Zucman)
        real(8), parameter :: asker_et_al_debt_to_assets=0.31
                                                        ! Debt to gross assets ratio (from Asker et al. (2011))
        integer, parameter :: target_wealth_of_top_1_perc=shut_down_housing_market*1+&
                                                          (1-shut_down_housing_market)*&
                                                          (minimum_downpayment_below_20_perc*1+&
                                                          (1-minimum_downpayment_below_20_perc)*1)
                                                            ! 0=target entrepreneurship rate
                                                            ! 1=target the wealth held by the top 1%
        real(8), parameter :: FRED_housing_services_to_GDP=minimum_downpayment_below_20_perc*0.25+&
                                                           (1-minimum_downpayment_below_20_perc)*0.13
                                                           ! Rents paid by renters/Rentes' income
        integer, parameter :: target_rent_to_price_ratio=1 ! 0=target landlords
                                                           ! 1=target rent to price ratio
        real(8), parameter :: himmelberg_etal_rent_to_price=0.0833 ! From Himmelberg et al (2006?)/ Garner and Verbrguge (2009)
        integer, parameter :: target_homeownership_rate=2 ! 0=target housing services
                                                          ! 1=target homeownership
        integer, parameter :: calibrate_size_of_smallest_house_hhld_can_buy=0 ! 0=do not calibrate minimum size to homeowners with mortgage
                                                                              ! 1=do calibrate
                                                                              ! 2=calibrate to MID to GDP
        integer, parameter :: calibrate_smallest_house_size=lump_sum_construction_profits*1+&
                                                            (1-lump_sum_construction_profits)*0
                                                              ! 0=do not calibrate smallest house size  
                                                              ! 1=calibrate smallest house size
        real(8), parameter :: SCF_homeownership_rate=0.66        ! 0.65 (from AHS 2017) 0.66 (from SCF 1989-2015)
        real(8), parameter :: fraction_of_landlords=minimum_downpayment_below_20_perc*0.112+& ! from RHFS reports (2015)
                                                    (1-minimum_downpayment_below_20_perc)*0.1 ! from Sommer and Sullivan (2017)                                                                
        real(8), parameter :: SW_hmowners_with_mrtgage_spend_over_X_on_hous=0.22   ! The fraction of households with a mortgage spending more than 22.6% of their income on housing costs (from Schwartz and Wilson (2007))
                                                                        ! 38% of homeowners pay over 22.6% of their income on housing costs and 16% pay over 37.5% of their income on housing costs
        real(8), parameter :: SW_renters_spend_over_X_on_hous=0.402406123 ! 50%=0.199889678, 30%=0.402406123, fraction of renters spending over 50% of their income on rent (AHS 2017)
        real(8), parameter :: rent_fraction_of_housing_costs=1 ! Determines what what fraction rent is of total housing costs
        real(8), parameter :: standard_net_wealth_to_GDP=shut_down_housing_market*3+&
                                                         (1-shut_down_housing_market)*&
                                                         (minimum_downpayment_below_20_perc*3+&
                                                         (1-minimum_downpayment_below_20_perc)*3)
        real(8), parameter :: target_risk_free_rate=0.03
        real(8), parameter :: SCF_homeowners_with_mortgage=0.66 ! 0.61 (1991) 0.66 (average) Fraction of homeowners with a mortgage (SCF)
        real(8), parameter :: fraction_hhlds_with_over_80_perc=0.096  ! from SCF (average for 1989-2016)
        real(8), parameter :: JCT_MID_to_GDP=0.3 ! Mortgage interest deductions to GDP ratio (aveage of 0.31 (JTC for 2017) and 0.54 (Sommer et al. for 2013)
        integer, parameter :: target_net_wealth_to_GDP=&
                                                       (1-exogenous_wages)*1+&
                                                       exogenous_wages*&
                                                       (minimum_downpayment_below_20_perc*(-1)+&
                                                       (1-minimum_downpayment_below_20_perc)*2)
                                                          ! -1=targetting fraction of homeowners with a mortgage over 80%
                                                          ! 0=targeting to fraction of homeowners with a mortgge
                                                          ! 1=target net wealth to GDP ratio
                                                          ! 2=target homeownership rate
        real(8), parameter :: bequests_to_net_wealth_nishiyama=0.012 ! From Nishiyama (2000)
        integer, parameter :: aftr_how_mny_lps_start_update=shut_down_housing_market*1+&
                                                            (1-shut_down_housing_market)*&
                                                            (exogenous_wages*0+&
                                                            (1-exogenous_wages)*1)
                                                            ! decides after how many iterations to converge on the equilibrium
        integer, parameter :: rebate_construction_profits_lump_sum=(1-exogenous_wages)*&
                                                                   (lump_sum_construction_profits*1+&
                                                                   (1-lump_sum_construction_profits)*2)+&
                                                                   exogenous_wages*&
                                                                   (minimum_downpayment_below_20_perc*1+&
                                                                   (1-minimum_downpayment_below_20_perc)*2)
                                                                   ! 0=a/a upper bar times average construction sector profits
                                                                   ! 1=distribute profits lump sum
                                                                   ! 2=profits rebated to government
        
        ! This variable sets the stopping rule for the housing market
        real(8) :: stopping_rule_housing_market=(1-what_is_the_program_solving)*1*10.d0**(-4)+&
                                                what_is_the_program_solving*&
                                                (different_progressive_wealth_taxes*3*10.d0**(-3)+&
                                                (1-different_progressive_wealth_taxes)*&
                                                ((1-shut_down_housing_market)*looser_lambda*0*10.d0**(-3)+& ! looser_lambda*3*10.d0**(-3) when flat wealth taxes with looser lambda
                                                3*10.d0**(-3))) ! 1*10.d0**(-3) 
                                                           
        real(8) :: stopping_rule_rental_market=(what_is_the_program_solving)*3*10.d0**(-2)+&
                                               (1-what_is_the_program_solving)*3*10.d0**(-2)
                                                           
        real(8), parameter :: stopping_rule_value_function=5*10.d0**(-4)
        
        ! This is the stopping rule for finding the stationary ditribution
        real(8) :: stopping_rule_stationary_distribution=multiple_household_members*10.d0**(-7)+&
                                                         (1-multiple_household_members)*&
                                                         (shut_down_housing_market*10.d0**(-7)+&
                                                         (1-shut_down_housing_market)*10.d0**(-7))
                                                                                                                  
        ! This variable sets the siping rule for the risk-8free interest rate
        real(8), parameter :: stopping_rule_risk_free_rate=5*10.d0**(-6) ! 5*10.d0**(-5)
                
        ! This variable sets the stopping rule for aggregate borrowing and lending
        real(8), parameter :: stopping_rule_borrowing_lending=10.d0**(-1)
                 
        ! This variable sets the stopping rule for the wage
        real(8) :: stopping_rule_wage=different_progressive_wealth_taxes*2*10.d0**(-4)+&
                                      (1-different_progressive_wealth_taxes)*3*10.d0**(-4) ! 5*10.d0**(-5)
        
        real(8) :: stopping_rule_housing_price=10.d0**(-3)
        
        real(8) :: stopping_rule_govt_budget=(1-looser_lambda)*8*10.d0**(-3)+looser_lambda*1*10.d0**(-3) ! looser_lambda*3*10.d0**(-3) when running flat wealth taxes with looser lambda
                                                                  
        real(8) :: weight_housing_price=0.05
        real(8) :: weight_wage=0.1
        real(8) :: weight_risk_free_update=0.1
                                                                                  
        ! This is the relative risk aversion of households with respect to consumption
        real(8), parameter :: risk_aversion=2
        real(8), parameter :: bequest_risk_aversion=0.5993
        real(8) :: relative_share_of_housing=&
                                           shut_down_housing_market*0+&
                                           (1-shut_down_housing_market)*&
                                           ((1-endogenous_rental_market)*&
                                           (minimum_downpayment_below_20_perc*0.20537107565391571+&
                                           (1-minimum_downpayment_below_20_perc)*&
                                           (is_there_mortgage_debt_premium*&
                                           ((1-add_utility_from_child)*&
                                           (robustness_check*&
                                           (smaller_rental*0.18329039753992515+&
                                           looser_lambda*0.17040566627648079+&
                                           higher_nu*0.18855667491623226+&
                                           lower_nu*0.17633423781210750+&
                                           lump_sum_construction_profits*0.17586341216440310)+&
                                           (1-robustness_check)*0.18329039753992515)+&
                                           add_utility_from_child*0.18511167117147584)+&
                                           (1-is_there_mortgage_debt_premium)*0.19400727685705133))+&
                                           endogenous_rental_market*&
                                           (minimum_downpayment_below_20_perc*0.10722148551702565+&
                                           (1-minimum_downpayment_below_20_perc)*0.18970314918908640)) ! 0.19574965981978795
                                            
        real(8) :: distance_relative_share_of_housing
        real(8) :: relative_share_of_housing_adjuster=5*10.d0**(-2)
        real(8) :: stopping_rule_relative_share_of_housing=10.d0**(-3)
        
        real(8) :: risk_aversion_share_of_cons
        
        real(8) :: weight_on_bequest=&
                                    add_utility_from_child*&
                                    shut_down_housing_market*0.0006+&
                                    (1-shut_down_housing_market)*0.0006
                                                                                       
        real(8) :: distance_weight_on_bequest
        real(8) :: weight_on_bequest_adjuster=5*10.d0**(-3)
        real(8) :: stopping_rule_weight_on_bequest=5*10.d0**(-5)
        
        real(8) :: advantage_to_owning=(1-endogenous_rental_market)*&
                                       (minimum_downpayment_below_20_perc*0+&
                                       (1-minimum_downpayment_below_20_perc)*&
                                       (is_there_mortgage_debt_premium*&
                                       ((1-add_utility_from_child)*&
                                       (robustness_check*&
                                       (smaller_rental*0.39899103696088928+&
                                       looser_lambda*0.12531747810918945+&
                                       higher_nu*0.37513459040035402+&
                                       lower_nu*0.41384101136012147+&
                                       lump_sum_construction_profits*0.45382373210462473)+&
                                       (1-robustness_check)*0.39899103696088928)+&
                                       add_utility_from_child*0.41251511772921201)+&
                                       (1-is_there_mortgage_debt_premium)*0.41970471253711911))+&
                                       endogenous_rental_market*&
                                       (minimum_downpayment_below_20_perc*0+&
                                       (1-minimum_downpayment_below_20_perc)*0)
                                       ! This is the advantage to onwing a house relative to renting the same house
        real(8) :: advantage_to_owning_adjuster=5*10.d0**(-2)
        real(8) :: distance_advantage_to_owning
        real(8) :: stopping_rule_advantage_to_owning=10.d0**(-3)
               
        real(8) :: discount_factor=&
                                   shut_down_housing_market*&
                                   ((1-add_utility_from_child)*&
                                   (robustness_check*&
                                   (looser_lambda*0.95934317861353402+&
                                   higher_nu*0.93882090752023539+&
                                   lower_nu*0.93494528342808769)+&
                                   (1-robustness_check)*0.93645937444019356)+&
                                   add_utility_from_child*0.93244102646280047)+&
                                   (1-shut_down_housing_market)*&
                                   ((1-endogenous_rental_market)*&
                                   (minimum_downpayment_below_20_perc*0.94523354289102512+&
                                   (1-minimum_downpayment_below_20_perc)*&
                                   (is_there_mortgage_debt_premium*&
                                   ((1-add_utility_from_child)*&
                                   (robustness_check*&
                                   (smaller_rental*0.92149350901326266+&
                                   looser_lambda*0.95422477458376920+&
                                   higher_nu*0.92344112382411336+&
                                   lower_nu*0.92086702485504013+&
                                   lump_sum_construction_profits*0.92229462472634194)+&
                                   (1-robustness_check)*0.92149350901326266)+&
                                   add_utility_from_child*0.91839964640866900)+&
                                   (1-is_there_mortgage_debt_premium)*0.91978070583658345))+&
                                   endogenous_rental_market*&
                                   (minimum_downpayment_below_20_perc*0.89120002800926279+&
                                   (1-minimum_downpayment_below_20_perc)*0.88))
                                   
        real(8) :: discount_factor_adjuster=shut_down_housing_market*1*10.d0**(-3)+&
                                            (1-shut_down_housing_market)*1*10.d0**(-3)
        real(8) :: distance_discount_factor
        real(8) :: stopping_rule_discount_factor=minimum_downpayment_below_20_perc*10.d0**(-3)+&
                                                (1-minimum_downpayment_below_20_perc)*10.d0**(-3)
                                                
        real(8) :: disutility_of_landlords=shut_down_housing_market*0+&
                                           (1-shut_down_housing_market)*&
                                           (endogenous_rental_market*&
                                           (minimum_downpayment_below_20_perc*(-0.36576598199620675)+&
                                           (1-minimum_downpayment_below_20_perc)*(-6.5173779237723264E-003)))
                                                                                       
        real(8) :: distance_disutility_of_landlords
        real(8) :: disutility_of_landlords_adjuster=5*10.d0**(-1)
        real(8) :: stopping_rule_disutility_of_landlords=10.d0**(-3)
            
        integer, parameter :: calibrate_probability_of_fast_lane=exogenous_interest_rate*0+&
                                                                 (1-exogenous_interest_rate)*0
        real(8) :: probability_of_staying_in_fast_lane=&
                                           shut_down_housing_market*0.93988738210760880+&
                                           (1-shut_down_housing_market)*0.85500001907348633
                                                                                       
        real(8) :: distance_probability_of_staying_in_fast_lane
        real(8) :: probability_of_staying_in_fast_lane_adjuster=5*10.d0**(-2)
        real(8) :: stopping_rule_probability_of_staying_in_fast_lane=5*10.d0**(-4)
        
        integer, parameter :: cond_max_debt_to_assets_on_prod=1
                                                              ! 0=productivity is not observed by banks
                                                              ! 1=productivity is observed by banks

        ! These variables define the state space for household productivities            
        real(8) :: sd_epsilon_log_productivity=shut_down_housing_market*&
                                               ((1-add_utility_from_child)*&
                                               (robustness_check*&
                                               (smaller_rental*9.9769438957395831E-002+&
                                               looser_lambda*9.9769438957395831E-002+&
                                               higher_nu*8.2771084776500581E-002+&
                                               lower_nu*0.11905545867259548)+&
                                               (1-robustness_check)*9.9769438957395831E-002)+&
                                               add_utility_from_child*8.9974562529838875E-002)+&
                                               (1-shut_down_housing_market)*&
                                               (is_there_mortgage_debt_premium*&
                                               ((1-add_utility_from_child)*&
                                               (robustness_check*&
                                               (smaller_rental*9.7197876916588252E-002+&
                                               looser_lambda*9.7197876916588252E-002+&
                                               higher_nu*7.8599186635936791E-002+&
                                               lower_nu*0.11809616274235504+&
                                               lump_sum_construction_profits*9.6970750773040348E-002)+&
                                               (1-robustness_check)*9.7197876916588252E-002)+&
                                               add_utility_from_child*8.8587640629151004E-002)+&
                                               (1-is_there_mortgage_debt_premium)*9.6241746566199896E-002)
                                               
        real(8) :: sd_epsilon_log_productivity_adjuster=10.d0**(-2)
        real(8) :: distance_wealth_by_top_1_perc
        real(8) :: stopping_rule_wealth_by_top_1_perc=10.d0**(-3)
            
        real(8) :: mean_epsilon_log_productivity=0
        real(8) :: sd_log_productivity
        real(8) :: mean_log_productivity=0
        real(8), parameter :: persistency_log_productivity=0.15
                                                        
        real(8) :: log_productivity_deviation_up=3
        real(8) :: log_productivity_deviation_down=3
        real(8) :: log_productivity_upper_bound
        real(8) :: log_productivity_lower_bound
        integer, parameter :: log_productivity_grid_size=(1-exogenous_wages)*7+&
                                                         exogenous_wages*1
        real(8), dimension(log_productivity_grid_size-1) :: log_productivity_grid_mid_point
        real(8), dimension(log_productivity_grid_size) :: log_productivity_grid
        integer, parameter :: productivity_grid_size=log_productivity_grid_size
        real(8), dimension(productivity_grid_size) :: productivity_grid
        
        ! This matrix determines the probabilities of transmission of ability from parents to their children
        real(8), dimension(productivity_grid_size,productivity_grid_size) :: productivity_process
        
        real(8) :: max_debt_to_assets=1.1685060533120875
        
        real(8) :: multiple_max_debt_to_assets=shut_down_housing_market*&
                                               (real(1.5)/real(log_productivity_grid_size))+&
                                               (1-shut_down_housing_market)*&
                                               (real(1.5)/real(log_productivity_grid_size))
                                               ! 1.5 gives 0.1875 as in GKKOC
        integer, parameter :: calibrate_multiple_max_debt_to_assets=0 ! 0=do not calibrate multiple_max_debt_to_assets
                                                                      ! 1=calibrate multiple_max_debt_to_assets
        real(8) :: multiple_max_debt_to_assets_adjuster=10.d0**(-1)
        real(8) :: distance_multiple_max_debt_to_assets
        real(8) :: stopping_rule_max_debt_to_assets=10.d0**(-3)
        
        
        integer, parameter :: productivity_shock_grid_size=(1-only_two_productivity_shocks)*3+&
                                                           only_two_productivity_shocks*2
        real(8), dimension(productivity_shock_grid_size) :: productivity_shock_grid
        
        ! This matrix determines the probabilities of transmission of ability from parents to their children
        real(8), dimension(productivity_shock_grid_size,productivity_shock_grid_size) :: &
            productivity_shock_process
        real(8), dimension(productivity_grid_size,productivity_shock_grid_size) :: &
            unconditional_productivity_shock_probability
        
        real(8), parameter :: curv_intrmdte_prod=(robustness_check*&
                                                 (smaller_rental*0.9+&
                                                 looser_lambda*0.9+&
                                                 higher_nu*0.95+&
                                                 lower_nu*0.85+&
                                                 lump_sum_construction_profits*0.9)+&
                                                 (1-robustness_check)*0.9)
                                               
        ! These variables define the state space for financail wealth    
        real(8) :: financial_lower_bound=(minimum_downpayment_below_20_perc*0+&
                                         (1-minimum_downpayment_below_20_perc)*0)
        
        integer, parameter :: financial_grid_size=(1-exogenous_wages)*200+&
                                                  exogenous_wages*&
                                                  (endogenous_rental_market*&
                                                  ((minimum_downpayment_below_20_perc*51+&
                                                  (1-minimum_downpayment_below_20_perc)*51))+& ! 51
                                                  (1-endogenous_rental_market)*&
                                                  ((minimum_downpayment_below_20_perc*101+&
                                                  (1-minimum_downpayment_below_20_perc)*121)))
                                                          
        ! This is used to refine the grid
        integer :: fin_num_of_internal=31
        real(8), dimension(financial_grid_size) :: financial_grid
        real(8), dimension(financial_grid_size) :: financial_grid_distance
        
        ! This vector contains all the combinations of future financial
        real(8), dimension(financial_grid_size) :: future_financial_grid_vector
    
        integer, parameter :: max_times_labour_income_saved=(1-exogenous_wages)*60000+&
                                                            exogenous_wages*&
                                                            ((1-endogenous_rental_market)*&
                                                            (minimum_downpayment_below_20_perc*15+&
                                                            (1-minimum_downpayment_below_20_perc)*10)+&
                                                            endogenous_rental_market*&
                                                            (minimum_downpayment_below_20_perc*8+&
                                                            (1-minimum_downpayment_below_20_perc)*20)) ! 12
                                                            
        real(8) :: average_labour_income_tax
        real(8) :: increase_in_labour_income_tax=0
        
        ! These variables save the housing price
        real(8), dimension(transition_length) :: housing_price
                        
        real(8), dimension(transition_length) :: &
            distance_housing_market=1,distance_rental_market=1
        
        real(8) :: rental_market_adjuster
        
        real(8) :: financial_tax=(1-what_is_the_program_solving)*0+&
                                 what_is_the_program_solving*&
                                 (1-exogenous_wages)*0
        real(8), parameter :: elasticity_of_taxable_wealth=0
        integer, parameter :: which_wealth_tax_to_do=1
        real(8) :: progressive_wealth_tax=0
        real(8) :: investment_income_tax=(1-exogenous_wages)*0.25+&
                                         exogenous_wages*0.15  
        real(8) :: business_income_tax=0.25
        real(8) :: consumption_tax=(1-exogenous_wages)*0+&
                                   exogenous_wages*0.075
        real(8), parameter :: benchmark_property_tax=different_progressive_wealth_taxes*0.01+&
                                                     (1-different_progressive_wealth_taxes)*&
                                                     (robustness_check*&
                                                     (smaller_rental*0.03+&
                                                     looser_lambda*0.01+&
                                                     higher_nu*0.01+&
                                                     lower_nu*0.01+&
                                                     lump_sum_construction_profits*0.0045)+&
                                                     (1-robustness_check)*0.01)
        real(8), dimension(transition_length) :: property_tax=&
            (1-what_is_the_program_solving)*0.01+&
            what_is_the_program_solving*&
            ((1-exogenous_wages)*(0.01)+&
            exogenous_wages*&
            ((1-endogenous_rental_market)*&
            (minimum_downpayment_below_20_perc*0.01+&
            (1-minimum_downpayment_below_20_perc)*0.01)+&
            endogenous_rental_market*&
            (minimum_downpayment_below_20_perc*0.01+&
            (1-minimum_downpayment_below_20_perc)*0.01)))
        real(8) :: rental_income_tax=0.3 ! from U.S. tax code
                
        real(8), parameter :: mortgage_interest_gap=&
            is_there_mortgage_debt_premium*0.015 ! From Sommer, Sullivan, and Verbrugge (2013)
        real(8), dimension(transition_length) :: stress_test=&
           what_is_the_program_solving*&
           minimum_downpayment_below_20_perc*0
        integer :: pay_mortgage_insurance ! 1=if household puts a minimum downpayment of less than 20% they have to pay mortgage insurance
                                          ! 0=if household puts a minimum downpayment of more than 20% they do not pay mortgage insurance
        real(8) :: mortgage_insurance_premium=&
                        minimum_downpayment_below_20_perc*0.0022+&
                        (1-minimum_downpayment_below_20_perc)*0
                                              ! mortage insurance premium is 0.22% above the regular morgage rate
                
        real(8), parameter :: housing_depreciation=0.02                                                          
        real(8) :: financial_wealth_depreciation=shut_down_housing_market*&
                                                 (exogenous_interest_rate*0.05+&
                                                 (1-exogenous_interest_rate)*0.04)+&
                                                 (1-shut_down_housing_market)*&
                                                 (exogenous_interest_rate*0.05+&
                                                 (1-exogenous_interest_rate)*0.14)
        
        real(8) :: distance_wage
        
        real(8), dimension(transition_length) :: wage=1
        real(8), dimension(transition_length,2) :: wage_guess
        
        real(8), parameter :: aggregate_productivity=1

        real(8), parameter :: share_of_corporate_profits=(1-exogenous_wages)*0+&
                                                         exogenous_wages*0
        real(8), parameter :: share_of_labour=(1-exogenous_wages)*0.6+&
                                              exogenous_wages*1   
        real(8), parameter :: share_of_capital=1-&
            share_of_labour-share_of_corporate_profits
        
        ! This variable is the curvature of the intermediate production
        ! This variable is used to deicide how much to break down the wealth distribution
        integer, parameter :: wealth_brackets=8
                                                       
        integer, parameter :: alternative_lenders_grid_size=&
                                    use_alternative_lenders*2+&
                                    (1-use_alternative_lenders)*1
        
        real(8), parameter :: life_cycle_component_a=&
                                                     minimum_downpayment_below_20_perc*(real(0.5)/real(31))+&
                                                     (1-minimum_downpayment_below_20_perc)*(real(0.38)/real(31))
        
        real(8), parameter :: unemploy_bene_frac_of_lowest_employ=0.686339523 ! (comparing 52 weeks of minimum wage work to 
                                                                              ! 23 weeks of unemployment benefits of 
                                                                              ! $450 per week)
            
        real(8), dimension(transition_length) :: probability_of_bad_shock_continuing=0
        
        integer, parameter :: employment_grid_size=&
                                (1-have_unemployment)*5+&
                                have_unemployment*5
        
        ! These variables are the different taxes
        real(8), dimension(employment_grid_size) :: labour_income_tax
       
        real(8), dimension(employment_grid_size) :: employment_grid
        
        ! This matrix determines the probabilities of between employment and unemployment
        real(8), dimension(transition_length,life_span,&
                            employment_grid_size,employment_grid_size) :: &
                            employment_process ! From Shimer (2005)
        real(8), dimension(transition_length,employment_grid_size) :: &
                            unconditional_employment_probability
                                                                
        ! This vector saves the survival probabilities from age x to x+1
        real(8), dimension(life_span) :: survival_probability
        
        real(8), dimension(61) :: actual_survival_probability=(/&
                    0.999064143747091000,0.999057437351439000,0.999047139252070000,0.999028513848316000,&
                    0.999002128606662000,0.998970763757824000,0.998937236843630000,0.998900839709677000,&
                    0.998862511711195000,0.998819889500737000,0.998765300260856000,0.998697769246064000,&
                    0.998622532351874000,0.998539241380058000,0.998442850308492000,0.998336586169898000,&
                    0.998207374825142000,0.998037528945133000,0.997822653735056000,0.997576926602050000,&
                    0.997324218973517000,0.997068772325292000,0.996794620528817000,0.996494883671402000,&
                    0.996169835096225000,0.995823254343122000,0.995465271640568000,0.995096642058342000,&
                    0.994716361630707000,0.994315713178366000,0.993882585782557000,0.993410578928887000,&
                    0.992905301041901000,0.992374176625162000,0.991819550283253000,0.991233213804662000,&
                    0.990602982230484000,0.989915066398680000,0.989137337543070000,0.988242183811962000,&
                    0.987190308049321000,0.985988594591617000,0.984710191376507000,0.983398867771029000,&
                    0.981995487585663000,0.980451723560690000,0.978705510497093000,0.976724572479724000,&
                    0.974471978843212000,0.971939291805028000,0.969180349260568000,0.966224979609251000,&
                    0.962747562676668000,0.958864040672779000,0.954589251428842000,0.949853785336017000,&
                    0.944555081427097000,0.938727524131536000,0.932235985994338000,0.924182154238224000,&
                    0.000000000000000000/)
        
        ! This vector saves the deterministic life-cycle component of labour efficiency
        real(8), dimension(life_span) :: labour_deterministic_efficiency
    
        ! Saves the risk free rate
        real(8), dimension(transition_length) :: risk_free_rate
        real(8) :: risk_free_rate_guess
        
        ! Used to calculate the aggregate borrowing and lending
        real(8) :: aggregate_borrowing_or_lending,aggregate_borrowing_or_lending_previous,&
            aggregate_borrowing,aggregate_lending,aggregate_borrowing_or_lending_adjuster
        
        real(8), parameter :: premium_with_alternative_lenders=0.048
                
        ! Used for expanding grid method
        real(8), parameter :: financial_grid_expander=(1-exogenous_wages)*6+&
                                                      exogenous_wages*&
                                                      (endogenous_rental_market*3+&
                                                      (1-endogenous_rental_market)*2)
        
        ! These variables define the state space for mortgage debt
        real(8), parameter :: mortgage_upper_bound=1-minimum_downpayment
        real(8), parameter :: mortgage_lower_bound=0
        
        ! If you cannot buy and sell houses then the mortgage is only 0
        ! Otherwise you can have two 
        integer, parameter :: mortgage_grid_size=shut_down_housing_market*1+&
                                                 (1-shut_down_housing_market)*&
                                                 (minimum_downpayment_below_20_perc*11+&
                                                 (1-minimum_downpayment_below_20_perc)*9)
        real(8), dimension(mortgage_grid_size) :: mortgage_grid
                
        ! This variable is used for not looping over financial and mortgage grids that are
        ! not feasible
        integer :: largest_possible_financial_index
        
        ! These variables define the state space for housing status
        integer, parameter :: housing_status_grid_size=shut_down_housing_market*1+&
                                                       (1-shut_down_housing_market)*&
                                                       ((1-endogenous_rental_market)*&
                                                       (minimum_downpayment_below_20_perc*50+&
                                                       (1-minimum_downpayment_below_20_perc)*100)+&
                                                       endogenous_rental_market*&
                                                       (minimum_downpayment_below_20_perc*50+&
                                                       (1-minimum_downpayment_below_20_perc)*50)) ! 50
                                                       
        ! This is used to refine the grid
        integer :: space_lived_in_num_of_internal=201
                                                        
        real(8), dimension(0:housing_status_grid_size-1,0:1) :: housing_status_utility_function
        real(8), dimension(0:housing_status_grid_size-1) :: housing_size
        
        real(8), dimension(0:housing_status_grid_size-1):: housing_status_grid_distance
        integer, parameter :: largest_house_size_hhld_can_rent=(1-exogenous_wages)*&
                                                               (robustness_check*&
                                                               (smaller_rental*25+&
                                                               looser_lambda*(housing_status_grid_size-1)+&
                                                               higher_nu*25+&
                                                               lower_nu*25+&
                                                               lump_sum_construction_profits*25)+&
                                                               (1-robustness_check)*25)+&
                                                               exogenous_wages*(housing_status_grid_size-1)
        integer :: index_of_smallest_house_hhld_can_buy
        real(8) :: size_of_smallest_house_hhld_can_buy=(1-endogenous_rental_market)*&
                                                       (minimum_downpayment_below_20_perc*1.45+& 
                                                       (1-minimum_downpayment_below_20_perc)*&
                                                       (is_there_mortgage_debt_premium*&
                                                       ((1-add_utility_from_child)*&
                                                       (robustness_check*&
                                                       (smaller_rental*0.8935+&
                                                       looser_lambda*0.5+&
                                                       higher_nu*0.5+&
                                                       lower_nu*0.5+&
                                                       lump_sum_construction_profits*0.5)+&
                                                       (1-robustness_check)*0.5)+&
                                                       add_utility_from_child*0.5)+&
                                                       (1-is_there_mortgage_debt_premium)*0.5))+&
                                                       endogenous_rental_market*&
                                                       (minimum_downpayment_below_20_perc*1.37+& 
                                                       (1-minimum_downpayment_below_20_perc)*0.5) ! 1
                                                       
        real(8) :: size_of_smallest_house_hhld_can_buy_adjuster=5*10.d0**(-2)
        real(8) :: distance_size_of_smallest_house_hhld_can_buy
        real(8) :: stopping_rule_size_of_smallest_house_hhld_can_buy=&
                                                minimum_downpayment_below_20_perc*10.d0**(-3)+&
                                                (1-minimum_downpayment_below_20_perc)*10.d0**(-3)
          
        real(8) :: smallest_house_size=(1-endogenous_rental_market)*&
                                       (minimum_downpayment_below_20_perc*0.58151266099814214+&
                                       (1-minimum_downpayment_below_20_perc)*&
                                       (is_there_mortgage_debt_premium*&
                                       ((1-add_utility_from_child)*&
                                       (robustness_check*&
                                       (smaller_rental*(0.89353664502672314/2)+&
                                       looser_lambda*0.89353664502672314+&
                                       higher_nu*0.89353664502672314+&
                                       lower_nu*0.89353664502672314+&
                                       lump_sum_construction_profits*0.93809468444663413)+&
                                       (1-robustness_check)*0.89353664502672314)+&
                                       add_utility_from_child*0.89353664502672314)+&
                                       (1-is_there_mortgage_debt_premium)*0.89363698486006882))+&
                                       endogenous_rental_market*&
                                       (minimum_downpayment_below_20_perc*0.30658367084786448+&
                                       (1-minimum_downpayment_below_20_perc)*0.57902178189663689) 
                                       
        real(8) :: smallest_house_size_adjuster=10.d0**(-2)
        real(8) :: distance_smallest_house_size
        real(8) :: stopping_rule_smallest_house_size=10.d0**(-3) 
                                        
        real(8) :: largest_house_size=(1-endogenous_rental_market)*&
                                      (minimum_downpayment_below_20_perc*8+&
                                      (1-minimum_downpayment_below_20_perc)*30)+&
                                      endogenous_rental_market*&
                                      (minimum_downpayment_below_20_perc*5.5+&
                                      (1-minimum_downpayment_below_20_perc)*16) ! 8
        
        integer :: largest_housing_size_consumed_in_equilibrium
        integer :: largest_financial_chosen_in_equilibrium
        
        real(8) :: housing_status_grid_expander=(minimum_downpayment_below_20_perc*1.55+&
                                                (1-minimum_downpayment_below_20_perc)*&
                                                (robustness_check*&
                                                (smaller_rental*1.907+&
                                                looser_lambda*1.6+&
                                                higher_nu*1.6+&
                                                lower_nu*1.6+&
                                                lump_sum_construction_profits*1.6)+&
                                                (1-robustness_check)*1.6))
                                                           
        real(8) :: housing_status_grid_expander_adjuster=2*10.d0**(-2)
        real(8) :: distance_housing_status_grid_expander
        real(8) :: stopping_rule_housing_status_grid_expander=10.d0**(-3) 
        
        integer :: calibrate_housing_status_grid_expander=0
                
        real(8), dimension(transition_length) :: total_housing_demand,total_rental_demand,total_rental_supply
        
        ! This vector saves consumption options for a given set of choices for future financial
        real(8), dimension(financial_grid_size) :: consumption_vector
            
        ! This parameter makes consumption be very small in the combination for
        ! financial and mortgages is not feasible, and gives negative consumption
        real(8), parameter :: epsilon_consumption=10.d0**(-100)
        
        ! Will be used in the optimization problem
        real(8), dimension(financial_grid_size) :: flow_utility_vector
        real(8), dimension(financial_grid_size) :: future_utility_vector
        
        ! Used to compute flow and future utility from the internal choice
        real(8) :: flow_utility_internal,future_utility_internal
                    
        real(8) :: rent_to_housing_price=&
                    (1-endogenous_rental_market)*&
                    (minimum_downpayment_below_20_perc*7.6260489861643146E-002+&
                    (1-minimum_downpayment_below_20_perc)*0.06)+&
                    endogenous_rental_market*&
                    (minimum_downpayment_below_20_perc*0.14023611483707454+&
                    (1-minimum_downpayment_below_20_perc)*8.3316020667552948E-002)  ! 9.0106353025486016E-002
                                                                                                                                   
        real(8), dimension(transition_length) :: rent ! This is the rent households pay to the rental company

        real(8), dimension(transition_length) :: total_housing_services,total_rent_paid,total_imputed_rents
        real(8), dimension(transition_length) :: total_renter_household_income
        
        real(8) :: rental_management_costs ! This is the management cost of the rental company
                                           
        real(8), parameter :: rental_management_costs_calibrated=&
                                (minimum_downpayment_below_20_perc*1.7599554037757183E-002+&
                                (1-minimum_downpayment_below_20_perc)*&
                                (is_there_mortgage_debt_premium*&
                                ((1-add_utility_from_child)*&
                                (robustness_check*&
                                (smaller_rental*3.2149747480955254E-003+&
                                looser_lambda*6.3650063330149553E-003+&
                                higher_nu*2.8721461798346948E-003+&
                                lower_nu*3.7136648047499388E-003+&
                                lump_sum_construction_profits*3.2255285399059724E-003)+&
                                (1-robustness_check)*3.2245505607532976E-003)+&
                                add_utility_from_child*3.0669471527248054E-003)+&
                                (1-is_there_mortgage_debt_premium)*(-2.0994164838875520E-002)))
                                                                 ! This is the calibrated value of 
                                                                 ! management costs of rentals
        
        real(8) :: rent_calibrated=(1-endogenous_rental_market)*&
                                   (minimum_downpayment_below_20_perc*6.0081258288368897E-002+&
                                   (1-minimum_downpayment_below_20_perc)*&
                                   (is_there_mortgage_debt_premium*&
                                   ((1-add_utility_from_child)*&
                                   (robustness_check*&
                                   (smaller_rental*0.11038080207995675+&
                                   looser_lambda*0.21853188884248065+&
                                   higher_nu*9.8610354314240756E-002+&
                                   lower_nu*0.12750249439664510+&
                                   lump_sum_construction_profits*0.11074314893997837)+&
                                   (1-robustness_check)*0.11070491227153027)+&
                                   add_utility_from_child*0.10529550601681738)+&
                                   (1-is_there_mortgage_debt_premium)*0.10701292130696495))+&
                                   endogenous_rental_market*& 
                                   (minimum_downpayment_below_20_perc*0.11098367848913067+&
                                   (1-minimum_downpayment_below_20_perc)*8.3316020667552948E-002) ! 0.10003085906222310
                                   
        real(8) :: long_run_rent=(1-endogenous_rental_market)*&
                                 (minimum_downpayment_below_20_perc*6.0081258288368897E-002+&
                                 (1-minimum_downpayment_below_20_perc)*0.10334237912230471)+&
                                 endogenous_rental_market*&
                                 (minimum_downpayment_below_20_perc*6.7724308851177875E-002+&
                                 (1-minimum_downpayment_below_20_perc)*9.4987302863270839E-002)
        
        real(8), parameter :: calibrated_stationary_housing_price=&
                                (1-endogenous_rental_market)*&
                                (minimum_downpayment_below_20_perc*1+&
                                (1-minimum_downpayment_below_20_perc)*&
                                (is_there_mortgage_debt_premium*&
                                ((1-add_utility_from_child)*&
                                (robustness_check*&
                                (smaller_rental*1.8396800757859999+&
                                looser_lambda*3.6421982287841517+&
                                higher_nu*1.6435059419725664+&
                                lower_nu*2.1250416207758001+&
                                lump_sum_construction_profits*1.8457191902546783)+&
                                (1-robustness_check)*1.8450819124329658)+&
                                add_utility_from_child*1.7549251395059231)+&
                                (1-is_there_mortgage_debt_premium)*1.7836502432879442))+&
                                endogenous_rental_market*&
                                (minimum_downpayment_below_20_perc*1+&
                                (1-minimum_downpayment_below_20_perc)*1) 
                                
        real(8), parameter :: long_run_stationary_housing_price=&
                                (1-endogenous_rental_market)*&
                                (minimum_downpayment_below_20_perc*0.78784251911688252+&
                                (1-minimum_downpayment_below_20_perc)*0.97730448458459673)+&
                                endogenous_rental_market*&
                                (minimum_downpayment_below_20_perc*65.133451512976151+&
                                (1-minimum_downpayment_below_20_perc)*0.97629597977187610)
                                        
        real(8), parameter :: calibrated_housing_stock=&
                                (1-endogenous_rental_market)*&
                                (minimum_downpayment_below_20_perc*92.789695871182971+&
                                (1-minimum_downpayment_below_20_perc)*&
                                (is_there_mortgage_debt_premium*&
                                ((1-add_utility_from_child)*&
                                (robustness_check*&
                                (smaller_rental*67.907570148858156+&
                                looser_lambda*74.526739632635852+&
                                higher_nu*74.354035073704281+&
                                lower_nu*74.629360422436918+&
                                lump_sum_construction_profits*74.619173313637404)+&
                                (1-robustness_check)*74.655581998846088)+&
                                add_utility_from_child*74.348611809155585)+&
                                (1-is_there_mortgage_debt_premium)*74.160325319839785))+&
                                endogenous_rental_market*&
                                (minimum_downpayment_below_20_perc*59.396794431644558+&
                                (1-minimum_downpayment_below_20_perc)*55.755395837354094) ! 59.614635536088869
                                
        real(8), parameter :: long_run_housing_stock=&
                                (1-endogenous_rental_market)*&
                                (minimum_downpayment_below_20_perc*92.789695871182971+&
                                (1-minimum_downpayment_below_20_perc)*72.031286830774974)+&
                                endogenous_rental_market*&
                                (minimum_downpayment_below_20_perc*87.621464489329895+&
                                (1-minimum_downpayment_below_20_perc)*57.083279572177211)
                                                                            
        real(8), parameter :: c_min_calibrated=&
                                (1-endogenous_rental_market)*&
                                (minimum_downpayment_below_20_perc*0.38077098021726297+&
                                (1-minimum_downpayment_below_20_perc)*&
                                (is_there_mortgage_debt_premium*&
                                ((1-add_utility_from_child)*&
                                (robustness_check*&
                                (smaller_rental*0.88913300405316120+&
                                looser_lambda*1.7603053352264826+&
                                higher_nu*0.79432037917840292+&
                                lower_nu*1.0270506621707713+&
                                lump_sum_construction_profits*0.89205175936286518)+&
                                (1-robustness_check)*0.89174375757956947)+&
                                add_utility_from_child*0.84817022357034166)+&
                                (1-is_there_mortgage_debt_premium)*0.86200424712662660))+&
                                endogenous_rental_market*&
                                (minimum_downpayment_below_20_perc*0.48330849246887719+&
                                (1-minimum_downpayment_below_20_perc)*0.48330849246887714) ! 0.48330849246887719
        
        real(8), parameter :: c_1_calibrated=&
                                (1-endogenous_rental_market)*&
                                (minimum_downpayment_below_20_perc*0.48709838752639784+&
                                (1-minimum_downpayment_below_20_perc)*&
                                (is_there_mortgage_debt_premium*&
                                ((1-add_utility_from_child)*&
                                (robustness_check*&
                                (smaller_rental*1.5444431188607823+&
                                looser_lambda*2.8994187664594526+&
                                higher_nu*1.3100697100300165+&
                                lower_nu*1.6903370976184664+&
                                lump_sum_construction_profits*1.4682681838845846)+&
                                (1-robustness_check)*1.4673521524900648)+&
                                add_utility_from_child*1.3989423699230723)+&
                                (1-is_there_mortgage_debt_premium)*1.4238213029835993))+&
                                endogenous_rental_market*&
                                (minimum_downpayment_below_20_perc*0.79778154789334510+&
                                (1-minimum_downpayment_below_20_perc)*0.82715065491954254) ! 0.79611440278676526
        
        real(8), parameter :: cutoff_housing_investment_calibrated=&
                                (1-endogenous_rental_market)*&
                                (minimum_downpayment_below_20_perc*0.64987901366455769+&
                                (1-minimum_downpayment_below_20_perc)*&
                                (is_there_mortgage_debt_premium*&
                                ((1-add_utility_from_child)*&
                                (robustness_check*&
                                (smaller_rental*0.38048796388710449+&
                                looser_lambda*0.41757535066865881+&
                                higher_nu*0.41660768232420409+&
                                lower_nu*0.41815033774709953+&
                                lump_sum_construction_profits*0.41809325909921780)+&
                                (1-robustness_check)*0.41829725795343237)+&
                                add_utility_from_child*0.41657729562532453)+&
                                (1-is_there_mortgage_debt_premium)*0.41552232130080990))+&
                                endogenous_rental_market*&
                                (minimum_downpayment_below_20_perc*0.41600233536342057+&
                                (1-minimum_downpayment_below_20_perc)*0.39049876511675985) ! 0.41752804746714811
                                
        real(8), parameter :: financial_per_household_calibrated=&
                                (1-endogenous_rental_market)*&
                                (minimum_downpayment_below_20_perc*0.64987901366455769+&
                                (1-minimum_downpayment_below_20_perc)*&
                                (is_there_mortgage_debt_premium*&
                                ((1-add_utility_from_child)*&
                                (robustness_check*&
                                (smaller_rental*1.6724126652342310+&
                                looser_lambda*2.5980413700570453+&
                                higher_nu*1.4793805572640597+&
                                lower_nu*1.9358928759860319+&
                                lump_sum_construction_profits*1.7098616865401062)+&
                                (1-robustness_check)*1.6739094531227698)+&
                                add_utility_from_child*1.7229130466768674)+&
                                (1-is_there_mortgage_debt_premium)*1.7595915592417395))+&
                                endogenous_rental_market*&
                                (minimum_downpayment_below_20_perc*0.25086559805174885+&
                                (1-minimum_downpayment_below_20_perc)*4.3011794223676084E-002)
                                                                 
        ! This is the government revenue constraint that comes from the calibrated model
        real(8) :: net_govt_revenue_constraint=shut_down_housing_market*&
                                               ((1-add_utility_from_child)*&
                                               (robustness_check*&
                                               (looser_lambda*6.3223851033692178+&
                                               higher_nu*4.6189446063365915+&
                                               lower_nu*6.2343713624247412)+&
                                               (1-robustness_check)*5.3150447520783448)+&
                                               add_utility_from_child*4.9416865226869069)+&
                                               (1-shut_down_housing_market)*& 
                                               ((1-endogenous_rental_market)*&
                                               (minimum_downpayment_below_20_perc*2.3297010433400738+&
                                               (1-minimum_downpayment_below_20_perc)*&
                                               (is_there_mortgage_debt_premium*&
                                               ((1-add_utility_from_child)*&
                                               (robustness_check*&
                                               (smaller_rental*6.7570575013200518+&
                                               looser_lambda*9.0813096999277345+&
                                               higher_nu*6.0565851085570115+&
                                               lower_nu*8.1447707324332725+&
                                               lump_sum_construction_profits*6.3115857203772006)+&
                                               (1-robustness_check)*6.9567649900560449)+&
                                               add_utility_from_child*6.5805942128152006)+&
                                               (1-is_there_mortgage_debt_premium)*6.7829505984013441))+&
                                               endogenous_rental_market*&
                                               (minimum_downpayment_below_20_perc*2.6878493653539675+&
                                               (1-minimum_downpayment_below_20_perc)*0.91503585643004337))
                                               
        real(8) :: net_govt_revenue_long_run=shut_down_housing_market*&
                                             ((1-add_utility_from_child)*&
                                             (robustness_check*&
                                             (looser_lambda*6.3223851033692178+&
                                             higher_nu*4.6189446063365915+&
                                             lower_nu*6.2343713624247412)+&
                                             (1-robustness_check)*5.3150447520783448)+&
                                             add_utility_from_child*4.9416865226869069)+&
                                             (1-shut_down_housing_market)*&
                                             ((1-endogenous_rental_market)*&
                                             (minimum_downpayment_below_20_perc*2.3297010433400738+&
                                             (1-minimum_downpayment_below_20_perc)*&
                                             (is_there_mortgage_debt_premium*&
                                             ((1-add_utility_from_child)*&
                                             (robustness_check*&
                                             (smaller_rental*6.7570575013200518+&
                                             looser_lambda*9.0813096999277345+&
                                             higher_nu*6.0565851085570115+&
                                             lower_nu*8.1447707324332725+&
                                             lump_sum_construction_profits*6.3115857203772006)+&
                                             (1-robustness_check)*6.9567649900560449)+&
                                             add_utility_from_child*6.5805942128152006)+&
                                             (1-is_there_mortgage_debt_premium)*6.7829505984013441))+&
                                             endogenous_rental_market*&
                                             (minimum_downpayment_below_20_perc*2.6878493653539675+&
                                             (1-minimum_downpayment_below_20_perc)*0.91503585643004337))
                                               
        real(8) :: distance_govt_budget
        
        real(8), parameter :: wage_calibrated=exogenous_wages*1+&
                                              (1-exogenous_wages)*& 
                                              (shut_down_housing_market*&
                                              ((1-add_utility_from_child)*&
                                              (robustness_check*&
                                              (smaller_rental*1.9862821719219561+&
                                              looser_lambda*3.7346539097447136+&
                                              higher_nu*1.7870292362065598+&
                                              lower_nu*2.2632380541472226)+&
                                              (1-robustness_check)*1.9862821719219561)+&
                                              add_utility_from_child*1.8674035267302336)+&
                                              (1-shut_down_housing_market)*&
                                              (is_there_mortgage_debt_premium*&
                                              ((1-add_utility_from_child)*&
                                              (robustness_check*&
                                              (smaller_rental*1.8396800757859999+&
                                              looser_lambda*3.6421982287841517+&
                                              higher_nu*1.6435059419725664+&
                                              lower_nu*2.1250416207758001+&
                                              lump_sum_construction_profits*1.8457191902546783)+&
                                              (1-robustness_check)*1.8450819124329658)+&
                                              add_utility_from_child*1.7549251395059231)+&
                                              (1-is_there_mortgage_debt_premium)*1.7836502432879442))
        
        ! this is the wage in the long-run counter factual simulation
        real(8), parameter :: wage_long_run=2.15
        
        real(8), parameter :: calibrated_risk_free_rate=&
                            (1-exogenous_wages)*&
                            (shut_down_housing_market*&
                            (exogenous_interest_rate*0.03+&
                            (1-exogenous_interest_rate)*0.03)+&
                            (1-shut_down_housing_market)*&
                            (exogenous_interest_rate*&
                            (is_there_mortgage_debt_premium*0.03+&
                            (1-is_there_mortgage_debt_premium)*0.045)+&
                            (1-exogenous_interest_rate)*0.03))+&
                            exogenous_wages*& 
                            ((1-endogenous_rental_market)*&
                            (minimum_downpayment_below_20_perc*0.02+&
                            (1-minimum_downpayment_below_20_perc)*0.045)+&
                            endogenous_rental_market*&
                            (minimum_downpayment_below_20_perc*0.02+&
                            (1-minimum_downpayment_below_20_perc)*0.03))
        
        real(8), parameter :: risk_free_rate_long_run=0.03
        
        real(8), parameter :: model_total_efficiency_units_calibrated=18.546343691687106
                                              
        real(8), parameter :: model_total_efficiency_units_long_run=18.546343691687106
                                              
        real(8), parameter :: model_corporate_capital_calibrated=1
        
        real(8), parameter :: model_corporate_capital_long_run=1
                                                                                           
        real(8), parameter :: average_labor_income_calibrated=&
                            shut_down_housing_market*&
                            ((1-add_utility_from_child)*&
                            (robustness_check*&
                            (looser_lambda*1.7643234039454954+&
                            higher_nu*0.84422749233798622+&
                            lower_nu*1.06919783308780853)+&
                            (1-robustness_check)*0.93835846840252368)+&
                            add_utility_from_child*0.88219787601298627)+&
                            (1-shut_down_housing_market)*&
                            (have_unemployment*&
                            (minimum_downpayment_below_20_perc*0.69712668096673380+&
                            (1-minimum_downpayment_below_20_perc)*0.69712668096673380)+&
                            (1-have_unemployment)*&
                            (minimum_downpayment_below_20_perc*0.47241951995259646+&
                            (1-minimum_downpayment_below_20_perc)*&
                            (is_there_mortgage_debt_premium*&
                            ((1-add_utility_from_child)*&
                            (robustness_check*&
                            (smaller_rental*0.86910077665087671+&
                            looser_lambda*1.7206455356105046+&
                            higher_nu*0.77642428670017194+&
                            lower_nu*1.0039111404968872+&
                            lump_sum_construction_profits*0.87195377220381221)+&
                            (1-robustness_check)*0.87165270972177855)+&
                            add_utility_from_child*0.82906089041439313)+&
                            (1-is_there_mortgage_debt_premium)*0.84258323247371603)))
        
        real(8), dimension(employment_grid_size) :: calibrated_soc_secrty
                                                                                                                     
        real(8) :: model_median_net_wealth
                        
        real(8), parameter :: calibrated_average_rental_size=&
                                (1-endogenous_rental_market)*&
                                (minimum_downpayment_below_20_perc*0.78784251911688252+&
                                (1-minimum_downpayment_below_20_perc)*&
                                (is_there_mortgage_debt_premium*&
                                ((1-add_utility_from_child)*&
                                (robustness_check*&
                                (smaller_rental*0.62124264617635450+&
                                looser_lambda*0.90875261478090008+&
                                higher_nu*0.94140236561530466+&
                                lower_nu*0.94516497337775696+&
                                lump_sum_construction_profits*0.97605100050622384)+&
                                (1-robustness_check)*0.94348984580131912)+&
                                add_utility_from_child*0.94442163394708623)+&
                                (1-is_there_mortgage_debt_premium)*0.94811256767973495))+&
                                endogenous_rental_market*&
                                (minimum_downpayment_below_20_perc*0.30693185641058568+&
                                (1-minimum_downpayment_below_20_perc)*0.64903696118263676) 
        
        real(8), parameter :: progressive_wealth_tax_threshold=&
            (1-shut_down_housing_market)*&
            calibrated_stationary_housing_price*&
            (is_there_mortgage_debt_premium*& 
            ((1-add_utility_from_child)*&
            (robustness_check*&
            (smaller_rental*0+&
            looser_lambda*1.6757343961935141*0.69+&
            higher_nu*1.07+&
            lower_nu*1.68+&
            lump_sum_construction_profits*5.75)+&
            (1-robustness_check)*1.6618030258357590*0.97)+&
            add_utility_from_child*1.6530772949847843*0)+&
            (1-is_there_mortgage_debt_premium)*1.6442699034179127*0.79)+&
            shut_down_housing_market*&
            average_labor_income_calibrated*&
            ((1-add_utility_from_child)*&
            (robustness_check*&
            (looser_lambda*7.1+&
            higher_nu*25.2+&
            lower_nu*10.6)+&
            (1-robustness_check)*13.771819)+&
            add_utility_from_child*0)
            
        real(8) :: threshold_housing=&
            different_progressive_wealth_taxes*&
            calibrated_stationary_housing_price*&
            (looser_lambda*1.6757343961935141+&
            (1-robustness_check)*1.6618030258357590)*0.42
            
        real(8) :: threshold_financial=&
            different_progressive_wealth_taxes*&
            average_labor_income_calibrated*1.38
        
        real(8) :: progressive_housing_tax=&
            different_progressive_wealth_taxes*2.88
        
        real(8) :: progressive_financial_tax=&
            different_progressive_wealth_taxes*&
            (looser_lambda*2.8204991385919895E-002+& !2.8141497986783025E-002
            (1-robustness_check)*2.8204991385919895E-002) 
            
        ! maximum mortgage payments as fraction of income
        real(8), parameter :: a_large_multiple_of_income=10.d0**(10)
        real(8), parameter :: max_debt_to_income_ratio=(1-what_is_the_program_solving)*&
                                                       (minimum_downpayment_below_20_perc*0.44+&
                                                       (1-minimum_downpayment_below_20_perc)*a_large_multiple_of_income)+&
                                                       what_is_the_program_solving*&
                                                       (have_unemployment*0.3+&
                                                       (1-have_unemployment)*a_large_multiple_of_income) ! a_large_multiple_of_income
                                                       
        real(8) :: max_mortgage_payments_as_fraction_of_income
        real(8) :: fraction_of_mortgage_payment_going_to_principal=real(1)/real(25)
                            
        ! This is the exogenous mortgage interest rate
        real(8), dimension(transition_length) :: mortgage_interest_rate
                                                                                                                                              
        real(8) :: slope_of_housing_stock_guess,slope_of_housing_price_guess,slope_of_rent_guess
                                                                              
        ! These variables are used for the housing stock and standard house size
        real(8), dimension(transition_length) :: housing_stock
        
        real(8), parameter :: empirical_housing_supplpy_elasticity=1.75 ! 1.75 from Saiz (2015 QJE)
        real(8), parameter :: empirical_land_to_housing_stock=0.314395015 ! From Case (2007)
        real(8) :: land_to_housing_stock
        real(8) :: c_min,c_1
        ! The above variables are used to computes the costs of construction of housing
        real(8) :: cutoff_housing_investment ! Used to compute the cutoff housing investment above which marginal costs are inreasing
        real(8), dimension(2) :: cutoff_housing_investment_bisection ! Used in the bisection to find the above variables save 
                                                                     ! the calibrated values of used to compute the costs of
                                                                     ! construction of housing
                
        real(8), parameter :: stopping_rule_cutoff_housing_investment=10.d0**(-5) ! Used to set a stopping rule for the bisection of housing
                                                                                  ! cocnstruction
        real(8) :: distance_cutoff_housing_investment ! Used to measure the distance of bisection cutoff_housing_investment
        real(8), dimension(transition_length) :: housing_investment,housing_investment_value 
    
        real(8) :: land_value ! This variable is used to compmute the value of land
        
        real(8), dimension(transition_length) :: distance_risk_free_rate=1
        real(8) :: largest_distance_risk_free_rate
        
        real(8), dimension(transition_length) :: aggregate_production_times_labour
        
        ! These variable break down the household budget to gross wage income, net wage income,
        ! wage income tax libability, gross capital gains, capital gains tax liability,
        ! gross financial wealth and gross housing wealth, mortgage debt
        real(8) :: gross_wage_income,wage_income_tax_paid,investment_income,&
            total_household_working_wealth,investment_income_tax_paid,gross_financial_wealth,mortgage_debt,&
            mortgage_payments,housing_depreciation_expenditures,after_tax_wealth,rent_spending,&
            property_taxes_paid,value_of_house_sold_next_period,spending_on_housing,&
            after_tax_wealth_net_of_expenses_renter,after_tax_wealth_net_of_expenses_owner,&
            rental_income_tax_paid,rental_income,gross_wage_income_next_period,mortgage_deductions,&
            tax_liability_next_period_without_mortgage_deductions,tax_liability_next_period_with_mortgage_deductions,&
            value_of_lived_in_space_sold_next_period,value_of_rented_space_sold_next_period,&
            employable_financial,gross_capital_gains,capital_gains_tax_paid,gross_housing_wealth,&
            total_household_wealth_that_can_be_leveraged,hidden_wealth,wealth_tax_paid,&
            borrow_or_lend,borrow_or_lend_1,borrow_or_lend_2,business_income_tax_paid,business_income,&
            profits_1,profits_2,total_household_wealth,total_household_wealth_1,welfare_subusidy,&
            progressive_wealth_tax_paid
            
        real(8), parameter :: min_welf_sub_as_frac_of_low_wage=0.02
            
        real(8) :: optimal_gross_wage_income,optimal_wage_income_tax_paid,&
                    optimal_after_tax_wealth_net_of_expenses,&
                    optimal_investment_income,optimal_investment_income_tax_paid,&
                    optimal_after_tax_wealth,optimal_rental_income_tax_paid,&
                    optimal_mortgage_deductions_tax_rebates,&
                    after_tax_wealth_net_of_expenses,&
                    optimal_hidden_wealth,optimal_wealth_tax_paid,&
                    optimal_business_income,optimal_borrow_or_lend,&
                    optimal_gross_capital_gains,optimal_capital_gains_tax_paid,&
                    optimal_capital_income_minus_wealth_tax,optimal_business_income_tax_paid,&
                    optimal_total_household_working_wealth,&
                    optimal_progressive_wealth_tax_paid,optimal_imputed_rent_tax_paid
                    
        integer :: optimal_space_lived_in,ownership
                    
        real(8) :: optimal_gross_wage_income_renter,optimal_wage_income_tax_paid_renter,&
                    optimal_mortgage_deductions_renter,&
                    optimal_after_tax_wealth_net_of_expenses_renter,&
                    optimal_consumption_renter,optimal_rental_income_tax_paid_renter,&
                    optimal_business_income_renter,optimal_business_income_tax_paid_renter,&
                    optimal_hidden_wealth_renter,optimal_investment_income_renter,&
                    optimal_investment_income_tax_paid_renter,optimal_borrow_or_lend_renter,&
                    optimal_total_household_working_wealth_renter
                    
        integer :: optimal_ownership_status_index_renter,&
                    optimal_use_alternative_lenders_renter,optimal_space_lived_in_renter
                    
        real(8) :: optimal_gross_wage_income_owner,optimal_wage_income_tax_paid_owner,&
                    optimal_mortgage_deductions_owner,&
                    optimal_after_tax_wealth_net_of_expenses_owner,&
                    optimal_consumption_owner,optimal_rental_income_tax_paid_owner,optimal_rental_income,&
                    optimal_business_income_owner,optimal_business_income_tax_paid_owner,&
                    optimal_hidden_wealth_owner,optimal_investment_income_owner,&
                    optimal_investment_income_tax_paid_owner,optimal_borrow_or_lend_owner,&
                    optimal_total_household_working_wealth_owner
                    
        integer :: optimal_ownership_status_index_owner,&
                    optimal_use_alternative_lenders_owner,optimal_space_lived_in_owner
                    
        ! These vectors save the indeces of the optmal choice for a given subset of choices, later I pick the highest
        ! The first index is for financial, second for mortgages, and third for housing status 
        integer, dimension(4) :: optimal_owner_indeces,optimal_renter_indeces
        
        integer :: optimal_owner_financial,optimal_renter_financial
                            
        ! These variables help me loop over all possible states
        integer :: time_index,age_index,employment_index,&
                   housing_status_index,lender_index,&
                   space_lived_in_index,&
                   productivity_index,productivity_shock_index
                                                                         
        ! These variables help me loop over all possible choices
        integer :: future_financial_index,future_mortgage_index,&
            future_housing_status_index,future_productivity_shock_index,&
            future_productivity_index
            
        integer :: future_log_productivity_index,log_productivity_index
        real(8) :: cut_off_1,cut_off_2
            
        integer :: household_members_at_corner
        
        integer :: past_employment_index_1,past_employment_index_2
                        
        integer :: looking_at_alternative_lenders
        
        ! This variable is to help me loop over all future income states and future productivity states
        integer :: future_employment_index
        
        ! This matrix saves the future value of making a certain combination of choices
        real(8), dimension(transition_length,life_span+1,&
            financial_grid_size,employment_grid_size,&
            productivity_shock_grid_size,productivity_grid_size) :: &
            value_function
         
        real(8), dimension(life_span+1,financial_grid_size,&
            employment_grid_size,productivity_shock_grid_size,&
            productivity_grid_size) :: &
            value_function_benchmark
        
        real(8), dimension(financial_grid_size,&
            employment_grid_size,productivity_shock_grid_size,&
            productivity_grid_size) :: &
            value_function_guess
            
        real(8) :: value_function_owner,value_function_renter
                           
        real(8) :: distance_value_function,weight_value_function_update=0.3
                            
        ! This matrix saves the future value of making a certain combination of choices
        real(8) :: val_fun_internal
        
        real(8) :: largest_value_function_value
        integer, dimension(4) :: distance_value_function_indeces
        integer, dimension(4) :: distance_value_function_indeces_youngest
                                
        ! This matrix saves the optimal choices
        integer, dimension(transition_length,life_span+1,&
            financial_grid_size,employment_grid_size,&
            productivity_shock_grid_size,productivity_grid_size) :: &
            policy_function_financial,policy_function_mortgage,policy_function_housing_status,&
            policy_function_ownership_status,policy_function_space_lived_in_index
                        
        integer, dimension(life_span+1,financial_grid_size,&
            employment_grid_size,productivity_shock_grid_size,&
            productivity_grid_size) :: &
            policy_function_financial_before_changes
            
        integer, dimension((1-use_alternative_lenders)+use_alternative_lenders*transition_length,&
                           (1-use_alternative_lenders)+use_alternative_lenders*(life_span+1),&
                           (1-use_alternative_lenders)+use_alternative_lenders*financial_grid_size,&
                           (1-use_alternative_lenders)+use_alternative_lenders*employment_grid_size,&
                           (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_grid_size,&
                           (1-use_alternative_lenders)+use_alternative_lenders*productivity_grid_size) :: &
            policy_function_use_alternative_lenders
                    
        ! This matrix saves the optimal consumptiona amount in each state of the world
        real(8), dimension(transition_length,life_span+1,financial_grid_size,&
            employment_grid_size,productivity_shock_grid_size,productivity_grid_size) :: &
            policy_function_mortgage_interest_deductions,&
            policy_function_consumption,policy_function_space_lived_in_size,&
            policy_function_rental_income_tax_paid,policy_function_working_wealth,&
            policy_function_investment_income_tax_paid,policy_function_investment_income,&
            policy_function_borrow_or_lend,policy_function_business_income,&
            policy_function_business_income_tax_paid
            
        real(8), dimension(life_span+1,financial_grid_size,&
            employment_grid_size,productivity_shock_grid_size,&
            productivity_grid_size) :: &
            policy_function_loss_on_house
            
        real(8), dimension(financial_grid_size) :: policy_function_hidden_wealth
        
        ! This matrix saves the optimal consumptiona amount in each state of the world
        real(8), dimension(life_span+1,financial_grid_size,&
            employment_grid_size,productivity_shock_grid_size,productivity_grid_size) :: &
            savings_decision_throughout_life_cycle,&
            business_income_by_wealth_level,&
            investment_income_by_wealth_level,&
            borrow_or_lend_decision_by_wealth_level
            
        real(8), dimension(life_span,transition_length) :: utility_from_public_consumption_counter
        real(8), dimension(life_span) :: utility_from_public_consumption_bench
        real(8) :: utility_from_public_consumption_average_bench,&
            utility_from_public_consumption_average_counter
            
        real(8) :: gross_housing_wealth_last_period,&
            gross_housing_wealth_this_period,mortgage_debt_last_period,net_housing_wealth_last_period,&
            left_over_wealth_after_selling_house_this_period,&
            average_net_wealth_after_selling_house,actual_property_taxes_paid_this_period,&
            expected_property_taxes_to_be_paid_this_period,actual_depreciation_this_period,&
            expected_depreciation_this_period,gross_housing_wealth_space_lived_in_this_period,&
            gross_housing_wealth_space_rented_out_this_period
            
        integer :: new_location_for_financial,new_location_for_optimal_fin_move_to,&
            net_optimal_frac
            
        integer :: adjusted_next_financial_index,adjusted_next_fin_move_to_index,&
            next_financial_index,next_fin_move_to_index
        real(8) :: adjusted_next_frac_move_to_optimal,next_frac_move_to_optimal
                                              
        ! The next variables are used to zoom in on decisions
        ! This variable is used to save the slope of the function
        real(8) :: slope_of_financial_internal,slope_of_space_lived_in_internal
        
        ! This variable is used to compute the distance between financial value at two grid location
        real(8) :: dis_prev_index_fin,dis_next_index_fin,dis_prev_index_space_lived_in,dis_next_index_space_lived_in
        
        ! This variable is used to find the distance between the financial and mortgage value of the internal choice
        ! and the financial and mortgage value of the optimal choice
        real(8) :: dis_internal_from_optimal_fin
                
        ! This variable is used to compute the actual financial choice
        real(8) :: financial_internal,space_lived_in_internal
        
        ! This variable is used to check different consumption bundles around the optimal choice
        real(8) :: consumption_internal_optimal_1
                                                       
        ! This is used to decide what fraction of population of households moves to another cell 
        ! 1 indicates moving to the same mortgage but different financial
        ! 2 indicates moving to the same financial but different mortgage
        ! 3 indicates moving to a different mortgage and different financial
        
        real(8), dimension(transition_length,life_span+1,&
            financial_grid_size,employment_grid_size,&
            productivity_shock_grid_size,productivity_grid_size) :: &
            frac_mov_optimal_1
            
        real(8), dimension(life_span+1,financial_grid_size,&
            employment_grid_size,productivity_shock_grid_size,&
            productivity_grid_size) :: &
            frac_mov_optimal_1_before_changes
        
        real(8) :: frac_mov_to_another_cell_1
                                                    
        ! This is used to decide which financial index the fraction of moves to
        integer, dimension(transition_length,life_span+1,&
            financial_grid_size,employment_grid_size,&
            productivity_shock_grid_size,productivity_grid_size):: &
            fin_index_frac_mov_to_optimal
            
        integer, dimension(life_span+1,financial_grid_size,&
            employment_grid_size,productivity_shock_grid_size,&
            productivity_grid_size):: &
            fin_index_frac_mov_to_optimal_before_changes
            
        integer :: fin_index_frac_mov_to
                                        
        ! This variable saves the highest value function
        real(8) :: largest_value
                            
        ! These matrices will be used to store the distribution of agents across each combination of state variables
        real(8), dimension(transition_length,life_span+1,&
            financial_grid_size,employment_grid_size,&
            productivity_shock_grid_size,productivity_grid_size) :: &
            distribution_guess,distribution_implied,&
            distribution_stationary
            
        integer, parameter :: max_CPU=81
            
        ! These matrices will be used to store the distribution of agents across each combination of state variables
        real(8), dimension(max_CPU,life_span+1,&
            financial_grid_size,employment_grid_size,&
            productivity_shock_grid_size,productivity_grid_size) :: &
            distribution_implied_private
            
        ! These matrices will be used to store the distribution of agents across each combination of state variables
        real(8), dimension((1-solve_transition_dynamics)+solve_transition_dynamics*2,&
            (1-solve_transition_dynamics)+solve_transition_dynamics*transition_length,&
            (1-solve_transition_dynamics)+solve_transition_dynamics*life_span,&
            (1-solve_transition_dynamics)+solve_transition_dynamics*financial_grid_size,&
            (1-solve_transition_dynamics)+solve_transition_dynamics*employment_grid_size,&
            (1-solve_transition_dynamics)+solve_transition_dynamics*productivity_shock_grid_size,&
            (1-solve_transition_dynamics)+solve_transition_dynamics*productivity_grid_size) :: &
            distribution_homeowners
            
        real(8), dimension((1-solve_transition_dynamics)+solve_transition_dynamics*2) :: &
            value_function_homeowners
        
        real(8), dimension(life_span+1,financial_grid_size,&
            employment_grid_size,productivity_shock_grid_size,&
            productivity_grid_size) :: &
            distribution_stationary_benchmark
        
        ! This variavble saves the distance between the distribution_guess and the distribution_implied
        real(8) :: distance_distribution=1
        
        ! This vector has the measure of households by age
        real(8), dimension(life_span) :: cohort_population
        real(8) :: total_population
        
        ! These variables are used for general loops
        integer :: i,j,k,loop_index
        
        real(8) :: distance_calibration=1     
        
        ! These variables save the model's statistics
        real(8), dimension(transition_length) :: &
            model_homeownership_rate,model_financial,model_gross_housing_wealth,model_total_efficiency_units,&
            model_net_housing_wealth,model_mortgages,model_total_net_wealth,&
            model_fraction_of_homeowners_with_mortgage,model_total_investment_income,&
            model_output,model_GDP,model_GDP_including_rent,model_GDP_incl_imput_rent,&
            model_average_labour_income,model_homeownership_rate_young,model_net_housing_wealth_young,&
            model_mortgages_young,model_gross_housing_wealth_young,model_financial_young,model_GDP_per_household,&
            model_financial_per_household,model_net_wealth_per_household,model_total_workers,&
            model_construction_company_profits_verified,model_average_labour_income_tax,&
            model_average_rental_unit_size,model_average_owner_occupied_unit_size,&
            model_median_owner_occupied_unit_size,mass_of_owners,mass_of_owners_with_mortgage,&
            mass_of_renters,model_bequests,model_fraction_of_homeowners_with_mortgage_over_80_perc,&
            model_fraction_of_mortgage_holders_using_alternative_lenders,model_mass_of_households_with_below_housing_size,&
            model_mass_of_households_below_wealth_level,model_average_net_wealth,model_space_rented_out,&
            model_fraction_of_landlords,model_average_landlord_house_size,model_average_landlord_space_rented_out,&
            model_unemployment_benefits,model_fraction_paying_progressive_wealth_tax,&
            model_fraction_paying_progressive_financial_tax,model_fraction_paying_progressive_housing_tax,&
            model_fraction_paying_both_progressive_taxes
            
        real(8), dimension(transition_length) :: &
            model_total_business_income,aggregation_of_tot_intermdte_gds,&
            corporate_capital,model_total_gross_enrepreneurial_income,model_depreciation_of_entrepreneurs_financial,&
            model_interest_payment_of_entrepreneurs,model_passive_invetment_income_of_entrepreneurs,model_fin_debt
            
        real(8) :: corporate_capital_new
            
        real(8), dimension(transition_length,productivity_grid_size,financial_grid_size) :: &
            tot_fin_by_prod_and_fin,tot_intermdt_by_prod_and_fin
            
        real(8) :: model_average_lowest_labor_income,mass_household_with_lowest_labor_income
                                        
        real(8), dimension(transition_length,0:2,employment_grid_size) :: &
            model_wealth_by_ownership_and_employment
            
        integer, parameter :: total_cells=&
            life_span*financial_grid_size*&
            employment_grid_size*productivity_shock_grid_size*&
            productivity_grid_size
            
        real(8), dimension(transition_length,total_cells) :: &
            model_housing_sizes_chosen,model_mass_of_homeowners_with_housing_size
            
        real(8), dimension(transition_length,total_cells) :: &
            model_incomes_earned,model_incomes_earned_saved,&
            model_mass_of_households_by_income_earned,model_cdf_of_income_earned
            
        real(8), dimension(transition_length) :: &
            total_constrcution_profits,construction_company_profits,&
            construction_company_profits_per_household
            
        real(8), dimension(transition_length,productivity_grid_size) :: &
            financial_by_productivity,net_housing_wealth_by_productivity,&
            mortgage_debt_by_productivity,housing_size_by_productivity
            
        real(8), dimension(transition_length,productivity_shock_grid_size,productivity_grid_size) :: &
            financial_by_productivity_and_shock,&
            fraction_of_population_by_productivity_and_shock
                                
        real(8), dimension(transition_length) :: frac_in_support,frac_in_support_youngest
                                
        real(8), dimension(employment_grid_size) :: model_ss_benefits,&
            model_lifetime_income_conditional_on_last_period_shock
            
        real(8) :: model_average_lifetime_income_conditional_on_last_period_shock
            
        real(8), dimension(employment_grid_size) :: &
            probability_came_from_past_employment_index_1,&
            probability_came_from_past_employment_index_2
                                                
        ! Used to keep track of whether a household is during retirement
        integer :: in_retirement
        
        integer :: can_have_best_productivity_shock,can_have_best_future_productivity_shock
        
        ! Used to keep track of whether is at least one period before retirement
        integer :: at_least_one_period_before_retirement
        
        integer :: can_get_mortgage,apply_disutility_of_landlords
        
        ! These variables save the model's distribution of wealth at the top
        real(8), dimension(wealth_brackets) :: &
            model_wealth_of_top_x_perc,model_net_hous_wealth_top_x_perc,&
            model_mortg_debt_wealth_top_perc,model_house_size_wealth_top_x_perc,&
            model_financial_wealth_top_x_perc,model_debt_to_house_value_top_x_perc,&
            model_homeonwership_rate_top_x_perc,pop_of_top_wealth_x_perc,&
            distance_pop_of_top_wealth_x_perc,stopping_rule_wealth_dist

        ! This is used to find the fraction of the household population to add to the
        ! top and bottom wealth distribution in case the total mass goes above the desired percetange
        real(8) :: frac_of_household_mas_to_add
                
        ! These variavbles save the model's distribution of wealth at the bottom
        real (8) :: model_wealth_of_bot_50_perc,&
            model_net_hous_wealth_bot_50_perc,&
            model_mortg_debt_bot_50_perc,&
            model_financial_wealth_bot_50_perc,&
            model_debt_to_house_value_bot_50_perc,&
            model_homeownership_rate_bot_50_perc,&
            pop_of_bot_wealth_50_perc,distance_pop_of_bot_wealth_50_perc
                
        ! This variable is used to figure out when the mass of households is larger than 50%
        real(8), parameter :: stopping_rule_bot_wealth_dist=0.5
        
        ! This matrix saves all the combinations of wealth
        real(8), dimension(solve_transition_dynamics+(1-solve_transition_dynamics)*financial_grid_size) :: &
            wealth_matrix,wealth_matrix_saved
            
        ! Breaks down wealth to net housing and fiancial wealth
        real(8), dimension(solve_transition_dynamics+(1-solve_transition_dynamics)*life_span,&
            solve_transition_dynamics+(1-solve_transition_dynamics)*financial_grid_size,&
            solve_transition_dynamics+(1-solve_transition_dynamics)*employment_grid_size,&
            solve_transition_dynamics+(1-solve_transition_dynamics)*productivity_shock_grid_size,&
            solve_transition_dynamics+(1-solve_transition_dynamics)*productivity_grid_size) :: &
            net_housing_wealth_matrix,financial_wealth_matrix,&
            mortgage_debt_matrix,homeownership_matrix
            
        ! This matrix saves the mass of households at a given wealth level
        real(8), dimension(solve_transition_dynamics+(1-solve_transition_dynamics)*financial_grid_size) :: &
            mass_of_pop_at_wealth_matrix
            
        real(8), dimension(financial_grid_size) :: &
            mass_of_pop_at_wealth_matrix_gini,wealth_matrix_gini
                                
        ! These variables are used to measure welfare scross different employment and productivity types for  the youngest cohort
        real(8), dimension(transition_length,employment_grid_size,productivity_grid_size) :: &
            welfare_by_employment_and_productivity,&
            mass_by_employment_and_productivity
            
        ! These variables are used to measure welfare scross different employment and productivity types for  the youngest cohort
        real(8), dimension(transition_length,0:&
            (endogenous_rental_market*2+(1-endogenous_rental_market)*1),&
            employment_grid_size) :: &
            welfare_by_ownership_status,mass_by_ownership_status
            
        ! These variables are used to measures welfare cross different productivity types and ages and their mass
        real(8), dimension(transition_length,((life_span-1)/10),productivity_grid_size) :: &
            welfare_by_age_and_productivity
                        
        ! These variables are used to measures welfare cross different productivity types and ages and their mass
        real(8), dimension(transition_length,((life_span-1)/10),productivity_grid_size) :: &
            homeownership_by_age_and_productivity,&
            mass_by_age_and_productivity,&
            housing_size_by_age_and_productivity
            
        real(8), dimension(transition_length,employment_grid_size,productivity_grid_size) :: &
            homeownership_by_employment_and_productivity,&
            housing_size_by_employment_and_productivity
                
        integer, parameter :: number_of_thresholds=4
        real(8), dimension(transition_length,number_of_thresholds) :: &
            mass_of_renters_at_housing_spending,&
            mass_of_homeowners_at_housing_spending,&
            frac_of_inc_spent_on_hous_threshold
                                        
        real(8) :: fraction_of_income_spent_on_housing
        
        integer :: thread_num,thread_index,total_number_of_threads
        
        ! These variables are used to save the max and min values of wealth in the wealth matrix
        real(8) :: max_wealth,min_wealth,max_wealth_gini,min_wealth_gini
        
        ! These matrices are used to save the index of the max and min values of the wealth in the wealth matrix
        integer, dimension(1) :: max_wealth_index,min_wealth_index
        
        ! These matrices are used to save the index of the max and min values of the wealth in the wealth matrix
        integer, dimension(1) :: min_wealth_index_gini
                        
        ! This varialbe helps me loop over the wealth distribution of different % of the wealth distribution
        integer :: wealth_of_top_x_perc_index
        
        ! This variable is used to compute the Gini Coeffcient 
        real(8), dimension(transition_length) :: gini_coefficient

        ! This vector is used to computes the cumulative mass at a different wealth levels
        ! The fist cell is the cumulative wealth at the current wealth level, and the second cell is the cumulative wealth
        ! at the previous wealth level
        real(8), dimension(transition_length,2) :: &
            gini_coefficient_cumulative_wealth,gini_coefficient_cumulative_income
        
        ! This variable is used to computes the total population counted in the Gini coefficient calcualtion
        real(8), dimension(transition_length) :: gini_coefficient_total_population
        
        ! This variables is to measure the numerator of the Gini coefficient
        real(8), dimension(transition_length) :: gini_coefficient_numerator
        
        ! This help with the loop
        real(8), dimension(transition_length) :: distance_gini_coefficient

        ! Thsese variables are used to compute government revenues from each source
        real(8), dimension(transition_length) :: &
            total_govt_revenues,govt_revenues_from_labour_income,govt_revenues_from_consumption,&
            govt_revenues_from_investment_income,govt_revenues_from_property_tax,&
            govt_revenues_from_property_tax_rental,govt_spending_on_ss,net_govt_revenues,&
            govt_revenues_from_rental_income,govt_spending_on_bailouts,&
            govt_spending_on_mortgage_interest_deductions,govt_spending_on_unemployment_benefits,&
            frac_bailedout,govt_revenues_from_wealth,govt_revenues_from_business_income,&
            govt_spending_welfare_subsidies,govt_revenues_from_progressive_wealth_tax,&
            govt_revenues_from_imputed_rents,govt_revenues_from_progressive_financial_tax,&
            govt_revenues_from_progressive_housing_tax
            
        ! These variables are used to compute the average welfare in the economy
        real(8), dimension(transition_length) :: &
            average_welfare_of_youngest_cohort,average_welfare_of_all_cohorts
        
        real(8), dimension(transition_length) :: &
            consumption_equivalent_youngest_cohort,consumption_equivalent_of_all_cohorts
                
        real(8), dimension(transition_length) :: aggregate_consumption,&
            aggregate_housing_consumption,aggregate_mortgage_consumption,&
            aggregate_rent_spending,aggregate_rental_income,aggregate_rental_profits
                
        ! This vector holds guesses for the financial wealth tax
        real(8), dimension(transition_length,2) :: wealth_tax_guess
        
        ! This variable is used to converge on the financial wealth tax
        real(8) :: largest_housing_market_distance,largest_rental_market_distance
        
        ! This variable saves the mass of people at each wealth level
        integer :: wealth_counter,wealth_counter_2
        
        integer :: loop_over_complete_distribution
                        
        real(8) :: x
        real(8) :: large_negative_num
        real(8) :: large_num=10.d0**(4)
        
        ! These variables save the time of an value function iteration
        real(8) ::  value_function_iteration_start_time,value_function_iteration_stop_time
        
        ! There variables save the total time of the simulation
        real(8) :: simulation_start_time,simulation_stop_time
        
        integer :: loop_count,loop_count_gini,loop_count_dist,counter
        integer :: simulation_ended,saved_stats_for_end_of_transition
        
        !$omp threadprivate(gross_wage_income)
        !$omp threadprivate(optimal_gross_wage_income)
        !$omp threadprivate(optimal_gross_wage_income_owner)
        !$omp threadprivate(optimal_gross_wage_income_renter)
        !$omp threadprivate(gross_wage_income_next_period)
        !$omp threadprivate(business_income)
        !$omp threadprivate(optimal_business_income)
        !$omp threadprivate(optimal_business_income_renter)
        !$omp threadprivate(optimal_business_income_owner)
        !$omp threadprivate(business_income_tax_paid)
        !$omp threadprivate(optimal_business_income_tax_paid)
        !$omp threadprivate(optimal_business_income_tax_paid_owner)
        !$omp threadprivate(optimal_business_income_tax_paid_renter)
        !$omp threadprivate(hidden_wealth)
        !$omp threadprivate(optimal_hidden_wealth)
        !$omp threadprivate(optimal_hidden_wealth_renter)
        !$omp threadprivate(optimal_hidden_wealth_owner)
        !$omp threadprivate(investment_income)
        !$omp threadprivate(optimal_investment_income)
        !$omp threadprivate(optimal_investment_income_owner)
        !$omp threadprivate(optimal_investment_income_renter)
        !$omp threadprivate(investment_income_tax_paid)
        !$omp threadprivate(optimal_investment_income_tax_paid)
        !$omp threadprivate(optimal_investment_income_tax_paid_owner)
        !$omp threadprivate(optimal_investment_income_tax_paid_renter)
        !$omp threadprivate(borrow_or_lend)
        !$omp threadprivate(borrow_or_lend_1)
        !$omp threadprivate(borrow_or_lend_2)
        !$omp threadprivate(optimal_borrow_or_lend)
        !$omp threadprivate(optimal_borrow_or_lend_renter)
        !$omp threadprivate(optimal_borrow_or_lend_owner)
        !$omp threadprivate(profits_1)
        !$omp threadprivate(profits_2)
        !$omp threadprivate(total_household_working_wealth)
        !$omp threadprivate(optimal_total_household_working_wealth)
        !$omp threadprivate(optimal_total_household_working_wealth_renter)
        !$omp threadprivate(optimal_total_household_working_wealth_owner)
        !$omp threadprivate(gross_capital_gains)
        !$omp threadprivate(optimal_gross_capital_gains)
        !$omp threadprivate(capital_gains_tax_paid)
        !$omp threadprivate(optimal_capital_gains_tax_paid)
        !$omp threadprivate(wage_income_tax_paid)
        !$omp threadprivate(optimal_wage_income_tax_paid)
        !$omp threadprivate(optimal_wage_income_tax_paid_renter)
        !$omp threadprivate(optimal_wage_income_tax_paid_owner)
        !$omp threadprivate(rental_income)
        !$omp threadprivate(optimal_rental_income)
        !$omp threadprivate(rental_income_tax_paid)
        !$omp threadprivate(optimal_rental_income_tax_paid)
        !$omp threadprivate(optimal_rental_income_tax_paid_renter)
        !$omp threadprivate(optimal_rental_income_tax_paid_owner)
        !$omp threadprivate(optimal_imputed_rent_tax_paid)
        !$omp threadprivate(optimal_consumption_owner)
        !$omp threadprivate(optimal_consumption_renter)
        !$omp threadprivate(wealth_tax_paid)
        !$omp threadprivate(optimal_wealth_tax_paid)
        !$omp threadprivate(progressive_wealth_tax_paid)
        !$omp threadprivate(optimal_progressive_wealth_tax_paid)
        !$omp threadprivate(optimal_owner_indeces)
        !$omp threadprivate(optimal_renter_indeces)
        !$omp threadprivate(optimal_ownership_status_index_owner)
        !$omp threadprivate(optimal_ownership_status_index_renter)
        !$omp threadprivate(optimal_space_lived_in)
        !$omp threadprivate(optimal_space_lived_in_owner)
        !$omp threadprivate(optimal_space_lived_in_renter)
        !$omp threadprivate(value_function_owner)
        !$omp threadprivate(value_function_renter)
        !$omp threadprivate(optimal_mortgage_deductions_tax_rebates)
        !$omp threadprivate(optimal_mortgage_deductions_renter)
        !$omp threadprivate(optimal_mortgage_deductions_owner)
        !$omp threadprivate(after_tax_wealth_net_of_expenses)
        !$omp threadprivate(optimal_after_tax_wealth_net_of_expenses)
        !$omp threadprivate(optimal_after_tax_wealth_net_of_expenses_owner)
        !$omp threadprivate(optimal_after_tax_wealth_net_of_expenses_renter)
        !$omp threadprivate(optimal_capital_income_minus_wealth_tax)
        !$omp threadprivate(optimal_use_alternative_lenders_owner)
        !$omp threadprivate(optimal_use_alternative_lenders_renter)
        !$omp threadprivate(tax_liability_next_period_without_mortgage_deductions)
        !$omp threadprivate(tax_liability_next_period_with_mortgage_deductions)
        !$omp threadprivate(optimal_owner_financial)
        !$omp threadprivate(optimal_renter_financial)
        !$omp threadprivate(total_household_wealth)
        !$omp threadprivate(total_household_wealth_1)
        !$omp threadprivate(welfare_subusidy)
        
        !$omp threadprivate(consumption_vector)
        !$omp threadprivate(consumption_internal_optimal_1)
        !$omp threadprivate(space_lived_in_internal)
        !$omp threadprivate(financial_internal)
        !$omp threadprivate(flow_utility_vector)
        !$omp threadprivate(future_utility_vector)
        !$omp threadprivate(flow_utility_internal)
        !$omp threadprivate(future_utility_internal)
        !$omp threadprivate(val_fun_internal)
        !$omp threadprivate(largest_value)
        
        !$omp threadprivate(dis_prev_index_space_lived_in)
        !$omp threadprivate(dis_next_index_space_lived_in)
        !$omp threadprivate(dis_prev_index_fin)
        !$omp threadprivate(dis_next_index_fin)
        !$omp threadprivate(slope_of_space_lived_in_internal)
        !$omp threadprivate(slope_of_financial_internal)
        !$omp threadprivate(dis_internal_from_optimal_fin)
        !$omp threadprivate(fin_index_frac_mov_to)
        !$omp threadprivate(frac_mov_to_another_cell_1)
        
        !$omp threadprivate(largest_possible_financial_index)
        !$omp threadprivate(future_employment_index)
        !$omp threadprivate(space_lived_in_index)
        !$omp threadprivate(employment_index)
        !$omp threadprivate(future_housing_status_index)
        !$omp threadprivate(productivity_index)
        !$omp threadprivate(future_productivity_index)
        !$omp threadprivate(productivity_shock_index)
        !$omp threadprivate(future_productivity_shock_index)
        !$omp threadprivate(lender_index)
        !$omp threadprivate(household_members_at_corner)
        !$omp threadprivate(future_mortgage_index)
        !$omp threadprivate(future_financial_index)
                
        !$omp threadprivate(property_taxes_paid)
        !$omp threadprivate(gross_housing_wealth)
        !$omp threadprivate(housing_depreciation_expenditures)
        !$omp threadprivate(spending_on_housing)
        !$omp threadprivate(mortgage_payments)
        !$omp threadprivate(mortgage_deductions)
        !$omp threadprivate(average_labour_income_tax)
        !$omp threadprivate(ownership)
        !$omp threadprivate(rent_spending)
        !$omp threadprivate(mortgage_debt)
        !$omp threadprivate(value_of_house_sold_next_period)
        !$omp threadprivate(value_of_lived_in_space_sold_next_period)
        !$omp threadprivate(value_of_rented_space_sold_next_period)
        !$omp threadprivate(total_household_wealth_that_can_be_leveraged)
        !$omp threadprivate(employable_financial)
        
        !$omp threadprivate(loop_count)
        !$omp threadprivate(thread_num)
        !$omp threadprivate(thread_index)
        !$omp threadprivate(can_get_mortgage)
        !$omp threadprivate(can_have_best_productivity_shock)
        !$omp threadprivate(can_have_best_future_productivity_shock)
        !$omp threadprivate(pay_mortgage_insurance)
        !$omp threadprivate(apply_disutility_of_landlords)
        !$omp threadprivate(looking_at_alternative_lenders)
        !$omp threadprivate(max_mortgage_payments_as_fraction_of_income)
        !$omp threadprivate(i)
        
	end module Wealth_Tax_Global_Vars
    
    program capital_gains_and_wealth_tax

        use Wealth_Tax_Global_Vars
        
        use omp_lib
        
        implicit none
               
        ! Sets the largest negative number
        large_negative_num=-99000000 ! ((epsilon_consumption)**(1-2))/(1-2)
        
        write(*,*) "large_negative_num=", large_negative_num
        
        simulation_ended=0
                                        
        ! The program calibrates
        if (what_is_the_program_solving==0) then
                                    
            ! Calls a subroutine that calibrates the model
            call calibrating_model()
                
            ! Calls a subroutine that writes the outputs
            call write_outputs(1,0)
                
        ! Solving for the wealth tax (with constant labour tax) staying revenue-neutral 
        elseif ((what_is_the_program_solving==1) .AND. (solve_transition_dynamics==0)) then
        
            call long_run_counter_factual()
            
            ! Calls a subroutine that writes the outputs
            call write_outputs(transition_length,0)
            
        elseif ((what_is_the_program_solving==1) .AND. (solve_transition_dynamics==1)) then
        
            call transition_simulation()
            
            call write_outputs(1,1)
                        
        end if
                                
    end program capital_gains_and_wealth_tax
        
    subroutine calculate_average_labour_income_tax&
        (gross_income,number_of_incomes,employment_index_1,wage_used)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        real(8) :: gross_income,wage_used
        integer :: number_of_incomes,employment_index_1
                            
        average_labour_income_tax=0
        
        if ((have_unemployment==1) .AND. (employment_index_1==employment_grid_size)) then
        
            average_labour_income_tax=0
        
        else
        
            average_labour_income_tax=&
                average_labour_income_tax+&
                (labour_income_tax(number_of_incomes-have_unemployment)+increase_in_labour_income_tax)*&
                min(max(gross_income,0.d0),&
                (what_is_the_program_solving*wage_calibrated+&
                (1-what_is_the_program_solving)*wage_used)*&
                employment_grid(number_of_incomes-have_unemployment)*&
                maxval(labour_deterministic_efficiency))
        
            do i=(number_of_incomes-1-have_unemployment),2,-1
                
                average_labour_income_tax=&
                    average_labour_income_tax+&
                    (labour_income_tax(i)+increase_in_labour_income_tax)*&
                    min(max(max(gross_income,0.d0)-&
                    (what_is_the_program_solving*wage_calibrated+&
                    (1-what_is_the_program_solving)*wage_used)*&
                    employment_grid(i+1)*maxval(labour_deterministic_efficiency),0.d0),&
                    (what_is_the_program_solving*wage_calibrated+&
                    (1-what_is_the_program_solving)*wage_used)*&
                    employment_grid(i)*maxval(labour_deterministic_efficiency)-&
                    (what_is_the_program_solving*wage_calibrated+&
                    (1-what_is_the_program_solving)*wage_used)*&
                    employment_grid(i+1)*maxval(labour_deterministic_efficiency))
            
            end do
        
            average_labour_income_tax=&
                average_labour_income_tax+&
                (labour_income_tax(1)+increase_in_labour_income_tax)*&
                max(max(gross_income,0.d0)-&
                (what_is_the_program_solving*wage_calibrated+&
                (1-what_is_the_program_solving)*wage_used)*&
                employment_grid(2)*maxval(labour_deterministic_efficiency),0.d0)
                                
            if (gross_income==0) then
            
                average_labour_income_tax=0
        
            else
            
                average_labour_income_tax=average_labour_income_tax/gross_income
    
            end if
            
        end if
        
        if ((labour_income_tax(employment_index_1)==0)  .AND. &
            (average_labour_income_tax>0) .AND. & 
            (increase_in_labour_income_tax==0) .AND. &
            (what_is_the_program_solving==0)) then
        
            write(*,*) "employment_index_1=", employment_index
            write(*,*) "average_labour_income_tax=", average_labour_income_tax
            write(*,*) "increase_in_labour_income_tax=", increase_in_labour_income_tax
            write(*,*) "gross_income=", gross_income
    
        end if
    
    end subroutine
         
    subroutine stationary_eqlibrium_intermediate_inputs(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index
        integer :: time_period
        real(8) :: total_useable_fin_wealth,effective_total_useable_fin_wealth
        
        model_total_investment_income(time_period)=0
        model_total_business_income(time_period)=0
                                                               
        ! Sets the intermediate goods production to 0
        aggregation_of_tot_intermdte_gds(time_period)=0
        corporate_capital(time_period)=0
        model_total_efficiency_units(time_period)=0
        
        model_total_gross_enrepreneurial_income(time_period)=0
        model_depreciation_of_entrepreneurs_financial(time_period)=0
        model_interest_payment_of_entrepreneurs(time_period)=0
        model_passive_invetment_income_of_entrepreneurs(time_period)=0
        
        ! Set the model's fin debt to 0
        model_fin_debt(time_period)=0
        
        ! Loops over all ages
        do age_index=1,life_span
        
            if (age_index>(life_span-retirement_span)) then
            
                in_retirement=1
            
            else
            
                in_retirement=0
            
            end if
        
            ! Finds the amount of financial for each productivity type
            do financial_index=1,financial_grid_size
        
                ! Loops over all productivities
                do employment_index=1,employment_grid_size
                                                                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                                            
                            if (in_retirement==0) then
                                    
                                ! Computes the amount of labor
                                model_total_efficiency_units(time_period)=&
                                    model_total_efficiency_units(time_period)+&
                                    labour_deterministic_efficiency(age_index)*&
                                    employment_grid(employment_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,&
                                    employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)
                                    
                            end if
                                                                                                        
                            ! Computes the total borrowing and lending
                            if (policy_function_borrow_or_lend&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)>0) then
                                        
                                model_fin_debt(time_period)=&
                                    model_fin_debt(time_period)+&
                                    policy_function_borrow_or_lend&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)
                                            
                            end if
                                                        
                            ! Measureing how much working wealth would be left over after hiding some of it
                            ! offshore
                            employable_financial=&
                                max(policy_function_working_wealth&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)-&
                                what_is_the_program_solving*&
                                is_hidden_wealth_offshore*&
                                policy_function_hidden_wealth&
                                (financial_index),0.d0)
                                                                       
                            ! Checks if the household is a borrowers
                            if (employable_financial<0) then
                                            
                                total_useable_fin_wealth=0
                                                
                            ! The household has some employable wealth
                            else
                                    
                                total_useable_fin_wealth=&
                                    employable_financial+&
                                    policy_function_borrow_or_lend&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                                
                            end if
                            
                            if (productivity_shock_grid(productivity_shock_index)>0) then
                                                        
                                ! Computes the effective total financial wealth used in production
                                effective_total_useable_fin_wealth=&
                                    (productivity_grid(productivity_index)**&
                                    productivity_shock_grid(productivity_shock_index))*&
                                    total_useable_fin_wealth
                                    
                            else
                            
                                effective_total_useable_fin_wealth=0
                            
                            end if
                                                                                                                                                    
                            model_total_gross_enrepreneurial_income(time_period)=&
                                model_total_gross_enrepreneurial_income(time_period)+&
                                (aggregate_production_times_labour(time_period)*&
                                (effective_total_useable_fin_wealth)**(curv_intrmdte_prod))*&
                                distribution_stationary&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                                                                                                                                                        
                            ! Computes the amount of financial sued by each productivity type and
                            ! financial level
                            tot_fin_by_prod_and_fin&
                                (time_period,productivity_index,financial_index)=&
                                effective_total_useable_fin_wealth
                    
                            ! This computes the total intermediate production by 
                            ! each productivity type and financial level
                            tot_intermdt_by_prod_and_fin&
                                (time_period,productivity_index,financial_index)=&
                                ((tot_fin_by_prod_and_fin&
                                (time_period,productivity_index,financial_index))**&
                                (curv_intrmdte_prod))*&
                                distribution_stationary&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                                    
                            ! Computes gross capital gains
                            gross_capital_gains=&
                                policy_function_business_income&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)+&
                                policy_function_investment_income&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                                
                            model_total_investment_income(time_period)=&
                                model_total_investment_income(time_period)+&
                                policy_function_investment_income&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                                        
                            model_total_business_income(time_period)=&
                                model_total_business_income(time_period)+&
                                policy_function_business_income&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                                                                                                                            
                            model_depreciation_of_entrepreneurs_financial(time_period)=&
                                model_depreciation_of_entrepreneurs_financial(time_period)+&
                                financial_wealth_depreciation*&
                                (policy_function_borrow_or_lend&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)+&
                                policy_function_working_wealth&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index))*&
                                distribution_stationary&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                                        
                            ! Counts only the interest paid on loans
                            if (policy_function_borrow_or_lend&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)>0) then
                                            
                                model_interest_payment_of_entrepreneurs(time_period)=&
                                    model_interest_payment_of_entrepreneurs(time_period)+&
                                    risk_free_rate(time_period)*&
                                    policy_function_borrow_or_lend&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)
                                                    
                            ! The entrepreneurs is passively investing
                            else
                                                                                
                                model_passive_invetment_income_of_entrepreneurs(time_period)=&
                                    model_passive_invetment_income_of_entrepreneurs(time_period)-&
                                    risk_free_rate(time_period)*&
                                    policy_function_borrow_or_lend&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)
                                                                                        
                            end if
                                                                          
                            capital_gains_tax_paid=&
                                policy_function_business_income_tax_paid&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)+&
                                policy_function_investment_income_tax_paid&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                                                                                                        
                            ! Computes the total intermediate goods produced
                            aggregation_of_tot_intermdte_gds(time_period)=&
                                aggregation_of_tot_intermdte_gds(time_period)+&
                                tot_intermdt_by_prod_and_fin&
                                (time_period,productivity_index,financial_index)
                                                                
                        end do
                                                           
                    end do
                    
                end do
            
            end do
        
        end do
                    
        if (solve_transition_dynamics==0) then
                    
            write(*,*) "retired households=", & 
                sum(distribution_stationary(time_period,life_span-retirement_span+1:life_span,:,:,:,:))/&
                sum(distribution_stationary(time_period,:,:,:,:,:))
                
        end if
                                
        ! Computes the aggregation of the intermediate goods production
        aggregation_of_tot_intermdte_gds(time_period)=&
            max(aggregation_of_tot_intermdte_gds(time_period)**(1/curv_intrmdte_prod),1.d0)
                            
        if (share_of_corporate_profits==0) then
        
            corporate_capital(time_period)=1
            
        else
            
            corporate_capital(time_period)=&
                corporate_capital(time_period)+&
                ((share_of_corporate_profits*&
                (aggregation_of_tot_intermdte_gds(time_period)**(share_of_capital)*&
                model_total_efficiency_units(time_period)**(share_of_labour)))/&
                (risk_free_rate(time_period)+financial_wealth_depreciation))**&
                (1/(share_of_capital+share_of_labour))
                                
        end if
        
        ! Obtains a new guess for the wage
        wage_guess(time_period,2)=&
            aggregate_productivity*(share_of_labour)*&
            (aggregation_of_tot_intermdte_gds(time_period))**(share_of_capital)*&
            (corporate_capital(time_period))**(share_of_corporate_profits)*&
            (model_total_efficiency_units(time_period))**(share_of_labour-1)
            
        write(*,*) "wage_guess(",time_period,",2)=", wage_guess(time_period,2)
            
        if (solve_transition_dynamics==0) then
            
            write(*,*) "aggregation_of_tot_intermdte_gds(",time_period,")=", aggregation_of_tot_intermdte_gds(time_period)
            write(*,*) "model_total_efficiency_units(",time_period,")=", model_total_efficiency_units(time_period)
            write(*,*) "corporate_capital(",time_period,")=", corporate_capital(time_period)
            
        end if
                    
    end subroutine
    
    subroutine stationary_equilibrium_statistics(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index
        integer :: time_period
        integer :: location,pay_mortgage_insurance_1
        integer, dimension(1) :: min_house_size_index,index_of_income_earned
        real(8) :: total_income,total_housing_costs
        
        model_financial(time_period)=0
        model_output(time_period)=0
        model_unemployment_benefits(time_period)=0
        model_total_efficiency_units(time_period)=0
        model_net_housing_wealth(time_period)=0
        model_total_net_wealth(time_period)=0
        model_gross_housing_wealth(time_period)=0
        model_mortgages(time_period)=0
        model_bequests(time_period)=0
        model_space_rented_out(time_period)=0
        model_fraction_of_landlords(time_period)=0
        model_average_landlord_house_size(time_period)=0
        model_average_landlord_space_rented_out(time_period)=0
        mass_of_owners(time_period)=0
        
        model_construction_company_profits_verified(time_period)=0
                        
        ! Loops over all ages
        do age_index=1,life_span
        
            if (age_index>(life_span-retirement_span)) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
                
            end if
                        
            ! Loops over all financial wealth options
            do financial_index=1,financial_grid_size
            
                ! Loops over all employment statuses
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                    
                            if (in_retirement==0) then
                        
                                if ((have_unemployment==1) .AND. (employment_index==employment_grid_size)) then
                                
                                    model_unemployment_benefits(time_period)=&
                                        model_unemployment_benefits(time_period)+&
                                        unemploy_bene_frac_of_lowest_employ*&
                                        ((what_is_the_program_solving*wage_calibrated+&
                                        (1-what_is_the_program_solving)*wage(time_period))*&
                                        employment_grid(employment_grid_size-1))*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                        
                                else    
                                                                        
                                    model_total_efficiency_units(time_period)=&
                                        model_total_efficiency_units(time_period)+&
                                        employment_grid(employment_index)*&
                                        labour_deterministic_efficiency(age_index)*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                    
                                end if
                            
                            end if
                    
                            ! Checks if the household is a landlord
                            if ((abs(housing_size(policy_function_housing_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index))-&
                                policy_function_space_lived_in_size&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index))<10.d0**(-9)) .OR. &
                                (policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)==0) .OR. &
                                (endogenous_rental_market==0))  then
                        
                            ! The household is a landlord
                            else
                            
                                model_fraction_of_landlords(time_period)=&
                                    model_fraction_of_landlords(time_period)+&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                
                                model_average_landlord_house_size(time_period)=&
                                    model_average_landlord_house_size(time_period)+&
                                    housing_size(policy_function_housing_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))*&                                
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                            
                                model_average_landlord_space_rented_out(time_period)=&
                                    model_average_landlord_space_rented_out(time_period)+&
                                    (housing_size(policy_function_housing_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))-&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))*&                                
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                                
                            end if
                            
                            model_total_net_wealth(time_period)=&
                                model_total_net_wealth(time_period)+&
                                financial_grid(financial_index)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                            
                            model_financial(time_period)=&
                                model_financial(time_period)+&
                                policy_function_working_wealth&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                    
                            if (endogenous_rental_market==1) then
                                                                                                                
                                model_gross_housing_wealth(time_period)=&
                                    model_gross_housing_wealth(time_period)+&
                                    policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    housing_price(time_period)*&
                                    housing_size&
                                    (policy_function_housing_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                        
                                model_net_housing_wealth(time_period)=&
                                    model_net_housing_wealth(time_period)+&
                                    policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    housing_price(time_period)*&
                                    (1-mortgage_grid(policy_function_mortgage&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)))*&
                                    housing_size&
                                    (policy_function_housing_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                            
                                model_mortgages(time_period)=&
                                    model_mortgages(time_period)+&
                                    policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    housing_price(time_period)*&
                                    mortgage_grid(policy_function_mortgage&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))*&
                                    housing_size&
                                    (policy_function_housing_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                            
                            else
                                                                                                    
                                model_gross_housing_wealth(time_period)=&
                                    model_gross_housing_wealth(time_period)+&
                                    policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    housing_price(time_period)*&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                            
                                model_net_housing_wealth(time_period)=&
                                    model_net_housing_wealth(time_period)+&
                                    policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    housing_price(time_period)*&
                                    (1-mortgage_grid(policy_function_mortgage&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)))*&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                
                                model_mortgages(time_period)=&
                                    model_mortgages(time_period)+&
                                    policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    housing_price(time_period)*&
                                    mortgage_grid(policy_function_mortgage&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))*&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                        
                            end if
                        
                            ! Computes total bequests
                            if (age_index==1) then
                            
                                model_bequests(time_period)=&
                                    model_bequests(time_period)+&
                                    financial_grid(financial_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                            end if
                            
                            ! Rebate construction profits lump sum
                            if (rebate_construction_profits_lump_sum==1) then
                            
                                model_construction_company_profits_verified(time_period)=&
                                    model_construction_company_profits_verified(time_period)+&
                                    construction_company_profits_per_household(time_period)*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                
                            ! Rebate more if the household has more wealth
                            elseif (rebate_construction_profits_lump_sum==0) then
                                                    
                                model_construction_company_profits_verified(time_period)=&
                                    model_construction_company_profits_verified(time_period)+&
                                    (construction_company_profits_per_household(time_period))*&
                                    (policy_function_working_wealth&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)/&
                                    model_financial_per_household(time_period))*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                            end if
                    
                            if (endogenous_rental_market==1) then
                            
                                ! calculates the space rented out
                                model_space_rented_out(time_period)=&
                                    model_space_rented_out(time_period)+&
                                    (housing_size(policy_function_housing_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))-&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                
                            end if                    
                        
                            if (policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)==1) then
                            
                                mass_of_owners(time_period)=&
                                    mass_of_owners(time_period)+&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                            
                            end if
                            
                        end do
                        
                    end do
                                                
                end do
                
            end do
            
        end do
        
        if (exogenous_wages==1) then
        
            model_total_investment_income(time_period)=&
                model_financial(time_period)*&
                risk_free_rate(time_period)
                            
        end if
            
        if (exogenous_wages==0) then
            
            model_output(time_period)=&
                aggregate_productivity*&
                (aggregation_of_tot_intermdte_gds(time_period))**(share_of_capital)*&
                (corporate_capital(time_period)**(share_of_corporate_profits))*&
                (model_total_efficiency_units(time_period))**(share_of_labour)
                
        else
        
            model_output(time_period)=&
                wage(time_period)*model_total_efficiency_units(time_period)
        
        end if
        
        model_GDP(time_period)=&
            model_output(time_period)
        
!        model_total_net_wealth(time_period)=&
!            model_financial(time_period)+&
!            model_net_housing_wealth(time_period)
            
        model_average_net_wealth(time_period)=&
            model_total_net_wealth(time_period)/&
            sum(distribution_stationary(time_period,:,:,:,:,:))
            
        model_average_landlord_house_size(time_period)=&
            model_average_landlord_house_size(time_period)/&
            model_fraction_of_landlords(time_period)
            
        model_average_landlord_space_rented_out(time_period)=&
            model_average_landlord_space_rented_out(time_period)/&
            model_fraction_of_landlords(time_period)
            
        model_fraction_of_landlords(time_period)=&
            model_fraction_of_landlords(time_period)/&
            sum(distribution_stationary(time_period,:,:,:,:,:))
            
        model_median_owner_occupied_unit_size(time_period)=0
        
        model_mass_of_homeowners_with_housing_size(time_period,:)=0
        model_housing_sizes_chosen(time_period,:)=0
        model_mass_of_households_with_below_housing_size(time_period)=0
        model_average_lowest_labor_income=0
        mass_household_with_lowest_labor_income=0
        
        total_renter_household_income(time_period)=0
                
        i=1
                              
        do age_index=1,life_span
        
            if (age_index>(life_span-retirement_span)) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
                
            end if
            
            do financial_index=1,financial_grid_size
                    
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                    
                            if (in_retirement==1) then
                        
                                total_income=&
                                    model_ss_benefits(employment_index)*&
                                    ((1-what_is_the_program_solving)*&
                                    model_average_labour_income(time_period)+&
                                    what_is_the_program_solving)
                                
                            else
                    
                                if ((have_unemployment==1) .AND. (employment_index==(employment_grid_size))) then
                                
                                    total_income=&
                                        unemploy_bene_frac_of_lowest_employ*&
                                        (what_is_the_program_solving*wage_calibrated+&
                                        (1-what_is_the_program_solving)*wage(time_period))*&
                                        employment_grid(employment_grid_size-1)
                                    
                                else
                        
                                    total_income=&
                                        wage(time_period)*employment_grid(employment_index)*&
                                        labour_deterministic_efficiency(age_index)
                                    
                                end if
                        
                            end if
                                                    
                            total_income=&
                                total_income+&
                                policy_function_business_income&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)+&
                                policy_function_investment_income&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)+&
                                policy_function_rental_income_tax_paid&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)/&
                                rental_income_tax
                            
                            if (policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)==0) then
                                
                                total_renter_household_income(time_period)=&
                                    total_renter_household_income(time_period)+&
                                    total_income*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                            end if
                                                                        
                            if ((in_retirement==0) .AND. &
                               (have_unemployment==0) .AND. &
                               (employment_index==employment_grid_size)) then
                                
                                model_average_lowest_labor_income=&
                                    model_average_lowest_labor_income+&
                                    (what_is_the_program_solving*wage_calibrated+&
                                    (1-what_is_the_program_solving)*wage(time_period))*&
                                    employment_grid(employment_index)*&
                                    labour_deterministic_efficiency(age_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                                mass_household_with_lowest_labor_income=&
                                    mass_household_with_lowest_labor_income+&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                            end if
                    
                            if (simulation_ended==1)  then
                        
                                if ((policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)==1)) then
                                
                                    ! Checks if this is the first element
                                    if (i==1) then
                                    
                                        location=i
                                    
                                    else
                            
                                        location=-1    
                                    
                                    end if
                            
                                    do j=1,i
                                
                                        if (policy_function_space_lived_in_size&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)==&
                                            model_housing_sizes_chosen(time_period,j)) then
                                            
                                            location=j
                                        
                                        end if
                                    
                                    end do
                            
                                    ! Checks if this is the first element or if there is no
                                    ! element that is equal to the house size
                                    if (i==1) then
                                                                                                    
                                        model_mass_of_homeowners_with_housing_size&
                                            (time_period,location)=&
                                            model_mass_of_homeowners_with_housing_size&
                                            (time_period,location)+&
                                            distribution_stationary&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                        
                                        model_housing_sizes_chosen(time_period,location)=&
                                            policy_function_space_lived_in_size&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                        
                                        i=i+1
                                
                                    elseif ((i>1) .AND. (location==-1)) then
                                
                                        model_mass_of_homeowners_with_housing_size&
                                            (time_period,i+1)=&
                                            model_mass_of_homeowners_with_housing_size&
                                            (time_period,i+1)+&
                                            distribution_stationary&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                        
                                        model_housing_sizes_chosen(time_period,i+1)=&
                                            policy_function_space_lived_in_size&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index) 
                                    
                                        i=i+1
                            
                                    elseif ((i>1) .AND. (location>-1)) then
                                
                                        model_mass_of_homeowners_with_housing_size&
                                            (time_period,location)=&
                                            model_mass_of_homeowners_with_housing_size&
                                            (time_period,location)+&
                                            distribution_stationary&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                    
                                    end if
                                                            
                                end if
                        
                            end if
                            
                        end do
                        
                    end do
                        
                end do
                        
            end do
                
        end do
            
        model_average_lowest_labor_income=&
            model_average_lowest_labor_income/&
            mass_household_with_lowest_labor_income
            
        if (simulation_ended==1) then
                
            if (mass_of_owners(time_period)>0) then
        
                do while (model_mass_of_households_with_below_housing_size(time_period)<=&
                    (0.5*mass_of_owners(time_period)))
            
                    min_house_size_index=&
                        minloc(model_housing_sizes_chosen(time_period,:),&
                        mask=model_housing_sizes_chosen(time_period,:)>0)
                                                
                    ! Checks if there is a mass at this point
                    if (model_mass_of_homeowners_with_housing_size&
                        (time_period,min_house_size_index(1))>0) then
        
                        ! Updates the amount of net wealth
                        model_median_owner_occupied_unit_size=&
                            model_housing_sizes_chosen(time_period,min_house_size_index(1))
            
                        model_mass_of_households_with_below_housing_size(time_period)=&
                            model_mass_of_households_with_below_housing_size(time_period)+&
                            model_mass_of_homeowners_with_housing_size&
                            (time_period,min_house_size_index(1))
                
                    end if
            
                    model_housing_sizes_chosen(time_period,min_house_size_index(1))=-1
                                
                end do
            
            end if
        
            if (solve_transition_dynamics==0) then
            
                write(*,*) "model_mass_of_households_with_below_housing_size=", &
                    model_mass_of_households_with_below_housing_size(time_period)
                write(*,*) "mass_of_owners=", &
                    mass_of_owners(time_period)
                
            end if        
        
            ! Computes the median net wealth in the economy
            model_median_net_wealth=0
            model_mass_of_households_below_wealth_level(time_period)=0
        
            ! Computes median wealth only for the benchmark
            if (what_is_the_program_solving==0) then
        
                i=1
        
                do while (model_mass_of_households_below_wealth_level(time_period)<&
                    (0.5*sum(distribution_stationary(time_period,:,:,:,:,:))))
        
                    ! Checks if there is a mass at this point
                    if (sum(distribution_stationary(time_period,:,i,:,:,:))>0) then
            
                        ! Updates the amount of net wealth
                        model_median_net_wealth=financial_grid(i)
                    
                        model_mass_of_households_below_wealth_level(time_period)=&
                            model_mass_of_households_below_wealth_level(time_period)+&
                            sum(distribution_stationary(time_period,:,i,:,:,:))
                
                    end if
            
                    i=i+1            
        
                end do
        
            end if
            
        end if
            
        if (solve_transition_dynamics==0) then
                              
            write(*,*) "model_financial(",time_period,")=", model_financial(time_period)
            write(*,*) "model_mortgages(",time_period,")=", model_mortgages(time_period)
            write(*,*) "model_net_housing_wealth(",time_period,")=", model_net_housing_wealth(time_period)
            write(*,*) "model_gross_housing_wealth(",time_period,")=", model_gross_housing_wealth(time_period)
            write(*,*) "model_total_net_wealth(",time_period,")=", model_total_net_wealth(time_period)
            write(*,*) "model_bequests(",time_period,")=", model_bequests(time_period)
            write(*,*) "model_average_net_wealth(time_period)=", &
                model_average_net_wealth(time_period)
            
        end if
        
!        write(*,*) "model_construction_company_profits_verified(",time_period,")=", &
!            model_construction_company_profits_verified(time_period)
!        write(*,*) "total_constrcution_profits(",time_period,")=", total_constrcution_profits(time_period)
        
        ! Computes the average financial per household
        model_financial_per_household(time_period)=&
            model_financial(time_period)/&
            sum(distribution_stationary(time_period,:,:,:,:,:))
                
        model_total_workers(time_period)=0
        model_average_labour_income(time_period)=0
                
        ! Calculating average labour income earning in the model
        ! Loops over all working individuals
        do age_index=1,life_span-retirement_span
                  
            ! Loops over all financial wealth options
            do financial_index=1,financial_grid_size
        
                ! Loops over all employment statuses
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                            
                            if ((have_unemployment==1) .AND. (employment_index==(employment_grid_size))) then
                            
                            else
                            
                                ! Computes the fraction of the population who are workers
                                model_total_workers(time_period)=&
                                    model_total_workers(time_period)+&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,productivity_index) 
                                
                                ! average labor income is the wage times the deterministic efficiency
                                ! times the employment status times the amount of people there
                                model_average_labour_income(time_period)=&
                                    model_average_labour_income(time_period)+&
                                    wage(time_period)*employment_grid(employment_index)*&
                                    labour_deterministic_efficiency(age_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,productivity_index)
                                
                            end if
                            
                        end do
                        
                    end do
                            
                end do
        
            end do
        
        end do
                        
        ! Computes average labour income earnings in the model for all households
        model_average_labour_income(time_period)=&
            model_average_labour_income(time_period)/&
            model_total_workers(time_period)
                                            
        ! Computes rents and imputed rents
        total_rent_paid(time_period)=0
        total_imputed_rents(time_period)=0
        total_housing_services(time_period)=0
        
        ! Calculating average labour income earning in the model
        ! Loops over all working individuals
        do age_index=1,life_span
        
            ! Loops over all financial wealth options
            do financial_index=1,financial_grid_size
            
                ! Loops over all employment statuses
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                        
                            if (policy_function_ownership_status&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)==0) then
                            
                                total_housing_services(time_period)=&
                                    total_housing_services(time_period)+&
                                    rent(time_period)*&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)
                        
                            end if
                                
                            total_rent_paid(time_period)=&
                                total_rent_paid(time_period)+&
                                rent(time_period)*&
                                (1-policy_function_ownership_status&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index))*&
                                policy_function_space_lived_in_size&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)
                    
                            total_imputed_rents(time_period)=&
                                total_imputed_rents(time_period)+&
                                rent(time_period)*&
                                policy_function_ownership_status&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)*&
                                policy_function_space_lived_in_size&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)
                                
                        end do
                            
                    end do
                                    
                end do
                                      
            end do
            
        end do
        
        model_GDP_including_rent(time_period)=model_GDP(time_period)+total_rent_paid(time_period)
        
        model_GDP_incl_imput_rent(time_period)=model_GDP(time_period)+total_imputed_rents(time_period)
        
        ! Computes GDP per household
        model_GDP_per_household(time_period)=&
            model_GDP_incl_imput_rent(time_period)/&
            sum(distribution_stationary(time_period,:,:,:,:,:))
                                                    
    end subroutine
        
    subroutine stationary_equilibirum_homeownership_rate(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period
        integer :: financial_index
                        
        model_fraction_of_homeowners_with_mortgage(time_period)=0
        model_fraction_of_homeowners_with_mortgage_over_80_perc(time_period)=0
        model_fraction_of_mortgage_holders_using_alternative_lenders(time_period)=0
        model_average_rental_unit_size(time_period)=0
        model_average_owner_occupied_unit_size(time_period)=0
        mass_of_renters(time_period)=0
        mass_of_owners(time_period)=0    
        mass_of_owners_with_mortgage(time_period)=0
        
        largest_housing_size_consumed_in_equilibrium=0
        largest_financial_chosen_in_equilibrium=0
        
        ! Calculating average labour income earning in the model
        ! Loops over all working individuals
        do age_index=1,life_span
        
            ! Loops over all financial wealth options
            do financial_index=1,financial_grid_size
            
                ! Loops over all employment statuses
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                    
                            ! Checks if the household chooses to consume that house size
                            if ((policy_function_housing_status&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)>&
                                largest_housing_size_consumed_in_equilibrium) .AND. &
                                (distribution_stationary&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)>0)) then
                           
                                largest_housing_size_consumed_in_equilibrium=&
                                    policy_function_housing_status&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,productivity_index)
                           
                            end if
                        
                            if ((policy_function_financial&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)>&
                                largest_financial_chosen_in_equilibrium) .AND. &
                                (distribution_stationary&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)>0)) then
                        
                                largest_financial_chosen_in_equilibrium=&
                                    policy_function_financial&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,productivity_index)
                           
                            end if
                
                            if (policy_function_ownership_status&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)==0) then
            
                                model_average_rental_unit_size(time_period)=&
                                    model_average_rental_unit_size(time_period)+&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,productivity_index)
                                    
                                mass_of_renters(time_period)=&
                                    mass_of_renters(time_period)+&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,productivity_index)
                                                                
                            else
                
                                model_average_owner_occupied_unit_size(time_period)=&
                                    model_average_owner_occupied_unit_size(time_period)+&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,productivity_index)
                                
                                mass_of_owners(time_period)=&
                                    mass_of_owners(time_period)+&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,productivity_index)
                                                        
                                ! Checks if the household has a mortgage
                                if (policy_function_mortgage&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)>1) then
                            
                                    mass_of_owners_with_mortgage(time_period)=&
                                        mass_of_owners_with_mortgage(time_period)+&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                            
                                    model_fraction_of_homeowners_with_mortgage(time_period)=&
                                        model_fraction_of_homeowners_with_mortgage(time_period)+&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                    
                                    if (minimum_downpayment_below_20_perc==1) then
                                                                    
                                        ! Checks if the household has over 80% in mortgages
                                        if (mortgage_grid&
                                            (policy_function_mortgage&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index))>0.81) then
                                        
                                            ! Adds up the fraction with over 80%
                                            model_fraction_of_homeowners_with_mortgage_over_80_perc(time_period)=&
                                                model_fraction_of_homeowners_with_mortgage_over_80_perc(time_period)+&
                                                distribution_stationary&
                                                (time_period,age_index,financial_index,&
                                                employment_index,productivity_shock_index,&
                                                productivity_index)
                                        
                                        end if
                                            
                                    end if
                            
                                    if (use_alternative_lenders==1) then
                                    
                                        ! Checks if the household uses alternative lenders
                                        if (policy_function_use_alternative_lenders&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)==1) then
                                            
                                            model_fraction_of_mortgage_holders_using_alternative_lenders(time_period)=&
                                                model_fraction_of_mortgage_holders_using_alternative_lenders(time_period)+&
                                                distribution_stationary&
                                                (time_period,age_index,financial_index,&
                                                employment_index,productivity_shock_index,&
                                                productivity_index)
                                            
                                        end if
                                        
                                    end if
                                    
                                end if
                                                    
                            end if
                            
                        end do
                        
                    end do
                                            
                end do
                                            
            end do
            
        end do
        
        ! Gets the average rental unit size
        model_average_rental_unit_size(time_period)=&
            model_average_rental_unit_size(time_period)/&
            mass_of_renters(time_period)
            
        ! Gets the average owner occupied unit size
        model_average_owner_occupied_unit_size(time_period)=&
            model_average_owner_occupied_unit_size(time_period)/&
            mass_of_owners(time_period)
        
        ! Gets the homeownership rate
        model_homeownership_rate(time_period)=&
            mass_of_owners(time_period)/&
            sum(distribution_stationary(time_period,:,:,:,:,:))
            
        model_fraction_of_mortgage_holders_using_alternative_lenders(time_period)=&
            model_fraction_of_mortgage_holders_using_alternative_lenders(time_period)/&
            model_fraction_of_homeowners_with_mortgage(time_period)
            
        ! Gets the fraction of homeowners with a mortgage
        model_fraction_of_homeowners_with_mortgage(time_period)=&
            model_fraction_of_homeowners_with_mortgage(time_period)/&
            mass_of_owners(time_period)
            
        ! Gets the fraction of homeowners with a mortgage over 80%
        model_fraction_of_homeowners_with_mortgage_over_80_perc(time_period)=&
            model_fraction_of_homeowners_with_mortgage_over_80_perc(time_period)/&
            (model_fraction_of_homeowners_with_mortgage(time_period)*&
            mass_of_owners(time_period))
            
        if (solve_transition_dynamics==0) then
            
!            write(*,*) "model_homeownership_rate(time_period)", &
!                model_homeownership_rate(time_period)
!        
!            write(*,*) "model_average_rental_unit_size(time_period)=", &
!                model_average_rental_unit_size(time_period)
!            
!            write(*,*) "model_average_owner_occupied_unit_size(time_period)=", &
!                model_average_owner_occupied_unit_size(time_period)
!            
!            write(*,*) "model_average_rental_unit_size(time_period)/model_average_owner_occupied_unit_size(time_period)=", &
!                model_average_rental_unit_size(time_period)/model_average_owner_occupied_unit_size(time_period)
!            
!            write(*,*) "model_fraction_of_homeowners_with_mortgage(time_period)=", &
!                model_fraction_of_homeowners_with_mortgage(time_period)
                                
        end if
                                                                               
        ! Calculating the total housing demand
        total_housing_demand(time_period)=0
        total_rental_demand(time_period)=0
        total_rental_supply(time_period)=0
            
        ! Calculating average labour income earning in the model
        ! Loops over all working individuals
        do age_index=1,life_span
                
            ! Loops over all financial wealth options
            do financial_index=1,financial_grid_size
            
                ! Loops over all employment statuses
                do employment_index=1,employment_grid_size  
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                    
                            total_housing_demand(time_period)=&
                                total_housing_demand(time_period)+&
                                policy_function_space_lived_in_size&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                            
                            ! Checks if the household is a renter
                            if (policy_function_ownership_status&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)==0) then
                                
                                total_rental_demand(time_period)=&
                                    total_rental_demand(time_period)+&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)
                                
                            else
                        
                                if (endogenous_rental_market==1) then
                            
                                    total_rental_supply(time_period)=&
                                        total_rental_supply(time_period)+&
                                        (housing_size&
                                        (policy_function_housing_status&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index))-&
                                        policy_function_space_lived_in_size&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index))*&
                                        distribution_stationary&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)
                                    
                                end if
                                    
                            end if 
                            
                        end do
                        
                    end do
                                                    
                end do
                
            end do                
                
        end do
        
    end subroutine
    
    ! This subroutine computes govt revenues from each source
    subroutine govt_revenues_calc(time_period,slicing)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index
        integer :: time_period
        integer :: slicing
        
        govt_revenues_from_labour_income(time_period)=0
        govt_spending_on_mortgage_interest_deductions(time_period)=0
        govt_revenues_from_consumption(time_period)=0
        govt_revenues_from_rental_income(time_period)=0
        govt_revenues_from_investment_income(time_period)=0
        govt_revenues_from_business_income(time_period)=0
        govt_revenues_from_imputed_rents(time_period)=0
        govt_revenues_from_property_tax(time_period)=0
        govt_revenues_from_property_tax_rental(time_period)=0
        govt_revenues_from_wealth(time_period)=0
        govt_revenues_from_progressive_wealth_tax(time_period)=0
        govt_revenues_from_progressive_financial_tax(time_period)=0
        govt_revenues_from_progressive_housing_tax(time_period)=0
        model_fraction_paying_progressive_wealth_tax(time_period)=0
        model_fraction_paying_progressive_housing_tax(time_period)=0
        model_fraction_paying_progressive_financial_tax(time_period)=0
        model_fraction_paying_both_progressive_taxes(time_period)=0
        govt_spending_on_bailouts(time_period)=0
        frac_bailedout(time_period)=0
        govt_spending_on_ss(time_period)=0
        govt_spending_on_unemployment_benefits(time_period)=0
        govt_spending_welfare_subsidies(time_period)=0
        net_govt_revenues(time_period)=0
        
        ! This loop computes tax paid on labour income
        ! Loops over all working ages
        do age_index=1,life_span
        
            if (age_index>(life_span-retirement_span)) then
            
                in_retirement=1
                
            else
            
                in_retirement=0
                
            end if
                
            ! Loops over all financial wealth options
            do financial_index=1,financial_grid_size
            
                ! Loops over all employment statuses
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                            
                            if (distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)>0) then
                                               
                                if (mortgage_deductibility>0) then
                            
                                    govt_spending_on_mortgage_interest_deductions(time_period)=&
                                        govt_spending_on_mortgage_interest_deductions(time_period)+&
                                        policy_function_mortgage_interest_deductions&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                    
                                    if ((in_retirement==1) .AND. &
                                        (policy_function_mortgage_interest_deductions&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)>0)) then
                                    
                                        write(*,*) "error mortgage deduction"
                                    
                                    end if
                                
                                    if ((policy_function_mortgage_interest_deductions&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)>0) .AND. &
                                        (policy_function_ownership_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)==0)) then
                                    
                                        write(*,*) "renter with mortgage deductions"
                                    
                                    end if
                                
                                    if ((employment_index==employment_grid_size) .AND. &
                                        (have_unemployment==1) .AND. &
                                        (policy_function_mortgage_interest_deductions&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)>0) .AND. &
                                        (increase_in_labour_income_tax==0)) then
                                    
                                        write(*,*) "error mortgage deduction for unemployed"
                                    
                                    end if
                                                
                                end if
                            
                                if (in_retirement==0) then
                            
                                    if ((have_unemployment==1) .AND. &
                                        (employment_index==(employment_grid_size))) then
                                
                                        govt_spending_on_unemployment_benefits(time_period)=&
                                            govt_spending_on_unemployment_benefits(time_period)+&
                                            (unemploy_bene_frac_of_lowest_employ*&
                                            (what_is_the_program_solving*wage_calibrated+&
                                            (1-what_is_the_program_solving)*wage(time_period))*&
                                            employment_grid(employment_grid_size-1))*&
                                            distribution_stationary&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                    
                                    else
                                                                                                
                                        call calculate_average_labour_income_tax&
                                            (wage(time_period)*&
                                            employment_grid(employment_index)*&
                                            labour_deterministic_efficiency(age_index),&
                                            employment_grid_size,employment_index,&
                                            wage(time_period))
                                        
                                        govt_revenues_from_labour_income(time_period)=&
                                            govt_revenues_from_labour_income(time_period)+&
                                            (average_labour_income_tax*&
                                            wage(time_period)*employment_grid(employment_index)*&
                                            labour_deterministic_efficiency(age_index))*&
                                            distribution_stationary&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                
                                    end if
                                
                                end if
                                
                                ! Checks if the household is in retirement or not
                                if (in_retirement==0) then
                                
                                    ! Checks if the household is unemployed
                                    if ((have_unemployment==1) .AND. (employment_index==(employment_grid_size))) then
                                        
                                        ! Computes the gross wage income
                                        gross_wage_income=&
                                            unemploy_bene_frac_of_lowest_employ*&
                                            (what_is_the_program_solving*wage_calibrated+&
                                            (1-what_is_the_program_solving)*wage(time_period))*&
                                            employment_grid(employment_grid_size-1)
                                        
                                    else
                                    
                                        ! Computes the gross wage income
                                        gross_wage_income=&
                                            wage(time_period)*employment_grid(employment_index)*&
                                            labour_deterministic_efficiency(age_index)
                                            
                                    end if
                                        
                                else
                                                                                        
                                    gross_wage_income=&
                                        model_ss_benefits(employment_index)*&
                                        ((1-what_is_the_program_solving)*&
                                        model_average_labour_income(time_period)+&
                                        what_is_the_program_solving)
                                                                    
                                end if
                                                        
                                if ((financial_grid(financial_index)+gross_wage_income-&
                                    rent(time_period)*housing_size(0))<&
                                    ((wage(time_period)*&
                                    (have_unemployment*employment_grid(employment_grid_size-1))+&
                                    (1-have_unemployment)*employment_grid(employment_grid_size))*&
                                    min_welf_sub_as_frac_of_low_wage)) then
                                    
                                    welfare_subusidy=&
                                        min_welf_sub_as_frac_of_low_wage*&
                                        (wage(time_period)*labour_deterministic_efficiency(age_index)*&
                                        (have_unemployment*employment_grid(employment_grid_size-1)+&
                                        (1-have_unemployment)*employment_grid(employment_grid_size)))-&
                                        (total_household_wealth+gross_wage_income-&
                                        rent(time_period)*housing_size(0))
                                    
                                else
                                
                                    welfare_subusidy=0
            
                                end if
                                
                                govt_spending_welfare_subsidies(time_period)=&
                                    govt_spending_welfare_subsidies(time_period)+&
                                    welfare_subusidy*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                        
                            end if
                            
                        end do
                        
                    end do
                                                                        
                end do
        
            end do
            
        end do
                   
        ! Calculates the average labour income tax
        model_average_labour_income_tax(time_period)=&
            govt_revenues_from_labour_income(time_period)/&
            (wage(time_period)*model_total_efficiency_units(time_period))
        
        ! This loop computes tax paid on consumption
        ! Loops over all ages
        do age_index=1,life_span
                        
            ! Loops over all employment statuses
            do employment_index=1,employment_grid_size
            
                do financial_index=1,financial_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                            
                            if (distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)>0) then
            
                                govt_revenues_from_consumption(time_period)=&
                                    govt_revenues_from_consumption(time_period)+&
                                    consumption_tax*&  ! Consumption tax
                                    policy_function_consumption&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*& ! Actual consumption
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index) ! Mass
                                    
                                govt_revenues_from_wealth(time_period)=&
                                    govt_revenues_from_wealth(time_period)+&
                                    financial_tax*&
                                    (max((policy_function_working_wealth&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)-&
                                    policy_function_hidden_wealth(financial_index)),0.d0))*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                
                                ! Checks if the household uses more wealth than the threshold
                                if ((policy_function_working_wealth&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)+&
                                    housing_price&
                                    (min(time_period+&
                                    property_tax_is_paid_on_current_period_tax*&
                                    solve_transition_dynamics*1,transition_length))*&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)+&
                                    policy_function_business_income&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)+&
                                    policy_function_investment_income&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))>=progressive_wealth_tax_threshold) then
                                    
                                    govt_revenues_from_progressive_wealth_tax(time_period)=&
                                        govt_revenues_from_progressive_wealth_tax(time_period)+&
                                        progressive_wealth_tax*&
                                        ((policy_function_working_wealth&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)+&
                                        housing_price&
                                        (min(time_period+&
                                        property_tax_is_paid_on_current_period_tax*&
                                        solve_transition_dynamics*1,transition_length))*&
                                        policy_function_space_lived_in_size&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)+&
                                        policy_function_business_income&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)+&
                                        policy_function_investment_income&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))-progressive_wealth_tax_threshold)*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                        
                                    model_fraction_paying_progressive_wealth_tax(time_period)=&
                                        model_fraction_paying_progressive_wealth_tax(time_period)+&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                    
                                end if
                                
                                ! Checks if the household uses more wealth than the threshold
                                if (housing_price&
                                    (min(time_period+&
                                    property_tax_is_paid_on_current_period_tax*&
                                    solve_transition_dynamics*1,transition_length))*&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)>threshold_housing) then
                                    
                                    govt_revenues_from_progressive_housing_tax(time_period)=&
                                        govt_revenues_from_progressive_housing_tax(time_period)+&
                                        progressive_housing_tax*&
                                        (housing_price&
                                        (min(time_period+&
                                        property_tax_is_paid_on_current_period_tax*&
                                        solve_transition_dynamics*1,transition_length))*&
                                        policy_function_space_lived_in_size&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)-threshold_housing)*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                        
                                    model_fraction_paying_progressive_housing_tax(time_period)=&
                                        model_fraction_paying_progressive_housing_tax(time_period)+&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                    
                                end if
                                
                                ! Checks if the household uses more wealth than the threshold
                                if ((policy_function_working_wealth&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)+&
                                    policy_function_business_income&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)+&
                                    policy_function_investment_income&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))>=max(threshold_financial,0.d0)) then
                                    
                                    govt_revenues_from_progressive_financial_tax(time_period)=&
                                        govt_revenues_from_progressive_financial_tax(time_period)+&
                                        progressive_financial_tax*&
                                        ((policy_function_working_wealth&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)+&
                                        policy_function_business_income&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)+&
                                        policy_function_investment_income&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))-max(threshold_financial,0.d0))*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                        
                                    model_fraction_paying_progressive_financial_tax(time_period)=&
                                        model_fraction_paying_progressive_financial_tax(time_period)+&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                    
                                end if
                                
                                if (different_progressive_wealth_taxes==1) then
                                
                                    ! Checks if the household uses more wealth than the threshold
                                    if (((policy_function_working_wealth&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)+&
                                        policy_function_business_income&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)+&
                                        policy_function_investment_income&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))>=max(threshold_financial,0.d0)) .OR. &
                                        (housing_price&
                                        (min(time_period+&
                                        property_tax_is_paid_on_current_period_tax*&
                                        solve_transition_dynamics*1,transition_length))*&
                                        policy_function_space_lived_in_size&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)>threshold_housing)) then
                                        
                                        model_fraction_paying_both_progressive_taxes(time_period)=&
                                            model_fraction_paying_both_progressive_taxes(time_period)+&
                                            distribution_stationary&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                        
                                    end if
                                    
                                end if                                    
                                    
                            end if
                            
                        end do
    
                    end do
                                
                end do
        
            end do
    
        end do
        
        model_fraction_paying_progressive_wealth_tax(time_period)=&
            model_fraction_paying_progressive_wealth_tax(time_period)/&
            sum(distribution_stationary)
            
        model_fraction_paying_progressive_housing_tax(time_period)=&
            model_fraction_paying_progressive_housing_tax(time_period)/&
            sum(distribution_stationary)
            
        model_fraction_paying_progressive_financial_tax(time_period)=&
            model_fraction_paying_progressive_financial_tax(time_period)/&
            sum(distribution_stationary)
            
        model_fraction_paying_both_progressive_taxes(time_period)=&
            model_fraction_paying_both_progressive_taxes(time_period)/&
            sum(distribution_stationary)
        
        ! Loops over ages
        do age_index=1,life_span
        
            ! Loops over all financial wealth options
            do financial_index=1,financial_grid_size
            
                ! Loops over all employment statuses
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                            
                            if (distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)>0) then
                                
                                govt_revenues_from_investment_income(time_period)=&
                                    govt_revenues_from_investment_income(time_period)+&
                                    investment_income_tax*&
                                    policy_function_investment_income&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                                govt_revenues_from_business_income(time_period)=&
                                    govt_revenues_from_business_income(time_period)+&
                                    business_income_tax*&
                                    policy_function_business_income&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                                govt_revenues_from_imputed_rents(time_period)=&
                                    govt_revenues_from_imputed_rents(time_period)+&
                                    tax_imputed_rent*&
                                    business_income_tax*&
                                    rent(time_period)*&
                                    policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                            end if
                                                                            
                        end do
                        
                    end do
                                                                                           
                end do
                
            end do 
        
        end do
                
        if (rebate_construction_profits_lump_sum==2) then
        
            govt_revenues_from_investment_income(time_period)=&
                govt_revenues_from_investment_income(time_period)+&
                total_constrcution_profits(time_period)
                                
        end if
        
        ! Loops over ages
        do age_index=1,life_span
                                    
            ! Loops over all financial wealth options
            do financial_index=1,financial_grid_size
            
                ! Loops over all employment statuses
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                            
                            if (distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)>0) then
                                                                                                                                   
                                govt_revenues_from_rental_income(time_period)=&
                                    govt_revenues_from_rental_income(time_period)+&
                                    policy_function_rental_income_tax_paid&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                               
                            end if
                            
                        end do
                            
                    end do
                                                  
                end do
                
            end do 
        
        end do
        
        if ((govt_revenues_from_rental_income(time_period)>0) .AND. &
            (endogenous_rental_market==0)) then
        
            write(*,*) "erorr rental"
            
        end if
                                                                 
        ! Loops over ages
        do age_index=1,life_span
                
            ! Loops over all financial wealth options
            do financial_index=1,financial_grid_size
            
                ! Loops over all employment statuses
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                            
                            if (distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)>0) then
                                    
                                if (endogenous_rental_market==1) then
                                            
                                    govt_revenues_from_property_tax(time_period)=&
                                        govt_revenues_from_property_tax(time_period)+&
                                        property_tax(time_period-&
                                        (1-property_tax_is_paid_on_current_period_tax)*solve_transition_dynamics*1)*&
                                        housing_price(time_period)*&
                                        policy_function_space_lived_in_size&
                                        (time_period-solve_transition_dynamics*1,&
                                        age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)*&
                                        distribution_stationary&
                                        (time_period-solve_transition_dynamics*1,&
                                        age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                    
                                else
                            
                                    if (policy_function_ownership_status&
                                        (time_period-solve_transition_dynamics*1,&
                                        age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)==1) then
                                    
                                        govt_revenues_from_property_tax(time_period)=&
                                            govt_revenues_from_property_tax(time_period)+&
                                            property_tax(time_period-&
                                            (1-property_tax_is_paid_on_current_period_tax)*solve_transition_dynamics*1)*&
                                            housing_price(time_period)*&
                                            policy_function_space_lived_in_size&
                                            (time_period-solve_transition_dynamics*1,&
                                            age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)*&
                                            distribution_stationary&
                                            (time_period-solve_transition_dynamics*1,&
                                            age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                        
                                    else
                                
                                        govt_revenues_from_property_tax_rental(time_period)=&
                                            govt_revenues_from_property_tax_rental(time_period)+&
                                            property_tax(time_period-&
                                            (1-property_tax_is_paid_on_current_period_tax)*solve_transition_dynamics*1)*&
                                            housing_price(time_period)*&
                                            policy_function_space_lived_in_size&
                                            (time_period-solve_transition_dynamics*1,&
                                            age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)*&
                                            distribution_stationary&
                                            (time_period-solve_transition_dynamics*1,&
                                            age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                
                                    end if                    
                                       
                                end if
                            
                            end if
                            
                        end do
                                           
                    end do
                                                                                                                                      
                end do
                
            end do                
                        
        end do
        
        ! Calculates tax revenue from productive wealth
        ! If there is no estate taxation then it starts from age 2
        ! if there is estate taxation it starts from age 1
        do age_index=1,life_span
                
            ! Loops over all financial wealth options
            do financial_index=1,financial_grid_size
            
                ! Loops over all employment statuses
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                
                            if (time_period==2) then
                            
                                if (distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)>0) then
                            
                                    ! Computes the total bailouts in the economy
                                    govt_spending_on_bailouts(time_period)=&
                                        govt_spending_on_bailouts(time_period)+&
                                        policy_function_loss_on_house&
                                        (age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                    
                                    if (policy_function_loss_on_house&
                                        (age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)>0) then
                                    
                                        frac_bailedout(time_period)=&
                                            frac_bailedout(time_period)+&
                                            distribution_stationary&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                    
                                    end if
                                    
                                end if
                                
                            end if
                            
                        end do
                
                    end do
                
                end do
        
            end do
            
        end do
                
        ! Computes total govt revenues
        total_govt_revenues(time_period)=&
            govt_revenues_from_labour_income(time_period)+govt_revenues_from_consumption(time_period)+&
            govt_revenues_from_business_income(time_period)+govt_revenues_from_investment_income(time_period)+&
            govt_revenues_from_property_tax(time_period)+govt_revenues_from_wealth(time_period)+&
            govt_revenues_from_imputed_rents(time_period)+govt_revenues_from_progressive_wealth_tax(time_period)+&
            govt_revenues_from_progressive_financial_tax(time_period)+&
            govt_revenues_from_progressive_housing_tax(time_period)+&
            govt_revenues_from_property_tax_rental(time_period)+govt_revenues_from_rental_income(time_period)-&
            govt_spending_on_unemployment_benefits(time_period)-govt_spending_on_bailouts(time_period)-&
            govt_spending_on_mortgage_interest_deductions(time_period)-&
            govt_spending_welfare_subsidies(time_period)
            
        ! Calculates government spending on social security
        do age_index=life_span-retirement_span+1,life_span
            
            do financial_index=1,financial_grid_size
            
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                            
                            if (distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)>0) then
                                                
                                govt_spending_on_ss(time_period)=&
                                    govt_spending_on_ss(time_period)+&
                                    (model_ss_benefits(employment_index)*&
                                    ((1-what_is_the_program_solving)*&
                                    model_average_labour_income(time_period)+&
                                    what_is_the_program_solving))*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                            end if
                                
                        end do
                            
                    end do
                        
                end do
                                                  
            end do
        
        end do
                                
        ! Calculates net government revenues
        net_govt_revenues(time_period)=total_govt_revenues(time_period)-govt_spending_on_ss(time_period)
                
        if ((solve_transition_dynamics==0) .AND. (slicing==0)) then
                
            write(*,*) "net_govt_revenues from budget iteration=", net_govt_revenues(time_period)
            
        end if
    
    end subroutine
    
    subroutine stationary_equilibrium_top_wealth_distribution_stats(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index
        integer :: time_period
        
        wealth_counter=0
        
        wealth_matrix(:)=(financial_lower_bound-1)*wage(time_period)
        
        do financial_index=financial_grid_size,1,-1
        
            if (sum(distribution_stationary&
                (time_period,:,financial_index,:,:,:))>0) then
                            
                ! Computes all the possible wealth levels
                wealth_matrix&
                    (financial_index)=&
                    financial_grid(financial_index)
                    
                wealth_counter=wealth_counter+1    
                                            
            else
                        
                ! Computes all the possible wealth levels
                wealth_matrix&
                    (financial_index)=&
                    (financial_lower_bound-1)*&
                    wage(time_period)
                        
            end if
            
            ! Computes the mass of households at each wealth level
            mass_of_pop_at_wealth_matrix&
                (financial_index)=&
                sum(distribution_stationary&
                (time_period,:,financial_index,:,:,:))
        
        end do
        
        net_housing_wealth_matrix=0
        homeownership_matrix=0
        mortgage_debt_matrix=0
        financial_wealth_matrix=0
            
        ! Starts measuring wealth with those at the top of the financial distribution
        do financial_index=financial_grid_size,1,-1
        
            do age_index=1,life_span
            
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                            
                            ! Computes net housing wealth
                            net_housing_wealth_matrix&
                                (age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)=&
                                policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                (1-mortgage_grid&
                                (policy_function_mortgage&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)))*&
                                housing_size&
                                (policy_function_housing_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index))*&
                                housing_price(time_period)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                                
                            mortgage_debt_matrix&
                                (age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)=&
                                policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                mortgage_grid&
                                (policy_function_mortgage&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index))*&
                                housing_size&
                                (policy_function_housing_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index))*&
                                housing_price(time_period)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                                                            
                            ! Computes financial wealth
                            financial_wealth_matrix&
                                (age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)=&
                                policy_function_working_wealth&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                            
                            ! checks if the household is a homeowner
                            if (policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)==1) then
                                
                                homeownership_matrix&
                                    (age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)=&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                            end if
                        
                        end do
                                    
                    end do
                            
                end do
                
            end do
        
        end do
                
        ! Saving the results
        wealth_matrix_saved(:)=wealth_matrix(:)
        
        ! Will now computes the wealth at the top x percentile
        do wealth_of_top_x_perc_index=1,(1-simulation_ended)*1+simulation_ended*wealth_brackets
                
            !Retrieving the resuts
            wealth_matrix(:)=wealth_matrix_saved(:)
        
            ! This variable computes the mass of people at the very top of the wealth distribution
            pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=0
            
            ! This variable is used to meausre the wealth held by the mass of households in the top wealth distribution
            model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)=0
            
            ! This variable is used to compute the housing wealth held by the  mass of households in the top wealth
            ! distribution
            model_net_hous_wealth_top_x_perc(wealth_of_top_x_perc_index)=0
            
            ! This variable is used to compute the total of the mortgage by the mass of households in the top wealth
            ! distrbution
            model_mortg_debt_wealth_top_perc(wealth_of_top_x_perc_index)=0
            
            ! This variable is used to compute the finanancial wealth held by the mass of household in the top wealth
            ! distribution
            model_financial_wealth_top_x_perc(wealth_of_top_x_perc_index)=0
                        
            ! This variable is used to compute the homeownership rate in the top welth distirbution
            model_homeonwership_rate_top_x_perc(wealth_of_top_x_perc_index)=0
            
            ! This varialbe is used to measure the mass of households in the top wealth distribution
            distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=0
            
            if (wealth_of_top_x_perc_index==wealth_brackets) then
            
                loop_over_complete_distribution=1
            
            else
            
                loop_over_complete_distribution=0
            
            end if
            
            wealth_counter_2=1
                        
            ! Computes the wealth distribution of the top x%
            do while (((loop_over_complete_distribution*wealth_counter_2)+&
                     (1-loop_over_complete_distribution)*&
                     (distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)+10.d0**(-6)))&
                     <=(loop_over_complete_distribution*wealth_counter+&
                     (1-loop_over_complete_distribution)*stopping_rule_wealth_dist(wealth_of_top_x_perc_index)))
                     
                wealth_counter_2=wealth_counter_2+1
                
                ! Picks the maximum value in the wealth matrix
                max_wealth=&
                    maxval(wealth_matrix(:),&
                    mask=wealth_matrix(:)>=&
                    financial_lower_bound*wage(time_period))
                                    
                ! Finds the indeces associated with this wealth level
                max_wealth_index=&
                    maxloc(wealth_matrix(:),&
                    mask=wealth_matrix(:)>=&
                    financial_lower_bound*wage(time_period))
                                    
                ! Checks if the current mass of households
                ! brings the total mass to more than the percentage of interetst
                if (((pop_of_top_wealth_x_perc&
                    (wealth_of_top_x_perc_index)+&
                    mass_of_pop_at_wealth_matrix&
                    (max_wealth_index(1)))/&
                    sum(distribution_stationary))>&
                    stopping_rule_wealth_dist(wealth_of_top_x_perc_index)) then
                                    
                    ! Computes the fraction that is added to the statistics
                    frac_of_household_mas_to_add=&
                        (sum(distribution_stationary)*&
                        stopping_rule_wealth_dist(wealth_of_top_x_perc_index)-&
                        pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index))/&
                        (mass_of_pop_at_wealth_matrix&
                        (max_wealth_index(1)))
                        
                    ! Means that we have reached the desired mass
                    distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=&
                        stopping_rule_wealth_dist(wealth_of_top_x_perc_index)+0.000001
                        
                else
                
                    frac_of_household_mas_to_add=1
                    
                    ! Looks at how far away the mass of households measure is from 1% of the total population
                    distance_pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=&
                        (pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/sum(distribution_stationary))
                
                end if
                                            
                ! Computes the wealth held by this mass of households   
                model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)=&
                    model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*max_wealth*&
                    sum(distribution_stationary&
                    (time_period,:,max_wealth_index(1),:,:,:))
                                           
                ! Computes the mass of households in with this wealth
                pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)=&
                    pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*&
                    mass_of_pop_at_wealth_matrix&
                    (max_wealth_index(1))
                     
                ! Computes the housing wealth held by this mass of households
                model_net_hous_wealth_top_x_perc(wealth_of_top_x_perc_index)=&
                    model_net_hous_wealth_top_x_perc(wealth_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*&
                    sum(net_housing_wealth_matrix&
                    (:,max_wealth_index(1),:,:,:))
                    
                ! Computes the mortgage debt held by this mass of households
                model_mortg_debt_wealth_top_perc(wealth_of_top_x_perc_index)=&
                    model_mortg_debt_wealth_top_perc(wealth_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*&
                    sum(mortgage_debt_matrix&
                    (:,max_wealth_index(1),:,:,:))
                            
                ! Computes the financial wealth held by this mass of households
                model_financial_wealth_top_x_perc(wealth_of_top_x_perc_index)=&
                    model_financial_wealth_top_x_perc(wealth_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*&
                    sum(financial_wealth_matrix&
                    (:,max_wealth_index(1),:,:,:))
                                                    
                ! Computes the mass of homeowners for this level of wealth
                model_homeonwership_rate_top_x_perc(wealth_of_top_x_perc_index)=&
                    model_homeonwership_rate_top_x_perc(wealth_of_top_x_perc_index)+&
                    frac_of_household_mas_to_add*&
                    sum(homeownership_matrix(:,max_wealth_index(1),:,:,:))
                                                                              
                ! Sets the wealth of the previously found highest level of wealth to 0
                wealth_matrix&
                    (max_wealth_index(1))=&
                    (financial_lower_bound-1)*&
                    wage(time_period)
                                                 
            end do
            
            model_homeonwership_rate_top_x_perc(wealth_of_top_x_perc_index)=&
                model_homeonwership_rate_top_x_perc(wealth_of_top_x_perc_index)/&
                pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)
                
            if (solve_transition_dynamics==0) then
                
                write(*,*) "stopping_rule_wealth_dist(",wealth_of_top_x_perc_index,")",&
                    "model_wealth_of_top_x_perc(",wealth_of_top_x_perc_index,")/model_net_wealth=",&
                    model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)/&
                    (model_total_net_wealth(time_period))
                    
                if (shut_down_housing_market==0) then
                    
                    write(*,*) "model_net_hous_wealth_top_x_perc(",wealth_of_top_x_perc_index,")/model_wealth_of_top_x_perc(",&
                        wealth_of_top_x_perc_index,")=", &
                        model_net_hous_wealth_top_x_perc(wealth_of_top_x_perc_index)/&
                        model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)
                    write(*,*) "model_mortg_debt_wealth_top_perc(",wealth_of_top_x_perc_index,")/&
                        (model_mortg_debt_wealth_top_perc(",wealth_of_top_x_perc_index,")&
                        model_gross_hous_wealth_top_x_perc(",wealth_of_top_x_perc_index,")=", &
                        model_mortg_debt_wealth_top_perc(wealth_of_top_x_perc_index)/&
                        (model_mortg_debt_wealth_top_perc(wealth_of_top_x_perc_index)+&
                        model_net_hous_wealth_top_x_perc(wealth_of_top_x_perc_index))
                    write(*,*) "model_homeonwership_rate_top_x_perc(",wealth_of_top_x_perc_index,")=", &
                        model_homeonwership_rate_top_x_perc(wealth_of_top_x_perc_index)
                        
                end if
                                    
            end if
                                      
        end do
            
    end subroutine
    
    subroutine stationary_equilibrium_bot_wealth_distribution_stats(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index
        integer :: time_period
        
        wealth_matrix(:)=&
            (financial_lower_bound-1)*&
            wage(time_period)
        
        do financial_index=financial_grid_size,1,-1
        
            if (sum(distribution_stationary&
                (time_period,:,financial_index,:,:,:))>0) then
        
                ! Computes all the possible wealth levels
                wealth_matrix&
                    (financial_index)=&
                    financial_grid(financial_index)
                                
            else
                            
                ! Computes all the possible wealth levels
                wealth_matrix&
                    (financial_index)=&
                    (financial_lower_bound-1)*&
                    wage(time_period)
                        
            end if
            
            ! Computes the mass of households at each wealth level
            mass_of_pop_at_wealth_matrix&
                (financial_index)=&
                sum(distribution_stationary&
                (time_period,:,financial_index,:,:,:))
                
        end do
        
        net_housing_wealth_matrix=0
        mortgage_debt_matrix=0
        financial_wealth_matrix=0
        homeownership_matrix=0
            
        ! Starts measuring wealth with those at the top of the financial distribution
        do financial_index=financial_grid_size,1,-1
        
            do age_index=1,life_span
            
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                    
                            ! Computes net housing wealth
                            net_housing_wealth_matrix&
                                (age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)=&
                                policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                (1-mortgage_grid(policy_function_mortgage&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)))*&
                                housing_size&
                                (policy_function_housing_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index))*&
                                housing_price(time_period)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                            
                            mortgage_debt_matrix&
                                (age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)=&
                                policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                mortgage_grid&
                                (policy_function_mortgage&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index))*&
                                housing_size&
                                (policy_function_housing_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index))*&
                                housing_price(time_period)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                            
                            ! Computes financial wealth
                            financial_wealth_matrix&
                                (age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)=&
                                policy_function_working_wealth&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                                
                            ! checks if the household is a homeowner
                            if (policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)==1) then
                                
                                homeownership_matrix&
                                    (age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)=&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                            end if
                               
                        end do
                        
                    end do
    
                end do
    
            end do
        
        end do
        
        ! This variable computes the mass of people at the bottom 50 of the wealth distribution
        pop_of_bot_wealth_50_perc=0
            
        ! This variable is used to meausre the wealth held by the mass of households in the bottom 50% of the wealth distribution
        model_wealth_of_bot_50_perc=0
            
        ! This variable is used to compute the housing wealth held by the mass of households in the bottom of wealth
        ! distribution
        model_net_hous_wealth_bot_50_perc=0
        
        ! This variable is used to compute the mortgage debt held by the mass of households in the bottom of wealth distribution
        model_mortg_debt_bot_50_perc=0
            
        ! This variable is used to compute the finanancial wealth held by the mass of household in the bottom of the wealth
        ! distribution
        model_financial_wealth_bot_50_perc=0
        
        ! This variable is used to compute the homeownership rate of in the bottom of the wealth distribution
        model_homeownership_rate_bot_50_perc=0
            
        ! This varialbe is used to measure the mass of households in the top wealth distribution
        distance_pop_of_bot_wealth_50_perc=0
                        
        ! Computes the wealth distribution of the top x%
        do while (distance_pop_of_bot_wealth_50_perc&
            <=stopping_rule_bot_wealth_dist)
            
            ! Picks the maximum value in the wealth matrix
            min_wealth=&
                minval(wealth_matrix(:),&
                mask=wealth_matrix(:)>=&
                financial_lower_bound*wage(time_period))
                            
            ! Finds the indeces associated with this wealth level
            min_wealth_index=&
                minloc(wealth_matrix(:),&
                mask=wealth_matrix(:)>=&
                financial_lower_bound*wage(time_period))
                
            ! Checks if the additional mass of households goes above the 
            ! desired mass of households
            if ((pop_of_bot_wealth_50_perc+&
                mass_of_pop_at_wealth_matrix&
                (min_wealth_index(1)))/&
                (sum(distribution_stationary))>&
                stopping_rule_bot_wealth_dist) then
                
                ! Computes the fraction that is added to the statistics
                frac_of_household_mas_to_add=&
                    (sum(distribution_stationary)*&
                    stopping_rule_bot_wealth_dist-&
                    pop_of_bot_wealth_50_perc)/&
                    (mass_of_pop_at_wealth_matrix&
                    (min_wealth_index(1)))
                    
                ! Means that we have reached the desired mass
                distance_pop_of_bot_wealth_50_perc=stopping_rule_bot_wealth_dist+0.00001
                    
            else
            
                frac_of_household_mas_to_add=1
                
                ! Looks at how far away the mass of households measure is from 1% of the total population
                distance_pop_of_bot_wealth_50_perc=&
                    (pop_of_bot_wealth_50_perc)/sum(distribution_stationary)
            
            end if
            
            ! Computes the wealth held by this mass of households   
            model_wealth_of_bot_50_perc=&
            model_wealth_of_bot_50_perc+&
                frac_of_household_mas_to_add*min_wealth*&
                sum(distribution_stationary&
                (time_period,:,min_wealth_index(1),:,:,:))
                                           
            ! Computes the mass of households in with this wealth
            pop_of_bot_wealth_50_perc=&
                pop_of_bot_wealth_50_perc+&
                frac_of_household_mas_to_add*&
                mass_of_pop_at_wealth_matrix&
                (min_wealth_index(1))
                     
            ! Computes the housing wealth held by this mass of households
            model_net_hous_wealth_bot_50_perc=&
                model_net_hous_wealth_bot_50_perc+&
                frac_of_household_mas_to_add*&
                sum(net_housing_wealth_matrix&
                (:,min_wealth_index(1),:,:,:))
                    
            ! Computes the mortgage debt held by this mass of households
            model_mortg_debt_bot_50_perc=&
                model_mortg_debt_bot_50_perc+&
                frac_of_household_mas_to_add*&
                sum(mortgage_debt_matrix&
                (:,min_wealth_index(1),:,:,:))
                            
            ! Computes the financial wealth held by this mass of households
            model_financial_wealth_bot_50_perc=&
                model_financial_wealth_bot_50_perc+&
                frac_of_household_mas_to_add*&
                sum(financial_wealth_matrix&
                (:,min_wealth_index(1),:,:,:))
                                                    
            ! Computes the mass of homeowners for this level of wealth
            model_homeownership_rate_bot_50_perc=&
                model_homeownership_rate_bot_50_perc+&
                frac_of_household_mas_to_add*&
                sum(homeownership_matrix(:,min_wealth_index(1),:,:,:))
                            
            ! Sets the wealth of the previously found highest level of wealth to 0
            wealth_matrix&
                (min_wealth_index(1))=&
                (financial_lower_bound-1)*&
                wage(time_period)
                             
        end do
        
        ! Computes the homeownership rate of the the bottom of the wealth distribution
        model_homeownership_rate_bot_50_perc=&
            model_homeownership_rate_bot_50_perc/&
            pop_of_bot_wealth_50_perc
            
        if (solve_transition_dynamics==0) then
            
            write(*,*) "model_wealth_of_bot_50_perc/net_wealth=", & 
                model_wealth_of_bot_50_perc/&
                (model_financial(time_period)+model_net_housing_wealth(time_period))
                
            write(*,*) "model_net_hous_wealth_bot_50_perc/model_wealth_of_bot_50_perc=", &
                model_net_hous_wealth_bot_50_perc/model_wealth_of_bot_50_perc
                    
            write(*,*) "model_mortg_debt_bot_50_perc/gross_housing_wealth_bot_50_perc=", &
                model_mortg_debt_bot_50_perc/&
                (model_mortg_debt_bot_50_perc+model_net_hous_wealth_bot_50_perc)   
                
            write(*,*) "model_homeownership_rate_bot_50_perc=", &
                model_homeownership_rate_bot_50_perc
                
        end  if
                    
    end subroutine
    
    ! This subroutine calculate the Gini coefficient
    subroutine calculate_gini_coefficient(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index
        integer :: time_period
        
        wealth_matrix_gini(:)=&
            (financial_lower_bound-1)*&
            wage(time_period)
        
        loop_count_gini=0
        
        ! Starts measuring wealth with those at the top of the financial distribution
        do financial_index=financial_grid_size,1,-1
        
            if (sum(distribution_stationary&
                (time_period,:,financial_index,:,:,:))>0) then
                            
                ! Computes all the possible wealth levels
                wealth_matrix_gini&
                    (financial_index)=&
                    financial_grid(financial_index)
                    
                loop_count_gini=loop_count_gini+1
                    
            end if
                            
            ! Computes the mass of households at each wealth level
            mass_of_pop_at_wealth_matrix_gini&
                (financial_index)=&
                sum(distribution_stationary&
                (time_period,:,financial_index,:,:,:))
                                                                    
        end do
        
        gini_coefficient_numerator(time_period)=0
        gini_coefficient_cumulative_wealth(time_period,:)=0
        gini_coefficient_total_population(time_period)=0
            
        ! This varialbe is used to measure the mass of households in the top wealth distribution
        counter=1
                        
        ! Computes the gini coeffcient numerator
        do while (counter<=loop_count_gini)
            
            ! Picks the maximum value in the wealth matrix
            min_wealth_gini=&
                minval(wealth_matrix_gini(:),&
                mask=wealth_matrix_gini(:)>=&
                financial_lower_bound*wage(time_period))
                
            ! Finds the indeces associated with this wealth level
            min_wealth_index_gini=&
                minloc(wealth_matrix_gini(:),&
                mask=wealth_matrix_gini(:)>=&
                financial_lower_bound*wage(time_period))
                                           
            ! Computes the wealth of households in with this wealth
            gini_coefficient_cumulative_wealth(time_period,2)=&
                gini_coefficient_cumulative_wealth(time_period,1)+&
                mass_of_pop_at_wealth_matrix_gini&
                (min_wealth_index_gini(1))*min_wealth_gini
                                                
            ! Sets the wealth of the previously found min level of wealth to a very large number
            wealth_matrix_gini&
                (min_wealth_index_gini)=&
                (financial_lower_bound-1)*&
                wage(time_period)
            
            ! Computes the total population counted so far
            gini_coefficient_total_population(time_period)=&
                gini_coefficient_total_population(time_period)+&
                mass_of_pop_at_wealth_matrix_gini&
                (min_wealth_index_gini(1))
            
            ! Computes the gini coefficeint numerator
            gini_coefficient_numerator(time_period)=&
                gini_coefficient_numerator(time_period)+&
                (mass_of_pop_at_wealth_matrix_gini&
                (min_wealth_index_gini(1))/&
                sum(distribution_stationary))*&
                (gini_coefficient_cumulative_wealth(time_period,2)+&
                gini_coefficient_cumulative_wealth(time_period,1))
                
            ! Moves the old point to the new point
            gini_coefficient_cumulative_wealth(time_period,1)=&
                gini_coefficient_cumulative_wealth(time_period,2)
            
            counter=counter+1
                             
        end do
        
        ! Computes the gini coefficient
        gini_coefficient(time_period)=&
            1-(gini_coefficient_numerator(time_period)/&
            gini_coefficient_cumulative_wealth(time_period,2))
        
        write(*,*) "gini_coefficient(", time_period,")=", gini_coefficient(time_period)
        
    end subroutine
        
    ! This subroutine calculate housing costs
    subroutine calculate_household_housing_spending(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index,pay_mortgage_insurance_1
        integer :: time_period
        real(8) :: total_income
                
        mass_of_renters_at_housing_spending(time_period,:)=0
        mass_of_homeowners_at_housing_spending(time_period,:)=0
        
        ! Loops over all ages
        do age_index=1,life_span
        
            ! Finds the amount of financial for each productivity type
            do financial_index=1,financial_grid_size
            
                do employment_index=1,employment_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                
                            if (age_index>life_span-retirement_span) then
                        
                                total_income=&
                                    model_ss_benefits(employment_index)*&
                                    ((1-what_is_the_program_solving)*&
                                    model_average_labour_income(time_period)+&
                                    what_is_the_program_solving)
                                
                            else
                        
                                if ((have_unemployment==1) .AND. (employment_index==(employment_grid_size))) then
                                
                                    total_income=&
                                        unemploy_bene_frac_of_lowest_employ*&
                                        (what_is_the_program_solving*wage_calibrated+&
                                        (1-what_is_the_program_solving)*wage(time_period))*&
                                        employment_grid(employment_grid_size-1)
                                    
                                else
                        
                                    total_income=&
                                        wage(time_period)*employment_grid(employment_index)*&
                                        labour_deterministic_efficiency(age_index)
                                    
                                end if
                        
                            end if
                                                    
                            total_income=&
                                total_income+&
                                policy_function_business_income&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)+&
                                policy_function_investment_income&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)+&
                                policy_function_rental_income_tax_paid&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)/&
                                rental_income_tax
                                            
                            ! The household is a renter
                            if (policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)==0) then
                                
                                fraction_of_income_spent_on_housing=&
                                    (rent(time_period)*&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))
                                                                                                                                                                                                       
                            ! Household is a homeowner
                            else
                    
                                if (policy_function_mortgage&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)>=0) then
                            
                                    if (mortgage_grid&
                                        (policy_function_mortgage&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))>0.81) then
                                                                    
                                        if (policy_function_use_alternative_lenders&
                                            ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                            (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                            (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                            (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                            (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                            (1-use_alternative_lenders)+use_alternative_lenders*productivity_index)==0) then
                                
                                            pay_mortgage_insurance_1=1
                                            
                                            else
                                        
                                            pay_mortgage_insurance_1=0
                                            
                                        end if
                                    
                                    else
                            
                                        pay_mortgage_insurance_1=0
                                    
                                    end if
                                                        
                                    ! The costs of housing are the housing depreciation, property taxes and 
                                    ! the mortgage interest payments
                                    fraction_of_income_spent_on_housing=&
                                        ((property_tax(min(time_period+&
                                        property_tax_is_paid_on_current_period_tax*solve_transition_dynamics*1,&
                                        transition_length))+&
                                        include_housing_depreciation_in_housing_costs*housing_depreciation+&
                                        (mortgage_interest_rate(time_period)+&
                                        (1-policy_function_use_alternative_lenders&
                                        ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_index))*&
                                        pay_mortgage_insurance_1*&
                                        mortgage_insurance_premium+&
                                        policy_function_use_alternative_lenders&
                                        ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_index)*&
                                        premium_with_alternative_lenders+&
                                        fraction_of_mortgage_payment_going_to_principal)*&
                                        mortgage_grid&
                                        (policy_function_mortgage&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)))*&
                                        (policy_function_space_lived_in_size&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)*&
                                        housing_price(time_period)))
                                                                                                                        
                                end if
                                                                                                                                                            
                            end if
                                                
                            fraction_of_income_spent_on_housing=&
                                fraction_of_income_spent_on_housing/&
                                total_income
                                        
                            frac_of_inc_spent_on_hous_threshold(time_period,1)=0.3*rent_fraction_of_housing_costs
                            frac_of_inc_spent_on_hous_threshold(time_period,2)=0.5*rent_fraction_of_housing_costs
                            frac_of_inc_spent_on_hous_threshold(time_period,3)=0.75*rent_fraction_of_housing_costs
                            frac_of_inc_spent_on_hous_threshold(time_period,4)=1 !*rent_fraction_of_housing_costs
                                
                            if (policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)==0) then
                                        
                                do i=1,number_of_thresholds
                                        
                                    ! Calculates if the households spend more than 25% of their income on housing
                                    if (fraction_of_income_spent_on_housing>&
                                        frac_of_inc_spent_on_hous_threshold(time_period,i)) then
                                                    
                                        ! Computes the mass of households at each wealth level
                                        mass_of_renters_at_housing_spending(time_period,i)=&
                                            mass_of_renters_at_housing_spending(time_period,i)+&
                                            distribution_stationary&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                                
                                    end if
                                                    
                                end do
                                         
                            ! Spending for homeowners
                            else
                                                                                                                            
                                do i=1,number_of_thresholds    
                                            
                                    ! Calculates if the households spend more than 25% of their income on housing
                                    if (fraction_of_income_spent_on_housing>&
                                        frac_of_inc_spent_on_hous_threshold(time_period,i)) then
                                                    
                                        ! Computes the mass of households at each wealth level
                                        mass_of_homeowners_at_housing_spending(time_period,i)=&
                                            mass_of_homeowners_at_housing_spending(time_period,i)+&
                                            distribution_stationary&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                                    
                                    end if
                                            
                                end do                                                    
                                                                                              
                            end if
                            
                        end do
                        
                    end do
                                    
                end do
        
            end do
            
        end do
        
        if (solve_transition_dynamics==1) then
        
            ! Saves the simulation number
            open(unit=1,file="percentage_spending_on_housing"//trim(file_number)//".txt",action="write",status="replace")
                
        else
        
            ! Saves the simulation number
            open(unit=1,file="percentage_spending_on_housing"//trim(file_number)//".txt",action="write",status="replace")
        
        end if
        
        do i=1,number_of_thresholds
        
            mass_of_renters_at_housing_spending(time_period,i)=&
                mass_of_renters_at_housing_spending(time_period,i)/&
                mass_of_renters(time_period)
            mass_of_homeowners_at_housing_spending(time_period,i)=&
                mass_of_homeowners_at_housing_spending(time_period,i)/&
                mass_of_owners_with_mortgage(time_period)
                
            if (solve_transition_dynamics==0) then
            
                if (i<3) then
                                
                    write(*,*) "percentage of renters spending more than ", &
                        frac_of_inc_spent_on_hous_threshold(time_period,i)," on their income on housing=",&
                        mass_of_renters_at_housing_spending(time_period,i)
                        
                    if (wealth_tax_system_type<6) then
                        
                        write(*,*) "percentag of homeowners with a mortgage spending more than ", &
                            frac_of_inc_spent_on_hous_threshold(time_period,i)," on their income on housing=",&
                            mass_of_homeowners_at_housing_spending(time_period,i)
                            
                    end if
                        
                end if
                    
            end if
                                
            write(1,*) "percentage of renters spending more than ", &
                frac_of_inc_spent_on_hous_threshold(time_period,i)," on their income on housing=",&
                mass_of_renters_at_housing_spending(time_period,i)
            write(1,*) "percentage of homeowners with a mortgage spending more than ", &
                frac_of_inc_spent_on_hous_threshold(time_period,i)," on their income on housing=",&
                mass_of_homeowners_at_housing_spending(time_period,i)
                
        end do
        
        close(1)
                
    end subroutine
           
    ! This subroutine calculates the average welfare of the youngest cohort and of all cohorts separately
    subroutine calculate_welfare(time_period)
    
        use Wealth_Tax_Global_Vars
    
        implicit none
        
        integer :: financial_index
        integer :: time_period
        
        ! Inititates welfare 
        average_welfare_of_all_cohorts(time_period)=0
        average_welfare_of_youngest_cohort(time_period)=0
        
        do age_index=1,life_span
                                
            ! Loops over all employment statuses
            do employment_index=1,employment_grid_size
            
                do financial_index=1,financial_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                    
                            average_welfare_of_all_cohorts(time_period)=&
                                average_welfare_of_all_cohorts(time_period)+&
                                (value_function&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*& ! Value function
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)) ! Mass
                                            
                            if (age_index==1) then
                            
                                if ((time_period==2) .AND. &
                                    (value_function&
                                    (time_period,1,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)==large_negative_num)) then
                            
                                    write(*,*) "value_function=", &
                                        value_function&
                                        (time_period,1,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                    write(*,*) "financial_index=", &
                                        financial_index
                                    write(*,*) "employment_index=", &
                                        employment_index
                                    
                                end if
                        
                                ! Computes the average welfare of the youngest cohort
                                average_welfare_of_youngest_cohort(time_period)=&
                                    average_welfare_of_youngest_cohort(time_period)+&
                                    (value_function&
                                    (time_period,1,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*& ! Value function
                                    distribution_stationary&
                                    (time_period,1,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)) ! Mass
                                
                            end if
                            
                        end do
            
                    end do
            
                end do
            
            end do
            
        end do
        
        average_welfare_of_all_cohorts(time_period)=&
            average_welfare_of_all_cohorts(time_period)/&
            sum(distribution_stationary(time_period,:,:,:,:,:))
        
        ! Obtains the average utility of the youngest cohort
        average_welfare_of_youngest_cohort(time_period)=&
            average_welfare_of_youngest_cohort(time_period)/&
            sum(distribution_stationary(time_period,1,:,:,:,:))
            
        if (solve_transition_dynamics==0) then
        
            write(*,*) "average_welfare_of_youngest_cohort=", average_welfare_of_youngest_cohort(time_period)
            write(*,*) "average_welfare_of_all_cohorts=", average_welfare_of_all_cohorts(time_period)
            
        end if
        
    end subroutine
    
    ! This subroutine calculates the average welfare of the youngest cohort and of all cohorts separately
    subroutine calculate_welfare_by_characteristics(time_period)
    
        use Wealth_Tax_Global_Vars
    
        implicit none
        
        integer :: financial_index
        integer :: time_period
        
        ! Inititates welfare 
        welfare_by_age_and_productivity(time_period,:,:)=0
        mass_by_age_and_productivity(time_period,:,:)=0
        
        do age_index=1,life_span
                        
            ! Loops over all employment statuses
            do employment_index=1,employment_grid_size
            
                do financial_index=1,financial_grid_size
                    
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                                                
                            ! Computes the average welfare of the youngest cohort
                            welfare_by_age_and_productivity&
                                (time_period,min(floor((real(age_index)-&
                                real(1))/real(10))+1,(life_span-1)/10),&
                                productivity_index)=&
                                welfare_by_age_and_productivity&
                                (time_period,min(floor((real(age_index)-&
                                real(1))/real(10))+1,(life_span-1)/10),&
                                productivity_index)+&
                                (value_function&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*& ! Value function
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)) ! Mass
                            
                            mass_by_age_and_productivity&
                                (time_period,min(floor((real(age_index)-&
                                real(1))/real(10))+1,(life_span-1)/10),&
                                productivity_index)=&
                                mass_by_age_and_productivity&
                                (time_period,min(floor((real(age_index)-&
                                real(1))/real(10))+1,(life_span-1)/10),&
                                productivity_index)+&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                            
                        end do
                        
                    end do
                        
                end do
                                    
            end do
            
        end do
        
        do age_index=1,((life_span-1)/10)
                    
            do productivity_index=1,productivity_grid_size
    
                welfare_by_age_and_productivity&
                    (time_period,age_index,&
                    productivity_index)=&
                    welfare_by_age_and_productivity&
                    (time_period,age_index,&
                    productivity_index)/&
                    mass_by_age_and_productivity&
                    (time_period,age_index,&
                    productivity_index)
            
            end do
                
        end do
            
        welfare_by_employment_and_productivity(time_period,:,:)=0
        mass_by_employment_and_productivity(time_period,:,:)=0
        
        welfare_by_ownership_status(time_period,:,:)=0
        model_wealth_by_ownership_and_employment(time_period,:,:)=0
        mass_by_ownership_status(time_period,:,:)=0
        
        do age_index=1,life_span
                    
            ! Loops over all employment statuses
            do employment_index=1,employment_grid_size
            
                do financial_index=1,financial_grid_size
                    
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                            
                            ! Computes the average welfare of the youngest cohort
                            welfare_by_employment_and_productivity&
                                (time_period,employment_index,productivity_index)=&
                                welfare_by_employment_and_productivity&
                                (time_period,employment_index,productivity_index)+&
                                (value_function&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*& ! Value function
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)) ! Mass
                            
                            mass_by_employment_and_productivity&
                                (time_period,employment_index,productivity_index)=&
                                mass_by_employment_and_productivity&
                                (time_period,employment_index,productivity_index)+&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                        
                            if (age_index==1) then
                            
                                if ((abs(housing_size(policy_function_housing_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))-&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,financial_index,employment_index,&
                                    productivity_shock_index,productivity_index))<10.d0**(-3)) .OR. &
                                    (policy_function_ownership_status&
                                    (time_period,age_index,financial_index,employment_index,&
                                    productivity_shock_index,productivity_index)==0) .OR. & 
                                    (endogenous_rental_market==0)) then
                                                                                                    
                                    welfare_by_ownership_status&
                                        (time_period,&
                                        policy_function_ownership_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index),&
                                        employment_index)=&
                                        welfare_by_ownership_status(time_period,&
                                        policy_function_ownership_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index),&
                                        employment_index)+&
                                        value_function&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)*&
                                        distribution_stationary&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)
                            
                                    model_wealth_by_ownership_and_employment&
                                        (time_period,&
                                        policy_function_ownership_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index),&
                                        employment_index)=&
                                        model_wealth_by_ownership_and_employment&
                                        (time_period,&
                                        policy_function_ownership_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index),&
                                        employment_index)+&
                                        financial_grid(financial_index)*&
                                        distribution_stationary&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)
                        
                                    mass_by_ownership_status&
                                        (time_period,&
                                        policy_function_ownership_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index),&
                                        employment_index)=&
                                        mass_by_ownership_status&
                                        (time_period,&
                                        policy_function_ownership_status&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,productivity_index),&
                                        employment_index)+&
                                        distribution_stationary&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,productivity_index)     
                                                    
                                else
                                
                                    if (endogenous_rental_market==0) then
                                
                                        write(*,*) "cannot be a landlord when the rental market is foreign owned"
                                        write(*,*) "housing_size(policy_function_housing_status)=", &
                                            housing_size(policy_function_housing_status&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index))
                                        write(*,*) "policy_function_space_lived_in_size=", &
                                            policy_function_space_lived_in_size&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                
                                    end if
                        
                                    welfare_by_ownership_status&
                                        (time_period,endogenous_rental_market*2,&
                                        employment_index)=&
                                        welfare_by_ownership_status&
                                        (time_period,endogenous_rental_market*2,&
                                        employment_index)+&
                                        value_function&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index) 
                                
                                    model_wealth_by_ownership_and_employment&
                                        (time_period,endogenous_rental_market*2,&
                                        employment_index)=&
                                        model_wealth_by_ownership_and_employment&
                                        (time_period,endogenous_rental_market*2,&
                                        employment_index)+&
                                        financial_grid(financial_index)*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                
                                    mass_by_ownership_status&
                                        (time_period,endogenous_rental_market*2,&
                                        employment_index)=&
                                        mass_by_ownership_status&
                                        (time_period,endogenous_rental_market*2,&
                                        employment_index)+&
                                        distribution_stationary&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,productivity_index)  
                                                                                                        
                                end if
                        
                            end if
                            
                        end do
                        
                    end do
                                        
                end do
                    
            end do
            
        end do
        
        do employment_index=1,employment_grid_size
        
            do productivity_index=1,productivity_grid_size
                
                welfare_by_employment_and_productivity&
                    (time_period,employment_index,productivity_index)=&
                    welfare_by_employment_and_productivity&
                    (time_period,employment_index,productivity_index)/&
                    mass_by_employment_and_productivity&
                    (time_period,employment_index,productivity_index)
                                            
            end do
                            
        end do
        
        do k=0,&
            endogenous_rental_market*2+&
            (1-endogenous_rental_market)*1
        
            do employment_index=1,employment_grid_size
                    
                welfare_by_ownership_status&
                    (time_period,k, employment_index)=&
                    welfare_by_ownership_status&
                    (time_period,k,employment_index)/&
                    mass_by_ownership_status&
                    (time_period,k,employment_index)
                
                model_wealth_by_ownership_and_employment&
                    (time_period,k,employment_index)=&
                    model_wealth_by_ownership_and_employment&
                    (time_period,k,employment_index)/&
                    mass_by_ownership_status&
                    (time_period,k,employment_index)
                                                        
            end do
        
        end do
        
    end subroutine
        
    subroutine calculate_homeownership_by_characteristics(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period
        integer :: financial_index
        
        homeownership_by_employment_and_productivity(time_period,:,:)=0
        housing_size_by_employment_and_productivity(time_period,:,:)=0
        mass_by_employment_and_productivity(time_period,:,:)=0
        homeownership_by_age_and_productivity(time_period,:,:)=0
        housing_size_by_age_and_productivity(time_period,:,:)=0
        mass_by_age_and_productivity(time_period,:,:)=0
        
        do age_index=1,life_span
                
            ! Loops over all employment statuses
            do employment_index=1,employment_grid_size
                
                do financial_index=1,financial_grid_size
                                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                        
                            ! Computes the average welfare of the youngest cohort
                            homeownership_by_employment_and_productivity&
                                (time_period,employment_index,productivity_index)=&
                                homeownership_by_employment_and_productivity&
                                (time_period,employment_index,productivity_index)+&
                                policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                            
                            ! Computes the house size by employment
                            housing_size_by_employment_and_productivity&
                                (time_period,employment_index,productivity_index)=& 
                                housing_size_by_employment_and_productivity&
                                (time_period,employment_index,productivity_index)+&
                                policy_function_space_lived_in_size&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                                                    
                            mass_by_employment_and_productivity&
                                (time_period,employment_index,productivity_index)=&
                                mass_by_employment_and_productivity&
                                (time_period,employment_index,productivity_index)+&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                        
                        end do
                        
                    end do
            
                end do
                                                    
            end do
                
        end do
                    
        do age_index=1,life_span
                
            ! Loops over all employment statuses
            do employment_index=1,employment_grid_size
                
                do financial_index=1,financial_grid_size
                                            
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size

                            homeownership_by_age_and_productivity&
                                (time_period,min(floor((real(age_index)-&
                                real(1))/real(10))+1,(life_span-1)/10),&
                                productivity_index)=&
                                homeownership_by_age_and_productivity&
                                (time_period,min(floor((real(age_index)-&
                                real(1))/real(10))+1,(life_span-1)/10),&
                                productivity_index)+&
                                policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                        
                            housing_size_by_age_and_productivity&
                                (time_period,min(floor((real(age_index)-&
                                real(1))/real(10))+1,(life_span-1)/10),&
                                productivity_index)=&
                                housing_size_by_age_and_productivity&
                                (time_period,min(floor((real(age_index)-&
                                real(1))/real(10))+1,(life_span-1)/10),&
                                productivity_index)+&
                                policy_function_space_lived_in_size&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                        
                            mass_by_age_and_productivity&
                                (time_period,min(floor((real(age_index)-&
                                real(1))/real(10))+1,(life_span-1)/10),&
                                productivity_index)=&
                                mass_by_age_and_productivity&
                                (time_period,min(floor((real(age_index)-&
                                real(1))/real(10))+1,(life_span-1)/10),&
                                productivity_index)+&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                            
                        end do
                        
                    end do
                
                end do
                
            end do
            
        end do
        
        do employment_index=1,employment_grid_size 
                        
            do productivity_index=1,productivity_grid_size
            
                homeownership_by_employment_and_productivity&
                    (time_period,employment_index,productivity_index)=&
                    homeownership_by_employment_and_productivity&
                    (time_period,employment_index,productivity_index)/&
                    mass_by_employment_and_productivity&
                    (time_period,employment_index,&
                    productivity_index)
                
                housing_size_by_employment_and_productivity&
                    (time_period,employment_index,productivity_index)=&
                    housing_size_by_employment_and_productivity&
                    (time_period,employment_index,productivity_index)/&
                    mass_by_employment_and_productivity&
                    (time_period,employment_index,&
                    productivity_index)
                                            
            end do
            
        end do
        
        do age_index=1,((life_span-1)/10)
                    
            do productivity_index=1,productivity_grid_size
    
                homeownership_by_age_and_productivity&
                    (time_period,age_index,productivity_index)=&
                    homeownership_by_age_and_productivity&
                    (time_period,age_index,productivity_index)/&
                    mass_by_age_and_productivity&
                    (time_period,age_index,productivity_index)
              
                housing_size_by_age_and_productivity&
                    (time_period,age_index,productivity_index)=&
                    housing_size_by_age_and_productivity&
                    (time_period,age_index,productivity_index)/&
                    mass_by_age_and_productivity&
                    (time_period,age_index,productivity_index)
                
            end do
                    
        end do
    
    end subroutine
    
    subroutine compute_portfolio_by_productivity(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index
        integer :: time_period
        
        financial_by_productivity(time_period,:)=0
        financial_by_productivity_and_shock(time_period,:,:)=0
        fraction_of_population_by_productivity_and_shock(time_period,:,:)=0
        net_housing_wealth_by_productivity(time_period,:)=0
        mortgage_debt_by_productivity(time_period,:)=0
        housing_size_by_productivity(time_period,:)=0
        
        do age_index=1,life_span
                
            ! Loops over all employment statuses
            do employment_index=1,employment_grid_size
                
                do financial_index=1,financial_grid_size
                                            
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                    
                            ! Computes the actual financial held by productivity type productivity index
                            financial_by_productivity(time_period,productivity_index)=&
                                financial_by_productivity(time_period,productivity_index)+&
                                policy_function_working_wealth&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                                
                            financial_by_productivity_and_shock&
                                (time_period,productivity_shock_index,productivity_index)=&
                                financial_by_productivity_and_shock&
                                (time_period,productivity_shock_index,productivity_index)+&
                                policy_function_working_wealth&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                                
                            fraction_of_population_by_productivity_and_shock&
                                (time_period,productivity_shock_index,productivity_index)=&
                                fraction_of_population_by_productivity_and_shock&
                                (time_period,productivity_shock_index,productivity_index)+&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                                
                            ! Computes the actual financial held by productivity type productivity index
                            net_housing_wealth_by_productivity(time_period,productivity_index)=&
                                net_housing_wealth_by_productivity(time_period,productivity_index)+&
                                policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                (financial_grid(financial_index)-&
                                policy_function_working_wealth&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index))*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                            
                            if (endogenous_rental_market==1) then
                            
                                ! Computes the actual financial held by productivity type productivity index
                                mortgage_debt_by_productivity(time_period,productivity_index)=&
                                    mortgage_debt_by_productivity(time_period,productivity_index)+&
                                    (policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    housing_price(time_period)*&
                                    housing_size&
                                    (policy_function_housing_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))*&
                                    mortgage_grid&
                                    (policy_function_mortgage&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)))*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                            
                            else
                                
                                ! Computes the actual financial held by productivity type productivity index
                                mortgage_debt_by_productivity(time_period,productivity_index)=&
                                    mortgage_debt_by_productivity(time_period,productivity_index)+&
                                    (policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    housing_price(time_period)*&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    mortgage_grid&
                                    (policy_function_mortgage&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)))*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                    
                            end if
                                
                            housing_size_by_productivity(time_period,productivity_index)=&
                                housing_size_by_productivity(time_period,productivity_index)+&
                                (1-shut_down_housing_market)*&
                                policy_function_space_lived_in_size&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)
                          
                        end do
                        
                    end do
                    
                end do
                
            end do
            
        end do
        
        do productivity_index=1,productivity_grid_size
        
            financial_by_productivity(time_period,productivity_index)=&
                financial_by_productivity(time_period,productivity_index)/&
                sum(distribution_stationary(time_period,:,:,:,:,productivity_index))
                
            net_housing_wealth_by_productivity(time_period,productivity_index)=&
                net_housing_wealth_by_productivity(time_period,productivity_index)/&
                sum(distribution_stationary(time_period,:,:,:,:,productivity_index))
                
            mortgage_debt_by_productivity(time_period,productivity_index)=&
                mortgage_debt_by_productivity(time_period,productivity_index)/&
                sum(distribution_stationary(time_period,:,:,:,:,productivity_index))
                
            housing_size_by_productivity(time_period,productivity_index)=&
                housing_size_by_productivity(time_period,productivity_index)/&
                sum(distribution_stationary(time_period,:,:,:,:,productivity_index))
                
        end do
        
        do productivity_index=1,productivity_grid_size
        
            if (productivity_grid(productivity_index)<=1) then
                        
                can_have_best_productivity_shock=0
                
            else
            
                can_have_best_productivity_shock=1
            
            end if
        
            do productivity_shock_index=&
                have_fixed_productivity*2+&
                (1-have_fixed_productivity)*&
                (can_have_best_productivity_shock*1+&
                (1-can_have_best_productivity_shock)*&
                ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                (1-all_low_z_households_get_into_0_lane)*2)),&
                have_fixed_productivity*2+&
                (1-have_fixed_productivity)*&
                productivity_shock_grid_size
            
                financial_by_productivity_and_shock&
                    (time_period,productivity_shock_index,productivity_index)=&
                    financial_by_productivity_and_shock&
                    (time_period,productivity_shock_index,productivity_index)/&
                    sum(distribution_stationary&
                    (time_period,:,:,:,productivity_shock_index,productivity_index))
                    
                fraction_of_population_by_productivity_and_shock&
                    (time_period,productivity_shock_index,productivity_index)=&
                    fraction_of_population_by_productivity_and_shock&
                    (time_period,productivity_shock_index,productivity_index)/&
                    sum(distribution_stationary)
            
            end do
            
        end do
    
    end subroutine
    
    subroutine frac_of_households_in_support_of_policy(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index
        integer :: time_period
        real(8), dimension(life_span) :: discounting_bench
        real(8), dimension(life_span,transition_length) :: discounting_counter
        
        frac_in_support(time_period)=0
        frac_in_support_youngest(time_period)=0
        
        if (what_is_the_program_solving==1) then
        
            open(UNIT=9,file="value_function"//trim(benchmark_simulation)//".dat",action='read')
                read(9,'(F20.8)') value_function_benchmark(:,:,:,:,:)
            close(9)
            open(UNIT=10,file="distribution_stationary"//trim(benchmark_simulation)//".dat",action='read')
                read(10,'(F20.8)') distribution_stationary_benchmark(:,:,:,:,:)
            close(10)
            
        end if
        
        do j=1,life_span
        
            utility_from_public_consumption_bench(j)=0
            discounting_bench(j)=1
        
            do i=j,life_span
        
                utility_from_public_consumption_bench(j)=&
                    utility_from_public_consumption_bench(j)+&
                    chi*discounting_bench(j)*&
                    ((net_govt_revenue_constraint/&
                    sum(distribution_stationary(time_period,:,:,:,:,:)))**&
                    (1-risk_aversion))/(1-risk_aversion)
                    
                if (i<life_span) then
                    
                    discounting_bench(j)=&
                        discounting_bench(j)*&
                        discount_factor*&
                        survival_probability(i)
                        
                end if
                    
            end do
        
        end do
        
        utility_from_public_consumption_average_bench=0
        
        do j=1,life_span
        
            utility_from_public_consumption_average_bench=&
                utility_from_public_consumption_average_bench+&
                utility_from_public_consumption_bench(j)*&
                (sum(distribution_stationary(time_period,j,:,:,:,:))/&
                sum(distribution_stationary(time_period,:,:,:,:,:)))
        
        end do
                                    
        do j=1,life_span
        
            utility_from_public_consumption_counter(j,time_period)=0
            discounting_counter(j,time_period)=1
            
            do i=j,life_span
                
                utility_from_public_consumption_counter(j,time_period)=&
                    utility_from_public_consumption_counter(j,time_period)+&
                    chi*discounting_counter(j,time_period)*&
                    ((net_govt_revenues(min(time_period+&
                    solve_transition_dynamics*(i-j),transition_length))/&
                    sum(distribution_stationary(time_period,:,:,:,:,:)))**&
                    (1-risk_aversion))/&
                    (1-risk_aversion)
                    
                if (i<life_span) then
                        
                    discounting_counter(j,time_period)=&
                        discounting_counter(j,time_period)*&
                        discount_factor*&
                        survival_probability(i)
                        
                end if
                        
            end do        
        
        end do
        
        if ((what_is_the_program_solving==1) .AND. (solve_transition_dynamics==0)) then
        
            utility_from_public_consumption_average_counter=0
        
            do j=1,life_span
        
                utility_from_public_consumption_average_counter=&
                    utility_from_public_consumption_average_counter+&
                    utility_from_public_consumption_counter(j,time_period)*&
                    (sum(distribution_stationary(time_period,j,:,:,:,:))/&
                    sum(distribution_stationary(time_period,:,:,:,:,:)))
        
            end do
            
        end if
        
        distribution_homeowners=0
        
        if ((what_is_the_program_solving==1) .AND. (solve_transition_dynamics==1)) then
        
            if  (time_period==2) then
            
                ! Sets the initial distribution of homeowners
                call compute_initial_distribution_of_homeowners(time_period-1)
            
            end if
        
            ! Computes the future distribution of homeowners
            call compute_future_distribution_of_homeowners(time_period)
                
            call compute_future_value_function_homeowners(time_period)
                
            if (value_function_homeowners(1)>&
                value_function_homeowners&
                ((1-solve_transition_dynamics)+&
                solve_transition_dynamics*2)) then
                    
                frac_in_support(time_period)=&
                    frac_in_support(time_period)+&
                    sum(distribution_homeowners&
                    (1,time_period,:,:,:,:,:))   
                                
            end if
                            
        end if
                
        ! Loops over all ages
        do age_index=1,life_span
    
            do employment_index=1,employment_grid_size
            
                do financial_index=1,financial_grid_size
                
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
            
                            ! Checks if households prefer the new system relative to the old
                            if ((value_function&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)+&
                                utility_from_public_consumption_counter(age_index,time_period))>&
                                (value_function_benchmark&
                                (age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)+&
                                utility_from_public_consumption_bench(age_index))) then
                                    
                                if (age_index==1) then
                                        
                                    frac_in_support_youngest(time_period)=&
                                        frac_in_support_youngest(time_period)+&
                                        (distribution_stationary_benchmark&
                                        (age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))
                                            
                                end if
                                            
                                frac_in_support(time_period)=&
                                    frac_in_support(time_period)+&
                                    distribution_stationary_benchmark&
                                    (age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)-&
                                    distribution_homeowners&
                                    ((1-solve_transition_dynamics)+solve_transition_dynamics*1,&
                                    (1-solve_transition_dynamics)+solve_transition_dynamics*time_period,&
                                    (1-solve_transition_dynamics)+solve_transition_dynamics*age_index,&
                                    (1-solve_transition_dynamics)+solve_transition_dynamics*financial_index,&
                                    (1-solve_transition_dynamics)+solve_transition_dynamics*employment_index,&
                                    (1-solve_transition_dynamics)+solve_transition_dynamics*productivity_shock_index,&
                                    (1-solve_transition_dynamics)+solve_transition_dynamics*productivity_index)
                                                                
                            end if
                            
                        end do
                        
                    end do
                        
                end do
                    
            end do
            
        end do
                        
        frac_in_support(time_period)=&
            frac_in_support(time_period)/sum(distribution_stationary_benchmark)
        frac_in_support_youngest(time_period)=&
            frac_in_support_youngest(time_period)/sum(distribution_stationary_benchmark(1,:,:,:,:))
            
        if (solve_transition_dynamics==0) then
        
            write(*,*) "frac_in_support(",time_period,")=", frac_in_support(time_period)
            write(*,*) "frac_in_support_youngest(",time_period,")=", frac_in_support_youngest(time_period)
!            write(*,*) "utility_from_public_consumption_bench(1)=", &
!                utility_from_public_consumption_bench(1)
!            write(*,*) "utility_from_public_consumption_counter(1,time_period)=", &
!                utility_from_public_consumption_counter(1,time_period)
!            write(*,*) "utility_from_public_consumption_average_bench=", &
!                utility_from_public_consumption_average_bench
!            write(*,*) "utility_from_public_consumption_average_counter=", &
!                utility_from_public_consumption_average_counter
            
        end if
        
        if ((solve_transition_dynamics==1) .AND. (time_period>=(transition_length-1))) then
        
            ! Saves the simulation number
            open(unit=1,file="welfare_from_public_goods_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(1,'(F15.8)') utility_from_public_consumption_counter(1,:)
            close(1)
            
            ! Saves the simulation number
            open(unit=1,file="welfare_from_public_goods_in_bench"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(1,'(F15.8)') utility_from_public_consumption_bench(1)
            close(1)
            
            ! Saves the simulation number
            open(unit=1,file="sum_distribution_stationary"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(1,'(F15.8)') sum(distribution_stationary&
                ((1-solve_transition_dynamics)*1+solve_transition_dynamics*2,:,:,:,:,:))
            close(1)
        
        end if
    
    end subroutine
    
    subroutine solve_risk_free_rate(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period
        integer :: financial_index
        integer :: count_1
        integer :: count_2
        real(8) :: distance_from_previous
        
        if (exogenous_interest_rate==0) then
        
            ! sets the guess to equal to risk free rate
            risk_free_rate_guess=risk_free_rate(time_period)
        
            write(*,*) "risk_free_rate=", risk_free_rate(time_period)
        
            aggregate_borrowing_or_lending=1
            aggregate_borrowing_or_lending_previous=1
            
            count_1=0
            count_2=0
        
            do while ((abs(aggregate_borrowing_or_lending)>stopping_rule_borrowing_lending) .AND. &
                (risk_free_rate(time_period)>(-financial_wealth_depreciation+0.005)) .AND. &
                (risk_free_rate(time_period)<0.2))
        
                aggregate_borrowing_or_lending=0
                        
                do age_index=1,life_span
        
                    do financial_index=1,financial_grid_size
                                            
                        do employment_index=1,employment_grid_size
                    
                            ! Loops over all productivities
                            do productivity_index=1,productivity_grid_size
                            
                                if (productivity_grid(productivity_index)<=1) then
                                
                                    can_have_best_productivity_shock=0
                                    
                                else
                                
                                    can_have_best_productivity_shock=1
                                
                                end if
                            
                                do productivity_shock_index=&
                                    have_fixed_productivity*2+&
                                    (1-have_fixed_productivity)*&
                                    (can_have_best_productivity_shock*1+&
                                    (1-can_have_best_productivity_shock)*&
                                    ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                                    (1-all_low_z_households_get_into_0_lane)*2)),&
                                    have_fixed_productivity*2+&
                                    (1-have_fixed_productivity)*&
                                    productivity_shock_grid_size
                                                            
                                    ! Calls a subroutine that calculate after tax wealth
                                    call calculate_capital_income_minus_wealth_tax&
                                        (financial_index,policy_function_mortgage&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index),&
                                        policy_function_ownership_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index),&
                                        policy_function_housing_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index),time_period)
                                                            
                                    ! Calculate the total borrowing and lending in the economy
                                    aggregate_borrowing_or_lending=&
                                        aggregate_borrowing_or_lending+&
                                        optimal_borrow_or_lend*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                                                            
                                end do
                
                            end do
                                    
                        end do
                            
                    end do
            
                end do
                
                if (share_of_corporate_profits>0) then
                
                    corporate_capital_new=&
                        ((share_of_corporate_profits*&
                        (aggregation_of_tot_intermdte_gds(time_period)**(share_of_capital)*&
                        (model_total_efficiency_units(time_period)**(share_of_labour))))/&
                        (risk_free_rate(time_period)+financial_wealth_depreciation))**&
                        (1/(share_of_capital+share_of_labour))
                        
                else
                
                    corporate_capital_new=0
                
                end if
                    
!                write(*,*) "corporate_capital_new=", corporate_capital_new
        
                aggregate_borrowing_or_lending=&
                    aggregate_borrowing_or_lending+&
                    corporate_capital_new
                    
                if (abs(aggregate_borrowing_or_lending)>0.5) then
                
                    aggregate_borrowing_or_lending_adjuster=0.00005
                
                else
            
                    aggregate_borrowing_or_lending_adjuster=0.00005
                    
                end if
                    
                ! Checks if this is the 3rd iterations
                if (count_1>1) then
                    
                    ! Checks if there is occilation
                    if (((aggregate_borrowing_or_lending>0) .AND. &
                        (aggregate_borrowing_or_lending_previous<0)) .OR. &
                        ((aggregate_borrowing_or_lending<0) .AND. &
                        (aggregate_borrowing_or_lending_previous>0))) then
                        
                        count_2=count_2+1
                    
                        ! Makes the updating rule tighter
                        if (abs(aggregate_borrowing_or_lending)<0.5) then
                
                            aggregate_borrowing_or_lending_adjuster=0.000000005
                    
                        end if
                                            
                    end if
                    
                end if
                
                distance_from_previous=&
                    abs(aggregate_borrowing_or_lending_previous-&
                    aggregate_borrowing_or_lending)
                                        
                aggregate_borrowing_or_lending_previous=&
                    aggregate_borrowing_or_lending
                    
                if (what_is_the_program_solving==1) then
                                                
                    ! Too much borrowing, so increase the interest rate            
                    risk_free_rate(time_period)=&
                        risk_free_rate(time_period)+&
                        aggregate_borrowing_or_lending_adjuster*aggregate_borrowing_or_lending
                                
                    ! Shows the updated borrowing and lending
                    write(*,*) "aggregate_borrowing_or_lending=", aggregate_borrowing_or_lending
                    write(*,*) "risk_free_rate updated=", risk_free_rate(time_period)
                                
                else
                
                    ! Too much borrowing, so increase the interest rate            
                    financial_wealth_depreciation=&
                        financial_wealth_depreciation+&
                        aggregate_borrowing_or_lending_adjuster*aggregate_borrowing_or_lending
                         
                    ! Shows the updated borrowing and lending
                    write(*,*) "aggregate_borrowing_or_lending=", aggregate_borrowing_or_lending
                    write(*,*) "financial_wealth_depreciation=", financial_wealth_depreciation
                        
                end if
                
                count_1=count_1+1
                                
                if (count_2>3) then
                
                    aggregate_borrowing_or_lending=0
                    
                end if
                
                if (distance_from_previous<10.d0**(-9)) then
                
                    aggregate_borrowing_or_lending=0
                
                end if
    
            end do
                    
            distance_risk_free_rate(time_period)=abs(risk_free_rate(time_period)-risk_free_rate_guess)        
                    
            risk_free_rate(time_period)=&
                weight_risk_free_update*risk_free_rate(time_period)+&
                (1-weight_risk_free_update)*risk_free_rate_guess
                
            ! Shows the updated borrowing and lending
            write(*,*) "aggregate_borrowing_or_lending=", aggregate_borrowing_or_lending
            write(*,*) "risk_free_rate updated=", risk_free_rate(time_period)
            write(*,*) "financial_wealth_depreciation=", financial_wealth_depreciation
                                    
        else
        
            distance_risk_free_rate(time_period)=0
            
            write(*,*) "risk_free_rate=", risk_free_rate(time_period)
                    
        end if
        
        ! Sets the mortgage interest rate above the risk free rate by mortgage_interest_gap
        mortgage_interest_rate(time_period)=&
            risk_free_rate(time_period)+&
            mortgage_interest_gap
            
        write(*,*) "mortgage_interest_rate(time_period)=", mortgage_interest_rate(time_period)
    
    end subroutine
        
    ! This subroutine, for a given housing price and a given set of parameters
    ! solves the value function and policy functions
    subroutine solve_value_function_and_policy_functions(time_period,solving_transition)
    
        use Wealth_Tax_Global_Vars
        !$ use omp_lib
        
        implicit none
        
        integer :: financial_index
        integer :: time_period
        integer :: solving_transition
                
        if ((time_period==(transition_length-1)) .AND. (solving_transition==1)) then
               
            open(UNIT=1,file="value_function"//trim(long_run_simulation)//".dat",action='read')
                read(1,'(F20.8)') value_function(time_period+1,:,:,:,:,:)
            close(1)
            
            value_function_guess(:,:,:,:)=value_function(time_period+1,1,:,:,:,:)
                
        end if
                        
        ! Sets the value after death to 0
        value_function(time_period,:,:,:,:,:)=large_negative_num
                        
        ! Sets the value after death to 0
        value_function(time_period,life_span+1,:,:,:,:)=0
        
        ! Setes the policy functions for some possible values
        ! even for cases that do not happen
        ! 0 financial, 0 mortgage, renting and consuming 0.
        policy_function_financial(time_period,:,:,:,:,:)=1
        policy_function_mortgage(time_period,:,:,:,:,:)=1
        policy_function_housing_status(time_period,:,:,:,:,:)=0
        policy_function_consumption(time_period,:,:,:,:,:)=0
        policy_function_ownership_status(time_period,:,:,:,:,:)=0
        policy_function_use_alternative_lenders&
            ((1-use_alternative_lenders)+use_alternative_lenders*time_period,:,:,:,:,:)=0
        policy_function_space_lived_in_index(time_period,:,:,:,:,:)=0
        policy_function_space_lived_in_size(time_period,:,:,:,:,:)=0
        policy_function_rental_income_tax_paid(time_period,:,:,:,:,:)=0
        policy_function_mortgage_interest_deductions(time_period,:,:,:,:,:)=0
        policy_function_business_income(time_period,:,:,:,:,:)=0
        policy_function_business_income_tax_paid(time_period,:,:,:,:,:)=0
        policy_function_hidden_wealth(:)=0
        policy_function_investment_income(time_period,:,:,:,:,:)=0
        policy_function_investment_income_tax_paid(time_period,:,:,:,:,:)=0
        policy_function_borrow_or_lend(time_period,:,:,:,:,:)=0
        policy_function_working_wealth(time_period,:,:,:,:,:)=0
        
        frac_mov_optimal_1(time_period,:,:,:,:,:)=0
        
        fin_index_frac_mov_to_optimal(time_period,:,:,:,:,:)=1
        
        negative_consumption=0
        
        ! Starts the time counter
        call cpu_time(value_function_iteration_start_time)
        
        if (solving_transition>=0) then
        
            !$omp parallel
            !$omp master
            !$ write(*,*) "number of threads = ", omp_get_num_threads()
            !$omp end master
            !$omp end parallel
            
        end if
                       
        ! Starts by looping over all possible ages
        do age_index=life_span,1,-1
        
            ! Checks if the household is in retirement
            if (age_index>(life_span-retirement_span)) then
                
                in_retirement=1
            
            ! The household is not in retirement
            else
            
                in_retirement=0 
            
            end if
            
            ! Checks if the household is one period before retirement
            if (age_index>=(life_span-retirement_span)) then
                
                at_least_one_period_before_retirement=1
            
            ! The household is at least one period before retirement
            else
                
                at_least_one_period_before_retirement=0
            
            end if
            
            !$omp parallel do default(none) &
            !$omp& shared(& 
            !$omp& frac_mov_optimal_1,fin_index_frac_mov_to_optimal,&
            !$omp& policy_function_consumption,policy_function_use_alternative_lenders,&
            !$omp& policy_function_space_lived_in_size,policy_function_space_lived_in_index,&
            !$omp& policy_function_rental_income_tax_paid,policy_function_ownership_status,&
            !$omp& policy_function_financial,policy_function_mortgage,policy_function_housing_status,&
            !$omp& policy_function_mortgage_interest_deductions,policy_function_business_income,&
            !$omp& policy_function_business_income_tax_paid,policy_function_investment_income_tax_paid,&
            !$omp& policy_function_investment_income,policy_function_hidden_wealth,&
            !$omp& policy_function_borrow_or_lend,policy_function_working_wealth,&
            !$omp& model_average_rental_unit_size,sd_epsilon_log_productivity,wage,&
            !$omp& rent,negative_consumption,model_gdp_per_household,size_of_smallest_house_hhld_can_buy,&
            !$omp& model_average_labour_income,future_financial_grid_vector,housing_status_utility_function,&
            !$omp& net_govt_revenues,risk_aversion_share_of_cons,survival_probability,discount_factor,&
            !$omp& unconditional_employment_probability,value_function_guess,value_function,employment_process,&
            !$omp& large_negative_num,fraction_of_mortgage_payment_going_to_principal,&
            !$omp& corporate_capital,labour_deterministic_efficiency,model_ss_benefits,housing_size,age_index,in_retirement,&
            !$omp& housing_price,mortgage_grid,mortgage_insurance_premium,mortgage_interest_rate,property_tax,&
            !$omp& financial_grid,consumption_tax,rental_income_tax,investment_income_tax,&
            !$omp& construction_company_profits_per_household,risk_free_rate,time_period,solving_transition,&
            !$omp& model_financial_per_household,employment_grid,stress_test,at_least_one_period_before_retirement,&
            !$omp& index_of_smallest_house_hhld_can_buy,probability_of_bad_shock_continuing,disutility_of_landlords,&
            !$omp& productivity_process,business_income_tax,financial_tax,progressive_wealth_tax,productivity_grid,&
            !$omp& max_debt_to_assets,multiple_max_debt_to_assets,aggregation_of_tot_intermdte_gds,&
            !$omp& aggregate_production_times_labour,productivity_shock_grid,productivity_shock_process,&
            !$omp& unconditional_productivity_shock_probability,probability_of_staying_in_fast_lane,&
            !$omp& weight_on_bequest,threshold_housing,threshold_financial,progressive_housing_tax,&
            !$omp& progressive_financial_tax,smallest_house_size,financial_wealth_depreciation)
                            
            ! Loops over all possible financial wealth positions
            do financial_index=1,financial_grid_size
                                                                                             
                ! Loops over all possible incomes
                do employment_index=1,employment_grid_size
                    
                    ! Loops over all productivities
                    do productivity_index=1,productivity_grid_size
                    
                        if (productivity_grid(productivity_index)<=1) then
                        
                            can_have_best_productivity_shock=0
                            
                        else
                        
                            can_have_best_productivity_shock=1
                        
                        end if
                    
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                        
                            total_household_wealth=&
                                financial_grid(financial_index)
                    
                            call compute_renters_problem&
                                (financial_index,time_period,solving_transition)
                                
                            if (shut_down_housing_market==0) then
                            
                                call compute_homeowners_problem&
                                    (financial_index,time_period,solving_transition)
                                    
                            else
                            
                                value_function_owner=&
                                    large_negative_num
                                    
                            end if
                                
                            call apply_policy_function&
                                (financial_index,time_period)
                        
                            if ((policy_function_use_alternative_lenders&
                                ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                (1-use_alternative_lenders)+use_alternative_lenders*productivity_index)==1) .AND. &
                                (use_alternative_lenders==0)) then
                            
                                write(*,*) "error alternative_lenders"
                            
                            end if
                        
                            if (do_internal_computations==1) then
                            
                                if ((abs(policy_function_space_lived_in_index&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)-&
                                    policy_function_housing_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))>10.d0**(-9)) .AND. &
                                    (endogenous_rental_market==0)) then
                                
                                    write(*,*) "error there are local landlords"
                                    
                                end if
                                                                                                                
                                call internal_computations&
                                    (value_function&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index),&
                                    policy_function_financial&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index),&
                                    policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index),&
                                    policy_function_space_lived_in_index&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index),&
                                    policy_function_housing_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index),&
                                    policy_function_mortgage&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index),&
                                    policy_function_rental_income_tax_paid&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index),&
                                    policy_function_use_alternative_lenders&
                                    ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                    (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                    (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                    (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                    (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                    (1-use_alternative_lenders)+use_alternative_lenders*productivity_index),&
                                    policy_function_mortgage_interest_deductions&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index),&
                                    financial_index,time_period,&
                                    optimal_after_tax_wealth_net_of_expenses,&
                                    solving_transition)
                                        
                                value_function&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)=&
                                    val_fun_internal
                                    
                            end if
                        
                            if (((policy_function_consumption&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)<=0) .OR. &
                                (value_function&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)==&
                                large_negative_num)) .AND. &
                                (policy_function_space_lived_in_size&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)>smallest_house_size)) then
                                
                                write(*,*) "error in consumption"
                                
                            end if
                                    
                            call check_budget_constraint_clears(time_period,&
                                optimal_after_tax_wealth_net_of_expenses,financial_index)
                                
                            if (policy_function_rental_income_tax_paid&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)>0) then
                                
                                write(*,*) "error rental tax paid"
                                
                            end if
                                
                        end do
                            
                    end do
                                                                                                                                                    
                end do
                
            end do
                
            !$omp end parallel do
            
        end do
        
        if (solving_transition==0) then
                
            loop_count=loop_count+1
            
        end if
        
        ! Stops the time counter 
        call cpu_time(value_function_iteration_stop_time)
        
        !write(*,*) "value function iteration finished loop number", loop_count
        write(*,*) "time=", value_function_iteration_stop_time-value_function_iteration_start_time
        
        if ((solving_transition==1) .AND. (what_is_the_program_solving==1)) then
        
            write(*,*) "time_period=", time_period
            
        end if
    
    end subroutine
    
    subroutine compute_renters_problem(financial_index,time_period,solving_transition)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index,time_period,solving_transition
        
        largest_value=large_negative_num
                            
        ! Financial index
        optimal_renter_indeces(1)=1
                        
        ! Mortgage index
        optimal_renter_indeces(2)=1
                        
        ! Housing size index
        optimal_renter_indeces(3)=0
                    
        optimal_ownership_status_index_renter=0
        optimal_gross_wage_income_renter=0
        optimal_wage_income_tax_paid_renter=0
        optimal_after_tax_wealth_net_of_expenses_renter=0
        optimal_consumption_renter=0 
        optimal_use_alternative_lenders_renter=0
        optimal_space_lived_in_renter=0
        optimal_rental_income_tax_paid_renter=0
        optimal_mortgage_deductions_renter=0
        optimal_business_income_renter=0
        optimal_business_income_tax_paid_renter=0
        optimal_investment_income_renter=0
        optimal_investment_income_tax_paid_renter=0
        optimal_hidden_wealth_renter=0
        optimal_borrow_or_lend_renter=0
            
        ownership=0       
        
        ! loops over all the rental options
        future_housing_status_loop_1: do &
            future_housing_status_index=&
            0,shut_down_housing_market*0+&
            (1-shut_down_housing_market)*&
            largest_house_size_hhld_can_rent
            
            call calculate_capital_income_minus_wealth_tax&
                (financial_index,optimal_renter_indeces(2),ownership,&
                future_housing_status_index,time_period)
    
            call calculate_after_tax_wealth&
                (optimal_renter_indeces(2),future_housing_status_index,&
                future_housing_status_index,ownership,&
                time_period,solving_transition,ownership)
                                
            if (after_tax_wealth_net_of_expenses==0) then
                            
                write(*,*) "error"
                            
            end if
                                                                                                                                                                
            consumption_vector=&
                (after_tax_wealth_net_of_expenses-&
                future_financial_grid_vector)/&
                (1+consumption_tax)
                                                                                
            ! Finds the largest feasible fututre financial possible
            largest_possible_financial_index=&
                minloc(consumption_vector,&
                1,mask=consumption_vector>0)
                                                                                                        
            ! Checks if there are any feasible consumption options
            if (largest_possible_financial_index>0) then
                                                                                                                                        
                ! Obtains the utility flow from re*nting
                flow_utility_vector&
                    (1:largest_possible_financial_index)=&
                    ((housing_status_utility_function&
                    (future_housing_status_index,0)*&
                    (consumption_vector&
                    (1:largest_possible_financial_index))**&
                    (risk_aversion_share_of_cons))/&
                    (1-risk_aversion))
                                                                                        
                future_utility_vector(1:largest_possible_financial_index)=0
                                                    
                ! Checks if the household cares about their child
                if (add_utility_from_child==1)  then
                                
                    ! It is the probability of surviving to the next period
                    ! times the value from the chocice of financial in each state of the world
                    ! plus the probability of not surviving times the warm glow utility
                    future_utility_vector&
                        (1:largest_possible_financial_index)=&
                        future_utility_vector&
                        (1:largest_possible_financial_index)+&
                        (1-survival_probability(age_index))*&
                        weight_on_bequest*&
                        (financial_grid&
                        (1:largest_possible_financial_index)**&
                        (1-bequest_risk_aversion))/&
                        (1-bequest_risk_aversion)
                                    
                end if
                                                                                               
                ! Loops over all the possible future income states
                ! When a household is before retirement they can only move into
                ! one employment state, so I take that into account
                do future_employment_index=&
                    at_least_one_period_before_retirement*employment_index+&
                    (1-at_least_one_period_before_retirement)*&
                    max(employment_index-1,1),&
                    at_least_one_period_before_retirement*employment_index+&
                    (1-at_least_one_period_before_retirement)*&
                    min(employment_index+1,employment_grid_size)
                    
                    do future_productivity_shock_index=&
                        have_fixed_productivity*2+&
                        (1-have_fixed_productivity)*&
                        productivity_shock_index,&
                        have_fixed_productivity*2+&
                        (1-have_fixed_productivity)*&
                        productivity_shock_grid_size
                                                                        
                        future_utility_vector&
                            (1:largest_possible_financial_index)=&
                            future_utility_vector&
                            (1:largest_possible_financial_index)+&
                            discount_factor*&
                            survival_probability(age_index)*&
                            productivity_shock_process&
                            (productivity_shock_index,future_productivity_shock_index)*&
                            (probability_of_bad_shock_continuing(time_period)*&
                            employment_process(1+solving_transition,age_index,&
                            employment_index,future_employment_index)+&
                            (1-probability_of_bad_shock_continuing(time_period))*&
                            employment_process(1,age_index,&
                            employment_index,future_employment_index))*&
                            value_function&
                            (min(time_period+solving_transition*1,&
                            transition_length),age_index+1,&
                            1:largest_possible_financial_index,&
                            future_employment_index,&
                            future_productivity_shock_index,&
                            productivity_index)
                            
                    end do
                                                
                end do
                            
                ! If there is unemployment, and the household is not close to retirement
                ! and the household does not have a low income state
                if ((have_unemployment==1) .AND. &
                    (at_least_one_period_before_retirement==0) .AND. &
                    (employment_index<(employment_grid_size-1))) then
                                
                    ! Loops over all the possible future income states
                    ! When a household is before retirement they can only move into
                    ! one employment state, so I take that into account
                    do future_employment_index=employment_grid_size,employment_grid_size
                    
                        do future_productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_index,&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                                                                                                                
                            future_utility_vector&
                                (1:largest_possible_financial_index)=&
                                future_utility_vector&
                                (1:largest_possible_financial_index)+&
                                discount_factor*&
                                survival_probability(age_index)*&
                                productivity_shock_process&
                                (productivity_shock_index,future_productivity_shock_index)*&
                                (probability_of_bad_shock_continuing(time_period)*&
                                employment_process(1+solving_transition,age_index,&
                                employment_index,future_employment_index)+&
                                (1-probability_of_bad_shock_continuing(time_period))*&
                                employment_process(1,age_index,&
                                employment_index,future_employment_index))*&
                                value_function&
                                (min(time_period+solving_transition*1,&
                                transition_length),age_index+1,&
                                1:largest_possible_financial_index,&
                                future_employment_index,&
                                future_productivity_shock_index,&
                                productivity_index)
                                
                        end do
                                                                                
                    end do
                                
                end if
                                                                                                                                                    
                ! Finds the value function
                value_function_renter=&
                    maxval(flow_utility_vector&
                    (1:largest_possible_financial_index)+&
                    future_utility_vector&
                    (1:largest_possible_financial_index))
                                                                                                                                
                ! Checks if the new choice is better the old
                ! one
                if (value_function_renter>=largest_value) then
                                                                                    
                    ! Saves the largest value and indeces
                    largest_value=&
                        value_function_renter
                                    
                    ! Finds financial policy function
                    optimal_renter_financial=&
                        maxloc(flow_utility_vector&
                        (1:largest_possible_financial_index)+&
                        future_utility_vector&
                        (1:largest_possible_financial_index),1)
                                        
                    optimal_renter_indeces(1)=optimal_renter_financial
                    optimal_renter_indeces(2)=1
                    optimal_renter_indeces(3)=future_housing_status_index
                    optimal_ownership_status_index_renter=0
                                    
                    optimal_consumption_renter=consumption_vector(optimal_renter_indeces(1))  
                    optimal_after_tax_wealth_net_of_expenses_renter=after_tax_wealth_net_of_expenses
                    optimal_gross_wage_income_renter=optimal_gross_wage_income
                    optimal_wage_income_tax_paid_renter=optimal_wage_income_tax_paid
                    optimal_space_lived_in_renter=optimal_space_lived_in
                    optimal_rental_income_tax_paid_renter=optimal_rental_income_tax_paid
                    optimal_mortgage_deductions_renter=optimal_mortgage_deductions_tax_rebates
                                    
                    optimal_business_income_renter=optimal_business_income
                    optimal_business_income_tax_paid_renter=optimal_business_income_tax_paid
                    optimal_hidden_wealth_renter=optimal_hidden_wealth
                    optimal_investment_income_renter=optimal_investment_income
                    optimal_investment_income_tax_paid_renter=optimal_investment_income_tax_paid
                    optimal_borrow_or_lend_renter=optimal_borrow_or_lend
                    optimal_total_household_working_wealth_renter=total_household_working_wealth
                                                                                                                                                                    
                end if
                                
            ! Cannot afford the any larger house
            else
                                
                exit future_housing_status_loop_1
                                                                                                                                                                                                                                               
            end if
                                    
        end do future_housing_status_loop_1
                                        
        ! Sets the highest values attained by a household
        ! who is a renter
        value_function_renter=largest_value

        largest_value=large_negative_num
    
    end subroutine
    
    subroutine compute_homeowners_problem(financial_index,time_period,solving_transition)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index,time_period,solving_transition
        
        optimal_owner_indeces(1)=1
        optimal_owner_indeces(2)=1
        optimal_owner_indeces(3)=index_of_smallest_house_hhld_can_buy
        optimal_ownership_status_index_owner=0
                                            
        optimal_gross_wage_income_owner=0
        optimal_wage_income_tax_paid_owner=0
        optimal_after_tax_wealth_net_of_expenses_owner=0
        optimal_use_alternative_lenders_owner=0
        optimal_space_lived_in_owner=0
        optimal_rental_income_tax_paid_owner=0
        optimal_mortgage_deductions_owner=0
        optimal_business_income_owner=0
        optimal_business_income_tax_paid_owner=0
        optimal_investment_income_owner=0
        optimal_investment_income_tax_paid_owner=0
        optimal_hidden_wealth_owner=0
        optimal_borrow_or_lend_owner=0
                    
        ownership=1
                                                                           
        ! Checks if the model allows housholds to get mortgages in retirement
        if (can_get_mortgage_in_retirement==0) then
                        
            ! Checks if the household is in retirement
            if (in_retirement==1) then
                        
                ! In this case the household cannot get a mortgage
                can_get_mortgage=0
                                        
            ! The household is not in retirement
            else
                    
                ! The household can get a mortgage
                can_get_mortgage=1
                                        
            end if
                                
        ! The household can get a mortgage at every age
        else
                            
            can_get_mortgage=1
                            
        end if  
                        
        ! Checks if the household is in the last period of life and this is a full life cycle model
        if (age_index==life_span) then
                    
            ! In this case, the household cannot get a mortgage
            can_get_mortgage=0
                    
        end if
                                                            
        ! Loops over all possible house sizes they can buy
        future_housing_status_loop_2: do &
            future_housing_status_index=&
            index_of_smallest_house_hhld_can_buy,&
            (housing_status_grid_size-1)
                                                                                                        
            ! Looks at all the mortgage options
            future_mortgage_loop_2: do future_mortgage_index=&
                can_get_mortgage*mortgage_grid_size+(1-can_get_mortgage),1,-1
                            
                ! Checks if the household is taking a large mortgage and might
                ! want to consider alternative lenders
                if (mortgage_grid&
                    (future_mortgage_index)>0.81) then
                                
                    looking_at_alternative_lenders=1
                                
                ! In this case the mortgage is less than 81% and no alternative lenders
                ! should be used in any case
                else
                                
                    looking_at_alternative_lenders=0
                                    
                end if
                            
                ! Checks if the household chosoes to go with alternative lenders
                do lender_index=0,&
                    looking_at_alternative_lenders*(alternative_lenders_grid_size-1)
                        
                    ! Checks if the household has anything enough downpayment after paying for the house they want
                    if (((total_household_wealth-&
                        housing_price(time_period)*&
                        housing_size(future_housing_status_index)*&
                        (1-mortgage_grid(future_mortgage_index))))>0) then
                                        
                        ! loops over all the possible spaces the households might want to keep
                        ! as livable space
                        do space_lived_in_index=&
                            future_housing_status_index,&
                            (1-endogenous_rental_market)*future_housing_status_index+&
                            endogenous_rental_market*index_of_smallest_house_hhld_can_buy,-1
                            
                            call calculate_capital_income_minus_wealth_tax&
                                (financial_index,future_mortgage_index,ownership,&
                                future_housing_status_index,time_period)
                                        
                            ! Calculating the income generated for this combination of housing and mortgage
                            call calculate_after_tax_wealth&
                                (future_mortgage_index,future_housing_status_index,&
                                space_lived_in_index,ownership,time_period,&
                                solving_transition,lender_index)
                                                                                                            
                            if (mortgage_grid(future_mortgage_index)>0.81) then
                            
                                if (lender_index==0) then
                                            
                                    pay_mortgage_insurance=1
                                    max_mortgage_payments_as_fraction_of_income=&
                                        max_debt_to_income_ratio
                                                
                                else
                                                    
                                    ! There is no insurance if the household goes with an alternative lender
                                    pay_mortgage_insurance=0
                                                
                                end if
                                                        
                            else
                                                            
                                pay_mortgage_insurance=0
                                max_mortgage_payments_as_fraction_of_income=&
                                    max_debt_to_income_ratio
                                                                
                            end if
                                            
                            if ((mortgage_grid(future_mortgage_index)>0.81) .AND. &
                                (pay_mortgage_insurance==0) .AND. &
                                (lender_index==0)) then
        
                                write(*,*) "error insurance"
                    
                            end if
                                        
                            spending_on_housing=&
                                housing_size(future_housing_status_index)*&
                                housing_price(time_period)*&
                                (property_tax(time_period)+housing_depreciation*&
                                include_housing_depreciation_in_housing_costs+&
                                mortgage_grid(future_mortgage_index)*&
                                (fraction_of_mortgage_payment_going_to_principal+&
                                mortgage_interest_rate(time_period)+&
                                stress_test(time_period)+&
                                (1-lender_index)*&
                                pay_mortgage_insurance*mortgage_insurance_premium+&
                                lender_index*premium_with_alternative_lenders))
                                                                                        
                            ! Checks if the household can afford the TDS
                            ! but if they use an alternative lender they have no minimum requirement
                            if ((spending_on_housing/&
                                (optimal_gross_wage_income+&
                                optimal_business_income+&
                                optimal_investment_income+&
                                optimal_rental_income))<=&
                                (lender_index*a_large_multiple_of_income+&
                                (1-lender_index)*&
                                max_mortgage_payments_as_fraction_of_income)) then
                                            
                                ! Computes the consumption vector
                                consumption_vector=&
                                    (after_tax_wealth_net_of_expenses-&
                                    future_financial_grid_vector)/&
                                    (1+consumption_tax)
                                                
                                ! Finds the largest feasible fututre financial possible given that
                                ! the homeowner takes on as much mortgage as possbile
                                largest_possible_financial_index=&
                                    minloc(consumption_vector,&
                                    1,mask=consumption_vector>0)
                                                
                                ! Makes sure the household can consume some positive amount
                                ! For very large mortgage position and low financial position
                                ! it may be that the household cannot afford any consumption 
                                ! if they to take on a new small mortgage
                                if (largest_possible_financial_index>0) then
                                                    
                                    if (space_lived_in_index<future_housing_status_index) then
                                                
                                        apply_disutility_of_landlords=1
                                                
                                    else
                                                
                                        apply_disutility_of_landlords=0
                                                    
                                    end if
                                                                                                                                                                    
                                    ! Obtains the utility flow from renting
                                    flow_utility_vector&
                                        (1:largest_possible_financial_index)=&
                                        ((housing_status_utility_function&
                                        (space_lived_in_index,1)*&
                                        (consumption_vector&
                                        (1:largest_possible_financial_index))**&
                                        (risk_aversion_share_of_cons))/&
                                        (1-risk_aversion))+&
                                        (1-shut_down_housing_market)*&
                                        endogenous_rental_market*&
                                        apply_disutility_of_landlords*&
                                        disutility_of_landlords*&
                                        (disutility_of_landlords_function_of_total_supply*&
                                        (housing_size(future_housing_status_index)-&
                                        housing_size(space_lived_in_index))**&
                                        (power_to_raise_to_disutility_to)+&
                                        (1-disutility_of_landlords_function_of_total_supply))
                                                                                                                                        
                                    future_utility_vector(1:largest_possible_financial_index)=0
                                                               
                                    ! Checks if the household cares about their child
                                    if (add_utility_from_child==1) then
                                                                                                        
                                        ! It is the probability of surviving to the next period
                                        ! times the value from the chocice of financial in each state of the world
                                        ! plus the probability of not surviving times the warm glow utility
                                        future_utility_vector&
                                            (1:largest_possible_financial_index)=&
                                            future_utility_vector&
                                            (1:largest_possible_financial_index)+&
                                            (1-survival_probability(age_index))*&
                                            weight_on_bequest*&
                                            (financial_grid&
                                            (1:largest_possible_financial_index)**&
                                            (1-bequest_risk_aversion))/&
                                            (1-bequest_risk_aversion)
                                                                                                                                                                
                                    end if
                                                                                                    
                                    ! Loops over all the possible future income states
                                    ! When a household is before retirement they can only move into
                                    ! one employment state, so I take that into account
                                    do future_employment_index=&
                                        at_least_one_period_before_retirement*employment_index+&
                                        (1-at_least_one_period_before_retirement)*&
                                        max(employment_index-1,1),&
                                        at_least_one_period_before_retirement*employment_index+&
                                        (1-at_least_one_period_before_retirement)*&
                                        min(employment_index+1,employment_grid_size)
                                        
                                        do future_productivity_shock_index=&
                                            have_fixed_productivity*2+&
                                            (1-have_fixed_productivity)*&
                                            productivity_shock_index,&
                                            have_fixed_productivity*2+&
                                            (1-have_fixed_productivity)*&
                                            productivity_shock_grid_size
                                                                                                            
                                            future_utility_vector&
                                                (1:largest_possible_financial_index)=&
                                                future_utility_vector&
                                                (1:largest_possible_financial_index)+&
                                                discount_factor*&
                                                survival_probability(age_index)*&
                                                productivity_shock_process&
                                                (productivity_shock_index,future_productivity_shock_index)*&
                                                (probability_of_bad_shock_continuing(time_period)*&
                                                employment_process(1+solving_transition,age_index,&
                                                employment_index,future_employment_index)+&
                                                (1-probability_of_bad_shock_continuing(time_period))*&
                                                employment_process(1,age_index,&
                                                employment_index,future_employment_index))*&
                                                value_function&
                                                (min(time_period+solving_transition*1,&
                                                transition_length),age_index+1,&
                                                1:largest_possible_financial_index,&
                                                future_employment_index,&
                                                future_productivity_shock_index,&
                                                productivity_index)
                                                                                                                
                                        end do
                                                                                                        
                                    end do
                                            
                                    ! If there is unemployment, and the household is not close to retirement
                                    ! and the household does not have a low income state
                                    if ((have_unemployment==1) .AND. &
                                        (at_least_one_period_before_retirement==0) .AND. &
                                        (employment_index<(employment_grid_size-1))) then
                                                    
                                        do future_employment_index=&
                                            employment_grid_size,employment_grid_size
                                            
                                            do future_productivity_shock_index=&
                                                have_fixed_productivity*2+&
                                                (1-have_fixed_productivity)*&
                                                productivity_shock_index,&
                                                have_fixed_productivity*2+&
                                                (1-have_fixed_productivity)*&
                                                productivity_shock_grid_size
                                                                                                                                                                                                                                                   
                                                future_utility_vector&
                                                    (1:largest_possible_financial_index)=&
                                                    future_utility_vector&
                                                    (1:largest_possible_financial_index)+&
                                                    discount_factor*&
                                                    survival_probability(age_index)*&
                                                    productivity_shock_process&
                                                    (productivity_shock_index,future_productivity_shock_index)*&
                                                    (probability_of_bad_shock_continuing(time_period)*&
                                                    employment_process(1+solving_transition,age_index,&
                                                    employment_index,future_employment_index)+&
                                                    (1-probability_of_bad_shock_continuing(time_period))*&
                                                    employment_process(1,age_index,&
                                                    employment_index,future_employment_index))*&
                                                    value_function&
                                                    (min(time_period+solving_transition*1,&
                                                    transition_length),age_index+1,&
                                                    1:largest_possible_financial_index,&
                                                    future_employment_index,&
                                                    future_productivity_shock_index,&
                                                    productivity_index)
                                                        
                                            end do
                                                        
                                        end do
                                            
                                    end if
                                                
                                    ! Finds the value function 
                                    value_function_owner=&
                                        maxval(flow_utility_vector&
                                        (1:largest_possible_financial_index)+&
                                        future_utility_vector&
                                        (1:largest_possible_financial_index))
                                                                                                                                                                                                                                                                
                                    ! Checks if the new choice is better the old
                                    ! one
                                    if (value_function_owner>=&
                                        largest_value) then
                                                
                                        ! Saves the largest value and indeces
                                        largest_value=&
                                            value_function_owner
                                                                                                                        
                                        ! Finds financial policy function
                                        optimal_owner_financial=&
                                            maxloc(flow_utility_vector&
                                            (1:largest_possible_financial_index)+&
                                            future_utility_vector&
                                            (1:largest_possible_financial_index),1)
                                                                            
                                        optimal_owner_indeces(1)=optimal_owner_financial
                                        optimal_owner_indeces(2)=future_mortgage_index
                                        optimal_owner_indeces(3)=future_housing_status_index
                                        optimal_ownership_status_index_owner=1
                                    
                                        optimal_consumption_owner=consumption_vector(optimal_owner_indeces(1))
                                        optimal_after_tax_wealth_net_of_expenses_owner=&
                                            after_tax_wealth_net_of_expenses
                                        optimal_gross_wage_income_owner=optimal_gross_wage_income
                                        optimal_wage_income_tax_paid_owner=optimal_wage_income_tax_paid
                                        optimal_use_alternative_lenders_owner=lender_index
                                        optimal_space_lived_in_owner=optimal_space_lived_in
                                        optimal_rental_income_tax_paid_owner=optimal_rental_income_tax_paid
                                        optimal_mortgage_deductions_owner=optimal_mortgage_deductions_tax_rebates
                                                                
                                        optimal_business_income_owner=optimal_business_income
                                        optimal_business_income_tax_paid_owner=optimal_business_income_tax_paid
                                        optimal_hidden_wealth_owner=optimal_hidden_wealth
                                        optimal_investment_income_owner=optimal_investment_income
                                        optimal_investment_income_tax_paid_owner=optimal_investment_income_tax_paid
                                        optimal_borrow_or_lend_owner=optimal_borrow_or_lend
                                        optimal_total_household_working_wealth_owner=total_household_working_wealth
                                                        
                                    end if
                                                                                                
                                end if
                                                                                        
                            end if
                                            
                        end do
                                    
                    else
                                
                        exit future_mortgage_loop_2
                                
                    end if
                                
                ! Exits the lender loop
                end do
                               
            ! extis the mortgage loop
            end do future_mortgage_loop_2
                            
        ! exits the housing loop
        end do future_housing_status_loop_2
                                    
        ! Sets the highest values attained by a household
        ! who is a homeowner and stays this way
        value_function_owner=largest_value
        
    end subroutine
    
    subroutine apply_policy_function(financial_index,time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index,time_period
        
         ! Checks if it is better to be a renter or an owner
        if (value_function_owner>=&
            value_function_renter) then
                                                                                                
            value_function&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                value_function_owner
                
            optimal_after_tax_wealth_net_of_expenses=&
                optimal_after_tax_wealth_net_of_expenses_owner
                
            policy_function_financial&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_owner_indeces(1)
                
            policy_function_mortgage&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_owner_indeces(2)
                
            policy_function_housing_status&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_owner_indeces(3)
                
            policy_function_ownership_status&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_ownership_status_index_owner
                    
            policy_function_consumption&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_consumption_owner
            
            if (use_alternative_lenders==1) then
                                                                                                                                                                                    
                policy_function_use_alternative_lenders&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)=&
                    optimal_use_alternative_lenders_owner
                
            end if
            
            policy_function_space_lived_in_index&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_space_lived_in_owner
            
            policy_function_space_lived_in_size&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                housing_size(optimal_space_lived_in_owner)
                
            policy_function_rental_income_tax_paid&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_rental_income_tax_paid_owner
            
            policy_function_mortgage_interest_deductions&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_mortgage_deductions_owner
                
            policy_function_business_income&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_business_income_owner
                
            policy_function_business_income_tax_paid&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_business_income_tax_paid_owner
                
            policy_function_investment_income&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_investment_income_owner
                
            policy_function_investment_income_tax_paid&
                (time_period,age_index,&
                financial_index,employment_index,&
                productivity_shock_index,&
                productivity_index)=&
                optimal_investment_income_tax_paid_owner
                
            policy_function_hidden_wealth&
                (financial_index)=&
                optimal_hidden_wealth_owner
                
            policy_function_borrow_or_lend&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_borrow_or_lend_owner
                
            policy_function_working_wealth&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_total_household_working_wealth_owner
                                                                                                                        
        else
        
            value_function&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                value_function_renter
                
            optimal_after_tax_wealth_net_of_expenses=&
                optimal_after_tax_wealth_net_of_expenses_renter
                
            policy_function_financial&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_renter_indeces(1)
                    
            policy_function_mortgage&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_renter_indeces(2)
            
            policy_function_housing_status&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_renter_indeces(3)
                                
            policy_function_ownership_status&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_ownership_status_index_renter
                                
            policy_function_consumption&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_consumption_renter
                            
            if (use_alternative_lenders==1) then
                                                                                                                                                                                                                                                        
                policy_function_use_alternative_lenders&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)=&
                    optimal_use_alternative_lenders_renter
                                    
            end if
                        
            policy_function_space_lived_in_index&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_space_lived_in_renter
                        
            policy_function_space_lived_in_size&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                housing_size(optimal_space_lived_in_renter)
                                
            policy_function_rental_income_tax_paid&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_rental_income_tax_paid_renter
                                   
            policy_function_mortgage_interest_deductions&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_mortgage_deductions_renter
                
            policy_function_business_income&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_business_income_renter
                
            policy_function_business_income_tax_paid&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_business_income_tax_paid_renter
                
            policy_function_investment_income&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_investment_income_renter
                
            policy_function_investment_income_tax_paid&
                (time_period,age_index,&
                financial_index,employment_index,&
                productivity_shock_index,&
                productivity_index)=&
                optimal_investment_income_tax_paid_renter
                
            policy_function_hidden_wealth&
                (financial_index)=&
                optimal_hidden_wealth_renter
                
            policy_function_borrow_or_lend&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_borrow_or_lend_renter
                
            policy_function_working_wealth&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)=&
                optimal_total_household_working_wealth_renter
                            
        end if
                    
    end subroutine
    
    subroutine calculate_after_tax_wealth&
        (mortgage_index_1,housing_status_index_1,&
        space_lived_in_index_1,ownership_status_index_1,time_period,&
        solving_transition,lender_index_1)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: mortgage_index_1,space_lived_in_index_1,&
                    housing_status_index_1,ownership_status_index_1,lender_index_1
        integer :: time_period,solving_transition,employment_index_1,pay_mortgage_insurance_1
        
        if ((ownership_status_index_1==0) .AND. (mortgage_index_1>1)) then
        
            write(*,*) "error mortgage_index_1=", mortgage_index_1
        
        end if
        
        if ((use_alternative_lenders==0) .AND. (abs(lender_index_1-0)>0)) then
        
            write(*,*) "error lender"
        
        end if
                        
        ! Calculates full mortgage debt
        mortgage_debt=&
            housing_price(time_period)*&
            housing_size(housing_status_index_1)*&
            mortgage_grid(mortgage_index_1)
        
        if (mortgage_grid(mortgage_index_1)>0.81) then
        
            if (lender_index_1==0) then
        
                pay_mortgage_insurance_1=1
                
            ! If the housheold goes with an alternative lender there is no insurance
            else
            
                pay_mortgage_insurance_1=0
            
            end if
        
        else
        
            pay_mortgage_insurance_1=0
        
        end if
        
        if ((mortgage_grid(mortgage_index_1)>0.81) .AND. &
            (pay_mortgage_insurance_1==0)) then
            
            write(*,*) "error insurance"
            
        end if
        
        mortgage_payments=&
            mortgage_debt*&
            (mortgage_interest_rate(time_period)+&
            (1-lender_index_1)*pay_mortgage_insurance_1*mortgage_insurance_premium+&
            lender_index_1*premium_with_alternative_lenders)
                       
        if ((mortgage_deductibility>0) .AND. (ownership_status_index_1==1) .AND. &
            (at_least_one_period_before_retirement==0)) then
               
            ! Computes the mortgage on own home
            mortgage_deductions=&
                (1-at_least_one_period_before_retirement)*&
                mortgage_deductibility*&
                housing_price(time_period)*&
                housing_size(space_lived_in_index_1)*&
                mortgage_grid(mortgage_index_1)*&
                (mortgage_interest_rate(time_period)+&
                (1-lender_index_1)*pay_mortgage_insurance_1*mortgage_insurance_premium+&
                lender_index_1*premium_with_alternative_lenders)
                
            optimal_mortgage_deductions_tax_rebates=0
                                    
            do employment_index_1=&
                at_least_one_period_before_retirement+&
                (1-at_least_one_period_before_retirement)*1,&
                at_least_one_period_before_retirement*0+&
                (1-at_least_one_period_before_retirement)*&
                employment_grid_size
                
                if ((have_unemployment==1) .AND. (employment_index_1==employment_grid_size)) then
                
                    ! Computing the wage income next period
                    gross_wage_income_next_period=&
                        unemploy_bene_frac_of_lowest_employ*&
                        (what_is_the_program_solving*wage_calibrated+&
                        (1-what_is_the_program_solving)*wage(time_period))*&
                        employment_grid(employment_grid_size-1)
                
                else
                                                
                    ! Computing the wage income next period
                    gross_wage_income_next_period=&
                        wage(time_period)*employment_grid(employment_index_1)*&
                        labour_deterministic_efficiency(age_index+1)
                        
                end if
                                                     
                ! Computing the average tax next period without mortgage deduction
                call calculate_average_labour_income_tax&
                    (gross_wage_income_next_period,&
                    employment_grid_size,employment_index_1,wage(time_period))
                    
                ! Calculates tax liability next period without MID
                tax_liability_next_period_without_mortgage_deductions=&
                    average_labour_income_tax*&
                    gross_wage_income_next_period
                    
                ! Computing the average tax paid next period with mortgage interest deductions
                call calculate_average_labour_income_tax&
                    (max(gross_wage_income_next_period-&
                    mortgage_deductibility*mortgage_deductions,0.d0),&
                    employment_grid_size,employment_index_1,&
                    wage(time_period))
                    
                ! Calculates tax liability next period with MID
                tax_liability_next_period_with_mortgage_deductions=&
                    average_labour_income_tax*&
                    max((gross_wage_income_next_period-&
                    mortgage_deductibility*mortgage_deductions),0.d0)
                    
                ! Calculates expected tax savings next period with MID
                optimal_mortgage_deductions_tax_rebates=&
                    optimal_mortgage_deductions_tax_rebates+&
                    employment_process(time_period,age_index,employment_index,employment_index_1)*&
                    max((tax_liability_next_period_without_mortgage_deductions-&
                    tax_liability_next_period_with_mortgage_deductions),0.d0)
                                        
            end do
                            
!            write(*,*) "optimal_mortgage_deductions_tax_rebates=", &
!                optimal_mortgage_deductions_tax_rebates
!            write(*,*) "age_index=", age_index
            
        else
        
            optimal_mortgage_deductions_tax_rebates=0
            
        end if
                                   
        ! Checks if the household is in retirement or not
        if (in_retirement==0) then
        
            ! Checks if the household is unemployed
            if ((have_unemployment==1) .AND. (employment_index==(employment_grid_size))) then
                
                ! Computes the gross wage income
                gross_wage_income=&
                    unemploy_bene_frac_of_lowest_employ*&
                    (what_is_the_program_solving*wage_calibrated+&
                    (1-what_is_the_program_solving)*wage(time_period))*&
                    employment_grid(employment_grid_size-1)
                
            else
            
                ! Computes the gross wage income
                gross_wage_income=&
                    wage(time_period)*employment_grid(employment_index)*&
                    labour_deterministic_efficiency(age_index)
                    
            end if
                
        else
                                                                
            gross_wage_income=&
                model_ss_benefits(employment_index)*&
                ((1-what_is_the_program_solving)*&
                model_average_labour_income(time_period)+&
                what_is_the_program_solving)
                                            
        end if
        
        if ((total_household_wealth+gross_wage_income-&
            rent(time_period)*housing_size(0))<&
            ((wage(time_period)*&
            (have_unemployment*employment_grid(employment_grid_size-1))+&
            (1-have_unemployment)*employment_grid(employment_grid_size))*&
            min_welf_sub_as_frac_of_low_wage)) then
            
            welfare_subusidy=&
                min_welf_sub_as_frac_of_low_wage*&
                (wage(time_period)*labour_deterministic_efficiency(age_index)*&
                (have_unemployment*employment_grid(employment_grid_size-1)+&
                (1-have_unemployment)*employment_grid(employment_grid_size)))-&
                (total_household_wealth+gross_wage_income-&
                rent(time_period)*housing_size(0))
            
        else
        
            welfare_subusidy=0
            
        end if
                                                                       
        ! Checks if the household is in retirement
        if (in_retirement==0) then
        
            ! Checks if the household is unemployed
            if ((have_unemployment==1) .AND. (employment_index==(employment_grid_size))) then
            
                wage_income_tax_paid=0
                
            else
                         
                call calculate_average_labour_income_tax&
                    (gross_wage_income,&
                    employment_grid_size,employment_index,&
                    wage(time_period))
                                                                                                          
                wage_income_tax_paid=&
                    average_labour_income_tax*gross_wage_income
                    
                if ((labour_income_tax(employment_index)==0) .AND. &
                   (average_labour_income_tax>0) .AND. &
                   (increase_in_labour_income_tax==0) .AND. &
                   (what_is_the_program_solving==0)) then
                
                    write(*,*) "labour_income_tax(employment_index)=", &
                        labour_income_tax(employment_index)
                    write(*,*) "average_labour_income_tax=", &
                        average_labour_income_tax
                                
                end if
                    
            end if
                                                                                                                                                                                                                                                              
        else
                                
            ! During retirement no taxes are paid on income
            wage_income_tax_paid=0
                                
        end if
            
        ! spending on rent by renters
        rent_spending=&
            (1-ownership_status_index_1)*&
            rent(time_period)*&
            housing_size(housing_status_index_1)
                                                                                                    
        ! Checks if the household is a homeowner
        if (ownership_status_index_1==1) then
        
            optimal_space_lived_in=&
                space_lived_in_index_1
            
        else
        
            optimal_space_lived_in=&
                housing_status_index_1
        
        end if
        
        ! Calculates effective rental income
        rental_income=&
            (1-shut_down_housing_market)*&
            endogenous_rental_market*&
            ownership_status_index_1*&
            rent(time_period)*&
            max((housing_size(housing_status_index_1)-&
            housing_size(space_lived_in_index_1)),0.d0)
            
        rental_income_tax_paid=&
            (1-shut_down_housing_market)*&
            endogenous_rental_market*&
            ownership_status_index_1*&
            (max(rent(time_period)-&
            housing_price(min(time_period+&
            property_tax_is_paid_on_current_period_tax*&
            solving_transition*1,transition_length))*&
            (housing_depreciation+&
            property_tax(min(time_period+&
            property_tax_is_paid_on_current_period_tax*&
            solving_transition*1,transition_length))+&
            (mortgage_grid(mortgage_index_1)*&
            (mortgage_interest_rate(time_period)+&
            (1-lender_index_1)*pay_mortgage_insurance_1*mortgage_insurance_premium+&
            lender_index_1*premium_with_alternative_lenders))),0.d0))*&
            max((housing_size(housing_status_index_1)-&
            housing_size(space_lived_in_index_1)),0.d0)
                        
        rental_income_tax_paid=&
            rental_income_tax*&
            max(rental_income_tax_paid,0.d0)
                        
        ! Computes the cost of the housing wealth tax to an owner
        gross_housing_wealth=&
            ownership_status_index_1*&
            housing_price(time_period)*&
            housing_size(housing_status_index_1)
            
        ! Computes the future value of the house when it is sold on the market next period
        value_of_house_sold_next_period=&
            ownership_status_index_1*&
            housing_price(min(time_period+solving_transition*1,transition_length))*&
            housing_size(housing_status_index_1)
            
        value_of_lived_in_space_sold_next_period=&
            ownership_status_index_1*&
            housing_price(min(time_period+solving_transition*1,transition_length))*&
            housing_size(space_lived_in_index_1)
        
        value_of_rented_space_sold_next_period=&
            ownership_status_index_1*&
            housing_price(min(time_period+&
            property_tax_is_paid_on_current_period_tax*&
            solving_transition*1,transition_length))*&
            max((housing_size(housing_status_index_1)-&
            housing_size(space_lived_in_index_1)),0.d0)
            
        property_taxes_paid=&
            ownership_status_index_1*&
            property_tax(min(time_period+&
            property_tax_is_paid_on_current_period_tax*&
            solve_transition_dynamics*1,transition_length))*&
            value_of_house_sold_next_period
                                                                   
        ! This measures the expenditures on fixing up the house when I do simulations
        housing_depreciation_expenditures=&
            housing_depreciation*&
            value_of_house_sold_next_period
            
        progressive_wealth_tax_paid=&
            progressive_wealth_tax*&
            max((total_household_working_wealth+&
            housing_price(min(time_period+&
            property_tax_is_paid_on_current_period_tax*&
            solving_transition*1,transition_length))*&
            housing_size(space_lived_in_index_1)+&
            optimal_gross_capital_gains)-&
            progressive_wealth_tax_threshold,0.d0)
            
        progressive_wealth_tax_paid=&
            progressive_wealth_tax_paid+&
            progressive_housing_tax*&
            max(housing_price(min(time_period+&
            property_tax_is_paid_on_current_period_tax*&
            solving_transition*1,transition_length))*&
            housing_size(space_lived_in_index_1)-&
            threshold_housing,0.d0)
            
        progressive_wealth_tax_paid=&
            progressive_wealth_tax_paid+&
            progressive_financial_tax*&
            max(total_household_working_wealth+&
            optimal_gross_capital_gains-&
            max(threshold_financial,0.d0),0.d0)
            
        optimal_progressive_wealth_tax_paid=&
            progressive_wealth_tax_paid
            
        optimal_gross_wage_income=&
            gross_wage_income
                                                                                
        optimal_wage_income_tax_paid=&
            wage_income_tax_paid
            
        optimal_rental_income_tax_paid=&
            rental_income_tax_paid
            
        optimal_rental_income=rental_income
        
        optimal_imputed_rent_tax_paid=&
            ownership_status_index_1*&
            tax_imputed_rent*&
            business_income_tax*&
            rent(time_period)*&
            housing_size&
            (space_lived_in_index_1)
                 
        if (((rental_income>0) .OR. (rental_income_tax_paid>0)) .AND. (ownership_status_index_1==0)) then
        
            write(*,*) "error"
            write(*,*) "rental_income=", rental_income
            write(*,*) "rental_income_tax_paid=", rental_income_tax_paid
            write(*,*) "ownership_status_index_1=", ownership_status_index_1
        
        end if
        
        if ((ownership_status_index_1==0) .AND. &
            ((mortgage_debt>0) .OR. (rental_income>0) .OR. (optimal_mortgage_deductions_tax_rebates>0) .OR. &
            (value_of_house_sold_next_period>0) .OR. (gross_housing_wealth>0))) then
            
            write(*,*) "errrrrrrrooororor"
            
        end if
        
        if ((ownership_status_index_1==1) .AND. (rent_spending>0)) then
        
            write(*,*) "not good"
        
        end if
                                                                                                                              
        ! Calculates the after tax income a homeowner with a mortgage has
        after_tax_wealth_net_of_expenses=&
            optimal_capital_income_minus_wealth_tax+&
            gross_wage_income-wage_income_tax_paid+& ! Gross wage income minus taxes paid
            rental_income-rental_income_tax_paid-& ! Rental income minus taxes paid
            property_taxes_paid-&  ! Property taxes
            optimal_imputed_rent_tax_paid-& ! imputed rents tax paid by homeowners
            optimal_progressive_wealth_tax_paid-& ! progressive wealt taxes
            housing_depreciation_expenditures-rent_spending-& ! These are expenditures for house upkeep and rent
            mortgage_payments+& ! These are the mortgage interest payments
            mortgage_deductibility*&
            optimal_mortgage_deductions_tax_rebates+& ! This is the value of mortgage interest deductios
            value_of_house_sold_next_period-gross_housing_wealth+&  ! Computes the difference between the 
            welfare_subusidy                                        ! price at which the house is sold next 
                                                                  ! period and the value it was bought for
                    
        if ((shut_down_housing_market==1) .AND. &
            (abs(after_tax_wealth_net_of_expenses-&
            (optimal_capital_income_minus_wealth_tax+&
            gross_wage_income-wage_income_tax_paid))>10.d0**(8))) then
            
            write(*,*) "erorr shut_down"
            
        end if
        
    end subroutine
    
    subroutine calculate_capital_income_minus_wealth_tax&
        (financial_index,mortgage_index_1,ownership_status_index_1,housing_status_index_1,time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index,mortgage_index_1,ownership_status_index_1,&
            housing_status_index_1,time_period
        real(8) :: effective_total_useable_fin_wealth,total_useable_fin_wealth
        
        total_household_wealth_1=financial_grid(financial_index)
            
        ! Calculating total net wealth
        total_household_working_wealth=&
            (total_household_wealth_1-&
            (1-shut_down_housing_market)*&
            (ownership_status_index_1*&
            housing_price(time_period)*&
            housing_size(housing_status_index_1)*&
            (1-mortgage_grid(mortgage_index_1))))
                            
        ! Calls a subroutine that calculates how much wealth is hidden
        ! for a given wealth tax
        call calculate_hidden_wealth&
            (total_household_working_wealth)
            
        optimal_hidden_wealth=hidden_wealth
            
        optimal_wealth_tax_paid=wealth_tax_paid
        
        if (exogenous_wages==0) then
        
            if (productivity_shock_grid(productivity_shock_index)>0) then
                      
                total_household_wealth_that_can_be_leveraged=&
                    max(total_household_wealth_1-&
                    what_is_the_program_solving*&
                    is_hidden_wealth_offshore*&
                    optimal_hidden_wealth,0.d0)
                        
                employable_financial=&
                    max(total_household_working_wealth-&
                    what_is_the_program_solving*&
                    is_hidden_wealth_offshore*&
                    optimal_hidden_wealth,0.d0)
                    
                if ((robustness_check==1) .AND. (looser_lambda==1)) then
                
                    ! Borrow financial wealth to the maximum
                    ! Assuming borrow_land_1>0
                    borrow_or_lend_1=&
                        max((1/(productivity_grid(productivity_index)**&
                        productivity_shock_grid(productivity_shock_index)))*&
                        (((productivity_grid(productivity_index)**&
                        productivity_shock_grid(productivity_shock_index))*&
                        curv_intrmdte_prod*aggregate_production_times_labour(time_period))/&
                        (risk_free_rate(time_period)+financial_wealth_depreciation))**&
                        (1/(1-curv_intrmdte_prod))-employable_financial,-employable_financial)
                
                else
                                                                                                                                                                                                                                                                                                                                                                              
                    ! Borrow financial wealth to the maximum
                    ! Assuming borrow_land_1>0
                    borrow_or_lend_1=&
                        min(max((1/(productivity_grid(productivity_index)**&
                        productivity_shock_grid(productivity_shock_index)))*&
                        (((productivity_grid(productivity_index)**&
                        productivity_shock_grid(productivity_shock_index))*&
                        curv_intrmdte_prod*aggregate_production_times_labour(time_period))/&
                        (risk_free_rate(time_period)+financial_wealth_depreciation))**&
                        (1/(1-curv_intrmdte_prod))-employable_financial,-employable_financial),&
                        (cond_max_debt_to_assets_on_prod*multiple_max_debt_to_assets*&
                        (productivity_index-1)+&
                        (1-cond_max_debt_to_assets_on_prod)*max_debt_to_assets)*&
                        max(total_household_wealth_that_can_be_leveraged,0.d0))
                        
                end if
                                                                                                                                                                        
                borrow_or_lend_1=max(borrow_or_lend_1,0.d0)
                                                                                                                                                                    
                ! Computes the total financial wealth used in production
                ! if the household has negative employable financial it only
                ! uses what it borrowed
                total_useable_fin_wealth=&
                    borrow_or_lend_1+&
                    employable_financial
                                                                
                ! Computes the effective total financial wealth used in production
                effective_total_useable_fin_wealth=&
                    (productivity_grid(productivity_index)**&
                    productivity_shock_grid(productivity_shock_index))*&
                    total_useable_fin_wealth
                                                                                                                                                        
                ! Checks the profits under this condition
                profits_1=&
                    (risk_free_rate(time_period)*employable_financial+&
                    aggregate_production_times_labour(time_period)*&
                    (effective_total_useable_fin_wealth)**(curv_intrmdte_prod)-&
                    (risk_free_rate(time_period)+financial_wealth_depreciation)*total_useable_fin_wealth)-&
                    business_income_tax*max(&
                    (risk_free_rate(time_period)*employable_financial+&
                    aggregate_production_times_labour(time_period)*&
                    (effective_total_useable_fin_wealth)**(curv_intrmdte_prod)-&
                    (risk_free_rate(time_period)+financial_wealth_depreciation)*total_useable_fin_wealth),0.d0)
                    
                if ((robustness_check==1) .AND. (looser_lambda==1)) then
                    
                    ! Borrow financial wealth to the maximum
                    ! Assuming borrow_land_1>0
                    borrow_or_lend_2=&
                        max((1/(productivity_grid(productivity_index)**&
                        productivity_shock_grid(productivity_shock_index)))*&
                        (((productivity_grid(productivity_index)**&
                        productivity_shock_grid(productivity_shock_index))*&
                        curv_intrmdte_prod*aggregate_production_times_labour(time_period))/&
                        (risk_free_rate(time_period)*((1-investment_income_tax)/(1-business_income_tax))+&
                        financial_wealth_depreciation))**&
                        (1/(1-curv_intrmdte_prod))-employable_financial,-employable_financial)
                    
                else
                
                    ! Borrow financial wealth to the maximum
                    ! Assuming borrow_land_1>0
                    borrow_or_lend_2=&
                        min(max((1/(productivity_grid(productivity_index)**&
                        productivity_shock_grid(productivity_shock_index)))*&
                        (((productivity_grid(productivity_index)**&
                        productivity_shock_grid(productivity_shock_index))*&
                        curv_intrmdte_prod*aggregate_production_times_labour(time_period))/&
                        (risk_free_rate(time_period)*((1-investment_income_tax)/(1-business_income_tax))+&
                        financial_wealth_depreciation))**&
                        (1/(1-curv_intrmdte_prod))-employable_financial,-employable_financial),&
                        (cond_max_debt_to_assets_on_prod*multiple_max_debt_to_assets*&
                        (productivity_index-1)+&
                        (1-cond_max_debt_to_assets_on_prod)*max_debt_to_assets)*&
                        total_household_wealth_that_can_be_leveraged)
                        
                end if
                                                                        
                borrow_or_lend_2=min(borrow_or_lend_2,0.d0)
                                                        
                ! Computes the total financial wealth used in production
                ! If the household has negative financial wealth it cannot produce anything
                ! as it did not borrow and has negative financial
                total_useable_fin_wealth=&
                    borrow_or_lend_2+&
                    employable_financial
                                                            
                ! Computes the effective total financial wealth used in production
                effective_total_useable_fin_wealth=&
                    (productivity_grid(productivity_index)**&
                    productivity_shock_grid(productivity_shock_index))*&
                    total_useable_fin_wealth
                                                                                                                                    
                ! Checks the profits under this condition
                ! It depends on the business income and the investment income taxes
                profits_2=&
                    (aggregate_production_times_labour(time_period)*&
                    (effective_total_useable_fin_wealth)**(curv_intrmdte_prod)-&
                    financial_wealth_depreciation*total_useable_fin_wealth)-&
                    business_income_tax*max((&
                    aggregate_production_times_labour(time_period)*&
                    (effective_total_useable_fin_wealth)**(curv_intrmdte_prod)-&
                    financial_wealth_depreciation*total_useable_fin_wealth),0.d0)-&
                    borrow_or_lend_2*risk_free_rate(time_period)-investment_income_tax*&
                    max(-borrow_or_lend_2*risk_free_rate(time_period),0.d0)
                                                                                                                          
                ! Checks if profit_1 is greater than profit_2
                ! or if the household has negative financial
                if (profits_1>=profits_2) then
                                                                    
                    borrow_or_lend=borrow_or_lend_1
                                                       
                else
                                                                                                            
                    borrow_or_lend=borrow_or_lend_2
                                                    
                end if
                                                                                                                                                                                                
                ! if the borrow and lend plus financial is less than 0
                ! then there is nothing useable for the household for production
                total_useable_fin_wealth=&
                    borrow_or_lend+&
                    employable_financial
                                                                                                                                            
                ! Computes the total financial wealth used in production
                effective_total_useable_fin_wealth=&
                    (productivity_grid(productivity_index)**&
                    productivity_shock_grid(productivity_shock_index))*&
                    total_useable_fin_wealth
                                                                                        
                ! Checks if the amount of capital used is larger than the capital owned by the
                ! household
                if (total_useable_fin_wealth>=employable_financial) then
                                                                               
                    ! Computes business income
                    business_income=&
                        risk_free_rate(time_period)*employable_financial+&
                        aggregate_production_times_labour(time_period)*&
                        (effective_total_useable_fin_wealth)**(curv_intrmdte_prod)-&
                        (risk_free_rate(time_period)+financial_wealth_depreciation)*&
                        total_useable_fin_wealth
                                                                                                    
                else
                                            
                    ! Computes business income
                    business_income=&
                        aggregate_production_times_labour(time_period)*&
                        (effective_total_useable_fin_wealth)**(curv_intrmdte_prod)-&
                        (financial_wealth_depreciation)*total_useable_fin_wealth
                                                                                            
                end if
                                                                                                                                                                                  
                ! Computes gross capital gains
                gross_capital_gains=&
                    risk_free_rate(time_period)*employable_financial+&
                    aggregate_production_times_labour(time_period)*&
                    (effective_total_useable_fin_wealth)**(curv_intrmdte_prod)-&
                    (risk_free_rate(time_period)+financial_wealth_depreciation)*&
                    total_useable_fin_wealth
                                                            
                investment_income=gross_capital_gains-business_income
                
            else
            
                borrow_or_lend=-total_household_working_wealth
                business_income=0
                investment_income=&
                    risk_free_rate(time_period)*&
                    total_household_working_wealth
            
            end if
            
            ! Rebate construction profits lump sum per household
            if (rebate_construction_profits_lump_sum==1) then
            
                investment_income=investment_income+&
                    construction_company_profits_per_household(time_period)
                                                
            ! Rebate more if the household has more wealth
            elseif (rebate_construction_profits_lump_sum==0) then
                                                                                                                                                        
                ! Adds capital gains from the construction company's shares
                investment_income=investment_income+&
                    (construction_company_profits_per_household(time_period))*&
                    (total_household_working_wealth/model_financial_per_household(time_period))
                                                
            end if
                                                                            
            business_income_tax_paid=&
                business_income_tax*max(business_income,0.d0)
                                            
            investment_income_tax_paid=&
                investment_income_tax*max(investment_income,0.d0)
                
            optimal_borrow_or_lend=borrow_or_lend
                                                                                         
            ! Computes the taxes paid on capital gains
            capital_gains_tax_paid=&
                business_income_tax_paid+&
                investment_income_tax_paid
                                                                                          
            optimal_business_income=&
                business_income
                                            
            optimal_investment_income=&
                investment_income
                                            
            optimal_business_income_tax_paid=&
                business_income_tax_paid
                                            
            optimal_investment_income_tax_paid=&
                investment_income_tax_paid
                
            gross_capital_gains=&
                business_income+investment_income
                                                                
            optimal_gross_capital_gains=&
                gross_capital_gains
                                    
            optimal_capital_gains_tax_paid=&
                business_income_tax_paid+&
                investment_income_tax_paid
                
        ! exogenous incomes
        else
                
            investment_income=&
                risk_free_rate(time_period)*&
                total_household_working_wealth
                
            ! Rebate construction profits lump sum per household
            if (rebate_construction_profits_lump_sum==1) then
            
                investment_income=investment_income+&
                    construction_company_profits_per_household(time_period)
                                                
            ! Rebate more if the household has more wealth
            elseif (rebate_construction_profits_lump_sum==0) then
                                                                                                                                                        
                ! Adds capital gains from the construction company's shares
                investment_income=investment_income+&
                    (construction_company_profits_per_household(time_period))*&
                    (total_household_working_wealth/model_financial_per_household(time_period))
                                                
            end if
            
            optimal_investment_income=investment_income
                
            optimal_investment_income_tax_paid=&
                investment_income_tax*&
                max(optimal_investment_income,0.d0)
                
            gross_capital_gains=optimal_investment_income
            
            optimal_gross_capital_gains=gross_capital_gains
            
            capital_gains_tax_paid=optimal_investment_income_tax_paid
                
            optimal_business_income=0
            
            optimal_business_income_tax_paid=0
            
            optimal_borrow_or_lend=0
        
        end if
        
        optimal_capital_income_minus_wealth_tax=&
            total_household_wealth_1+& ! total_household wealth
            gross_capital_gains-capital_gains_tax_paid-& ! Gross capital gains minus taxes paid
            what_is_the_program_solving*optimal_wealth_tax_paid
    
    end subroutine
    
    ! This subroutine calculates the amount of hidden wealth
    subroutine calculate_hidden_wealth(financial_household_wealth)
    
        use Wealth_Tax_Global_Vars
        
        real(8) :: financial_household_wealth,reported_households_wealth
                            
        ! Wealth tax policy
        if (which_wealth_tax_to_do==1) then
        
            hidden_wealth=&
                financial_household_wealth*min(max(financial_tax*elasticity_of_taxable_wealth,0.d0),1.d0)
                
            reported_households_wealth=financial_household_wealth-hidden_wealth
            
            wealth_tax_paid=max(financial_tax,0.d0)*reported_households_wealth
            
            if ((financial_tax>0) .AND. &
                (reported_households_wealth>0) .AND. &
                (wealth_tax_paid==0)) then
            
                write(*,*) "Error wealth tax is 0"
            
            end if
            
        ! Optimal policy
        else
        
            hidden_wealth=0
            wealth_tax_paid=0
            
        end if
                            
    end subroutine
    
    subroutine internal_computations&
        (value_function_1,fin_index_1,ownership_status_index_1,&
        space_lived_in_index_1,housing_status_index_1,mortgage_index_1,&
        rental_income_tax_paid_2,lender_index_1,current_mortgage_deductions_tax_rebates_1,&
        financial_index,time_period,after_tax_wealth_net_of_expenses_1,solving_transition)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: &
            financial_index,fin_index_1,ownership_status_index_1,&
            housing_status_index_1,space_lived_in_index_1,mortgage_index_1,&
            space_lived_in_internal_index,housing_stauts_index_1_is_smallest_index,&
            time_period,solving_transition,lender_index_1,employment_index_1,&
            pay_mortgage_insurance_1,apply_disutility_of_landlords_1,adjust_budget,&
            can_purchase_new_house
        real(8) :: &
            val_fun,value_function_1,after_tax_wealth_net_of_expenses_1,&
            after_tax_wealth_net_of_expenses_1_copy,&
            rental_income_1,rental_income_tax_paid_1,&
            rent_spent_1,space_lived_in_optimal_1,&
            after_tax_wealth_net_of_expenses_1_optimal,&
            rental_income_tax_paid_optimal_1,mortgage_deductions_1,&
            optimal_mortgage_deductions_tax_rebates_1,&
            tax_liability_next_period_without_mortgage_deductions_1,&
            tax_liability_next_period_with_mortgage_deductions_1,&
            gross_wage_income_next_period_1,mortgage_deductions_tax_rebates_1,&
            current_mortgage_deductions_tax_rebates_1,rental_income_tax_paid_2,&
            gross_housing_wealth_this_period_1,gross_housing_wealth_next_period_1,&
            housing_depreciation_1,optimal_housing_depreciation_1,&
            property_taxes_paid_1,optimal_property_tax_paid_1,&
            optimal_gain_on_house_sale_1,gain_on_house_sale_1,&
            optimal_mortgage_payments_1,mortgage_payments_1,&
            optimal_investment_income_1,investment_income_1,&
            max_mortgage_payments_as_fraction_of_income_1,spending_on_housing_1
            
        val_fun=value_function_1
                                    
        consumption_internal_optimal_1=&
            consumption_vector(fin_index_1)
        
        space_lived_in_optimal_1=&
            housing_size(space_lived_in_index_1)
        
        after_tax_wealth_net_of_expenses_1_optimal=&
            after_tax_wealth_net_of_expenses_1
        
        optimal_mortgage_deductions_tax_rebates_1=&
            current_mortgage_deductions_tax_rebates_1
            
        ! Checks if the household pays mortgage insurance
        if (mortgage_grid(mortgage_index_1)>0.81) then
                
            if (lender_index_1==0) then
                    
                pay_mortgage_insurance_1=1
                max_mortgage_payments_as_fraction_of_income_1=&
                    max_debt_to_income_ratio
                    
            else
            
                pay_mortgage_insurance_1=0
                        
            end if
                        
        else
                    
            pay_mortgage_insurance_1=0
            max_mortgage_payments_as_fraction_of_income_1=&
                max_debt_to_income_ratio
                        
        end if
            
        optimal_mortgage_payments_1=&
            (1-endogenous_rental_market)*&
            housing_price(time_period)*&
            housing_size(space_lived_in_index_1)*&
            mortgage_grid(mortgage_index_1)*&
            (mortgage_interest_rate(time_period)+&
            (1-lender_index_1)*&
            pay_mortgage_insurance_1*mortgage_insurance_premium+&
            lender_index_1*premium_with_alternative_lenders)
            
        rental_income_tax_paid_optimal_1=&
            (1-shut_down_housing_market)*&
            ownership_status_index_1*&
            endogenous_rental_market*&
            rental_income_tax_paid_2
            
        if (shut_down_housing_market==1) then
        
            rental_income_tax_paid_1=0
            
        end if
            
        if ((endogenous_rental_market==0) .AND. (rental_income_tax_paid_2>0)) then
        
            write(*,*) "error rental income"
        
        end if
        
        if ((endogenous_rental_market==0) .AND. &
            (abs(space_lived_in_index_1-housing_status_index_1)>0)) then
        
            write(*,*) "error space lived in"
        
        end if
        
        if (exogenous_wages==1) then
                                                            
            optimal_investment_income_1=&
                risk_free_rate(time_period)*&
                (financial_grid(financial_index)-&
                (ownership_status_index_1*&
                housing_price(time_period)*&
                housing_size(housing_status_index_1)*&
                (1-mortgage_grid(mortgage_index_1))))
                
        else
        
            investment_income_1=0
            optimal_investment_income_1=0
        
        end if
                        
        gross_housing_wealth_this_period_1=&
            ownership_status_index_1*&
            housing_price(time_period)*&
            housing_size(housing_status_index_1)
            
        gross_housing_wealth_next_period_1=&
            ownership_status_index_1*&
            housing_price(time_period+solve_transition_dynamics*1)*&
            housing_size(housing_status_index_1)
            
        optimal_gain_on_house_sale_1=&
            ownership_status_index_1*&
            (gross_housing_wealth_next_period_1-&
            gross_housing_wealth_this_period_1)
            
        optimal_housing_depreciation_1=&
            ownership_status_index_1*&
            housing_depreciation*&
            gross_housing_wealth_next_period_1
            
        optimal_property_tax_paid_1=&
            ownership_status_index_1*&
            property_tax(min(time_period+&
            property_tax_is_paid_on_current_period_tax*&
            solve_transition_dynamics*1,transition_length))*&
            gross_housing_wealth_next_period_1
                        
        frac_mov_optimal_1&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index)=0
                        
        fin_index_frac_mov_to_optimal&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index)=fin_index_1
                                
        ! Here I zoom in on the optimal choice region
        ! Computes the distance between the previous point and current choice
        dis_prev_index_fin=&
            financial_grid(fin_index_1)-&
            financial_grid(max(fin_index_1-1,1))
                                                                                    
        ! Computes the distance between the next point and current choice
        dis_next_index_fin=&
            financial_grid(min(fin_index_1+1,financial_grid_size))-&
            financial_grid(fin_index_1)
                                                                                                                        
        ! Computes the slope between the financial 
        ! points before and after the optimal choice
        slope_of_financial_internal=&
            (dis_prev_index_fin+dis_next_index_fin)/&
            (fin_num_of_internal-1)
            
        if (ownership_status_index_1==1) then
        
            if (endogenous_rental_market==1) then
            
                ! Here I zoom in on the optimal choice region
                ! Computes the distance between the previous point and current choice
                dis_prev_index_space_lived_in=&
                    housing_size(space_lived_in_index_1)-&
                    housing_size(max(space_lived_in_index_1-1,&
                    index_of_smallest_house_hhld_can_buy))
                
                ! Computes the distance between the next point and current choice
                dis_next_index_space_lived_in=&
                    housing_size(min(space_lived_in_index_1+1,&
                    housing_status_index_1))-&
                    housing_size(space_lived_in_index_1)
                    
            else
            
                ! Here I zoom in on the optimal choice region
                ! Computes the distance between the previous point and current choice
                dis_prev_index_space_lived_in=&
                    housing_size(space_lived_in_index_1)-&
                    housing_size(max(space_lived_in_index_1-1,&
                    index_of_smallest_house_hhld_can_buy))
                
                ! Computes the distance between the next point and current choice
                dis_next_index_space_lived_in=&
                    housing_size(min(space_lived_in_index_1+1,&
                    housing_status_grid_size))-&
                    housing_size(space_lived_in_index_1)
            
            end if
                
        else
            
            ! Here I zoom in on the optimal choice region
            ! Computes the distance between the previous point and current choice
            dis_prev_index_space_lived_in=&
                housing_size(space_lived_in_index_1)-&
                housing_size(max(space_lived_in_index_1-1,0))
                
            ! Computes the distance between the next point and current choice
            dis_next_index_space_lived_in=&
                housing_size(min(space_lived_in_index_1+1,&
                housing_status_grid_size))-&
                housing_size(space_lived_in_index_1)
        
        end if
                                                                                                                                                                                                        
        ! Computes the slope between the financial 
        ! points before and after the optimal choice
        slope_of_space_lived_in_internal=&
            (dis_prev_index_space_lived_in+&
            dis_next_index_space_lived_in)/&
            (space_lived_in_num_of_internal-1)
            
        if ((ownership_status_index_1==1) .AND. (endogenous_rental_market==1)) then
            
            ! Checks if the housing status index is the smallest
            if ((housing_status_index_1<=index_of_smallest_house_hhld_can_buy)) then
        
                housing_stauts_index_1_is_smallest_index=1
            
            else
        
                housing_stauts_index_1_is_smallest_index=0
        
            end if
            
        end if
                
        if ((housing_status_index_1==0) .AND. &
            (index_of_smallest_house_hhld_can_buy>0) .AND. &
            (ownership_status_index_1==1) .AND. &
            (endogenous_rental_market==1)) then
        
            write(*,*) "ownership_status_index_1=", ownership_status_index_1
            write(*,*) "housing_status_index_1=", housing_status_index_1
            
        end if
            
        after_tax_wealth_net_of_expenses_1_copy=&
            after_tax_wealth_net_of_expenses_1
                                                                
        ! Here I zoom in around the optimal choice found earlier
        internal_loop_1: do future_financial_index=1,fin_num_of_internal-2
                                                                                    
            ! Finds the financial amount for the internal iteration
            ! It is the one financial value back from the optimal choice
            ! plus the slope multiplied by the number of steps taken away from
            ! that back financial value
            financial_internal=&
                financial_grid(max(fin_index_1-1,1))+&
                slope_of_financial_internal*future_financial_index
                
            ! if the household is a homeowner, then it loops over 29 possible lived in spaces
            ! if the household is not a renter, then it only loops once
            internal_loop_2: do space_lived_in_internal_index=0,&
                shut_down_housing_market*0+&
                (1-shut_down_housing_market)*&
                ((1-exogenous_wages)*0+&
                exogenous_wages*((1-endogenous_rental_market)*(space_lived_in_num_of_internal-2)+&
                endogenous_rental_market*((ownership_status_index_1*&
                (housing_stauts_index_1_is_smallest_index*0+&
                (1-housing_stauts_index_1_is_smallest_index)*(space_lived_in_num_of_internal-2))+&
                (1-ownership_status_index_1)*(space_lived_in_num_of_internal-2)))))

                ! Checks if the household is a homeowner
                if (ownership_status_index_1==1) then
                        
                    if (space_lived_in_internal_index==0) then
            
                        space_lived_in_internal=housing_size(space_lived_in_index_1)
                            
                    else
                    
                        ! Computes the space lived in
                        space_lived_in_internal=&
                            housing_size(max(space_lived_in_index_1-1,index_of_smallest_house_hhld_can_buy))+&
                            slope_of_space_lived_in_internal*space_lived_in_internal_index
                                                        
                    end if
                                                                            
                ! checks if the household is a renter
                elseif (ownership_status_index_1==0) then
                    
                    if (space_lived_in_internal_index==0) then
                
                        space_lived_in_internal=&
                            housing_size(space_lived_in_index_1)
                                
                    else
                        
                        ! Computes the space lived in
                        space_lived_in_internal=&
                            housing_size(max(space_lived_in_index_1-1,0))+&
                            slope_of_space_lived_in_internal*space_lived_in_internal_index
                    
                    end if
                            
                end if
                
                if (shut_down_housing_market==1) then
                
                    space_lived_in_internal=0
                
                end if
                
                adjust_budget=0
                                
                if ((space_lived_in_internal_index>0) .AND. (exogenous_wages==1)) then
                
                    if (shut_down_housing_market==1) then
                    
                        write(*,*) "error internal budget"
                        
                    end if
                
                    adjust_budget=1
                    
                    rent_spent_1=&
                        (1-ownership_status_index_1)*&
                        rent(time_period)*&
                        space_lived_in_internal
                        
                    if ((space_lived_in_internal_index==0) .AND. &
                        (abs(rent_spent_1-(1-ownership_status_index_1)*&
                        rent(time_period)*housing_size(space_lived_in_index_1))>10.d0**(-12))) then
                        
                        write(*,*) "error rent paid"
                        
                    end if
                    
                    if ((mortgage_deductibility>0) .AND. (mortgage_index_1>1) .AND. &
                        (at_least_one_period_before_retirement==0)) then
                                                                                                            
                        ! Computes the mortgage on own home
                        mortgage_deductions_1=&
                            (1-at_least_one_period_before_retirement)*&
                            mortgage_deductibility*&
                            housing_price(time_period)*&
                            space_lived_in_internal*&
                            mortgage_grid(mortgage_index_1)*&
                            (mortgage_interest_rate(time_period)+&
                            (1-lender_index_1)*pay_mortgage_insurance_1*mortgage_insurance_premium+&
                            lender_index_1*premium_with_alternative_lenders)
                            
                        mortgage_deductions_tax_rebates_1=0
                            
                        do employment_index_1=&
                            at_least_one_period_before_retirement+&
                            (1-at_least_one_period_before_retirement)*1,&
                            at_least_one_period_before_retirement*0+&
                            (1-at_least_one_period_before_retirement)*employment_grid_size
                            
                            if ((have_unemployment==1) .AND. &
                                (employment_index_1==employment_grid_size)) then
                            
                                gross_wage_income_next_period_1=&
                                    unemploy_bene_frac_of_lowest_employ*&
                                    (what_is_the_program_solving*wage_calibrated+&
                                    (1-what_is_the_program_solving)*wage(time_period))*&
                                    employment_grid(employment_grid_size-1)
                                    
                            else
                        
                                ! Computing the wage income next period
                                gross_wage_income_next_period_1=&
                                    wage(time_period)*employment_grid(employment_index_1)*&
                                    labour_deterministic_efficiency(age_index+1)
                                    
                            end if
                                                         
                            ! Computing the average tax next period without mortgage deduction
                            call calculate_average_labour_income_tax&
                                (gross_wage_income_next_period_1,&
                                employment_grid_size,employment_index_1,&
                                wage(time_period))
                                
                            if ((employment_index_1==employment_grid_size) .AND. &
                                (labour_income_tax(employment_grid_size)==0) .AND. &
                                (average_labour_income_tax>0)) then
                            
                                write(*,*) "error jjjjjj"
                                write(*,*) "average_labour_income_tax=", &
                                    average_labour_income_tax
                                write(*,*) "employment_index_1=", &
                                    employment_index_1
                                write(*,*) "gross_wage_income_next_period_1=", &
                                    gross_wage_income_next_period_1
                                write(*,*) "labour_income_tax=", &
                                    labour_income_tax(employment_index_1)
                            
                            end if
                        
                            ! Calculates tax liability next period without MID
                            tax_liability_next_period_without_mortgage_deductions_1=&
                                average_labour_income_tax*&
                                gross_wage_income_next_period_1
                                                            
                            ! Computing the average tax paid next period with mortgage interest deductions
                            call calculate_average_labour_income_tax&
                                (max(gross_wage_income_next_period_1-&
                                mortgage_deductibility*mortgage_deductions_1,0.d0),&
                                employment_grid_size,employment_index_1,&
                                wage(time_period))
                            
                            ! Calculates tax liability next period with MID
                            tax_liability_next_period_with_mortgage_deductions_1=&
                                average_labour_income_tax*&
                                max((gross_wage_income_next_period_1-&
                                mortgage_deductibility*mortgage_deductions_1),0.d0)
                
                            ! Calculates expected tax savings next period with MID
                            mortgage_deductions_tax_rebates_1=&
                                mortgage_deductions_tax_rebates_1+&
                                (1-at_least_one_period_before_retirement)*&
                                employment_process(time_period,age_index,employment_index,employment_index_1)*&
                                (tax_liability_next_period_without_mortgage_deductions_1-&
                                tax_liability_next_period_with_mortgage_deductions_1)
                                
                        end do
                
                        if ((space_lived_in_internal_index==0) .AND. &
                            (abs(current_mortgage_deductions_tax_rebates_1-&
                            mortgage_deductions_tax_rebates_1)>10.d0**(-12))) then
                            
                            write(*,*) "errorr"
                            write(*,*) "current_mortgage_deductions_tax_rebates_1=", &
                                current_mortgage_deductions_tax_rebates_1
                            write(*,*) "mortgage_deductions_tax_rebates_1=", mortgage_deductions_tax_rebates_1
                            
                        end if
                                
                    else
        
                        mortgage_deductions_tax_rebates_1=0
            
                    end if
                    
                    if (endogenous_rental_market==1) then
                                                                                    
                        ! Computes the new rental income
                        rental_income_1=&
                            endogenous_rental_market*&
                            ownership_status_index_1*&
                            rent(time_period)*&
                            max((housing_size(housing_status_index_1)-&
                            space_lived_in_internal),0.d0)
                            
                        if ((rental_income_1>0) .AND.&
                            (abs(housing_size(housing_status_index_1)-space_lived_in_internal)<10.d0**(-7))) then
                            
                            write(*,*) "error rental"
                            
                        end if
                                            
                        ! Computes the new rental income tax paid
                        rental_income_tax_paid_1=&
                            ownership_status_index_1*&
                            (max(rent(time_period)-&
                            housing_price(min(time_period+&
                            property_tax_is_paid_on_current_period_tax*&
                            solving_transition*1,transition_length))*&
                            (housing_depreciation+&
                            property_tax(min(time_period+&
                            property_tax_is_paid_on_current_period_tax*&
                            solving_transition*1,transition_length))+&
                            (mortgage_grid(mortgage_index_1)*&
                            (mortgage_interest_rate(time_period)+&
                            (1-lender_index_1)*pay_mortgage_insurance_1*mortgage_insurance_premium+&
                            lender_index_1*premium_with_alternative_lenders))),0.d0))*&
                            max((housing_size(housing_status_index_1)-space_lived_in_internal),0.d0)
                                                    
                        rental_income_tax_paid_1=&
                            rental_income_tax*&
                            max(rental_income_tax_paid_1,0.d0)
                                                        
                        property_taxes_paid_1=&
                            ownership_status_index_1*&
                            property_tax(min(time_period+&
                            property_tax_is_paid_on_current_period_tax*&
                            solve_transition_dynamics*1,transition_length))*&
                            gross_housing_wealth_next_period_1
                                                                                    
                        if ((space_lived_in_internal_index==0) .AND. &
                            (abs(rental_income_tax_paid_2-rental_income_tax_paid_1)>10.d0**(-12))) then
                            
                            write(*,*) "error rental income tax"    
                    
                        end if
                        
                        if ((space_lived_in_internal_index==0) .AND. &
                            (abs(rental_income_1-(endogenous_rental_market*&
                            ownership_status_index_1*rent(time_period)*&
                            (housing_size(housing_status_index_1)-&
                            housing_size(space_lived_in_index_1))))>(10.d0)**(-12))) then
                        
                            write(*,*) "error rent income"
                        
                        end if
                                            
                    else
                    
                        mortgage_payments_1=&
                            ownership_status_index_1*&
                            housing_price(time_period)*&
                            space_lived_in_internal*&
                            mortgage_grid(mortgage_index_1)*&
                            (mortgage_interest_rate(time_period)+&
                            (1-lender_index_1)*pay_mortgage_insurance_1*mortgage_insurance_premium+&
                            lender_index_1*premium_with_alternative_lenders)
                            
                        investment_income_1=&
                            risk_free_rate(time_period)*&
                            (financial_grid(financial_index)-&
                            (ownership_status_index_1*&
                            housing_price(time_period)*&
                            space_lived_in_internal*&
                            (1-mortgage_grid(mortgage_index_1))))
                    
                        gross_housing_wealth_this_period_1=&
                            ownership_status_index_1*&
                            housing_price(time_period)*&
                            space_lived_in_internal
                            
                        gross_housing_wealth_next_period_1=&
                            ownership_status_index_1*&
                            housing_price(time_period+solve_transition_dynamics*1)*&
                            space_lived_in_internal
                            
                        gain_on_house_sale_1=&
                            ownership_status_index_1*&
                            (gross_housing_wealth_next_period_1-&
                            gross_housing_wealth_this_period_1)
                    
                        property_taxes_paid_1=&
                            ownership_status_index_1*&
                            property_tax(time_period+solve_transition_dynamics*1)*&
                            gross_housing_wealth_next_period_1
                                                    
                        housing_depreciation_1=&
                            ownership_status_index_1*&
                            housing_depreciation*&
                            gross_housing_wealth_next_period_1   
                    
                    end if
                    
                elseif (space_lived_in_internal_index==0) then
                                
                    rent_spent_1=&
                        (1-ownership_status_index_1)*&
                        rent(time_period)*&
                        space_lived_in_internal
                    mortgage_deductions_tax_rebates_1=optimal_mortgage_deductions_tax_rebates_1
                    mortgage_payments_1=optimal_mortgage_payments_1
                    investment_income_1=optimal_investment_income_1
                    rental_income_tax_paid_1=rental_income_tax_paid_optimal_1
                    rental_income_1=&
                        endogenous_rental_market*&
                        ownership_status_index_1*&
                        rent(time_period)*&
                        (housing_size(housing_status_index_1)-&
                        space_lived_in_internal)
                    property_taxes_paid_1=optimal_property_tax_paid_1
                    housing_depreciation_1=optimal_housing_depreciation_1
                    gain_on_house_sale_1=optimal_gain_on_house_sale_1
                    adjust_budget=0
                                        
                end if
                    
                after_tax_wealth_net_of_expenses_1=&
                    after_tax_wealth_net_of_expenses_1_copy
                    
                if ((ownership_status_index_1==0) .AND. &
                    (current_mortgage_deductions_tax_rebates_1>0)) then
                        
                    write(*,*) "error renter with mortgage deduction"
                        
                end if
                    
                if ((endogenous_rental_market==1) .AND. (exogenous_wages==1)) then
                    
                    ! Subtracts the rental income from the global optimum and 
                    ! add the rental income that would accrue in the current space lived in
                    after_tax_wealth_net_of_expenses_1=&
                        after_tax_wealth_net_of_expenses_1-&
                        adjust_budget*&
                        ((endogenous_rental_market*&
                        ownership_status_index_1*rent(time_period)*&
                        max((housing_size(housing_status_index_1)-&
                        housing_size(space_lived_in_index_1)),0.d0)-&
                        rental_income_tax_paid_2)-&
                        (rental_income_1-rental_income_tax_paid_1)-&
                        mortgage_deductibility*&
                        (mortgage_deductions_tax_rebates_1-&
                        current_mortgage_deductions_tax_rebates_1)+&
                        (property_taxes_paid_1-optimal_property_tax_paid_1)+&
                        (rent_spent_1-(1-ownership_status_index_1)*&
                        rent(time_period)*housing_size(housing_status_index_1)))
                        
                elseif ((endogenous_rental_market==0) .AND.(exogenous_wages==1)) then
                
                    ! Subtracts the rental income from the global optimum and 
                    ! add the rental income that would accrue in the current space lived in
                    after_tax_wealth_net_of_expenses_1=&
                        after_tax_wealth_net_of_expenses_1+&
                        adjust_budget*&
                        (ownership_status_index_1*&
                        mortgage_deductibility*&
                        (mortgage_deductions_tax_rebates_1-&
                        current_mortgage_deductions_tax_rebates_1)-&
                        ownership_status_index_1*&
                        (mortgage_payments_1-&
                        housing_price(time_period)*&
                        housing_size(space_lived_in_index_1)*&
                        mortgage_grid(mortgage_index_1)*&
                        (mortgage_interest_rate(time_period)+&
                        (1-lender_index_1)*pay_mortgage_insurance_1*mortgage_insurance_premium+&
                        lender_index_1*premium_with_alternative_lenders))+&
                        (gain_on_house_sale_1-&
                        ownership_status_index_1*&
                        (housing_price(time_period+solve_transition_dynamics*1)*&
                        housing_size(space_lived_in_index_1)-&
                        housing_price(time_period)*&
                        housing_size(space_lived_in_index_1)))-&
                        ownership_status_index_1*&
                        (housing_depreciation_1-&
                        housing_depreciation*&
                        housing_price(time_period+solve_transition_dynamics*1)*&
                        housing_size(space_lived_in_index_1))-&
                        ownership_status_index_1*&
                        (property_taxes_paid_1-&
                        property_tax(time_period+solve_transition_dynamics*1)*&
                        housing_price(time_period+solve_transition_dynamics*1)*&
                        housing_size(space_lived_in_index_1))-&
                        (rent_spent_1-(1-ownership_status_index_1)*&
                        rent(time_period)*housing_size(space_lived_in_index_1))+&
                        ownership_status_index_1*&
                        (1-investment_income_tax)*&
                        (investment_income_1-&
                        risk_free_rate(time_period)*&
                        (financial_grid(financial_index)-&
                        (ownership_status_index_1*&
                        housing_price(time_period)*&
                        housing_size(space_lived_in_index_1)*&
                        (1-mortgage_grid(mortgage_index_1))))))
                
                end if
                        
                if ((endogenous_rental_market==1) .AND. &
                   (rental_income_1>10.d0**(-2)) .AND. &
                   (abs(space_lived_in_internal-housing_size(housing_status_index_1))<10.d0**(-7))) then
                
                    write(*,*) "error"
                    write(*,*) "ownership_status_index_1=", ownership_status_index_1
                    write(*,*) "after_tax_wealth_net_of_expenses_1=", after_tax_wealth_net_of_expenses_1
                    write(*,*) "after_tax_wealth_net_of_expenses_1_copy=", after_tax_wealth_net_of_expenses_1_copy
                    write(*,*) "space_lived_in_internal=", space_lived_in_internal
                    write(*,*) "housing_size(housing_status_index_1)=", housing_size(housing_status_index_1)
                    write(*,*) "rental_income_1=", rental_income_1
                    write(*,*) "cop=", &
                        endogenous_rental_market*&
                            ownership_status_index_1*&
                            rent(time_period)*&
                            (housing_size(housing_status_index_1)-&
                            space_lived_in_internal)
                
                end if
                
                can_purchase_new_house=1
                
                if ((endogenous_rental_market==0) .AND. &
                    (ownership_status_index_1==1) .AND.&
                    (shut_down_housing_market==0)) then
                
                    ! Checks if the household has anything enough downpayment after paying for the house they want
                    if (((financial_grid(financial_index)-&
                        housing_price(time_period)*&
                        space_lived_in_internal*&
                        (1-mortgage_grid(mortgage_index_1))))>0) then
                                                                                                                                                                                        
                        spending_on_housing_1=&
                            space_lived_in_internal*&
                            housing_price(time_period)*&
                            (property_tax(time_period)+housing_depreciation*&
                            include_housing_depreciation_in_housing_costs+&
                            mortgage_grid(mortgage_index_1)*&
                            (fraction_of_mortgage_payment_going_to_principal+&
                            mortgage_interest_rate(time_period)+&
                            stress_test(time_period)+&
                            (1-lender_index_1)*&
                            pay_mortgage_insurance_1*mortgage_insurance_premium+&
                            lender_index_1*premium_with_alternative_lenders))
                                                                                        
                        ! Checks if the household can afford the TDS
                        ! but if they use an alternative lender they have no minimum requirement
                        if ((spending_on_housing_1/&
                            (optimal_gross_wage_income+&
                            investment_income_1))<=&
                            (lender_index_1*a_large_multiple_of_income+&
                            (1-lender_index_1)*max_mortgage_payments_as_fraction_of_income_1)) then
                            
                            can_purchase_new_house=1
                            
                        else
                        
                            can_purchase_new_house=0
                        
                        end if
                        
                    else
                    
                        can_purchase_new_house=0
                        
                    end if
                
                end if
                
                if (can_purchase_new_house==1) then
            
                    ! This is consumption for some financial choice the 
                    ! optimal consumption found earlier
                    consumption_internal_optimal_1=&
                        (after_tax_wealth_net_of_expenses_1-financial_internal)/&
                        (1+consumption_tax)
                                            
                    ! If consumption is positive then check if this consumption is better
                    ! than the earlier found optimal consumption
                    if (consumption_internal_optimal_1>0) then
                                                                                    
                        ! Finds the distance between the internal financial choice and the 
                        ! optimal financial choice
                        dis_internal_from_optimal_fin=&
                            financial_internal-financial_grid(fin_index_1)
                                                    
                        ! Considering a financial choice below the optimal one found
                        if (dis_internal_from_optimal_fin<0) then
                                                
                            ! Fraction of households who choose to move to a lower financial choice
                            ! is the distance between the new internal financial value choice and the optimal choice
                            ! divided by the distance between the optimal choice and the next lower choice
                            frac_mov_to_another_cell_1=&
                                abs(dis_internal_from_optimal_fin)/&
                                dis_prev_index_fin
                                                        
                            ! Saves the index of the cell that the fraction is moving to
                            ! Here they move to the previous index because the distance
                            ! is negative (new financial - old financial>0)
                            fin_index_frac_mov_to=&
                                fin_index_1-1
                                                
                        ! Considering a financial choice above the optimal one found
                        elseif (dis_internal_from_optimal_fin>0) then
                                            
                            ! Fraction of households who choose to move to the a higher financial choice
                            ! is the distance between the new internal financial value choice and the optimal choice
                            ! divided by the distance between the optimal choice and the next higher choice
                            frac_mov_to_another_cell_1=&
                                abs(dis_internal_from_optimal_fin)/&
                                dis_next_index_fin
                                                            
                            ! Saves the index of the cell the fraction is moving to
                            ! Here they move to a higher fiancial index (new financial - old financial>0)
                            fin_index_frac_mov_to=&
                                fin_index_1+1
                                                                                                        
                        ! This means we are considering the same financial choice as the optimal choice found
                        else
                                                                                                
                            ! No households move to the another grid point
                            frac_mov_to_another_cell_1=0
                                                                
                            ! Saves the index of the cell the fraction is moving to
                            ! Here they stay at the same index (new financial - old financial=0)
                            fin_index_frac_mov_to=&
                                fin_index_1
                                                                                                                
                        end if
                    
                        if ((abs(space_lived_in_internal-&
                            housing_size(housing_status_index_1))>10.d0**(-4)) .AND. &
                            (ownership_status_index_1==1)) then
                        
                            apply_disutility_of_landlords_1=1
                        
                        else
                    
                            apply_disutility_of_landlords_1=0
                    
                        end if
                    
                        ! Obtains the utility flow from renting
                        flow_utility_internal=&
                            (((space_lived_in_internal*&
                            (1+ownership_status_index_1*&
                            advantage_to_owning))**&
                            (relative_share_of_housing*(1-risk_aversion))*&
                            (consumption_internal_optimal_1)**&
                            (risk_aversion_share_of_cons))/&
                            (1-risk_aversion))+&
                            (1-shut_down_housing_market)*&
                            endogenous_rental_market*&
                            apply_disutility_of_landlords_1*&
                            disutility_of_landlords*&
                            (disutility_of_landlords_function_of_total_supply*&
                            (housing_size(housing_status_index_1)-&
                            space_lived_in_internal)**&
                            (power_to_raise_to_disutility_to)+&
                            (1-disutility_of_landlords_function_of_total_supply))
                                                                                           
                        future_utility_internal=0
                                            
                        ! Checks if the household cares about their child
                        if (add_utility_from_child==1) then
                                                                                    
                            ! Obtains the future utility
                            ! It is the probability of surviving to the next period
                            ! times the expected utility of a newly born household 
                            ! from the chocice of financial, housing and mortgage
                            ! ! in each state of the world 
                            ! times the probability of not surviving times the discount factor
                            future_utility_internal=&
                                future_utility_internal+&
                                (1-survival_probability(age_index))*&
                                weight_on_bequest*&
                                (frac_mov_to_another_cell_1*&
                                (financial_grid(fin_index_frac_mov_to)**&
                                (1-bequest_risk_aversion))/&
                                (1-bequest_risk_aversion)+&
                                (1-frac_mov_to_another_cell_1)*&
                                (financial_grid(fin_index_1)**&
                                (1-bequest_risk_aversion))/&
                                (1-bequest_risk_aversion))
                        
                        end if
                                                                                                                                       
                        ! Loops over all the possible future income states
                        ! When a household is before retirement they can only move into
                        ! one employment state, so I take that into account
                        do future_employment_index=&
                            at_least_one_period_before_retirement*employment_index+&
                            (1-at_least_one_period_before_retirement)*&
                            max(employment_index-1,1),&
                            at_least_one_period_before_retirement*employment_index+&
                            (1-at_least_one_period_before_retirement)*&
                            min(employment_index+1,employment_grid_size) 
                            
                            do future_productivity_shock_index=&
                                have_fixed_productivity*2+&
                                (1-have_fixed_productivity)*&
                                productivity_shock_index,&
                                have_fixed_productivity*2+&
                                (1-have_fixed_productivity)*&
                                productivity_shock_grid_size
                                                                        
                                future_utility_internal=&
                                    future_utility_internal+&
                                    discount_factor*&
                                    survival_probability(age_index)*&
                                    productivity_shock_process&
                                    (productivity_shock_index,future_productivity_shock_index)*&
                                    (probability_of_bad_shock_continuing(time_period)*&
                                    employment_process(1+solving_transition,age_index,&
                                    employment_index,future_employment_index)+&
                                    (1-probability_of_bad_shock_continuing(time_period))*&
                                    employment_process(1,age_index,&
                                    employment_index,future_employment_index))*&
                                    (frac_mov_to_another_cell_1*&                                  
                                    value_function&
                                    (min(time_period+solving_transition*1,&
                                    transition_length),age_index+1,&
                                    fin_index_frac_mov_to,&
                                    future_employment_index,&
                                    future_productivity_shock_index,&
                                    productivity_index)+&
                                    (1-frac_mov_to_another_cell_1)*&
                                    value_function&
                                    (min(time_period+solving_transition*1,&
                                    transition_length),age_index+1,fin_index_1,&
                                    future_employment_index,&
                                    future_productivity_shock_index,&
                                    productivity_index))
                                
                            end do
                                                                            
                        end do
                    
                        ! If there is unemployment, and the household is not close to retirement
                        ! and the household does not have a low income state
                        if ((have_unemployment==1) .AND. &
                            (at_least_one_period_before_retirement==0) .AND. &
                            (employment_index<(employment_grid_size-1))) then
                                                    
                            do future_employment_index=&
                                employment_grid_size,employment_grid_size
                                
                                do future_productivity_shock_index=&
                                    have_fixed_productivity*2+&
                                    (1-have_fixed_productivity)*&
                                    productivity_shock_index,&
                                    have_fixed_productivity*2+&
                                    (1-have_fixed_productivity)*&
                                    productivity_shock_grid_size
                                                                
                                    future_utility_internal=&
                                        future_utility_internal+&
                                        discount_factor*&
                                        survival_probability(age_index)*&
                                        productivity_shock_process&
                                        (productivity_shock_index,future_productivity_shock_index)*&
                                        (probability_of_bad_shock_continuing(time_period)*&
                                        employment_process(1+solving_transition,age_index,&
                                        employment_index,future_employment_index)+&
                                        (1-probability_of_bad_shock_continuing(time_period))*&
                                        employment_process(1,age_index,&
                                        employment_index,future_employment_index))*&
                                        (frac_mov_to_another_cell_1*&                                  
                                        value_function&
                                        (min(time_period+solving_transition*1,&
                                        transition_length),age_index+1,&
                                        fin_index_frac_mov_to,&
                                        future_employment_index,&
                                        future_productivity_shock_index,&
                                        productivity_index)+&
                                        (1-frac_mov_to_another_cell_1)*&
                                        value_function&
                                        (min(time_period+solving_transition*1,&
                                        transition_length),age_index+1,fin_index_1,&
                                        future_employment_index,&
                                        future_productivity_shock_index,&
                                        productivity_index))
                                        
                                end do
                                                                        
                            end do
                    
                        end if
                                                            
                        ! Finds the value function of this saving decision
                        val_fun_internal=&
                            flow_utility_internal+&
                            future_utility_internal
                                                    
                        ! Checks if the current choice is better than the previously found optimal choice
                        if (val_fun_internal>=val_fun) then
                
                            val_fun=val_fun_internal
                            
!                            if (val_fun==value_function_1) then
!                            
!                                write(*,*) "error value function is the same"
!                            
!                            end if
                                                                            
                            frac_mov_optimal_1&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)=&
                                frac_mov_to_another_cell_1
                                
                            fin_index_frac_mov_to_optimal&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)=&
                                fin_index_frac_mov_to
                        
                            policy_function_consumption&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)=&
                                consumption_internal_optimal_1
                            
                            space_lived_in_optimal_1=&
                                space_lived_in_internal
                                                  
                            after_tax_wealth_net_of_expenses_1_optimal=&
                                after_tax_wealth_net_of_expenses_1
                            
                            optimal_mortgage_deductions_tax_rebates_1=&
                                mortgage_deductions_tax_rebates_1
                                                            
                            rental_income_tax_paid_optimal_1=&
                                rental_income_tax_paid_1
                                
                            optimal_investment_income_1=&
                                investment_income_1
                            
                            if (abs(fin_index_frac_mov_to_optimal&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)-&
                                policy_function_financial&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index))>1) then
                            
                                write(*,*) "error"
                                write(*,*) "fin_index_frac_mov_to_optimal=", &
                                    fin_index_frac_mov_to_optimal&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                write(*,*) "policy_function_financial=", &
                                    policy_function_financial&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                        
                            end if
                        
                        end if
                        
                    else
                    
                        exit internal_loop_2
                        
                    end if
                                                                                
                end if
                
            end do internal_loop_2
                                    
        end do internal_loop_1
            
        val_fun_internal=val_fun
        
        policy_function_space_lived_in_size&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index)=&
            space_lived_in_optimal_1
                    
        optimal_after_tax_wealth_net_of_expenses=&
            after_tax_wealth_net_of_expenses_1_optimal
            
        policy_function_rental_income_tax_paid&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index)=&
            rental_income_tax_paid_optimal_1
            
        policy_function_mortgage_interest_deductions&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index)=&
            mortgage_deductibility*&
            optimal_mortgage_deductions_tax_rebates_1
            
        if (exogenous_wages==1) then
            
            policy_function_investment_income_tax_paid&
                (time_period,age_index,&
                financial_index,employment_index,&
                productivity_shock_index,&
                productivity_index)=&
                investment_income_tax*max(optimal_investment_income_1,0.d0)
                
            policy_function_investment_income&
                (time_period,age_index,&
                financial_index,employment_index,&
                productivity_shock_index,&
                productivity_index)=&
                max(optimal_investment_income_1,0.d0)
                
        end if
            
        if ((employment_index==employment_grid_size) .AND. &
            (have_unemployment==1)) then
            
            if ((policy_function_mortgage_interest_deductions&
                (time_period,age_index,financial_index,&
                employment_index,productivity_shock_index,&
                productivity_index)>0) .AND. &
                (increase_in_labour_income_tax==0)) then
            
                write(*,*) "policy_function_mortgage_interest_deductions=", &
                    policy_function_mortgage_interest_deductions&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)
                write(*,*) "employment_index=", employment_index
            
            end if
            
        end if
            
        !write(*,*) "index_of_smallest_house_hhld_can_buy=", index_of_smallest_house_hhld_can_buy
                
        if ((policy_function_space_lived_in_size&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index)==0) .AND. &
            (abs(housing_status_index_1-space_lived_in_index_1)==0) .AND. &
            (exogenous_wages==1)) then
                            
            write(*,*) "space_lived_in_optimal_1=",&
                        space_lived_in_optimal_1
            write(*,*) "housing_status_index_1=", housing_status_index_1
            write(*,*) "space_lived_in_index_1=", space_lived_in_index_1
            write(*,*) "slope_of_space_lived_in_internal=", slope_of_space_lived_in_internal
            write(*,*) "ownership_status_index_1=", ownership_status_index_1
                                                        
        end if
                
    end subroutine
    
    subroutine check_budget_constraint_clears(time_period,after_tax_wealth_net_of_expenses_1,financial_index)
        
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index
        integer :: time_period
        real(8) :: after_tax_wealth_net_of_expenses_1
                                                                                                            
        x=after_tax_wealth_net_of_expenses_1-&
            (frac_mov_optimal_1&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index)*&
            financial_grid(fin_index_frac_mov_to_optimal&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index))+&
            (1-frac_mov_optimal_1&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index))*&
            financial_grid(policy_function_financial&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index))+&
            (1+consumption_tax)*policy_function_consumption&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index))
                                                                        
        if ((abs(x)>5*10.d0**(-9)) .AND. &
           (policy_function_space_lived_in_size&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index)>smallest_house_size)) then
                         
                write(*,*) "error budget does not clear"
                write(*,*) "x=", x
                write(*,*) "policy_function_ownership_status=",&
                    policy_function_ownership_status&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)
                    
                write(*,*) "financial_index=", &
                    policy_function_financial&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)
                    
                write(*,*) "next_index=", &
                    fin_index_frac_mov_to_optimal&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)
                
                write(*,*) "frac_move=", &
                    frac_mov_optimal_1&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)
                
                write(*,*) "consumption+savings=",&
                    (frac_mov_optimal_1&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)*&
                    financial_grid(fin_index_frac_mov_to_optimal&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index))+&
                    (1-frac_mov_optimal_1&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index))*&
                    financial_grid(policy_function_financial&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index))+&
                    (1+consumption_tax)*policy_function_consumption&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index))
                    
                write(*,*) "after_tax_wealth_net_of_expenses_1=", &
                    after_tax_wealth_net_of_expenses_1
                
                write(*,*) "rental_income old=", &
                    policy_function_ownership_status&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)*&
                    rent(time_period)*&
                    (housing_size(policy_function_housing_status&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index))-&
                    housing_size(policy_function_space_lived_in_index&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)))
                
                write(*,*) "rental_income new=", &
                    policy_function_ownership_status&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)*&
                    rent(time_period)*&
                    (housing_size(policy_function_housing_status&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index))-&
                    policy_function_space_lived_in_size&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index))
                    
                write(*,*) "space lived in old=", &
                    housing_size(policy_function_space_lived_in_index&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index))
                    
                write(*,*) "space lived in new=", &
                    policy_function_space_lived_in_size&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)
                    
                write(*,*) "housing size=", &
                    housing_size(policy_function_housing_status&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index))
            
                write(*,*) "rent=", rent(time_period)
                    
                if (policy_function_space_lived_in_size&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index)>&
                    housing_size(policy_function_housing_status&
                    (time_period,age_index,financial_index,&
                    employment_index,productivity_shock_index,&
                    productivity_index))) then
                    
                    write(*,*) "error 2"
                    
                end if
                                    
        end if
            
        if ((value_function&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index)==large_negative_num) .AND. &
            (policy_function_space_lived_in_size&
            (time_period,age_index,financial_index,&
            employment_index,productivity_shock_index,&
            productivity_index)>smallest_house_size)) then
            
            write(*,*) "error value function"
            write(*,*) "after_tax_wealth_net_of_expenses_1=", after_tax_wealth_net_of_expenses_1
            write(*,*) "age_index=", age_index
            write(*,*) "employment_index=", employment_index
            write(*,*) "financial_index=", financial_index
            write(*,*) "productivity_index=", productivity_index
            write(*,*) "productivity_shock_index=", productivity_shock_index
                                                                                            
            negative_consumption=1
                        
        end if
    
    end subroutine
    
    subroutine type_of_household(productivity_index_2,string_to_use)
    
        use Wealth_Tax_Global_Vars
        
        integer, intent(in) :: productivity_index_2
        character*15, intent(out) :: string_to_use
        
        if (productivity_index_2==1) then
        
            string_to_use='type_1'
            
        elseif (productivity_index_2==2) then
        
            string_to_use='type_2'
            
        elseif (productivity_index_2==3) then
        
            string_to_use='type_3'
            
        elseif (productivity_index_2==4) then
        
            string_to_use='type_4'
            
        elseif (productivity_index_2==5) then
        
            string_to_use='type_5'
            
        elseif (productivity_index_2==6) then
        
            string_to_use='type_6'
            
        elseif (productivity_index_2==7) then
        
            string_to_use='type_7'
            
        elseif (productivity_index_2==8) then
        
            string_to_use='type_8'
            
        elseif (productivity_index_2==9) then
        
            string_to_use='type_9'
            
        end if
    
    end subroutine
    
    subroutine life_cycle_savings_decisions(time_period,financial_index_1,employment_index_1,&
                                            household_memebers_index_1,productivity_index_1)
    
        use Wealth_Tax_Global_Vars
        
        integer :: time_period,financial_index_1,employment_index_1,&
                    household_memebers_index_1,productivity_index_1,&
                    financial_index_2
                    
        character*15 :: household_type
        
        call type_of_household(productivity_index_1,household_type)
        
        financial_index_2=financial_index_1
                      
        ! Loops over all ages
        do age_index=1,life_span
        
            ! Records the savings decision in age age_index
            savings_decision_throughout_life_cycle&
                (age_index,financial_index_1,employment_index_1,&
                household_memebers_index_1,productivity_index_1)=&
                financial_grid(&
                policy_function_financial(&
                time_period,age_index,financial_index_2,employment_index_1,&
                household_memebers_index_1,productivity_index_1))
                            
            ! Sets the new financial index equal to the policy function
            ! for this given index
            financial_index_2=&
                policy_function_financial(&
                time_period,age_index,financial_index_2,employment_index_1,&
                household_memebers_index_1,productivity_index_1)
        
        end do
        
        ! Saving main simulation statistics
        open(unit=2,file="savings_decision_throughout_life_cycle"//trim(household_type)//".txt",&
            action="write",status="replace")
                    
        do age_index=1,life_span
                                
            write(2,*) savings_decision_throughout_life_cycle&
                (age_index,financial_index_1,employment_index_1,&
                household_memebers_index_1,productivity_index_1)
                
        end do
        
        close(2)
    
    end subroutine
    
    subroutine borrowing_or_lending_decisions(time_period,age_index_1,employment_index_1,&
                                            productivity_shock_index_1,productivity_index_1)
    
        use Wealth_Tax_Global_Vars
        
        integer :: time_period,age_index_1,financial_index_1,&
                    employment_index_1,productivity_index_1,&
                    productivity_shock_index_1
                    
        character*15 :: household_type
        
        call type_of_household(productivity_index_1,household_type)
                      
        ! Loops over all ages
        do financial_index_1=1,financial_grid_size
        
            ! Records the savings decision in age age_index
            borrow_or_lend_decision_by_wealth_level&
                (age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)=&
                policy_function_borrow_or_lend&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,productivity_index_1)
               
        end do
        
        ! Saving main simulation statistics
        open(unit=2,file="borrowing_or_lending_decision"//trim(household_type)//".txt",&
            action="write",status="replace")
                    
        do financial_index_1=1,financial_grid_size
                                
            write(2,*) borrow_or_lend_decision_by_wealth_level&
                (age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)
                
        end do
        
        close(2)
    
    end subroutine
    
    subroutine business_income_decisions(time_period,age_index_1,employment_index_1,&
                                            productivity_shock_index_1,productivity_index_1)
    
        use Wealth_Tax_Global_Vars
        
        integer :: time_period,age_index_1,financial_index_1,&
                    employment_index_1,productivity_index_1,&
                    productivity_shock_index_1
                    
        character*15 :: household_type
        
        call type_of_household(productivity_index_1,household_type)
                      
        ! Loops over all ages
        do financial_index_1=1,financial_grid_size
        
            ! Records the savings decision in age age_index
            business_income_by_wealth_level&
                (age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)=&
                policy_function_business_income&
                (time_period,age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)
                
            ! Records the savings decision in age age_index
            investment_income_by_wealth_level&
                (age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)=&
                policy_function_investment_income&
                (time_period,age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)
               
        end do
        
        ! Saving main simulation statistics
        open(unit=2,file="business_income_gross_decision"//trim(household_type)//".txt",&
            action="write",status="replace")
                    
        do financial_index_1=1,financial_grid_size
                                
            write(2,*) business_income_by_wealth_level&
                (age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)
                                
        end do
        
        close(2)
        
        ! Saving main simulation statistics
        open(unit=2,file="investment_income_gross_decision"//trim(household_type)//".txt",&
            action="write",status="replace")
                    
        do financial_index_1=1,financial_grid_size
                                
            write(2,*) investment_income_by_wealth_level&
                (age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)
                                
        end do
        
        close(2)
        
        ! Saving main simulation statistics
        open(unit=2,file="business_income_net_decision"//trim(household_type)//".txt",&
            action="write",status="replace")
                    
        do financial_index_1=1,financial_grid_size
                                
            write(2,*) business_income_by_wealth_level&
                (age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)-&
                policy_function_business_income_tax_paid&
                (time_period,age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)
                                
        end do
        
        close(2)
        
        ! Saving main simulation statistics
        open(unit=2,file="investment_income_net_decision"//trim(household_type)//".txt",&
            action="write",status="replace")
                    
        do financial_index_1=1,financial_grid_size
                                
            write(2,*) investment_income_by_wealth_level&
                (age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)-&
                policy_function_investment_income_tax_paid&
                (time_period,age_index_1,financial_index_1,employment_index_1,&
                productivity_shock_index_1,productivity_index_1)
                                
        end do
        
        close(2)
    
    end subroutine    
    
    ! This subroutine guesses an initial distribution 
    subroutine initialize_feasible_distribution(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period
                
        ! Sets all the elements in distribution_guess to 0
        distribution_guess=0
        
        distribution_guess(time_period,1,1,1,&
            2*(1-all_low_z_households_get_into_0_lane)+&
            productivity_shock_grid_size*all_low_z_households_get_into_0_lane,1)=1
        
        ! Starts by looping over all possible ages
        do age_index=2,life_span
            
            distribution_guess(time_period,age_index,1,1,&
                2*(1-all_low_z_households_get_into_0_lane)+&
                productivity_shock_grid_size*all_low_z_households_get_into_0_lane,1)=&
                survival_probability(age_index-1)*&
                distribution_guess(time_period,age_index-1,1,1,&
                2*(1-all_low_z_households_get_into_0_lane)+&
                productivity_shock_grid_size*all_low_z_households_get_into_0_lane,1)
            
        end do
                
        write(*,*) "sum(distribution_guess)=", sum(distribution_guess)
        
    end subroutine
    
    ! This subroutine, for a given housing price and a given distribution guess
    ! iterates until the distribution is stationary using the value function and
    ! policy functions solutions
    subroutine converge_to_stationary_equilibrium(time_period,solving_transition)
    
        use Wealth_Tax_Global_Vars
        !$ use omp_lib
               
        implicit none
        
        integer :: financial_index
        integer :: time_period
        integer :: solving_transition
        
        if (solving_transition>=0) then
        
            !$omp parallel
            !$omp master
            !$ total_number_of_threads=omp_get_num_threads()
!            write(*,*) "total_number_of_threads=", total_number_of_threads
            !$omp end master
            !$omp end parallel
                    
        end if
                
        if (time_period==2) then
        
            open(UNIT=12,file="distribution_stationary"//trim(benchmark_simulation)//".dat",action='read')
                read(12,'(F20.8)') distribution_guess(1,:,:,:,:,:)
            close(12)
            
            distribution_stationary(1,:,:,:,:,:)=distribution_guess(1,:,:,:,:,:)
            
            open(UNIT=13,file="policy_function_financial"//trim(benchmark_simulation)//".dat",action='read')
                read(13,'(I4)') policy_function_financial(1,:,:,:,:,:)
            close(13)
            
            policy_function_financial_before_changes=policy_function_financial(1,:,:,:,:,:)
            
            open(UNIT=14,file="fin_index_frac_mov_to_optimal"//trim(benchmark_simulation)//".dat",action='read')
                read(14,'(I3)') fin_index_frac_mov_to_optimal(1,:,:,:,:,:)
            close(14)
            
            fin_index_frac_mov_to_optimal_before_changes=fin_index_frac_mov_to_optimal(1,:,:,:,:,:)
            
            open(UNIT=15,file="frac_mov_optimal_1"//trim(benchmark_simulation)//".dat",action='read')
                read(15,'(F10.8)') frac_mov_optimal_1(1,:,:,:,:,:)
            close(15)
            
            frac_mov_optimal_1_before_changes=frac_mov_optimal_1(1,:,:,:,:,:)
            
            open(UNIT=16,file="policy_function_housing_status"//trim(benchmark_simulation)//".dat",action='read')
                read(16,'(I3)') policy_function_housing_status(1,:,:,:,:,:)
            close(16)
            
            open(UNIT=17,file="policy_function_mortgage"//trim(benchmark_simulation)//".dat",action='read')
                read(17,'(I3)') policy_function_mortgage(1,:,:,:,:,:)
            close(17)
            
            open(UNIT=18,file="policy_function_ownership_status"//trim(benchmark_simulation)//".dat",action='read')
                read(18,'(I3)') policy_function_ownership_status(1,:,:,:,:,:)
            close(18)
            
            if (readjust_financial_position==1) then
            
                call readjust_policy_function_financial(time_period-1)
                
            end if
        
        end if
        
        if ((what_is_the_program_solving==1) .AND. (solving_transition==1)) then
        
            write(*,*) "time_period=", time_period
        
        end if
        
        distance_distribution=1
                
        loop_count_dist=0
               
        ! Keeps looping untilt the distribution is stationary
        do while ((distance_distribution>stopping_rule_stationary_distribution))
                
            ! Starts the implied distribution at 0
            distribution_implied_private=0
            distribution_implied=0
            
             if (solving_transition>=0) then
        
                !$omp parallel
                !$omp master
                !$ total_number_of_threads=omp_get_num_threads()
!                write(*,*) "total_number_of_threads=", total_number_of_threads
                !$omp end master
                !$omp end parallel
                    
            end if
                
            ! Starts by looping over all possible ages
            do age_index=1,life_span-1
                
                ! Checks if the household is at least one period before retirement
                if (age_index>=(life_span-retirement_span)) then
                
                    at_least_one_period_before_retirement=1
                
                else
                
                    at_least_one_period_before_retirement=0
                
                end if
                                           
                !$omp parallel do default(none) &
                !$omp& shared(&
                !$omp& distribution_implied_private,distribution_guess,&
                !$omp& frac_mov_optimal_1,policy_function_financial,fin_index_frac_mov_to_optimal,&
                !$omp& time_period,solving_transition,at_least_one_period_before_retirement,&
                !$omp& survival_probability,employment_process,age_index,&
                !$omp& productivity_shock_process,productivity_grid)
!                                                            
                ! Loops over all possible financial wealth positions
                do financial_index=1,financial_grid_size
                    
!                    thread_num=0
                    !$ thread_num=omp_get_thread_num()
                                                                    
                    ! Loops over all income states
                    do employment_index=1,employment_grid_size
                    
                        do productivity_index=1,productivity_grid_size
                    
                            if (productivity_grid(productivity_index)<=1) then
            
                                can_have_best_productivity_shock=0
                        
                            else
            
                                can_have_best_productivity_shock=1
            
                            end if
        
                            do productivity_shock_index=&
                                have_fixed_productivity*2+&
                                (1-have_fixed_productivity)*&
                                (can_have_best_productivity_shock*1+&
                                (1-can_have_best_productivity_shock)*&
                                ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                                (1-all_low_z_households_get_into_0_lane)*2)),&
                                have_fixed_productivity*2+&
                                (1-have_fixed_productivity)*&
                                productivity_shock_grid_size
                                                
                                ! Loops over all possible future employment states
                                do future_employment_index=&
                                    at_least_one_period_before_retirement*employment_index+&
                                    (1-at_least_one_period_before_retirement)*1,&
                                    at_least_one_period_before_retirement*employment_index+&
                                    (1-at_least_one_period_before_retirement)*employment_grid_size
                                    
                                    do future_productivity_shock_index=&
                                        have_fixed_productivity*2+&
                                        (1-have_fixed_productivity)*&
                                        productivity_shock_index,&
                                        have_fixed_productivity*2+&
                                        (1-have_fixed_productivity)*&
                                        productivity_shock_grid_size
                                                                           
                                        distribution_implied_private&
                                            (thread_num+1,age_index+1,&
                                            policy_function_financial&
                                            (min(time_period-solving_transition*1,&
                                            transition_length),&
                                            age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index),&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            productivity_index)=&
                                            (1-frac_mov_optimal_1&   ! The fraction moving to this cell
                                            (min(time_period-solving_transition*1,&
                                            transition_length),&
                                            age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index))*&
                                            survival_probability(age_index)*&
                                            productivity_shock_process&
                                            (productivity_shock_index,future_productivity_shock_index)*&
                                            employment_process&
                                            (time_period-solving_transition*1,age_index,&
                                            employment_index,future_employment_index)*&
                                            distribution_guess&
                                            (min(time_period-solving_transition*1,&
                                            transition_length),&
                                            age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)+&
                                            distribution_implied_private&
                                            (thread_num+1,age_index+1,&
                                            policy_function_financial&
                                            (min(time_period-solving_transition*1,&
                                            transition_length),&
                                            age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index),&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            productivity_index)
                                                
                                        distribution_implied_private&
                                            (thread_num+1,age_index+1,&
                                            fin_index_frac_mov_to_optimal&
                                            (min(time_period-solving_transition*1,&
                                            transition_length),&
                                            age_index,financial_index,&
                                            employment_index,&
                                            productivity_shock_index,&
                                            productivity_index),&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            productivity_index)=&
                                            frac_mov_optimal_1&   ! The fraction moving to this cell
                                            (min(time_period-solving_transition*1,&
                                            transition_length),&
                                            age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)*&
                                            survival_probability(age_index)*&
                                            productivity_shock_process&
                                            (productivity_shock_index,future_productivity_shock_index)*&
                                            employment_process&
                                            (time_period-solving_transition*1,age_index,&
                                            employment_index,future_employment_index)*&
                                            distribution_guess&
                                            (min(time_period-solving_transition*1,&
                                            transition_length),age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)+&
                                            distribution_implied_private&
                                            (thread_num+1,age_index+1,&
                                            fin_index_frac_mov_to_optimal&
                                            (min(time_period-solving_transition*1,&
                                            transition_length),&
                                            age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index),&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            productivity_index)
                                        
                                    end do
                                    
                                end do
                                    
                            end do
                                            
                        end do
                    
                    end do
            
                end do
                
                !$omp end parallel do
                            
            end do
            
            if (solving_transition>=0) then
        
                !$omp parallel
                !$omp master
                !$ total_number_of_threads=omp_get_num_threads()
!                write(*,*) "total_number_of_threads=", total_number_of_threads
                !$omp end master
                !$omp end parallel
                    
            end if
            
            do age_index=1,life_span
                                    
                !$omp parallel do default(none) &
                !$omp& shared(&
                !$omp& distribution_implied_private,distribution_guess,&
                !$omp& frac_mov_optimal_1,policy_function_financial,fin_index_frac_mov_to_optimal,&
                !$omp& time_period,solving_transition,at_least_one_period_before_retirement,&
                !$omp& survival_probability,unconditional_employment_probability,age_index,&
                !$omp& unconditional_productivity_shock_probability,productivity_process,productivity_grid)
                                                                            
                ! Loops over all possible financial wealth positions
                do financial_index=1,financial_grid_size
                
!                    thread_num=0
                    !$ thread_num=omp_get_thread_num()
                                                                            
                    ! Loops over all income states
                    do employment_index=1,employment_grid_size
                    
                        ! Loops over all possible productivities
                        do productivity_index=1,productivity_grid_size  
        
                            if (productivity_grid(productivity_index)<=1) then
                        
                                can_have_best_productivity_shock=0
                            
                            else
                        
                                can_have_best_productivity_shock=1
                        
                            end if
                    
                            do productivity_shock_index=&
                                have_fixed_productivity*2+&
                                (1-have_fixed_productivity)*&
                                (can_have_best_productivity_shock*1+&
                                (1-can_have_best_productivity_shock)*&
                                ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                                (1-all_low_z_households_get_into_0_lane)*2)),&
                                have_fixed_productivity*2+&
                                (1-have_fixed_productivity)*&
                                productivity_shock_grid_size
                                                                            
                                ! Loops over all possible future employment states
                                do future_employment_index=1,employment_grid_size
                                
                                    do future_productivity_index=1,productivity_grid_size
                                
                                        if (productivity_grid(future_productivity_index)<=1) then
                                    
                                            can_have_best_future_productivity_shock=0
                                        
                                        else
                                
                                            can_have_best_future_productivity_shock=1
                                    
                                        end if
                            
                                        do future_productivity_shock_index=&
                                            have_fixed_productivity*2+&
                                            (1-have_fixed_productivity)*&
                                            (can_have_best_future_productivity_shock*1+&
                                            (1-can_have_best_future_productivity_shock)*&
                                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                                            (1-all_low_z_households_get_into_0_lane)*2)),&
                                            have_fixed_productivity*2+&
                                            (1-have_fixed_productivity)*&
                                            productivity_shock_grid_size
                                                                        
                                            distribution_implied_private&
                                                (thread_num+1,1,&
                                                policy_function_financial&
                                                (min(time_period-solving_transition*1,transition_length),&
                                                age_index,financial_index,&
                                                employment_index,productivity_shock_index,&
                                                productivity_index),&
                                                future_employment_index,&
                                                future_productivity_shock_index,&
                                                future_productivity_index)=&
                                                (1-frac_mov_optimal_1&   ! The fraction moving to this cell
                                                (min(time_period-solving_transition*1,transition_length),&
                                                age_index,financial_index,&
                                                employment_index,productivity_shock_index,&
                                                productivity_index))*&
                                                (1-survival_probability(age_index))*&
                                                productivity_process&
                                                (productivity_index,future_productivity_index)*&
                                                unconditional_productivity_shock_probability&
                                                (future_productivity_index,future_productivity_shock_index)*&
                                                unconditional_employment_probability&
                                                (time_period-solving_transition*1,future_employment_index)*&
                                                distribution_guess&
                                                (min(time_period-solving_transition*1,transition_length),&
                                                age_index,financial_index,&
                                                employment_index,productivity_shock_index,&
                                                productivity_index)+&
                                                distribution_implied_private&
                                                (thread_num+1,1,&
                                                policy_function_financial&
                                                (min(time_period-solving_transition*1,transition_length),&
                                                age_index,financial_index,&
                                                employment_index,productivity_shock_index,&
                                                productivity_index),&
                                                future_employment_index,&
                                                future_productivity_shock_index,&
                                                future_productivity_index)
                                    
                                            distribution_implied_private&
                                                (thread_num+1,1,&
                                                fin_index_frac_mov_to_optimal&
                                                (min(time_period-solving_transition*1,transition_length),&
                                                age_index,financial_index,&
                                                employment_index,productivity_shock_index,&
                                                productivity_index),&
                                                future_employment_index,&
                                                future_productivity_shock_index,&
                                                future_productivity_index)=&
                                                frac_mov_optimal_1&   ! The fraction moving to this cell
                                                (min(time_period-solving_transition*1,transition_length),&
                                                age_index,financial_index,&
                                                employment_index,productivity_shock_index,&
                                                productivity_index)*&
                                                (1-survival_probability(age_index))*&
                                                productivity_process&
                                                (productivity_index,future_productivity_index)*&
                                                unconditional_productivity_shock_probability&
                                                (future_productivity_index,future_productivity_shock_index)*&
                                                unconditional_employment_probability&
                                                (time_period-solving_transition*1,future_employment_index)*&
                                                distribution_guess&
                                                (min(time_period-solving_transition*1,transition_length),&
                                                age_index,financial_index,&
                                                employment_index,productivity_shock_index,&
                                                productivity_index)+&
                                                distribution_implied_private&
                                                (thread_num+1,1,&
                                                fin_index_frac_mov_to_optimal&
                                                (min(time_period-solving_transition*1,transition_length),&
                                                age_index,financial_index,&
                                                employment_index,productivity_shock_index,&
                                                productivity_index),&
                                                future_employment_index,&
                                                future_productivity_shock_index,&
                                                future_productivity_index)
                                                
                                        end do
                                        
                                    end do
                                        
                                end do
                                    
                            end do
                                        
                        end do
                        
                    end do
                    
                end do
                
                !$omp end parallel do
                
            end do
            
            if (solving_transition>=0) then
        
                !$omp parallel
                !$omp master
                !$ total_number_of_threads=omp_get_num_threads()
!                write(*,*) "total_number_of_threads=", total_number_of_threads
                !$omp end master
                !$omp end parallel
                    
            end if
                        
            do age_index=1,life_span
                        
                !$omp parallel do default(none) &
                !$omp& shared(&
                !$omp& distribution_implied_private,distribution_implied,&
                !$omp& total_number_of_threads,time_period,age_index,productivity_grid)
                                                                            
                ! Loops over all possible financial wealth positions
                do financial_index=1,financial_grid_size
                                                                                            
                    ! Loops over all income states
                    do employment_index=1,employment_grid_size
                    
                        ! Loops over all possible productivities
                        do productivity_index=1,productivity_grid_size  
                        
                            if (productivity_grid(productivity_index)<=1) then
                    
                                can_have_best_productivity_shock=0
                            
                            else
                        
                                can_have_best_productivity_shock=1
                        
                            end if
                    
                            do productivity_shock_index=&
                                have_fixed_productivity*2+&
                                (1-have_fixed_productivity)*&
                                (can_have_best_productivity_shock*1+&
                                (1-can_have_best_productivity_shock)*&
                                ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                                (1-all_low_z_households_get_into_0_lane)*2)),&
                                have_fixed_productivity*2+&
                                (1-have_fixed_productivity)*&
                                productivity_shock_grid_size
                        
                                do thread_index=1,total_number_of_threads
                                
                                    distribution_implied&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)=&
                                        distribution_implied&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)+&
                                        distribution_implied_private&
                                        (thread_index,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)
                                        
                                end do
                            
                            end do
                            
                        end do
                        
                    end do
                    
                end do
                
                !$omp end parallel do
                
            end do
                        
            if (solving_transition==0) then
            
                ! Returns the maximmum distance between any two elements in the distributions
                distance_distribution=&
                    maxval(abs(distribution_implied(time_period,:,:,:,:,:)-&
                    distribution_guess(time_period,:,:,:,:,:)))
                    
            else
            
                distance_distribution=0
                    
            end if
            
            if (minval(distribution_implied)<0) then
            
                write(*,*) "minval distribution_implied=", minval(distribution_implied)            
            
            end if
            
            if (abs(sum(distribution_guess(time_period-solving_transition*1,:,:,:,:,:))-&
                sum(distribution_implied(time_period,:,:,:,:,:)))>10.d0**(-10)) then
                                
                write(*,*) "sum(distribution_guess(",time_period-solving_transition*1,")=", &
                    sum(distribution_guess(time_period-solving_transition*1,:,:,:,:,:))
                write(*,*) "sum(distribution_implied(",time_period,")=", &
                    sum(distribution_implied(time_period,:,:,:,:,:))
                    
            end if
            
            if (solving_transition==0) then
                
                write(*,*) "distribution distance=", distance_distribution
                
            end if
                
            ! Updates the guess
            distribution_guess(time_period,:,:,:,:,:)=&
                distribution_implied(time_period,:,:,:,:,:)
                        
            loop_count_dist=loop_count_dist+1
        
        end do
                
        ! Sets the stationary distribution to the distribution the code converged to 
        distribution_stationary(time_period,:,:,:,:,:)=distribution_implied(time_period,:,:,:,:,:)
                    
    end subroutine
    
    ! In transition, this subroutine adjusts the net wealth of household as a result of changes in house prices
    subroutine readjust_policy_function_financial(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period
        integer :: financial_index
        real(8) :: average_net_wealth_in_stationary_equilibrium
        
        do age_index=1,life_span
                                                                            
            ! Loops over all possible financial wealth positions
            do financial_index=1,financial_grid_size
                                                                            
                ! Loops over all income states
                do employment_index=1,employment_grid_size
                    
                    ! Loops over all possible productivities
                    do productivity_index=1,productivity_grid_size  
                    
                        if (productivity_grid(productivity_index)<=1) then
                
                            can_have_best_productivity_shock=0
                        
                        else
                    
                            can_have_best_productivity_shock=1
                    
                        end if
                
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                    
                            ! Checks if the household is a homeowner in the first period
                            if (policy_function_ownership_status&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)==1) then
                                
                                ! Computing the average financail savings for the household who is a homeowner
                                average_net_wealth_in_stationary_equilibrium=&
                                    (frac_mov_optimal_1&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    financial_grid&
                                    (fin_index_frac_mov_to_optimal&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))+&
                                    (1-frac_mov_optimal_1&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))*&
                                    financial_grid&
                                    (policy_function_financial&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)))
                            
                                call compute_value_of_assets&
                                    (time_period,age_index,financial_index,employment_index,&
                                    productivity_shock_index,productivity_index,&
                                    average_net_wealth_in_stationary_equilibrium)
                                                                                                       
                                ! Finds the location that is closest to the
                                ! original point minus the loss or profit on the house
                                ! which includes the difference in sale and the difference in 
                                ! depreciation, property tax and housing tax
                                new_location_for_financial=&
                                    minloc(abs(&
                                    (financial_grid&
                                    (policy_function_financial&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))+&
                                    max(left_over_wealth_after_selling_house_this_period,&
                                    -net_housing_wealth_last_period)+&
                                    (expected_property_taxes_to_be_paid_this_period-&
                                    actual_property_taxes_paid_this_period)+&
                                    (expected_depreciation_this_period-&
                                    actual_depreciation_this_period))-&
                                    financial_grid),1)
                                    
                                policy_function_financial&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)=&
                                    new_location_for_financial 
                            
                                if (average_net_wealth_after_selling_house>=&
                                    financial_grid(financial_grid_size)) then
                            
                                    policy_function_financial&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)=financial_grid_size
                                    
                                    fin_index_frac_mov_to_optimal&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)=financial_grid_size
                                    
                                    frac_mov_optimal_1&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)=0                         
                            
                                elseif (average_net_wealth_after_selling_house<=financial_grid(1)) then
                                    
                                    policy_function_financial&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)=1
                                    
                                    fin_index_frac_mov_to_optimal&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)=1
                                    
                                    frac_mov_optimal_1&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)=0
                                        
                                else
                        
                                    ! Checks if the new point is on the grid is below the 
                                    ! new net wealth
                                    if (financial_grid&
                                        (new_location_for_financial)<&
                                        average_net_wealth_after_selling_house) then
                                
                                        new_location_for_optimal_fin_move_to=&
                                            min(new_location_for_financial+1,financial_grid_size)
                                        
                                        ! keeps raising the new location for the optimal fin move to
                                        ! if the wealth point at the current locationis not above
                                        ! the avergage net wealth after selling the house
                                        ! but stops if the new location is equal to the highest grid point
                                        do while ((financial_grid&
                                            (new_location_for_optimal_fin_move_to)<&
                                            average_net_wealth_after_selling_house) .AND. &
                                            (new_location_for_optimal_fin_move_to<financial_grid_size))
                                        
                                            new_location_for_optimal_fin_move_to=&
                                                min(new_location_for_optimal_fin_move_to+1,&
                                                financial_grid_size)
                                    
                                        end do
                                        
                                    ! in this case the new point on the grid is above the average 
                                    ! net wealth after selling the house
                                    elseif (financial_grid&
                                            (new_location_for_financial)>&
                                            average_net_wealth_after_selling_house) then
                                    
                                        new_location_for_optimal_fin_move_to=&
                                            max(new_location_for_financial-1,1)
                                    
                                        ! keeps lowering the new location for the optimal fin move to
                                        ! if the wealth point at the current locationis not below
                                        ! the avergage net wealth after selling the house
                                        ! but stops if the new location is equal to the lowest grid point
                                        do while ((financial_grid&
                                            (new_location_for_optimal_fin_move_to)>&
                                            average_net_wealth_after_selling_house) .AND. &
                                            (new_location_for_optimal_fin_move_to>1))
                                            
                                            new_location_for_optimal_fin_move_to=&
                                                max(new_location_for_optimal_fin_move_to-1,1)
                                        
                                        end do
                                
                                    ! Here the new point on the grid is exactly equals to the new net wealth 
                                    ! after selling the house
                                    else
                                
                                        new_location_for_optimal_fin_move_to=&
                                            new_location_for_financial
                                    
                                    end if
                                    
                                    fin_index_frac_mov_to_optimal&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)=&
                                        new_location_for_optimal_fin_move_to    
                            
                                    if ((new_location_for_financial>new_location_for_optimal_fin_move_to) .OR. &
                                        (new_location_for_financial<new_location_for_optimal_fin_move_to)) then
                            
                                        ! Computes the new optial financial
                                        frac_mov_optimal_1&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)=&
                                            abs(average_net_wealth_after_selling_house-&
                                            financial_grid(new_location_for_financial))/&
                                            abs(financial_grid(new_location_for_optimal_fin_move_to)-&
                                            financial_grid(new_location_for_financial))
                                    
                                    ! In this case, they are the same
                                    else
                                
                                        frac_mov_optimal_1&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)=0
                                    
                                    end if
                                    
                                end if
                                    
                            end if
                        
                        end do
                        
                    end do
                                            
                end do
                
            end do
            
        end do
                
    end subroutine
    
    subroutine compute_value_of_assets&
        (time_period,age_index_1,financial_index_1,employment_index_1,&
        productivity_shock_index_1,productivity_index_1,net_wealth_1)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period,age_index_1,financial_index_1,employment_index_1,productivity_shock_index_1,&
            productivity_index_1
        real(8) :: net_wealth_1

        if (endogenous_rental_market==1) then
                            
            ! Computes the gross value of the house when it was bought
            gross_housing_wealth_last_period=&
                housing_price(time_period)*&
                housing_size&
                (policy_function_housing_status&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1))
                                                                                                
            ! Computes total mortgage debt last period
            mortgage_debt_last_period=&
                housing_price(time_period)*&
                housing_size&
                (policy_function_housing_status&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1))*&
                mortgage_grid&
                (policy_function_mortgage&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1))
    
            ! Computes the net housing value the hhld had last period
            net_housing_wealth_last_period=&
                gross_housing_wealth_last_period-&
                mortgage_debt_last_period
    
            ! Computes the value of the house this period
            gross_housing_wealth_this_period=&
                housing_price&
                (min(time_period+1,transition_length))*&
                housing_size&
                (policy_function_housing_status&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1))
        
            gross_housing_wealth_space_lived_in_this_period=&
                housing_price&
                (min(time_period+1,transition_length))*&
                policy_function_space_lived_in_size&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1)
        
            gross_housing_wealth_space_rented_out_this_period=&
                housing_price&
                (min(time_period+1,transition_length))*&
                max((housing_size&
                (policy_function_housing_status&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1))-&
                policy_function_space_lived_in_size&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1)),0.d0)
        
        else

            ! Computes the gross value of the house when it was bought
            gross_housing_wealth_last_period=&
                housing_price(time_period)*&
                policy_function_space_lived_in_size&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1)
    
            ! Computes total mortgage debt last period
            mortgage_debt_last_period=&
                housing_price(time_period)*&
                policy_function_space_lived_in_size&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1)*&
                mortgage_grid&
                (policy_function_mortgage&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1))
    
            ! Computes the net housing value the hhld had last period
            net_housing_wealth_last_period=&
                gross_housing_wealth_last_period-&
                mortgage_debt_last_period
    
            ! Computes the value of the house this period
            gross_housing_wealth_this_period=&
                housing_price&
                (min(time_period+1,transition_length))*&
                policy_function_space_lived_in_size&
                (time_period,age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1)

        end if

        if (bailout_household_if_net_equity_is_negative==1) then
                                        
            ! Computing the value leftover after selling the house
            ! if the value is below zero it is assumed that the government will
            ! pay it
            left_over_wealth_after_selling_house_this_period=&
                (gross_housing_wealth_this_period-&
                gross_housing_wealth_last_period)
            
            ! Checks the household defaults on a house that is worth less than
            ! its
            if ((left_over_wealth_after_selling_house_this_period+&
                net_housing_wealth_last_period)<0) then
        
                ! This the loss to the bank
                policy_function_loss_on_house&
                    (age_index_1,financial_index_1,&
                    employment_index_1,productivity_shock_index_1,&
                    productivity_index_1)=&
                    (left_over_wealth_after_selling_house_this_period+&
                    net_housing_wealth_last_period)*(-1.d0)
        
            end if
    
            ! Computes the net wealth leftoer after selling the
            ! house with a new price
            average_net_wealth_after_selling_house=&
                net_wealth_1+&
                max(left_over_wealth_after_selling_house_this_period,&
                -net_housing_wealth_last_period)
            
        else

            left_over_wealth_after_selling_house_this_period=&
                net_wealth_1+&
                (gross_housing_wealth_this_period-&
                gross_housing_wealth_last_period) 
        
            ! Checks the household defaults on a house that is worth less than
            ! its
            if (left_over_wealth_after_selling_house_this_period<0) then
    
                ! This the loss to the bank
                policy_function_loss_on_house&
                    (age_index_1,financial_index_1,&
                    employment_index_1,productivity_shock_index_1,&
                    productivity_index_1)=&
                    (left_over_wealth_after_selling_house_this_period)*(-1.d0)
    
            end if
    
            ! Computes the net wealth leftoer after selling the
            ! house with a new price
            average_net_wealth_after_selling_house=&
                max(left_over_wealth_after_selling_house_this_period,0.d0)
        
        end if

        if (endogenous_rental_market==0) then
            
            ! Actual property taxes paid this period
            actual_property_taxes_paid_this_period=&
                (property_tax(min(time_period+&
                property_tax_is_paid_on_current_period_tax*&
                solve_transition_dynamics*1,transition_length)))*&
                gross_housing_wealth_this_period
                                        
            ! Property taxes expected to pay this period
            expected_property_taxes_to_be_paid_this_period=&
                property_tax(time_period)*&
                gross_housing_wealth_last_period
        
        else

            ! Actual property taxes paid this period
            actual_property_taxes_paid_this_period=&
                (property_tax(min(time_period+&
                property_tax_is_paid_on_current_period_tax*&
                solve_transition_dynamics*1,transition_length)))*&
                gross_housing_wealth_this_period
    
            !!!! need to add this and account for renters too 
            !!!! if want to include transition
            
            ! Property taxes expected to pay this period
            expected_property_taxes_to_be_paid_this_period=&
                property_tax(time_period)*&
                gross_housing_wealth_last_period
            
        end if
                                        
        ! Actual depreciation
        actual_depreciation_this_period=&
            housing_depreciation*&
            gross_housing_wealth_this_period
            
        ! Expected depreciation
        expected_depreciation_this_period=&
            housing_depreciation*&
            gross_housing_wealth_last_period
        
        average_net_wealth_after_selling_house=&
            average_net_wealth_after_selling_house+&
            (expected_property_taxes_to_be_paid_this_period-&
            actual_property_taxes_paid_this_period)+&
            (expected_depreciation_this_period-&
            actual_depreciation_this_period)
            
        ! Checks the household defaults on a house that is worth less than
        ! its
        if (average_net_wealth_after_selling_house<0) then
                            
            ! This the loss to the bank
            policy_function_loss_on_house&
                (age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1)=&
                policy_function_loss_on_house&
                (age_index_1,financial_index_1,&
                employment_index_1,productivity_shock_index_1,&
                productivity_index_1)+&
                (average_net_wealth_after_selling_house)*(-1.d0)
                    
            average_net_wealth_after_selling_house=0
                               
        end if
                        
    end subroutine
    
    subroutine compute_initial_distribution_of_homeowners(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index,time_period
                
        do age_index=1,life_span
            
            do financial_index=1,financial_grid_size
                
                do employment_index=1,employment_grid_size
                
                    ! Loops over all possible productivities
                    do productivity_index=1,productivity_grid_size  
                    
                        if (productivity_grid(productivity_index)<=1) then
                
                            can_have_best_productivity_shock=0
                        
                        else
                    
                            can_have_best_productivity_shock=1
                    
                        end if
                
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                                
                            ! Checks if the household in period 1 was a homeowner
                            if (policy_function_housing_status&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)==1) then
                               
                                ! Makes the distribution of adjusted homeowners
                                ! equal to stationary distribution 
                                distribution_homeowners&
                                    (1,time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)=&
                                    distribution_stationary_benchmark&
                                    (age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                
                                ! Makes the distribution of unadjusted homeowners
                                ! equal to stationary distribution 
                                distribution_homeowners&
                                    ((1-solve_transition_dynamics)+&
                                    solve_transition_dynamics*2,&
                                    time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)=&
                                    distribution_stationary_benchmark&
                                    (age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                                
                            end if
                            
                        end do
                    
                    end do
                    
                end do
                
            end do
            
        end do
    
    end subroutine
    
    ! Computes where homeowners in period 1 end up in the distribution and what their value functions
    ! and where homeowners in period 1 would have been in the distribution and what their what their value function would be if 
    subroutine compute_future_distribution_of_homeowners(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index,time_period
                
        do age_index=1,life_span
            
            do financial_index=1,financial_grid_size
                
                do employment_index=1,employment_grid_size
                    
                    ! Loops over all possible productivities
                    do productivity_index=1,productivity_grid_size  
                    
                        if (productivity_grid(productivity_index)<=1) then
                
                            can_have_best_productivity_shock=0
                        
                        else
                    
                            can_have_best_productivity_shock=1
                    
                        end if
                
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                                                                                        
                            adjusted_next_financial_index=& 
                                policy_function_financial&
                                (time_period-1,age_index,&
                                financial_index,&
                                employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                                
                            adjusted_next_fin_move_to_index=&
                                fin_index_frac_mov_to_optimal&
                                (time_period-1,age_index,&
                                financial_index,&
                                employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                                
                            adjusted_next_frac_move_to_optimal=&
                                frac_mov_optimal_1&
                                (time_period-1,age_index,&
                                financial_index,&
                                employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                    
                            next_financial_index=& 
                                policy_function_financial_before_changes&
                                (age_index,financial_index,&
                                employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                                    
                            next_fin_move_to_index=&
                                fin_index_frac_mov_to_optimal_before_changes&
                                (age_index,financial_index,&
                                employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                                
                            next_frac_move_to_optimal=&
                                frac_mov_optimal_1_before_changes&
                                (age_index,financial_index,&
                                employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                            
                            ! Computes the fraction in each income state for surviving households
                            do future_employment_index=1,employment_grid_size
                            
                                do future_productivity_shock_index=&
                                    have_fixed_productivity*2+&
                                    (1-have_fixed_productivity)*&
                                    productivity_shock_index,&
                                    have_fixed_productivity*2+&
                                    (1-have_fixed_productivity)*&
                                    productivity_shock_grid_size
                                                                                                                                                        
                                    ! Gets the value function of the adjusted homeowner
                                    distribution_homeowners&
                                        (1,time_period,min(age_index+1,life_span),&
                                        adjusted_next_financial_index,&
                                        future_employment_index,&
                                        future_productivity_shock_index,&
                                        productivity_index)=&
                                        distribution_homeowners&
                                        (1,time_period,min(age_index+1,life_span),&
                                        adjusted_next_financial_index,&
                                        future_employment_index,&
                                        future_productivity_shock_index,&
                                        productivity_index)+&
                                        (1-adjusted_next_frac_move_to_optimal)*&
                                        survival_probability(age_index)*&
                                        productivity_shock_process&
                                        (productivity_shock_index,future_productivity_shock_index)*&
                                        employment_process&
                                        (time_period,age_index,&
                                        employment_index,future_employment_index)*&
                                        distribution_homeowners&
                                        (1,time_period-1,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)
                                
                                    ! Gets the value function of the adjusted homeowner
                                    distribution_homeowners&
                                        (1,time_period,min(age_index+1,life_span),&
                                        adjusted_next_fin_move_to_index,&
                                        future_employment_index,&
                                        future_productivity_shock_index,&
                                        productivity_index)=&
                                        distribution_homeowners&
                                        (1,time_period,min(age_index+1,life_span),&
                                        adjusted_next_fin_move_to_index,&
                                        future_employment_index,&
                                        future_productivity_shock_index,&
                                        productivity_index)+&
                                        adjusted_next_frac_move_to_optimal*&
                                        survival_probability(age_index)*&
                                        productivity_shock_process&
                                        (productivity_shock_index,future_productivity_shock_index)*&
                                        employment_process&
                                        (time_period,age_index,&
                                        employment_index,future_employment_index)*&
                                        distribution_homeowners&
                                        (1,time_period-1,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)
                                    
                                    ! Gets the value function of the adjusted homeowner
                                    distribution_homeowners&
                                        ((1-solve_transition_dynamics)+&
                                        solve_transition_dynamics*2,&
                                        time_period,min(age_index+1,life_span),&
                                        next_financial_index,&
                                        future_employment_index,&
                                        future_productivity_shock_index,&
                                        productivity_index)=&
                                        distribution_homeowners&
                                        ((1-solve_transition_dynamics)+&
                                        solve_transition_dynamics*2,&
                                        time_period,min(age_index+1,life_span),&
                                        next_financial_index,&
                                        future_employment_index,&
                                        future_productivity_shock_index,&
                                        productivity_index)+&
                                        (1-next_frac_move_to_optimal)*&
                                        survival_probability(age_index)*&
                                        productivity_shock_process&
                                        (productivity_shock_index,future_productivity_shock_index)*&
                                        employment_process&
                                        (time_period,age_index,&
                                        employment_index,future_employment_index)*&
                                        distribution_homeowners&
                                        ((1-solve_transition_dynamics)+&
                                        solve_transition_dynamics*2,&
                                        time_period-1,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)
                                
                                    ! Gets the value function of the adjusted homeowner
                                    distribution_homeowners&
                                        ((1-solve_transition_dynamics)+&
                                        solve_transition_dynamics*2,&
                                        time_period,min(age_index+1,life_span),&
                                        next_fin_move_to_index,&
                                        future_employment_index,&
                                        future_productivity_shock_index,&
                                        productivity_index)=&
                                        distribution_homeowners&
                                        ((1-solve_transition_dynamics)+&
                                        solve_transition_dynamics*2,&
                                        time_period,min(age_index+1,life_span),&
                                        next_fin_move_to_index,&
                                        future_employment_index,&
                                        future_productivity_shock_index,&
                                        productivity_index)+&
                                        next_frac_move_to_optimal*&
                                        survival_probability(age_index)*&
                                        productivity_shock_process&
                                        (productivity_shock_index,future_productivity_shock_index)*&
                                        employment_process&
                                        (time_period,age_index,&
                                        employment_index,future_employment_index)*&
                                        distribution_homeowners&
                                        ((1-solve_transition_dynamics)+&
                                        solve_transition_dynamics*2,&
                                        time_period-1,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)
                                        
                                end do
                                
                            end do
                        
                            ! Computes the fraction in each income state next period for newborns
                            do future_employment_index=1,employment_grid_size
                            
                                do future_productivity_index=1,productivity_grid_size
                                        
                                    if (productivity_grid(future_productivity_index)<=1) then
                                
                                        can_have_best_future_productivity_shock=0
                                    
                                    else
                            
                                        can_have_best_future_productivity_shock=1
                                
                                    end if
                        
                                    do future_productivity_shock_index=&
                                        have_fixed_productivity*2+&
                                        (1-have_fixed_productivity)*&
                                        (can_have_best_future_productivity_shock*1+&
                                        (1-can_have_best_future_productivity_shock)*&
                                        ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                                        (1-all_low_z_households_get_into_0_lane)*2)),&
                                        have_fixed_productivity*2+&
                                        (1-have_fixed_productivity)*&
                                        productivity_shock_grid_size
                                                                                                
                                        ! Gets the value function of the adjusted homeowner
                                        distribution_homeowners&
                                            (1,time_period,1,&
                                            adjusted_next_financial_index,&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            future_productivity_index)=&
                                            distribution_homeowners&
                                            (1,time_period,1,&
                                            adjusted_next_financial_index,&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            future_productivity_index)+&
                                            (1-adjusted_next_frac_move_to_optimal)*&
                                            (1-survival_probability(age_index))*&
                                            productivity_process&
                                            (productivity_index,future_productivity_index)*&
                                            unconditional_productivity_shock_probability&
                                            (future_productivity_index,future_productivity_shock_index)*&
                                            unconditional_employment_probability&
                                            (time_period,future_employment_index)*&
                                            distribution_homeowners&
                                            (1,time_period-1,age_index,&
                                            financial_index,employment_index,&
                                            productivity_shock_index,&
                                            productivity_index)
                                
                                        ! Gets the value function of the adjusted homeowner
                                        distribution_homeowners&
                                            (1,time_period,1,&
                                            adjusted_next_fin_move_to_index,&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            future_productivity_index)=&
                                            distribution_homeowners&
                                            (1,time_period,1,&
                                            adjusted_next_fin_move_to_index,&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            future_productivity_index)+&
                                            adjusted_next_frac_move_to_optimal*&
                                            (1-survival_probability(age_index))*&
                                            productivity_process&
                                            (productivity_index,future_productivity_index)*&
                                            unconditional_productivity_shock_probability&
                                            (future_productivity_index,future_productivity_shock_index)*&
                                            unconditional_employment_probability&
                                            (time_period,future_employment_index)*&
                                            distribution_homeowners&
                                            (1,time_period-1,age_index,&
                                            financial_index,employment_index,&
                                            productivity_shock_index,&
                                            productivity_index)
                                    
                                        ! Gets the value function of the adjusted homeowner
                                        distribution_homeowners&
                                            ((1-solve_transition_dynamics)+&
                                            solve_transition_dynamics*2,&
                                            time_period,1,&
                                            next_financial_index,&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            future_productivity_index)=&
                                            distribution_homeowners&
                                            ((1-solve_transition_dynamics)+&
                                            solve_transition_dynamics*2,&
                                            time_period,1,&
                                            next_financial_index,&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            future_productivity_index)+&
                                            (1-next_frac_move_to_optimal)*&
                                            (1-survival_probability(age_index))*&
                                            productivity_process&
                                            (productivity_index,future_productivity_index)*&
                                            unconditional_productivity_shock_probability&
                                            (future_productivity_index,future_productivity_shock_index)*&
                                            unconditional_employment_probability&
                                            (time_period,future_employment_index)*&
                                            distribution_homeowners&
                                            ((1-solve_transition_dynamics)+&
                                            solve_transition_dynamics*2,&
                                            time_period-1,age_index,&
                                            financial_index,employment_index,&
                                            productivity_shock_index,&
                                            productivity_index)
                                
                                        ! Gets the value function of the adjusted homeowner
                                        distribution_homeowners&
                                            ((1-solve_transition_dynamics)+&
                                            solve_transition_dynamics*2,&
                                            time_period,1,&
                                            next_fin_move_to_index,&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            future_productivity_index)=&
                                            distribution_homeowners&
                                            ((1-solve_transition_dynamics)+&
                                            solve_transition_dynamics*2,&
                                            time_period,1,&
                                            next_fin_move_to_index,&
                                            future_employment_index,&
                                            future_productivity_shock_index,&
                                            future_productivity_index)+&
                                            next_frac_move_to_optimal*&
                                            (1-survival_probability(age_index))*&
                                            productivity_process&
                                            (productivity_index,future_productivity_index)*&
                                            unconditional_productivity_shock_probability&
                                            (future_productivity_index,future_productivity_shock_index)*&
                                            unconditional_employment_probability&
                                            (time_period,future_employment_index)*&
                                            distribution_homeowners&
                                            ((1-solve_transition_dynamics)+&
                                            solve_transition_dynamics*2,&
                                            time_period-1,age_index,&
                                            financial_index,employment_index,&
                                            productivity_shock_index,&
                                            productivity_index)
                                            
                                    end do
                                    
                                end do
                                    
                            end do
                                                                    
                        end do
                            
                    end do
                    
                end do
                
            end do
            
        end do
    
    end subroutine
    
    ! Computes where homeowners in period 1 end up in the distribution and what their value functions
    ! and where homeowners in period 1 would have been in the distribution and what their what their value function would be if 
    subroutine compute_future_value_function_homeowners(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index,time_period
        
        value_function_homeowners(:)=0
                
        do age_index=1,life_span
            
            do financial_index=1,financial_grid_size
                
                do employment_index=1,employment_grid_size
                
                    ! Loops over all possible productivities
                    do productivity_index=1,productivity_grid_size  
    
                        if (productivity_grid(productivity_index)<=1) then
                    
                            can_have_best_productivity_shock=0
                        
                        else
                    
                            can_have_best_productivity_shock=1
                    
                        end if
                
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                
                            value_function_homeowners(1)=&
                                value_function_homeowners(1)+&
                                (value_function&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)+&
                                utility_from_public_consumption_counter&
                                (age_index,time_period))*&
                                distribution_homeowners&
                                (1,time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                            
                            value_function_homeowners&
                                ((1-solve_transition_dynamics)+&
                                solve_transition_dynamics*2)=&
                                value_function_homeowners&
                                ((1-solve_transition_dynamics)+&
                                solve_transition_dynamics*2)+&
                                (value_function&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)+&
                                utility_from_public_consumption_bench(age_index))*&
                                distribution_homeowners&
                                ((1-solve_transition_dynamics)+&
                                solve_transition_dynamics*2,&
                                time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                        
                        end do
                       
                    end do
                    
                end do
                
            end do
            
        end do
    
    end subroutine
    
    subroutine solve_prices(time_period,solve_house_price)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period,solve_house_price,loop_count_iterations
        real(8) :: lower_bound,upper_bound,distance_lower_bound,distance_upper_bound
        real(8) :: percentage_change_in_price
        integer :: equal_weights=1
        real(8) :: percetange_chage=0.02
        
        loop_count_iterations=0
        
        ! Computing the total demand and total supply of rentals
        ! and total demand and total supply of housing
        call calculate_total_housing_and_demand_and_supply(time_period)
        
        write(*,*) "using slicing method"
        
        ! The program focuses on converging on house prices
        if (solve_house_price==1) then
        
            percentage_change_in_price=percetange_chage*&
                min(abs(housing_stock(time_period)-total_housing_demand(time_period)),2.d0)
        
            write(*,*) "original housing_price=", &
                housing_price(time_period)
            write(*,*) "original housing price supply minus demand=", &
                housing_stock(time_period)-total_housing_demand(time_period)
            write(*,*) "percentage_change_in_price=", &
                percentage_change_in_price
        
            ! The supply is larger than the demand so this gives an upper bound on the house price
            if (housing_stock(time_period)>total_housing_demand(time_period)) then
            
                ! Sets the upper bound to the house price
                upper_bound=housing_price(time_period)
                
                ! Computes the distance between supply and demand
                distance_upper_bound=abs(housing_stock(time_period)-total_housing_demand(time_period))
                
                ! Decreases the house price by percentage_change_in_price
                ! to find a price for which demand is great than supply
                housing_price(time_period)=upper_bound*(1-percentage_change_in_price)
                
                ! Computes the value function and policy functions for that price
                call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                
                loop_count_iterations=loop_count_iterations+1
                
                ! Computing the total demand and total supply of rentals
                ! and total demand and total supply of housing for the new house price
                call calculate_total_housing_and_demand_and_supply(time_period)
                               
                ! As long as the supply is still greater than the demand, 
                ! the program keeps reduce the house price
                do while (housing_stock(time_period)>total_housing_demand(time_period))
                
                    write(*,*) "time_period=", time_period
                    write(*,*) "housing_price(time_period)=", housing_price(time_period)
                    write(*,*) "keep reducing house price, supply minus demand=", &
                        housing_stock(time_period)-total_housing_demand(time_period)
                    
                    ! Reduces the house price more
                    housing_price(time_period)=housing_price(time_period)*(1-percentage_change_in_price)    
                    
                    ! Computes the value function and policy functions for that price
                    call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                
                    loop_count_iterations=loop_count_iterations+1
                
                    ! Computing the total demand and total supply of rentals
                    ! and total demand and total supply of housing for the new house price
                    call calculate_total_housing_and_demand_and_supply(time_period)
                
                end do
                
                ! Computes the difference between the housing supply and the housing demand
                distance_lower_bound=abs(housing_stock(time_period)-total_housing_demand(time_period))
                
                ! Sets the lower bound equal to the house proce
                lower_bound=housing_price(time_period)
                
                write(*,*) "lower_bound=", lower_bound
                write(*,*) "start to slice"
                
                ! Cpmputes a new price
                housing_price(time_period)=&
                    equal_weights*(lower_bound+upper_bound)/2+&
                    (1-equal_weights)*&
                    ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                    (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                
                ! Keeps 
                do while (abs(lower_bound-upper_bound)>5*10.d0**(-4))
                
                    ! Computes the value function and policy functions for that price
                    call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                    
                    loop_count_iterations=loop_count_iterations+1
                
                    ! Computing the total demand and total supply of rentals
                    ! and total demand and total supply of housing for the new house price
                    call calculate_total_housing_and_demand_and_supply(time_period)
                    
                    if (housing_stock(time_period)>total_housing_demand(time_period)) then
                    
                        upper_bound=housing_price(time_period)
                        
                        ! Computes the distance between supply and demand
                        distance_upper_bound=abs(housing_stock(time_period)-total_housing_demand(time_period))
                       
                    else
                    
                        lower_bound=housing_price(time_period)
                        
                        ! Computes the distance between supply and demand
                        distance_lower_bound=abs(housing_stock(time_period)-total_housing_demand(time_period))
                        
                    end if
                    
                    ! Cpmputes a new price
                    housing_price(time_period)=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                        
                    write(*,*) "housing_price(time_period)=", &
                        housing_price(time_period)
                    write(*,*) "upper_bound=", upper_bound
                    write(*,*) "lower_bound=", lower_bound
                    write(*,*) "abs(upper_bound-lower_bound)=", &
                        abs(upper_bound-lower_bound)
                                    
                end do
                
            else
            
                ! Sets the lower bound to the housing price
                lower_bound=housing_price(time_period)
                
                ! Computes the distance between the housing supply and housing demand
                distance_lower_bound=abs(housing_stock(time_period)-total_housing_demand(time_period))
                                
                ! Increase the house price by percentage_change_in_price
                ! to find a price for which demand is great than supply
                housing_price(time_period)=lower_bound*(1+percentage_change_in_price)
                
                ! Computes the value function and policy functions for that price
                call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                
                loop_count_iterations=loop_count_iterations+1
                
                ! Computing the total demand and total supply of rentals
                ! and total demand and total supply of housing for the new house price
                call calculate_total_housing_and_demand_and_supply(time_period)
                               
                ! As long as the supply is still greater than the demand, 
                ! the program keeps reduce the house price
                do while (housing_stock(time_period)<total_housing_demand(time_period))
                
                    write(*,*) "time_period=", time_period
                    write(*,*) "housing_price(time_period)=", housing_price(time_period)
                    write(*,*) "keep increasing house price, supply minus demand=", &
                        housing_stock(time_period)-total_housing_demand(time_period)
                    
                    ! Reduces the house price more
                    housing_price(time_period)=housing_price(time_period)*(1+percentage_change_in_price)    
                    
                    ! Computes the value function and policy functions for that price
                    call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                    
                    loop_count_iterations=loop_count_iterations+1
                
                    ! Computing the total demand and total supply of rentals
                    ! and total demand and total supply of housing for the new house price
                    call calculate_total_housing_and_demand_and_supply(time_period)
                
                end do
                
                ! Computes the difference between the housing supply and the housing demand
                distance_upper_bound=abs(housing_stock(time_period)-total_housing_demand(time_period))
                
                ! Sets the lower bound equal to the house proce
                upper_bound=housing_price(time_period)
                
                write(*,*) "upper_bound=", lower_bound
                write(*,*) "start to slice"
                
                ! Cpmputes a new price
                housing_price(time_period)=&
                    equal_weights*(lower_bound+upper_bound)/2+&
                    (1-equal_weights)*&
                    ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                    (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                
                ! Keeps looping until the upper and lower bounds are close
                do while (abs(lower_bound-upper_bound)>5*10.d0**(-4))
                
                    ! Computes the value function and policy functions for that price
                    call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                    
                    loop_count_iterations=loop_count_iterations+1
                
                    ! Computing the total demand and total supply of rentals
                    ! and total demand and total supply of housing for the new house price
                    call calculate_total_housing_and_demand_and_supply(time_period)
                    
                    if (housing_stock(time_period)>total_housing_demand(time_period)) then
                    
                        upper_bound=housing_price(time_period)
                        
                        ! Computes the distance between supply and demand
                        distance_upper_bound=abs(housing_stock(time_period)-total_housing_demand(time_period))
                        
                    else
                    
                        lower_bound=housing_price(time_period)
                        
                        ! Computes the distance between supply and demand
                        distance_lower_bound=abs(housing_stock(time_period)-total_housing_demand(time_period))
                        
                    end if
                    
                    ! Cpmputes a new price
                    housing_price(time_period)=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                        
                    write(*,*) "housing_price(time_period)=", &
                        housing_price(time_period)
                    write(*,*) "upper_bound=", upper_bound
                    write(*,*) "lower_bound=", lower_bound
                    write(*,*) "abs(upper_bound-lower_bound)=", &
                        abs(upper_bound-lower_bound)
                
                end do
            
            end if
                    
        elseif (solve_house_price==0) then
        
            percentage_change_in_price=percetange_chage*&
                min(abs(total_rental_supply(time_period)-total_rental_demand(time_period)),2.d0)
        
            write(*,*) "original rent=", &
                rent(time_period)
            write(*,*) "original rent supply minus demand=", &
                total_rental_supply(time_period)-total_rental_demand(time_period)
            write(*,*) "percentage_change_in_price=", &
                percentage_change_in_price
        
            ! The supply is larger than the demand so this gives an upper bound on the house price
            if (total_rental_supply(time_period)>total_rental_demand(time_period)) then
            
                ! Sets the upper bound to the house price
                upper_bound=rent(time_period)
                
                ! Computes the distance between supply and demand
                distance_upper_bound=abs(total_rental_supply(time_period)-total_rental_demand(time_period))
                
                ! Decreases the house price by percentage_change_in_price
                ! to find a price for which demand is great than supply
                rent(time_period)=upper_bound*(1-percentage_change_in_price)
                
                ! Computes the value function and policy functions for that price
                call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                
                loop_count_iterations=loop_count_iterations+1
                
                ! Computing the total demand and total supply of rentals
                ! and total demand and total supply of housing for the new house price
                call calculate_total_housing_and_demand_and_supply(time_period)
                               
                ! As long as the supply is still greater than the demand, 
                ! the program keeps reduce the house price
                do while (total_rental_supply(time_period)>total_rental_demand(time_period))
                
                    write(*,*) "time_period=", time_period
                    write(*,*) "rent(time_period)=", rent(time_period)
                    write(*,*) "keep reducing rental price, supply minus demand=", &
                        total_rental_supply(time_period)-total_rental_demand(time_period)
                    
                    ! Reduces the house price more
                    rent(time_period)=rent(time_period)*(1-percentage_change_in_price)    
                    
                    ! Computes the value function and policy functions for that price
                    call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                    
                    loop_count_iterations=loop_count_iterations+1
                
                    ! Computing the total demand and total supply of rentals
                    ! and total demand and total supply of housing for the new house price
                    call calculate_total_housing_and_demand_and_supply(time_period)
                
                end do
                
                ! Computes the difference between the housing supply and the housing demand
                distance_lower_bound=abs(total_rental_supply(time_period)-total_rental_demand(time_period))
                
                ! Sets the lower bound equal to the house proce
                lower_bound=rent(time_period)
                
                write(*,*) "lower_bound=", lower_bound
                write(*,*) "start to slice"
                
                ! Cpmputes a new price
                rent(time_period)=&
                    equal_weights*(lower_bound+upper_bound)/2+&
                    (1-equal_weights)*&
                    ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                    (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                
                ! Keeps 
                do while (abs(lower_bound-upper_bound)>10.d0**(-3))
                
                    ! Computes the value function and policy functions for that price
                    call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                    
                    loop_count_iterations=loop_count_iterations+1
                
                    ! Computing the total demand and total supply of rentals
                    ! and total demand and total supply of housing for the new house price
                    call calculate_total_housing_and_demand_and_supply(time_period)
                    
                    if (total_rental_supply(time_period)>total_rental_demand(time_period)) then
                    
                        upper_bound=rent(time_period)
                        
                        ! Computes the distance between supply and demand
                        distance_upper_bound=abs(total_rental_supply(time_period)-total_rental_demand(time_period))
                        
                    else
                    
                        lower_bound=rent(time_period)
                        
                        ! Computes the distance between supply and demand
                        distance_lower_bound=abs(total_rental_supply(time_period)-total_rental_demand(time_period))
                                            
                    end if
                    
                    ! Cpmputes a new price
                    rent(time_period)=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                        
                    write(*,*) "rent(time_period)=", &
                        rent(time_period)
                    write(*,*) "upper_bound=", upper_bound
                    write(*,*) "lower_bound=", lower_bound
                    write(*,*) "abs(upper_bound-lower_bound)=", &
                        abs(upper_bound-lower_bound)
                
                end do
                
            else
            
                ! Sets the lower bound to the housing price
                lower_bound=rent(time_period)
                
                ! Computes the distance between the housing supply and housing demand
                distance_lower_bound=abs(total_rental_supply(time_period)-total_rental_demand(time_period))
                                
                ! Increase the house price by percentage_change_in_price
                ! to find a price for which demand is great than supply
                rent(time_period)=lower_bound*(1+percentage_change_in_price)
                
                ! Computes the value function and policy functions for that price
                call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                
                loop_count_iterations=loop_count_iterations+1
                
                ! Computing the total demand and total supply of rentals
                ! and total demand and total supply of housing for the new house price
                call calculate_total_housing_and_demand_and_supply(time_period)
                               
                ! As long as the supply is still greater than the demand, 
                ! the program keeps reduce the house price
                do while (total_rental_supply(time_period)<total_rental_demand(time_period))
                
                    write(*,*) "time_period=", time_period
                    write(*,*) "rent(time_period)=", rent(time_period)
                    write(*,*) "keep increasing rent, supply minus demand=", &
                        total_rental_supply(time_period)-total_rental_demand(time_period)
                    
                    ! Reduces the house price more
                    rent(time_period)=rent(time_period)*(1+percentage_change_in_price)    
                    
                    ! Computes the value function and policy functions for that price
                    call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                    
                    loop_count_iterations=loop_count_iterations+1
                
                    ! Computing the total demand and total supply of rentals
                    ! and total demand and total supply of housing for the new house price
                    call calculate_total_housing_and_demand_and_supply(time_period)
                
                end do
                
                ! Computes the difference between the housing supply and the housing demand
                distance_upper_bound=abs(total_rental_supply(time_period)-total_rental_demand(time_period))
                
                ! Sets the lower bound equal to the house proce
                upper_bound=rent(time_period)
                
                write(*,*) "upper_bound=", upper_bound
                write(*,*) "start to slice"
                
                ! Cpmputes a new price
                rent(time_period)=&
                    equal_weights*(lower_bound+upper_bound)/2+&
                    (1-equal_weights)*&
                    ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                    (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                
                ! Keeps looping until the upper and lower bounds are close
                do while (abs(lower_bound-upper_bound)>10.d0**(-3))
                
                    ! Computes the value function and policy functions for that price
                    call solve_value_function_and_policy_functions(time_period,solve_transition_dynamics)
                    
                    loop_count_iterations=loop_count_iterations+1
                
                    ! Computing the total demand and total supply of rentals
                    ! and total demand and total supply of housing for the new house price
                    call calculate_total_housing_and_demand_and_supply(time_period)
                    
                    if (total_rental_supply(time_period)>total_rental_demand(time_period)) then
                    
                        upper_bound=rent(time_period)
                        
                        ! Computes the distance between supply and demand
                        distance_upper_bound=abs(total_rental_supply(time_period)-total_rental_demand(time_period))
                                            
                    else
                    
                        lower_bound=rent(time_period)
                        
                        ! Computes the distance between supply and demand
                        distance_lower_bound=abs(total_rental_supply(time_period)-total_rental_demand(time_period))
                       
                    end if
                    
                    ! Cpmputes a new price
                    rent(time_period)=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                        
                    write(*,*) "rent(time_period)=", &
                        rent(time_period)
                    write(*,*) "upper_bound=", upper_bound
                    write(*,*) "lower_bound=", lower_bound
                    write(*,*) "abs(upper_bound-lower_bound)=", &
                        abs(upper_bound-lower_bound)
                
                end do
                            
            end if
        
        end if
        
        write(*,*) "housing_stock(time_period)-total_housing_demand(time_period)=", &
            housing_stock(time_period)-total_housing_demand(time_period)
        write(*,*) "total_rental_supply(time_period)-total_rental_demand(time_period)=", &
            total_rental_supply(time_period)-total_rental_demand(time_period)
    
    end subroutine
    
    subroutine calculate_total_housing_and_demand_and_supply(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period,financial_index
        
        ! Calculating the total housing demand
        total_housing_demand(time_period)=0
        total_rental_demand(time_period)=0
        total_rental_supply(time_period)=0
            
        ! Calculating average labour income earning in the model
        ! Loops over all working individuals
        do age_index=1,life_span
                
            ! Loops over all financial wealth options
            do financial_index=1,financial_grid_size
            
                ! Loops over all employment statuses
                do employment_index=1,employment_grid_size   
                
                    ! Loops over all possible productivities
                    do productivity_index=1,productivity_grid_size  
    
                        if (productivity_grid(productivity_index)<=1) then
                    
                            can_have_best_productivity_shock=0
                        
                        else
                    
                            can_have_best_productivity_shock=1
                    
                        end if
                
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                    
                            total_housing_demand(time_period)=&
                                total_housing_demand(time_period)+&
                                policy_function_space_lived_in_size&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)*&
                                distribution_stationary&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,&
                                productivity_index)
                            
                            ! Checks if the household is a renter
                            if (policy_function_ownership_status&
                                (time_period,age_index,&
                                financial_index,employment_index,&
                                productivity_shock_index,productivity_index)==0) then
                            
                                total_rental_demand(time_period)=&
                                    total_rental_demand(time_period)+&
                                    policy_function_space_lived_in_size&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,&
                                    financial_index,employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)
                                
                            else
                    
                                if (endogenous_rental_market==1) then
                            
                                    total_rental_supply(time_period)=&
                                        total_rental_supply(time_period)+&
                                        (housing_size&
                                        (policy_function_housing_status&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index))-&
                                        policy_function_space_lived_in_size&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index))*&
                                        distribution_stationary&
                                        (time_period,age_index,&
                                        financial_index,employment_index,&
                                        productivity_shock_index,&
                                        productivity_index)
                                    
                                end if
                                    
                            end if  
                            
                        end do
                        
                    end do
                                                    
                end do
                
            end do                
                
        end do  
        
        housing_stock(time_period)=&
            (1/housing_depreciation)*&
            ((housing_price(time_period))/&
            (c_1_calibrated))**&
            (empirical_housing_supplpy_elasticity)
    
    end subroutine
        
    ! This is a function that creates the utility advantage from owning a house
    subroutine function_of_utility_advantage_from_homeowning(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period
        
        total_constrcution_profits(time_period)=0
        
        ! Checks if there is a housing market and if I allow the housing market to adjust and if I am running counter-factuals
        if ((what_is_the_program_solving==1) .AND. & 
           (solve_transition_dynamics==0) .AND. &
           (shut_down_housing_market==0)) then
           
            ! Computes the housing stock for the given housing price
            housing_stock(time_period)=&
                (1/housing_depreciation)*&
                ((housing_price(time_period))/&
                (c_1_calibrated))**&
                (empirical_housing_supplpy_elasticity)
                
            ! Computing the total value of housing investment
            housing_investment(time_period)=&
                (housing_price(time_period)/&
                c_1_calibrated)**&
                (empirical_housing_supplpy_elasticity)
                            
            ! Computes profits for the constrcution company
            construction_company_profits(time_period)=0
            construction_company_profits(time_period)=construction_company_profits(time_period)+&
                max((housing_price(time_period)-c_min_calibrated)*&
                cutoff_housing_investment_calibrated,0.d0)
            construction_company_profits(time_period)=construction_company_profits(time_period)+&
                max(housing_price(time_period)*&
                (housing_investment(time_period)-&
                cutoff_housing_investment_calibrated)-&
                ((c_1_calibrated*(housing_investment(time_period))**&
                ((1/empirical_housing_supplpy_elasticity)+1))/&
                ((1/empirical_housing_supplpy_elasticity)+1)-&
                (c_1_calibrated*(cutoff_housing_investment_calibrated)**&
                ((1/empirical_housing_supplpy_elasticity)+1))/&
                ((1/empirical_housing_supplpy_elasticity)+1)),0.d0)
                    
            total_constrcution_profits(time_period)=&
                total_constrcution_profits(time_period)+&
                construction_company_profits(time_period)                
            
            ! Computes total construction profits per household
            construction_company_profits_per_household(time_period)=&
                total_constrcution_profits(time_period)/total_population
                                        
            write(*,*) "housing_price to stationary price", &
                housing_price(time_period)/&
                calibrated_stationary_housing_price
                
        elseif ((what_is_the_program_solving==1) .AND. &
                (solve_transition_dynamics==1) .AND. &
                (shut_down_housing_market==0)) then
            
            ! Computing the total value of housing investment
            housing_investment(time_period)=&
                (housing_price(time_period)/&
                c_1_calibrated)**&
                (empirical_housing_supplpy_elasticity)
                                            
            ! Computes profits for the constrcution company
            construction_company_profits(time_period)=0
            construction_company_profits(time_period)=construction_company_profits(time_period)+&
                max((housing_price(time_period)-c_min_calibrated)*&
                cutoff_housing_investment_calibrated,0.d0)
            construction_company_profits(time_period)=construction_company_profits(time_period)+&
                max(housing_price(time_period)*&
                (housing_investment(time_period)-&
                cutoff_housing_investment_calibrated)-&
                ((c_1_calibrated*(housing_investment(time_period))**&
                ((1/empirical_housing_supplpy_elasticity)+1))/&
                ((1/empirical_housing_supplpy_elasticity)+1)-&
                (c_1_calibrated*(cutoff_housing_investment_calibrated)**&
                ((1/empirical_housing_supplpy_elasticity)+1))/&
                ((1/empirical_housing_supplpy_elasticity)+1)),0.d0)
                                    
            total_constrcution_profits(time_period)=&
                total_constrcution_profits(time_period)+&
                construction_company_profits(time_period)                
            
            ! Computes total construction profits per household
            construction_company_profits_per_household(time_period)=&
                total_constrcution_profits(time_period)/total_population
                
        ! Here I calibrate the model
        elseif ((what_is_the_program_solving==0) .AND. &
                (shut_down_housing_market==0)) then
                                    
            c_1=(housing_price(time_period))/&
                ((housing_depreciation*total_housing_demand(time_period))**&
                (1/empirical_housing_supplpy_elasticity))
                                                            
            ! Sets the housing stock equal to the total population
            housing_stock(time_period)=(1/housing_depreciation)*&
                (housing_price(time_period)/c_1)**&
                (empirical_housing_supplpy_elasticity)
                                                
            ! Computing the total value of housing investment
            housing_investment(time_period)=&
                (housing_price(time_period)/c_1)**&
                (empirical_housing_supplpy_elasticity)
            
            ! Computes the total value of housing
            housing_investment_value(time_period)=&
                housing_price(time_period)*housing_investment(time_period)
                
            ! Starts a bisection to find the cutoff_housing_investment. 
            ! The first value is the lower bound of the cutoff
            ! The second value if the upper bound of the cutoff
            cutoff_housing_investment_bisection(1)=0
            cutoff_housing_investment_bisection(2)=housing_investment(time_period)
            
            ! Sets the cutoff 
            distance_cutoff_housing_investment=1
            
            ! Continues until the distance is smaller than the stopping rule
            do while (distance_cutoff_housing_investment>stopping_rule_cutoff_housing_investment)
            
                ! Takes the average of the two points
                cutoff_housing_investment=&
                    (cutoff_housing_investment_bisection(1)+cutoff_housing_investment_bisection(2))/2
            
                ! Recomputes the profits of the construction company for the new value of the cutoff_housing_investment
                ! First, finds the minimum cost
                c_min=c_1*&
                    (cutoff_housing_investment)**&
                    (1/empirical_housing_supplpy_elasticity)
                
                ! Computes profits for the constrcution company
                construction_company_profits(time_period)=0
                construction_company_profits(time_period)=&
                    construction_company_profits(time_period)+&
                    (housing_price(time_period)-c_min)*&
                    cutoff_housing_investment
                construction_company_profits(time_period)=&
                    construction_company_profits(time_period)+&
                    housing_price(time_period)*&
                    (housing_investment(time_period)-cutoff_housing_investment)-&
                    ((c_1*(housing_investment(time_period))**&
                    ((1/empirical_housing_supplpy_elasticity)+1))/&
                    ((1/empirical_housing_supplpy_elasticity)+1)-&
                    (c_1*(cutoff_housing_investment)**&
                    ((1/empirical_housing_supplpy_elasticity)+1))/&
                    ((1/empirical_housing_supplpy_elasticity)+1))
                            
                ! Computes the value of land
                land_value=construction_company_profits(time_period)
                        
                ! Computes the value of land as a fraction of total value of housing invesment
                land_to_housing_stock=land_value/housing_investment_value(time_period)
                
                ! Computes the distance between the computed land_to_housing_stock and its empirical value
                distance_cutoff_housing_investment=abs(land_to_housing_stock-empirical_land_to_housing_stock)
                
                ! Checks if the value is larger or smaller than the empicial value
                if (land_to_housing_stock<empirical_land_to_housing_stock) then
        
                    cutoff_housing_investment_bisection(2)=cutoff_housing_investment
        
                else
            
                    cutoff_housing_investment_bisection(1)=cutoff_housing_investment
                
                end if
                
            
            end do
                                        
            ! Computes the total construction profits
            total_constrcution_profits(time_period)=&
                total_constrcution_profits(time_period)+&
                construction_company_profits(time_period)
                
            ! Computes the construction company profits per household
            construction_company_profits_per_household(time_period)=&
                total_constrcution_profits(time_period)/total_population
                            
            distance_housing_market(time_period)=&
                abs(total_housing_demand(time_period)-&
                housing_stock(time_period))
                                                                                       
            write(*,*) "distance_housing_market",time_period,"=",&
                distance_housing_market(time_period)
                                    
        end if
                
        if ((loop_count==0) .AND. (solve_transition_dynamics==0) .AND. &
           (shut_down_housing_market==0)) then
        
            write(*,*) "total_constrcution_profits(time_period)=", total_constrcution_profits(time_period)
            write(*,*) "construction_company_profits_per_household=", &
                construction_company_profits_per_household(time_period)
            write(*,*) "c_1=", c_1
            
        end if
        
        ! the program solves the housing market in calibration
        if ((endogenous_rental_market==0) .AND. &
            (what_is_the_program_solving==0) .AND. &
            (shut_down_housing_market==0)) then
                                        
            ! Sets the rent value
            rent(time_period)=rent_to_housing_price*housing_price(time_period)
                                                
            ! Management costs are determined so that the rental company has 0 economic profits
            rental_management_costs=&
                rent(time_period)+housing_price(time_period)*&
                ((1-housing_depreciation-property_tax(time_period))/&
                (1+risk_free_rate(time_period))-1)
                                
        ! Here I am running a counter factual simulation
        elseif ((endogenous_rental_market==0) .AND. &
            (what_is_the_program_solving==1) .AND. &
            (shut_down_housing_market==0)) then
            
            ! Finds the rent that clears the rental market
            rent(time_period)=max(rental_management_costs_calibrated+&
                housing_price(time_period)-&
                housing_price(min(time_period+solve_transition_dynamics*1,transition_length))*&
                (1-housing_depreciation-property_tax(time_period))/&
                (1+risk_free_rate(time_period)),0.d0)
                                                                
        end if
        
        ! if the housing market is shut down setting the rent to 0 constrution profits to 0 and
        ! construction prodts per household to 0
        if (shut_down_housing_market==1) then
        
            c_1=0
            c_min=0
            housing_price(time_period)=0
            rent(time_period)=0
            total_constrcution_profits(time_period)=0
            construction_company_profits_per_household(time_period)=0
        
        end if
        
        if ((solve_transition_dynamics==0) .AND. (loop_count>=0) .AND. (what_is_the_program_solving==1) .AND. &
           (shut_down_housing_market==0)) then
            
            write(*,*) "housing_price=", housing_price(time_period)
        
            write(*,*) "rent_calibrated=", rent_calibrated
            write(*,*) "rent=", rent(time_period)
            write(*,*) "rent(transition_length)/rent_calibrated=", &
                rent(transition_length)/rent_calibrated
            write(*,*) "risk_free_rate(time_period)=", &
                risk_free_rate(time_period)
!            write(*,*) "housing_depreciation=", &
!                housing_depreciation
!            write(*,*) "property_tax(time_period)=", &
!                property_tax(time_period)
                
            if (endogenous_rental_market==0) then
                
!                write(*,*) "rent=", &
!                    rental_management_costs_calibrated+&
!                    housing_price(time_period)-&
!                    housing_price(min(time_period+solve_transition_dynamics*1,transition_length))*&
!                    (1-housing_depreciation-property_tax(time_period))/&
!                    (1+risk_free_rate(time_period))
                write(*,*) "rental_management_costs_calibrated=", &
                    rental_management_costs_calibrated
                
            end if
            
                
        end if
        
        if (loop_count>=-1) then
        
            if (shut_down_housing_market==0) then
                        
                housing_size(0)=smallest_house_size
            
                ! This says that a household can only save up to max_times_labour_income_saved of their maximum labour income
                housing_size(housing_status_grid_size-1)=largest_house_size
                
                if (housing_status_grid_size>2) then
                                                       
                    ! Here I am doing the expanding grid method
                    do i=1,housing_status_grid_size-1
            
                        housing_status_grid_distance(i)=&
                            i*((housing_size(housing_status_grid_size-1)-housing_size(0))**&
                            (real(1)/housing_status_grid_expander))/(real(housing_status_grid_size)-real(1))
        
                    end do
                    
                    housing_size=housing_size(0)+housing_status_grid_distance**(housing_status_grid_expander)
                    
                end if
                
                ! Saving welfare at each age group for a given productivity
                open(unit=3,file="housing_status_grid_points"//trim(file_number)//".txt",action="write",status="replace")
                    do i=0,housing_status_grid_size-1
                        write(3,*) housing_size(i)
                    end do
                close(3)
                
            else
            
                housing_size(0:(housing_status_grid_size-1))=1
            
            end if
        
        end if
                    
        index_of_smallest_house_hhld_can_buy=&
            minloc((size_of_smallest_house_hhld_can_buy-housing_size),1,&
            mask=(size_of_smallest_house_hhld_can_buy-housing_size)>0)
                
        if ((loop_count<=2) .AND. (solve_transition_dynamics==0)) then
        
            write(*,*) "housing_size(index_of_smallest_house_hhld_can_buy)=", & 
                housing_size(index_of_smallest_house_hhld_can_buy)
            write(*,*) "size_of_smallest_house_hhld_can_buy=", size_of_smallest_house_hhld_can_buy
        
        end if
        
        ! Loops over all the possible housing statuses
        do housing_status_index=0,(housing_status_grid_size-1)
                    
            housing_status_utility_function&
                (housing_status_index,0)=&
                (housing_size(housing_status_index))**&
                (relative_share_of_housing*(1-risk_aversion))
                
            housing_status_utility_function&
                (housing_status_index,1)=&
                ((housing_size(housing_status_index)*&
                (1+advantage_to_owning)))**&
                (relative_share_of_housing*(1-risk_aversion))
                                        
            if (loop_count<0) then
        
                do i=0,1
                                
                    write(*,*) "utility from housing size", &
                        housing_size(housing_status_index), &
                        " gives utility of ", housing_status_utility_function&
                        (housing_status_index,i)
                    write(*,*) "housing_status_index=", housing_status_index
                    write(*,*) "ownership_status_index=", i
                
                end do
        
            end if
            
        end do
        
        if (shut_down_housing_market==1) then
        
            housing_status_utility_function(0:(housing_status_grid_size-1),:)=1
        
        end if
                
    end subroutine
    
    ! This subroutine initializes some variables, grids and processes
    subroutine initialize_variables_and_grids(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period
        
        ! Checks if there are productivities in the model
        if (productivity_grid_size>1) then
        
            call set_productivity_variable()
            
        else
        
            productivity_process(1,1)=1
                
            productivity_grid(1)=0
            
        end if
        
        if (productivity_shock_grid_size>1) then
        
            call set_productivity_shock_process()
            
        else
        
            productivity_shock_process(:,:)=0
            productivity_shock_process(:,1)=1            
            productivity_grid(:)=1
            
        end if
        
        call set_employment_variables(time_period)
                        
        call set_mortgage_grid()
        
        do i=1,life_span
        
            survival_probability(i)=actual_survival_probability(i)
                
        end do
                
        if (loop_count<1) then
        
            do age_index=1,life_span
            
                if (solve_transition_dynamics==0) then
        
!                    write(*,*) "survival_probability(",age_index,")=", survival_probability(age_index)
                    
                end if
                
            end do
        
        end if
        
        cohort_population(1)=1
        
        ! Initializes the population to what the first cohort is
        total_population=cohort_population(1)
            
        ! Initializes the measure of households in each cohort
        do i=2,life_span
        
            cohort_population(i)=cohort_population(i-1)*survival_probability(i-1)
            
            ! Updates the total population
            total_population=total_population+cohort_population(i)
            
        end do
        
        if (solve_transition_dynamics==0) then
                
            write(*,*) "total population=", total_population
        
        end if
        
        if (re_do_simulation_with_fixed_parameters==0) then
        
            stopping_rule_wealth_dist(1)=0.01
            
        else
        
            stopping_rule_wealth_dist(1)=0.01
            
        end if
        
        stopping_rule_wealth_dist(2)=0.001
        stopping_rule_wealth_dist(3)=0.01
        stopping_rule_wealth_dist(4)=0.1
        stopping_rule_wealth_dist(5)=0.2
        stopping_rule_wealth_dist(6)=0.3
        stopping_rule_wealth_dist(7)=0.4
        stopping_rule_wealth_dist(8)=1
                
    end subroutine
    
    subroutine set_productivity_variable()
        
        use Wealth_Tax_Global_Vars
        
        implicit none
                    
        ! Sets the sd of ability
        sd_log_productivity=&
            sd_epsilon_log_productivity/&
            sqrt(1-(persistency_log_productivity)**2)
    
        ! Sets the lower and upper bounds of the productivity cutoffs
        log_productivity_lower_bound=-log_productivity_deviation_down*sd_log_productivity
        log_productivity_upper_bound=+log_productivity_deviation_up*sd_log_productivity
        
        ! Discretizing the productivity grid
        do log_productivity_index=1,log_productivity_grid_size
        
            ! Sets the grid points
            log_productivity_grid(log_productivity_index)=&
                log_productivity_lower_bound+&
                ((log_productivity_upper_bound-&
                log_productivity_lower_bound)/&
                (log_productivity_grid_size-1))*&
                (log_productivity_index-1)
        
        end do
        
        ! Constructcs the midpoints
        do log_productivity_index=1,log_productivity_grid_size-1
        
            log_productivity_grid_mid_point&
                (log_productivity_index)=&
                (log_productivity_grid(log_productivity_index+1)+&
                log_productivity_grid(log_productivity_index))/2
        
        end do
        
        ! Computes the transmission probabilities from parent to child
        do log_productivity_index=1,log_productivity_grid_size
        
            do future_log_productivity_index=2,log_productivity_grid_size-1
            
                cut_off_1=&
                    (log_productivity_grid_mid_point&
                    (future_log_productivity_index)-&
                    persistency_log_productivity*&
                    log_productivity_grid(log_productivity_index))/&
                    sd_epsilon_log_productivity

                cut_off_2=&
                    (log_productivity_grid_mid_point&
                    (future_log_productivity_index-1)-&
                    persistency_log_productivity*&
                    log_productivity_grid(log_productivity_index))/&
                    sd_epsilon_log_productivity
                
                ! Computes the probability of transitioning form state productivity_index to future_productivity_index
                productivity_process&
                    (log_productivity_index,&
                    future_log_productivity_index)=&
                    (1+ERF(cut_off_1/SQRT(2.d0)))/2-&
                    (1+ERF(cut_off_2/SQRT(2.d0)))/2
                        
            end do
        
        end do
                    
        ! Obtains the transimission probabilities from parent to child from each state to first state and last state
        do log_productivity_index=1,log_productivity_grid_size
        
            cut_off_1=&
                (log_productivity_grid_mid_point(1)-&
                persistency_log_productivity*&
                log_productivity_grid(log_productivity_index))/&
                sd_epsilon_log_productivity

            cut_off_2=&
                (log_productivity_grid_mid_point&
                (log_productivity_grid_size-1)-&
                persistency_log_productivity*&
                log_productivity_grid(log_productivity_index))/&
                sd_epsilon_log_productivity
        
            ! Computes the probability of transitioning from state productivity_index to 1
            productivity_process&
                (log_productivity_index,1)=&
                (1+ERF(cut_off_1/SQRT(2.d0)))/2
                
            ! Computes the probability of transitioning from state productivity_index to state productivity_grid_size
            productivity_process&
                (log_productivity_index,&
                log_productivity_grid_size)=&
                1-(1+ERF(cut_off_2/SQRT(2.d0)))/2
                
        end do
            
        if (loop_count<1) then
            
            do log_productivity_index=1,log_productivity_grid_size
        
                write(*,*) "sum(productivity_process(",log_productivity_index,")=", &
                    sum(productivity_process(log_productivity_index,:))
                
            end do
                
        end if
        
        log_productivity_grid=log_productivity_grid+mean_log_productivity
            
        productivity_grid=exp(log_productivity_grid)
            
        if (loop_count<1) then
                
            do i=1,productivity_grid_size
    
                write(*,*) "productivity_index", i, "=", productivity_grid(i)
        
            end do
               
        end if
            
    end subroutine
    
    subroutine set_productivity_shock_process()
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        ! Sets the power to which innhate productivity is raised to
        productivity_shock_grid(1)=5
        productivity_shock_grid(2)=1
        
        if (only_two_productivity_shocks==1) then
        
            productivity_shock_grid(3)=1
            
        else
        
            productivity_shock_grid(3)=0
        
        end if
        
        if (loop_count<1) then
        
            do i=1,productivity_shock_grid_size
        
                write(*,*) "productivity_shock_grid(i)=", &
                    productivity_shock_grid(i)
        
            end do
            
        end if
                
        unconditional_productivity_shock_probability(1:4,1)=0
        unconditional_productivity_shock_probability(1:4,2)=1*(1-all_low_z_households_get_into_0_lane)
        unconditional_productivity_shock_probability(1:4,3)=&
            1-unconditional_productivity_shock_probability(1,1)-&
            unconditional_productivity_shock_probability(1,2)
        
        ! Productivity is stable over life cycle
        if (have_fixed_productivity==1) then
                    
            ! Sets the unconditional probability shock
            unconditional_productivity_shock_probability(5:7,1)=0 ! 0.3
            unconditional_productivity_shock_probability(5:7,2)=1 ! 0.7 
            unconditional_productivity_shock_probability(5:7,3)=&
                1-unconditional_productivity_shock_probability(5,1)-&
                unconditional_productivity_shock_probability(5,2)
        
        ! Productivity is subject to shocks
        else
        
            ! Sets the unconditional probability shock
            unconditional_productivity_shock_probability(5:7,1)=1 ! 0.3
            unconditional_productivity_shock_probability(5:7,2)=0 ! 0.7 
            unconditional_productivity_shock_probability(5:7,3)=&
                1-unconditional_productivity_shock_probability(5,1)-&
                unconditional_productivity_shock_probability(5,2)
                        
        end if
        
        do i=1,productivity_grid_size
        
            if (loop_count<1) then
        
                write(*,*) "unconditional_productivity_shock_probability(",i,":)=", &
                    sum(unconditional_productivity_shock_probability(i,:))
                
            end if
        
        end do
        
        ! Prodctivity is stable over life cycle
        if (have_fixed_productivity==1) then
        
            ! Sets the probability of moving between shocks
            productivity_shock_process(1,1)=0 ! 0.92
            productivity_shock_process(1,2)=1 ! 0.05
            productivity_shock_process(1,3)=&
                1-productivity_shock_process(1,1)-&
                productivity_shock_process(1,2)
            
            productivity_shock_process(2,1)=0
            productivity_shock_process(2,2)=1 ! 0.97
            productivity_shock_process(2,3)=&
                1-productivity_shock_process(2,1)-&
                productivity_shock_process(2,2)
        
            productivity_shock_process(3,1)=0
            productivity_shock_process(3,2)=1
            productivity_shock_process(3,3)=&
                1-productivity_shock_process(3,1)-&
                productivity_shock_process(3,2)
            
        ! Productivity is subject to shocks
        else
        
            if (calibrate_probability_of_fast_lane==0) then
        
                ! Sets the probability of moving between shocks
                productivity_shock_process(1,1)=0.92
                productivity_shock_process(1,2)=0.05
                productivity_shock_process(1,3)=&
                    1-productivity_shock_process(1,1)-&
                    productivity_shock_process(1,2)
                
                productivity_shock_process(2,1)=0
                productivity_shock_process(2,2)=0.97
                productivity_shock_process(2,3)=&
                    1-productivity_shock_process(2,1)-&
                    productivity_shock_process(2,2)
                    
            else
            
                ! Sets the probability of moving between shocks
                productivity_shock_process(1,1)=probability_of_staying_in_fast_lane
                productivity_shock_process(1,2)=&
                    1-productivity_shock_process(1,1)
                productivity_shock_process(1,3)=0
                
                productivity_shock_process(2,1)=0
                
                if (only_two_productivity_shocks==1) then
                
                    productivity_shock_process(2,2)=1
                
                else
                
                    productivity_shock_process(2,2)=probability_of_staying_in_fast_lane
                    
                end if
                
                productivity_shock_process(2,3)=&
                    1-productivity_shock_process(2,1)-&
                    productivity_shock_process(2,2)
           
            end if
        
            productivity_shock_process(3,1)=0
            productivity_shock_process(3,2)=0
            productivity_shock_process(3,3)=&
                1-productivity_shock_process(3,1)-&
                productivity_shock_process(3,2)
        
        end if
        
    end subroutine
    
    subroutine set_employment_variables(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period
                
        ! Checks if there is unemployment
        if (have_unemployment==1) then
                
            if (employment_grid_size==5) then
            
                labour_income_tax(1)=0.28
                labour_income_tax(2)=0.25
                labour_income_tax(3)=0.15
                labour_income_tax(4)=0
                labour_income_tax(employment_grid_size)=0
                                
                employment_grid(1)=1
                employment_grid(2)=0.384
                employment_grid(3)=0.220
                employment_grid(4)=0.083
                                
            elseif (employment_grid_size==6) then
            
                labour_income_tax(1)=0.33
                labour_income_tax(2)=0.28
                labour_income_tax(3)=0.22
                labour_income_tax(4)=0.15
                labour_income_tax(5)=0
                
                employment_grid(1)=1
                employment_grid(2)=0.420999059
                employment_grid(3)=0.269832338
                employment_grid(4)=0.163984328
                employment_grid(5)=0.065712804
                            
            end if
        
            employment_grid(employment_grid_size)=0
            
        else
        
            if (multiple_household_members==1) then
            
                labour_income_tax(1)=0.33
                labour_income_tax(2)=0.25
                labour_income_tax(3)=0.22
                labour_income_tax(4)=0.15
                labour_income_tax(5)=0.1
                
                employment_grid(1)=1
                employment_grid(2)=0.385338346
                employment_grid(3)=0.255639098
                employment_grid(4)=0.167293233
                employment_grid(5)=0.071428571
            
            else
        
                labour_income_tax(1)=0.33
                labour_income_tax(2)=0.28
                labour_income_tax(3)=0.22
                labour_income_tax(4)=0.15
                labour_income_tax(5:employment_grid_size)=0.0
                        
                employment_grid(1)=1
                employment_grid(2)=0.4346
                employment_grid(3)=0.2712
                employment_grid(4)=0.1596
                employment_grid(5)=0.0596
                
            end if
        
        end if
        
        if ((solve_transition_dynamics==0) .AND. (loop_count<1)) then
                
            write(*,*) "employment_grid=", employment_grid
            
        end if
        
        if (have_unemployment==0) then
        
            do age_index=1,(life_span-retirement_span-1)
        
                ! Sets the probability of moving from different income states to other income states
                employment_process(time_period,age_index,1,1)=0.83 
                employment_process(time_period,age_index,1,2)=1-&
                    employment_process(time_period,age_index,1,1) 
                employment_process(time_period,age_index,1,3:employment_grid_size)=0
                employment_process(time_period,age_index,2,1)=employment_process(time_period,age_index,1,2) 
                employment_process(time_period,age_index,2,3)=(1-0.83)
                employment_process(time_period,age_index,2,2)=1-&
                    employment_process(time_period,age_index,2,3)-&
                    employment_process(time_period,age_index,2,1)
                employment_process(time_period,age_index,2,4:employment_grid_size)=0
                employment_process(time_period,age_index,3,1)=0 
                employment_process(time_period,age_index,3,2)=(1-0.83)
                employment_process(time_period,age_index,3,4)=(1-0.83)
                employment_process(time_period,age_index,3,3)=1-&
                    employment_process(time_period,age_index,3,2)-&
                    employment_process(time_period,age_index,3,4)
                employment_process(time_period,age_index,3,5:employment_grid_size)=0
                employment_process(time_period,age_index,4,1:2)=0 
                employment_process(time_period,age_index,4,3)=(1-0.83)
                employment_process(time_period,age_index,4,5)=(1-0.83)
                employment_process(time_period,age_index,4,4)=1-&
                    employment_process(time_period,age_index,4,3)-&
                    employment_process(time_period,age_index,4,5)
                employment_process(time_period,age_index,5,1:3)=0
                employment_process(time_period,age_index,5,4)=(1-0.83)
                employment_process(time_period,age_index,5,5)=1-&
                    employment_process(time_period,age_index,5,4)
                
            end do
        
            do age_index=(life_span-retirement_span),life_span
            
                employment_process(time_period,age_index,1,1)=1
                employment_process(time_period,age_index,1,2:employment_grid_size)=0
                employment_process(time_period,age_index,2,2)=1
                employment_process(time_period,age_index,2,1)=0
                employment_process(time_period,age_index,2,3:employment_grid_size)=0
                employment_process(time_period,age_index,3,3)=1
                employment_process(time_period,age_index,3,1:2)=0
                employment_process(time_period,age_index,3,4:employment_grid_size)=0
                employment_process(time_period,age_index,4,4)=1
                employment_process(time_period,age_index,4,1:3)=0
                employment_process(time_period,age_index,4,employment_grid_size)=0
                employment_process(time_period,age_index,5,1:4)=0
                employment_process(time_period,age_index,5,5)=1
                                                           
            end do
                    
            if (loop_count<1) then
            
                do i=1,employment_grid_size
            
                    do j=1,employment_grid_size
            
                        if (solve_transition_dynamics==0) then
        
!                            write(*,*) "employment_process(i,j)", i, ",",j,"=", employment_process(1,1,i,j)
                    
                        end if
                    
                    end do
        
                end do
                
            end if
                            
            unconditional_employment_probability(time_period,1:employment_grid_size)=0.2
            unconditional_employment_probability(time_period,employment_grid_size)=1-&
                unconditional_employment_probability(time_period,4)-&
                unconditional_employment_probability(time_period,3)-&
                unconditional_employment_probability(time_period,2)-&
                unconditional_employment_probability(time_period,1)
                
        elseif (have_unemployment==1) then
        
            if (employment_grid_size==6)  then
                            
                do age_index=1,(life_span-retirement_span-1)
        
                    ! Sets the probability of moving from different income states to other income states
                    employment_process(time_period,age_index,1,employment_grid_size)=&
                        high_unemployment(time_period)*0.2+(1-high_unemployment(time_period))*0.057
                    employment_process(time_period,age_index,1,2)=0.1700
                    employment_process(time_period,age_index,1,1)=1-&
                        employment_process(time_period,age_index,1,2)-&
                        employment_process(time_period,age_index,1,employment_grid_size)
                    employment_process(time_period,age_index,1,3:5)=0
                        
                    employment_process(time_period,age_index,2,employment_grid_size)=&
                        high_unemployment(time_period)*0.2+(1-high_unemployment(time_period))*0.057
                    employment_process(time_period,age_index,2,1)=0.2260 
                    employment_process(time_period,age_index,2,3)=0.1700
                    employment_process(time_period,age_index,2,2)=1-&
                        employment_process(time_period,age_index,2,employment_grid_size)-&
                        employment_process(time_period,age_index,2,3)-&
                        employment_process(time_period,age_index,2,1)
                    employment_process(time_period,age_index,2,4:5)=0
                    
                    employment_process(time_period,age_index,3,employment_grid_size)=&
                        high_unemployment(time_period)*0.2+(1-high_unemployment(time_period))*0.057
                    employment_process(time_period,age_index,3,2)=0.2800
                    employment_process(time_period,age_index,3,4)=0.1700
                    employment_process(time_period,age_index,3,3)=1-&
                        employment_process(time_period,age_index,3,2)-&
                        employment_process(time_period,age_index,3,4)-&
                        employment_process(time_period,age_index,3,employment_grid_size)
                    employment_process(time_period,age_index,3,1)=0
                    employment_process(time_period,age_index,3,5)=0
                        
                    employment_process(time_period,age_index,4,employment_grid_size)=&
                        high_unemployment(time_period)*0.2+(1-high_unemployment(time_period))*0.057
                    employment_process(time_period,age_index,4,1:2)=0
                    employment_process(time_period,age_index,4,3)=0.3400
                    employment_process(time_period,age_index,4,5)=0.1700
                    employment_process(time_period,age_index,4,4)=1-&
                        employment_process(time_period,age_index,4,employment_grid_size)-&
                        employment_process(time_period,age_index,4,3)-&
                        employment_process(time_period,age_index,4,5)
                        
                    employment_process(time_period,age_index,5,1:3)=0
                    employment_process(time_period,age_index,5,4)=0.4100
                    employment_process(time_period,age_index,5,employment_grid_size)=&
                        high_unemployment(time_period)*0.2+(1-high_unemployment(time_period))*0.057
                    employment_process(time_period,age_index,5,5)=1-&
                        employment_process(time_period,age_index,5,employment_grid_size)-&
                        employment_process(time_period,age_index,5,4)
                        
                    employment_process(time_period,age_index,6,6)=&
                        high_unemployment(time_period)*0.2+(1-high_unemployment(time_period))*0.057
                    employment_process(time_period,age_index,6,1:4)=0
                    employment_process(time_period,age_index,6,5)=1-&
                        employment_process(time_period,age_index,6,employment_grid_size)
                    
                end do
                    
                do age_index=(life_span-retirement_span),life_span
            
                    employment_process(time_period,age_index,1,1)=1
                    employment_process(time_period,age_index,1,2:employment_grid_size)=0
                    employment_process(time_period,age_index,2,2)=1
                    employment_process(time_period,age_index,2,1)=0
                    employment_process(time_period,age_index,2,3:employment_grid_size)=0
                    employment_process(time_period,age_index,3,3)=1
                    employment_process(time_period,age_index,3,1:2)=0
                    employment_process(time_period,age_index,3,4:employment_grid_size)=0
                    employment_process(time_period,age_index,4,4)=1
                    employment_process(time_period,age_index,4,1:3)=0
                    employment_process(time_period,age_index,4,employment_grid_size)=0
                    employment_process(time_period,age_index,5,1:4)=0
                    employment_process(time_period,age_index,5,5)=1
                    employment_process(time_period,age_index,5,employment_grid_size)=0
                    employment_process(time_period,age_index,6,1:5)=0
                    employment_process(time_period,age_index,6,6)=1
                                                           
                end do
                    
                if (loop_count<1) then
            
                    do i=1,employment_grid_size
            
                        do j=1,employment_grid_size
            
                            if (solve_transition_dynamics==0) then
        
!                                write(*,*) "employment_process(i,j)", i, ",",j,"=", employment_process(1,1,i,j)
                    
                            end if
                    
                        end do
        
                    end do
                
                end if
            
                if (loop_count<1) then
            
                    do i=1,employment_grid_size
            
                        if (solve_transition_dynamics==0) then
        
!                                write(*,*) "employment_process(i,:)", i, "=", sum(employment_process(1,1,i,:))
                        
                        end if
                    
                    end do
                
                end if
            
                if (high_unemployment(time_period)==0) then

                    unconditional_employment_probability(time_period,5)=0.184543
                    unconditional_employment_probability(time_period,4)=0.190767
                    unconditional_employment_probability(time_period,3)=0.191191
                    unconditional_employment_probability(time_period,2)=0.188665
                    unconditional_employment_probability(time_period,1)=0.187834
                    
                else

                    unconditional_employment_probability(time_period,5)=0.146400
                    unconditional_employment_probability(time_period,4)=0.165300
                    unconditional_employment_probability(time_period,3)=0.163400
                    unconditional_employment_probability(time_period,2)=0.162260
                    unconditional_employment_probability(time_period,1)=0.162640
                            
                end if
            
                unconditional_employment_probability(time_period,6)=1-&
                    unconditional_employment_probability(time_period,1)-&
                    unconditional_employment_probability(time_period,2)-&
                    unconditional_employment_probability(time_period,3)-&
                    unconditional_employment_probability(time_period,4)-&
                    unconditional_employment_probability(time_period,5)
                    
            elseif (employment_grid_size==5) then
            
                do age_index=1,(life_span-retirement_span-1)
        
                    ! Sets the probability of moving from different income states to other income states
                    employment_process(time_period,age_index,1,employment_grid_size)=&
                        high_unemployment(time_period)*0.2+(1-high_unemployment(time_period))*0.057
                    employment_process(time_period,age_index,1,2)=0.1700
                    employment_process(time_period,age_index,1,1)=1-&
                        employment_process(time_period,age_index,1,2)-&
                        employment_process(time_period,age_index,1,employment_grid_size)
                    employment_process(time_period,age_index,1,3:4)=0
                        
                    employment_process(time_period,age_index,2,employment_grid_size)=&
                        high_unemployment(time_period)*0.2+(1-high_unemployment(time_period))*0.057
                    employment_process(time_period,age_index,2,1)=0.4470
                    employment_process(time_period,age_index,2,3)=0.1700
                    employment_process(time_period,age_index,2,2)=1-&
                        employment_process(time_period,age_index,2,employment_grid_size)-&
                        employment_process(time_period,age_index,2,3)-&
                        employment_process(time_period,age_index,2,1)
                    employment_process(time_period,age_index,2,4)=0
                    
                    employment_process(time_period,age_index,3,employment_grid_size)=&
                        high_unemployment(time_period)*0.2+(1-high_unemployment(time_period))*0.057
                    employment_process(time_period,age_index,3,2)=0.3400
                    employment_process(time_period,age_index,3,4)=0.1700
                    employment_process(time_period,age_index,3,3)=1-&
                        employment_process(time_period,age_index,3,2)-&
                        employment_process(time_period,age_index,3,4)-&
                        employment_process(time_period,age_index,3,employment_grid_size)
                    employment_process(time_period,age_index,3,1)=0
                        
                    employment_process(time_period,age_index,4,employment_grid_size)=&
                        high_unemployment(time_period)*0.2+(1-high_unemployment(time_period))*0.057
                    employment_process(time_period,age_index,4,1:2)=0
                    employment_process(time_period,age_index,4,3)=0.4050
                    employment_process(time_period,age_index,4,4)=1-&
                        employment_process(time_period,age_index,4,employment_grid_size)-&
                        employment_process(time_period,age_index,4,3)
                                                
                    employment_process(time_period,age_index,&
                        employment_grid_size,employment_grid_size)=&
                        high_unemployment(time_period)*0.2+(1-high_unemployment(time_period))*0.057
                    employment_process(time_period,age_index,employment_grid_size,1:3)=0
                    employment_process(time_period,age_index,employment_grid_size,4)=1-&
                        employment_process(time_period,age_index,&
                        employment_grid_size,employment_grid_size)
                    
                end do
                    
                do age_index=(life_span-retirement_span),life_span
            
                    employment_process(time_period,age_index,1,1)=1
                    employment_process(time_period,age_index,1,2:employment_grid_size)=0
                    employment_process(time_period,age_index,2,2)=1
                    employment_process(time_period,age_index,2,1)=0
                    employment_process(time_period,age_index,2,3:employment_grid_size)=0
                    employment_process(time_period,age_index,3,3)=1
                    employment_process(time_period,age_index,3,1:2)=0
                    employment_process(time_period,age_index,3,4:employment_grid_size)=0
                    employment_process(time_period,age_index,4,4)=1
                    employment_process(time_period,age_index,4,1:3)=0
                    employment_process(time_period,age_index,4,employment_grid_size)=0
                    employment_process(time_period,age_index,employment_grid_size,1:4)=0
                    employment_process(time_period,age_index,&
                        employment_grid_size,employment_grid_size)=1
                                                           
                end do
                    
                if (loop_count<1) then
            
                    do i=1,employment_grid_size
            
                        do j=1,employment_grid_size
            
                            if (solve_transition_dynamics==0) then
        
!                                write(*,*) "employment_process(i,j)", i, ",",j,"=", employment_process(1,1,i,j)
                    
                            end if
                    
                        end do
        
                    end do
                
                end if
            
                if (loop_count<1) then
            
                    do i=1,employment_grid_size
            
                        if (solve_transition_dynamics==0) then
        
!                                write(*,*) "employment_process(i,:)", i, "=", sum(employment_process(1,1,i,:))
                        
                        end if
                    
                    end do
                
                end if
            
                if (high_unemployment(time_period)==0) then
                
                    unconditional_employment_probability(time_period,4)=0.186371
                    unconditional_employment_probability(time_period,3)=0.190309
                    unconditional_employment_probability(time_period,2)=0.190734
                    unconditional_employment_probability(time_period,1)=0.375586
                    
                else
                
                    unconditional_employment_probability(time_period,4)=0.158424
                    unconditional_employment_probability(time_period,3)=0.161253
                    unconditional_employment_probability(time_period,2)=0.160876
                    unconditional_employment_probability(time_period,1)=0.318168
                            
                end if
            
                unconditional_employment_probability(time_period,employment_grid_size)=1-&
                    unconditional_employment_probability(time_period,1)-&
                    unconditional_employment_probability(time_period,2)-&
                    unconditional_employment_probability(time_period,3)-&
                    unconditional_employment_probability(time_period,4)
            
            end if
        
        end if
                  
        if ((loop_count<1) .AND. (solve_transition_dynamics==0)) then
              
!            write(*,*) "unconditional_employment_probability(time_period,1:employment_grid_size)=", &
!                unconditional_employment_probability(time_period,1:employment_grid_size)
!            write(*,*) "sum(unconditional_employment_probability(time_period,:))=", &
!                sum(unconditional_employment_probability(time_period,:))
        
        end if
        
        ! Computes the labour efficiency at each age until retirement
        do age_index=1,(life_span-retirement_span)
        
            ! Obtains the life_cycle_component
            labour_deterministic_efficiency(age_index)=&
                min((1+life_cycle_component_a*(age_index-1)),1+life_cycle_component_a*31)
                
            if (loop_count<1) then
            
                if (solve_transition_dynamics==0) then
                            
!                    write(*,*) "labour efficiency=", labour_deterministic_efficiency(age_index)
!                    write(*,*) "age_index=", age_index
                    
                end if
                
            end if
            
        end do
            
        labour_deterministic_efficiency((life_span-retirement_span)+1:life_span)=0
    
    end subroutine
    
    subroutine set_mortgage_grid()
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        ! Sets the mortgage debt grid end points
        mortgage_grid(1)=mortgage_lower_bound
        
        if (mortgage_grid_size>1) then
        
            if (minimum_downpayment_below_20_perc==0) then
                    
                do i=2,mortgage_grid_size
            
                    mortgage_grid(i)=mortgage_grid(i-1)+0.1
            
                end do
                
                if (mortgage_grid_size==9) then
                
                    mortgage_grid(mortgage_grid_size)=0.8
                    
                elseif (mortgage_grid_size==10) then
                
                    mortgage_grid(mortgage_grid_size)=0.9
                    
                elseif (mortgage_grid_size==11) then
                
                    mortgage_grid(mortgage_grid_size)=0.95
                    
                end if
                
            else
            
                do i=2,mortgage_grid_size-1
            
                    mortgage_grid(i)=mortgage_grid(i-1)+0.1
            
                end do
                
                if (mortgage_grid_size==9) then
                
                    mortgage_grid(mortgage_grid_size)=0.8
                    
                elseif (mortgage_grid_size==10) then
                
                    mortgage_grid(mortgage_grid_size)=0.9
                    
                elseif (mortgage_grid_size==11) then
                
                    mortgage_grid(mortgage_grid_size)=0.95
                    
                end if
                
            end if
            
        end if
        
        if ((loop_count<1) .AND. (solve_transition_dynamics==0)) then
        
            do i=1,mortgage_grid_size
            
                if (solve_transition_dynamics==0) then
        
                    write(*,*) "mortgage_grid(",i,")=", mortgage_grid(i)
                    
                end if
        
            end do
        
            write(*,*) "mortgage_grid(",mortgage_grid_size,")=", mortgage_grid(mortgage_grid_size)
            
        end if
    
    end subroutine
        
    subroutine set_SS_benefits()
    
        use Wealth_Tax_Global_Vars
        
        implicit none
                                   
        model_ss_benefits=0
                            
        ! Computing the average lifetime income conditional on the final state
        do employment_index=1,employment_grid_size
            
            probability_came_from_past_employment_index_1=0
    
            model_lifetime_income_conditional_on_last_period_shock(employment_index)=0
            
            probability_came_from_past_employment_index_1(employment_index)=1
        
            do age_index=(life_span-retirement_span),1,-1
                
                probability_came_from_past_employment_index_2=0
                        
                do past_employment_index_1=1,employment_grid_size
                                                                    
                    model_lifetime_income_conditional_on_last_period_shock(employment_index)=&
                        model_lifetime_income_conditional_on_last_period_shock(employment_index)+&
                        probability_came_from_past_employment_index_1&
                        (past_employment_index_1)*&
                        labour_deterministic_efficiency(age_index)*&
                        employment_grid(past_employment_index_1)
                            
                    do past_employment_index_2=1,employment_grid_size
                            
                        probability_came_from_past_employment_index_2&
                            (past_employment_index_2)=&
                            probability_came_from_past_employment_index_2&
                            (past_employment_index_2)+&
                            probability_came_from_past_employment_index_1&
                            (past_employment_index_1)*&
                            employment_process&
                            (1,max(age_index-1,1),past_employment_index_2,past_employment_index_1)*&
                            unconditional_employment_probability(1,past_employment_index_2)/&
                            unconditional_employment_probability(1,past_employment_index_1)
                                                        
                    end do
                        
                end do
                                            
                probability_came_from_past_employment_index_1=&
                    probability_came_from_past_employment_index_2
                                            
            end do
                
            model_lifetime_income_conditional_on_last_period_shock(employment_index)=&
                model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                (life_span-retirement_span)
                                
        end do
            
        ! Computing the average lifetime income conditional on the last period shock
        model_average_lifetime_income_conditional_on_last_period_shock=0
            
        do employment_index=1,employment_grid_size
            
            model_average_lifetime_income_conditional_on_last_period_shock=&
                model_average_lifetime_income_conditional_on_last_period_shock+&
                model_lifetime_income_conditional_on_last_period_shock(employment_index)*&
                unconditional_employment_probability(1,employment_index)
                
        end do
                        
!        model_average_lifetime_income_conditional_on_last_period_shock=&
!            model_average_lifetime_income_conditional_on_last_period_shock/&
!            employment_grid_size
                
        ! Looping over all possible last period employment states
        do employment_index=1,employment_grid_size
                    
            if ((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)<=0.3) then
                    
                ! Computes social security benefits
                model_ss_benefits(employment_index)=&
                    0.9*(model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                    model_average_lifetime_income_conditional_on_last_period_shock)
                    
            elseif (((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)>0.3) .AND. &
                ((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)<=2)) then
                    
                ! Computes social security benefits
                model_ss_benefits(employment_index)=&
                    0.27+0.32*(model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                    model_average_lifetime_income_conditional_on_last_period_shock-0.3)
                    
            elseif (((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)>2) .AND. &
                ((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)<=4.1)) then
                    
                ! Computes social security benefits
                model_ss_benefits(employment_index)=&
                    0.81+0.15*(model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                    model_average_lifetime_income_conditional_on_last_period_shock-2)
                        
            elseif ((model_lifetime_income_conditional_on_last_period_shock(employment_index)/&
                model_average_lifetime_income_conditional_on_last_period_shock)>4.1) then
                    
                ! Computes social security benefits
                model_ss_benefits(employment_index)=1.13
                        
            end if
                
            write(*,*) "model_ss_benefits(",employment_index,")=", &
                model_ss_benefits(employment_index)
                
        end do
        
        if (high_unemployment(1)==0) then
        
            do employment_index=1,employment_grid_size

                calibrated_soc_secrty(employment_index)=&
                    model_ss_benefits(employment_index)*average_labor_income_calibrated
                
                write(*,*) "calibrated_soc_secrty(employment_index)=", &
                    calibrated_soc_secrty(employment_index)
        
            end do
        
        else
                                         
            calibrated_soc_secrty(1)=0.26092059024088626
            calibrated_soc_secrty(2)=0.23080449468671208
            calibrated_soc_secrty(3)=0.21015485581735935
            calibrated_soc_secrty(4)=0.20281168522531290
            calibrated_soc_secrty(5)=0.20514179166366761
            calibrated_soc_secrty(6)=0.21776567616078457
            
            do employment_index=1,employment_grid_size
            
                write(*,*) "calibrated_soc_secrty(employment_index)=", &
                    calibrated_soc_secrty(employment_index)
            
            end do
        
        end if
                                            
    end subroutine
    
    subroutine initialize_financial_grid(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period
                
        ! Sets the financial wealth grid end points
        financial_grid(1)=&
            financial_lower_bound*&
            (what_is_the_program_solving*wage_calibrated+&
            (1-what_is_the_program_solving)*wage(time_period))*&
            employment_grid(1)*&
            ((1-what_is_the_program_solving)+&
            what_is_the_program_solving)
        
        ! This says that a household can only save up to max_times_labour_income_saved of their maximum labour income
        financial_grid(financial_grid_size)=&
            max_times_labour_income_saved*&
            (what_is_the_program_solving*wage_calibrated+&
            (1-what_is_the_program_solving)*wage(time_period))*&
            employment_grid(1)*&
            ((1-what_is_the_program_solving)+&
            what_is_the_program_solving)
               
        ! Here I am doing the expanding grid method
        do i=2,financial_grid_size
        
            financial_grid_distance(i)=&
                (i-1)*((financial_grid(financial_grid_size)-financial_grid(1))**&
                (real(1)/financial_grid_expander))/(real(financial_grid_size)-real(1))
    
        end do
        
        financial_grid=&
            financial_grid(1)+&
            financial_grid_distance**&
            (financial_grid_expander)
        
        future_financial_grid_vector=financial_grid
        
        open(unit=3,file="financial_grid_points"//trim(file_number)//".txt",action="write",status="replace")
        do i=1,financial_grid_size
            write(3,*) financial_grid(i)/&
                        (wage*employment_grid(1)*&
                        ((1-what_is_the_program_solving)+&
                        what_is_the_program_solving))
        end do
        close(3)
        open(unit=3,file="financial_grid"//trim(file_number)//".txt",action="write",status="replace")
        do i=1,financial_grid_size
            write(3,*) financial_grid(i)
        end do
        close(3)
      
    end subroutine
        
    subroutine calculate_aggregate_consumption(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index
        integer :: time_period,pay_mortgage_insurance_1
        
        if (endogenous_rental_market==1) then
        
            aggregate_housing_consumption(time_period)=&
                housing_depreciation*&
                housing_price(time_period)*&
                (total_housing_demand(time_period)-&
                total_rental_demand(time_period)+&
                total_rental_supply(time_period))
                
        else
        
            aggregate_housing_consumption(time_period)=0
        
        end if
        
        aggregate_consumption(time_period)=0
        aggregate_mortgage_consumption(time_period)=0
        aggregate_rent_spending(time_period)=0
        aggregate_rental_income(time_period)=0
        aggregate_rental_profits(time_period)=0
        
        ! Computes aggregate consumption
        ! Starts by looping over all possible ages
        do age_index=1,life_span
                                    
            ! Loops over all possible financial wealth positions
            do financial_index=1,financial_grid_size
                            
                ! Loops over all possible incomes
                do employment_index=1,employment_grid_size
                
                    ! Loops over all possible productivities
                    do productivity_index=1,productivity_grid_size  
    
                        if (productivity_grid(productivity_index)<=1) then
                    
                            can_have_best_productivity_shock=0
                        
                        else
                    
                            can_have_best_productivity_shock=1
                    
                        end if
                
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                            
                            if (distribution_stationary&
                                (time_period,age_index,financial_index,&
                                employment_index,productivity_shock_index,&
                                productivity_index)>0) then
                    
                                ! Computes aggregate consumption using the benchmark stantionary distribution
                                aggregate_consumption(time_period)=&
                                    aggregate_consumption(time_period)+&
                                    policy_function_consumption&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)*&
                                    distribution_stationary&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)
                        
                                if (mortgage_grid&
                                    (policy_function_mortgage&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index))>0.81) then
                            
                                    if (policy_function_use_alternative_lenders&
                                        ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_index)==0) then
                                        
                                        pay_mortgage_insurance_1=1
                                    
                                    else
                                        
                                        pay_mortgage_insurance_1=0
                                    
                                    end if
                                    
                                else
                                
                                    pay_mortgage_insurance_1=0
                                
                                end if
                            
                                if (policy_function_ownership_status&
                                    (time_period,age_index,financial_index,&
                                    employment_index,productivity_shock_index,&
                                    productivity_index)==0) then
                            
                                    aggregate_rent_spending(time_period)=&
                                        aggregate_rent_spending(time_period)+&
                                        rent(time_period)*&
                                        policy_function_space_lived_in_size&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                            
                                else
                        
                                    if (endogenous_rental_market==0) then
                                    
                                        aggregate_housing_consumption(time_period)=&
                                            aggregate_housing_consumption(time_period)+&
                                            housing_depreciation*&
                                            housing_price(time_period)*&
                                            policy_function_space_lived_in_size&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)*&
                                            distribution_stationary&
                                            (time_period,age_index,financial_index,&
                                            employment_index,productivity_shock_index,&
                                            productivity_index)
                                
                                    end if
                                                
                                    aggregate_rental_income(time_period)=&
                                        aggregate_rental_income(time_period)+&
                                        rent(time_period)*&
                                        (housing_size&
                                        (policy_function_housing_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))-&
                                        policy_function_space_lived_in_size&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                
                                    aggregate_rental_profits(time_period)=&
                                        aggregate_rental_profits(time_period)+&
                                        (max((rent(time_period)-&
                                        housing_price(time_period)*&
                                        (housing_depreciation+property_tax(time_period)+&
                                        mortgage_grid(policy_function_mortgage&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))*&
                                        (mortgage_interest_rate(time_period)+&
                                        (1-policy_function_use_alternative_lenders&
                                        ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_index))*&
                                        pay_mortgage_insurance_1*mortgage_insurance_premium+&
                                        policy_function_use_alternative_lenders&
                                        ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_index)*&
                                        premium_with_alternative_lenders))),0.d0)*&
                                        max((housing_size&
                                        (policy_function_housing_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))-&
                                        policy_function_space_lived_in_size&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)),0.d0))*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                    
                                end if
                        
                                if (endogenous_rental_market==1) then
                            
                                    aggregate_mortgage_consumption(time_period)=&
                                        aggregate_mortgage_consumption(time_period)+&
                                        policy_function_ownership_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)*&
                                        housing_price(time_period)*&
                                        housing_size&
                                        (policy_function_housing_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))*&
                                        mortgage_grid&
                                        (policy_function_mortgage&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))*&
                                        (mortgage_interest_rate(time_period)+&
                                        (1-policy_function_use_alternative_lenders&
                                        ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_index))*&
                                        pay_mortgage_insurance_1*mortgage_insurance_premium+&
                                        policy_function_use_alternative_lenders&
                                        ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_index)*&
                                        premium_with_alternative_lenders)*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                                    
                                else
                        
                                    aggregate_mortgage_consumption(time_period)=&
                                        aggregate_mortgage_consumption(time_period)+&
                                        policy_function_ownership_status&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)*&
                                        housing_price(time_period)*&
                                        policy_function_space_lived_in_size&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)*&
                                        mortgage_grid&
                                        (policy_function_mortgage&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index))*&
                                        (mortgage_interest_rate(time_period)+&
                                        (1-policy_function_use_alternative_lenders&
                                        ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_index))*&
                                        pay_mortgage_insurance_1*mortgage_insurance_premium+&
                                        policy_function_use_alternative_lenders&
                                        ((1-use_alternative_lenders)+use_alternative_lenders*time_period,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*age_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*financial_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*employment_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_shock_index,&
                                        (1-use_alternative_lenders)+use_alternative_lenders*productivity_index)*&
                                        premium_with_alternative_lenders)*&
                                        distribution_stationary&
                                        (time_period,age_index,financial_index,&
                                        employment_index,productivity_shock_index,&
                                        productivity_index)
                            
                                end if
                            
                            end if
                            
                        end do
                        
                    end do
                                                    
                end do
                                                                    
            end do
                            
        end do
                                            
        write(*,*) "aggregate_consumption", time_period, "=", aggregate_consumption(time_period)
        write(*,*) "aggregate_housing_consumption=", time_period, "=", aggregate_housing_consumption(time_period)
        write(*,*) "aggregate_mortgage_consumption=", time_period, "=", aggregate_mortgage_consumption(time_period)
                        
    end subroutine
    
    subroutine update_tax_system(time_period,which_tax_system_to_solve)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period,which_tax_system_to_solve,loop_count_iterations
        real(8) :: lower_bound,upper_bound,distance_lower_bound,distance_upper_bound
        real(8) :: percentage_change_in_tax,&
            previous_income_tax_increase,previous_financial_tax,&
            previous_business_income_tax,previous_progressive_wealth_tax,&
            previous_progressive_threshold
        real(8) :: weight=0.5,percent_change=0.02
        integer :: equal_weights=1
        
        if (abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)<0.1) then
        
            if ((which_tax_system_to_solve==6) .OR. &
                (which_tax_system_to_solve==7)) then
                
                weight=0.5
                
            else
                    
                weight=0.5
                
            end if
        
        else
        
            weight=0.5
        
        end if
        
        ! Adjusts the financial rax up by a certain constant multiplied by the distance between 
        ! net_govt_revenues raised and the net_govt_revenues that the gov't is required to raise
        if (loop_count>aftr_how_mny_lps_start_update) then
                
            loop_count_iterations=0
            
            ! Computes the the financial threshold the clears the government's budget
            if (which_tax_system_to_solve==7) then
            
                ! Computing net govt revenues 
                call govt_revenues_calc(time_period,1)
                
                percentage_change_in_tax=percent_change*&
                    min(abs(net_govt_revenues(time_period)-net_govt_revenue_constraint),1.d0)
        
                previous_progressive_threshold=&
                    threshold_financial
        
                ! net govt revenues are larger than the constraint
                if (net_govt_revenues(time_period)<net_govt_revenue_constraint) then
            
                    ! Sets the upper bound to the threshold_financial
                    upper_bound=threshold_financial
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                    
                    ! Decreases the threshold_financial by percentage_change_in_tax
                    ! to find a progressive_fincial_tax for which net government revenues are smaller than the constraint
                    threshold_financial=&
                        upper_bound*(1-percentage_change_in_tax)
                                                        
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                
                    ! As long as net govt revenues are still larger than the constraint, 
                    ! the program keeps reducing the threshold_financial
                    do while ((net_govt_revenues(time_period)<net_govt_revenue_constraint) .AND. &
                        (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5)))
                
!                        write(*,*) "time_period=", time_period
                        write(*,*) "threshold_financial=", &
                            threshold_financial
                        write(*,*) "keep reducing threshold_financial, revenues minus constraint=", &
                            net_govt_revenues(time_period)-net_govt_revenue_constraint
                            
                        ! Reduces the threshold_financial
                        threshold_financial=&
                            threshold_financial-3
                            
                        if (threshold_financial<=0) then
                        
                            threshold_financial=-10
                            
                            EXIT
                            
                        end if
                                                                                                                             
                        ! Computes net govt revenues for that threshold_financial
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                                
                    end do
                                                        
                    ! Computes the difference between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the lower bound equal to the current threshold_financial
                    lower_bound=threshold_financial
                
!                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "start to slice"
                
                    ! Computes a new threshold_financial
                    threshold_financial=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                        
                    if (threshold_financial>=0) then
                    
                        ! Keeps looping until the lower and upper bounds are very clsoe
                        do while (abs(net_govt_revenues(time_period)-&
                            net_govt_revenue_constraint)>10.d0**(-5))
                    
                            ! Computes net govt revenues for that threshold_financial
                            call govt_revenues_calc(time_period,1)
                        
                            loop_count_iterations=loop_count_iterations+1
                
                            if (net_govt_revenues(time_period)>net_govt_revenue_constraint) then
                            
                                lower_bound=threshold_financial
                            
                                ! Computes the distance between net govt revenues and the constraint
                                distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                           
                            else
                        
                                upper_bound=threshold_financial
                                
                                ! Computes the distance between net govt revenues and the constraint
                                distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                            
                            end if
                        
                            ! Computes a new threshold_financial
                            threshold_financial=&
                                equal_weights*(lower_bound+upper_bound)/2+&
                                (1-equal_weights)*&
                                ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                                (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                                                        
                        end do
                        
                    end if
                    
                    write(*,*) "threshold_financial=", &
                            threshold_financial
                    write(*,*) "upper_bound=", upper_bound
                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "abs(upper_bound-lower_bound) low side=", &
!                        abs(upper_bound-lower_bound)
                
                ! here net govt revenues are larfer than the constraint
                else
            
                    ! Sets the lower bound to the threshold_financial
                    lower_bound=threshold_financial
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                                
                    ! Increase the threshold_financial by percentage_change_in_tax
                    ! to find a threshold_financial for which net govt revenues are greater than the constraint
                    threshold_financial=lower_bound*(1+percentage_change_in_tax)
                                        
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                    
                    ! As long as net govt revenues are greater than the constraint, 
                    ! the program keeps increasing the subsidy
                    do while ((net_govt_revenues(time_period)>net_govt_revenue_constraint) .AND. &
                        (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5)))
                
!                        write(*,*) "time_period=", time_period
                        write(*,*) "threshold_financial=", &
                            threshold_financial
                        write(*,*) "keep increasing the threshold_financial, revenues minus constraint=", &
                            net_govt_revenues(time_period)-net_govt_revenue_constraint
                                                    
                        ! Increases the threshold_financial
                        threshold_financial=&
                            threshold_financial+100
                            
                        if (threshold_financial>financial_grid(financial_grid_size)) then
                        
                            threshold_financial=financial_grid(financial_grid_size)+1
                            
                            EXIT
                        
                        end if
                                                                                                    
                        ! Computes net govt revenues
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                                
                    end do
                
                    ! Computes the difference between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the lower bound equal to the threshold_financial
                    upper_bound=threshold_financial
                
!                    write(*,*) "upper_bound=", lower_bound
!                    write(*,*) "start to slice"
                
                    ! Cpmputes a new subsidy
                    threshold_financial=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                        
                    if (threshold_financial<=financial_grid(financial_grid_size)) then
                                        
                        ! Keeps looping until the upper and lower bounds are close
                        do while (abs(net_govt_revenues(time_period)-&
                            net_govt_revenue_constraint)>10.d0**(-5))
                        
                            ! Computes net govt revenues
                            call govt_revenues_calc(time_period,1)
                        
                            loop_count_iterations=loop_count_iterations+1
                    
                            if (net_govt_revenues(time_period)<net_govt_revenue_constraint) then
                        
                                upper_bound=threshold_financial
                            
                                ! Computes the distance between net govt revenues and the constraint
                                distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                            
                            else
                        
                                lower_bound=threshold_financial
                            
                                ! Computes the distance between net govt revenues and the constraint
                                distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                                
                            end if
                        
                            ! Cpmputes a new threshold_financial
                            threshold_financial=&
                                equal_weights*(lower_bound+upper_bound)/2+&
                                (1-equal_weights)*&
                                ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                                (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                                                    
                        end do
                        
                    end if
                    
                    write(*,*) "threshold_financial=", &
                        threshold_financial
                    write(*,*) "upper_bound=", upper_bound
                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "abs(upper_bound-lower_bound)=", &
!                        abs(upper_bound-lower_bound)
            
                end if
                
                threshold_financial=&
                    weight*previous_progressive_threshold+&
                    (1-weight)*threshold_financial
                                    
                call govt_revenues_calc(time_period,1)
            
                write(*,*) "slicing net_govt_revenues=", net_govt_revenues(time_period)
                write(*,*) "distance=", abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                write(*,*) "threshold_financial=", threshold_financial  
            
            ! Computes the financial tax the clears the government's budget
            elseif (which_tax_system_to_solve==6) then
            
                ! Computing net govt revenues 
                call govt_revenues_calc(time_period,1)
                
                percentage_change_in_tax=percent_change*&
                    min(abs(net_govt_revenues(time_period)-net_govt_revenue_constraint),1.d0)
        
                previous_progressive_wealth_tax=&
                    progressive_financial_tax
        
                ! net govt revenues are larger than the constraint
                if (net_govt_revenues(time_period)>net_govt_revenue_constraint) then
            
                    ! Sets the upper bound to the progressive_financial_tax
                    upper_bound=progressive_financial_tax
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                    
                    ! Decreases the progressive_financial_tax by percentage_change_in_tax
                    ! to find a progressive_fincial_tax for which net government revenues are smaller than the constraint
                    progressive_financial_tax=&
                        upper_bound*(1-percentage_change_in_tax)
                                                        
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                
                    ! As long as net govt revenues are still larger than the constraint, 
                    ! the program keeps reducing the progressive_financial_tax
                    do while ((net_govt_revenues(time_period)>net_govt_revenue_constraint) .AND. &
                        (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5)))
                
!                        write(*,*) "time_period=", time_period
!                        write(*,*) "progressive_financial_tax=", &
!                            progressive_financial_tax
!                        write(*,*) "keep reducing progressive_financial_tax, revenues minus constraint=", &
!                            net_govt_revenues(time_period)-net_govt_revenue_constraint
                            
                        ! Reduces the progressive_financial_tax
                        progressive_financial_tax=&
                            progressive_financial_tax-&
                            0.0001
                                                                                                 
                        ! Computes net govt revenues for that progressive_financial_tax
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                                
                    end do
                                    
                    ! Computes the difference between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the lower bound equal to the current progressive_financial_tax
                    lower_bound=progressive_financial_tax
                
!                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "start to slice"
                
                    ! Computes a new progressive_financial_tax
                    progressive_financial_tax=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                    
                    ! Keeps looping until the lower and upper bounds are very clsoe
                    do while (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5))
                
                        ! Computes net govt revenues for that progressive_financial_tax
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
            
                        if (net_govt_revenues(time_period)<net_govt_revenue_constraint) then
                        
                            lower_bound=progressive_financial_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                       
                        else
                    
                            upper_bound=progressive_financial_tax
                            
                            ! Computes the distance between net govt revenues and the constraint
                            distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                        
                        end if
                    
                        ! Computes a new progressive_financial_tax
                        progressive_financial_tax=&
                            equal_weights*(lower_bound+upper_bound)/2+&
                            (1-equal_weights)*&
                            ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                            (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                                                    
                    end do
                    
!                    write(*,*) "progressive_financial_tax=", &
!                            progressive_financial_tax
!                    write(*,*) "upper_bound=", upper_bound
!                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "abs(upper_bound-lower_bound) low side=", &
!                        abs(upper_bound-lower_bound)
                
                ! here net govt revenues are smaller than the constraint
                else
            
                    ! Sets the lower bound to the progressive_financial_tax
                    lower_bound=progressive_financial_tax
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                                
                    ! Increase the progressive_financial_tax by percentage_change_in_tax
                    ! to find a progressive_financial_tax for which net govt revenues are greater than the constraint
                    progressive_financial_tax=lower_bound*(1+percentage_change_in_tax)
                                        
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                    
                    ! As long as net govt revenues are greater than the constraint, 
                    ! the program keeps increasing the subsidy
                    do while ((net_govt_revenues(time_period)<net_govt_revenue_constraint) .AND. &
                        (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5)))
                
!                        write(*,*) "time_period=", time_period
!                        write(*,*) "progressive_financial_tax=", &
!                            progressive_financial_tax
!                        write(*,*) "keep increasing the progressive_financial_tax, revenues minus constraint=", &
!                            net_govt_revenues(time_period)-net_govt_revenue_constraint
                                                    
                        ! Increases the progressive_financial_tax
                        progressive_financial_tax=&
                            progressive_financial_tax+&
                            0.001
                                                                                            
                        ! Computes net govt revenues
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                                
                    end do
                
                    ! Computes the difference between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the lower bound equal to the progressive_financial_tax
                    upper_bound=progressive_financial_tax
                
!                    write(*,*) "upper_bound=", lower_bound
!                    write(*,*) "start to slice"
                
                    ! Cpmputes a new subsidy
                    progressive_financial_tax=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                                        
                    ! Keeps looping until the upper and lower bounds are close
                    do while (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5))
                    
                        ! Computes net govt revenues
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                
                        if (net_govt_revenues(time_period)>net_govt_revenue_constraint) then
                    
                            upper_bound=progressive_financial_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                        
                        else
                    
                            lower_bound=progressive_financial_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                            
                        end if
                    
                        ! Cpmputes a new progressive_financial_tax
                        progressive_financial_tax=&
                            equal_weights*(lower_bound+upper_bound)/2+&
                            (1-equal_weights)*&
                            ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                            (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                                                
                    end do
                    
!                    write(*,*) "progressive_financial_tax=", &
!                        progressive_financial_tax
!                    write(*,*) "upper_bound=", upper_bound
!                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "abs(upper_bound-lower_bound)=", &
!                        abs(upper_bound-lower_bound)
            
                end if
                
                progressive_financial_tax=&
                    weight*previous_progressive_wealth_tax+&
                    (1-weight)*progressive_financial_tax
                                    
                call govt_revenues_calc(time_period,1)
            
!                write(*,*) "slicing net_govt_revenues=", net_govt_revenues(time_period)
!                write(*,*) "distance=", abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
!                write(*,*) "progressive_financial_tax=", progressive_financial_tax            
            
            elseif (which_tax_system_to_solve==4) then
            
                ! Computing net govt revenues 
                call govt_revenues_calc(time_period,1)
                
                percentage_change_in_tax=percent_change*&
                    min(abs(net_govt_revenues(time_period)-net_govt_revenue_constraint),1.d0)
        
!                write(*,*) "original progressive_wealth_tax=", &
!                    progressive_wealth_tax
!                write(*,*) "original net revenues minus constraint=", &
!                    net_govt_revenues(time_period)-net_govt_revenue_constraint
!                write(*,*) "percentage_change_in_tax=", &
!                    percentage_change_in_tax

                previous_progressive_wealth_tax=&
                    progressive_wealth_tax
        
                ! net govt revenues are larger than the constraint
                if (net_govt_revenues(time_period)>net_govt_revenue_constraint) then
            
                    ! Sets the upper bound to the progressive_wealth_tax
                    upper_bound=progressive_wealth_tax
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                    
                    ! Decreases the progressive_wealth_tax by percentage_change_in_tax
                    ! to find a progressive_wealth_tax for which net government revenues are smaller than the constraint
                    progressive_wealth_tax=&
                        upper_bound*(1-percentage_change_in_tax)
                                                        
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                
                    ! As long as net govt revenues are still larger than the constraint, 
                    ! the program keeps reducing the progressive_wealth_tax
                    do while ((net_govt_revenues(time_period)>net_govt_revenue_constraint) .AND. &
                        (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5)))
                
!                        write(*,*) "time_period=", time_period
!                        write(*,*) "progressive_wealth_tax=", &
!                            progressive_wealth_tax
!                        write(*,*) "keep reducing progressive_wealth_tax, revenues minus constraint=", &
!                            net_govt_revenues(time_period)-net_govt_revenue_constraint
                            
                        if (progressive_wealth_tax>0) then
                    
                            ! Reduces the progressive_wealth_tax
                            progressive_wealth_tax=&
                                progressive_wealth_tax*&
                                (1-percentage_change_in_tax)
                                
                        else
                        
                            ! Reduces the progressive_wealth_tax
                            progressive_wealth_tax=&
                                progressive_wealth_tax-&
                                0.0000001
                        
                        end if
                                                                         
                        ! Computes net govt revenues for that progressive_wealth_tax
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                                
                    end do
                                    
                    ! Computes the difference between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the lower bound equal to the current progressive_wealth_tax
                    lower_bound=progressive_wealth_tax
                
!                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "start to slice"
                
                    ! Computes a new progressive_wealth_tax
                    progressive_wealth_tax=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                    
                    ! Keeps looping until the lower and upper bounds are very clsoe
                    do while (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5))
                
                        ! Computes net govt revenues for that progressive_wealth_tax
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
            
                        if (net_govt_revenues(time_period)<net_govt_revenue_constraint) then
                        
                            lower_bound=progressive_wealth_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                       
                        else
                    
                            upper_bound=progressive_wealth_tax
                            
                            ! Computes the distance between net govt revenues and the constraint
                            distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                        
                        end if
                    
                        ! Computes a new progressive_wealth_tax
                        progressive_wealth_tax=&
                            equal_weights*(lower_bound+upper_bound)/2+&
                            (1-equal_weights)*&
                            ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                            (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                                                    
                    end do
                    
!                    write(*,*) "progressive_wealth_tax=", &
!                            progressive_wealth_tax
!                    write(*,*) "upper_bound=", upper_bound
!                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "abs(upper_bound-lower_bound) low side=", &
!                        abs(upper_bound-lower_bound)
                
                ! here net govt revenues are smaller than the constraint
                else
            
                    ! Sets the lower bound to the progressive_wealth_tax
                    lower_bound=progressive_wealth_tax
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                                
                    ! Increase the progressive_wealth_tax by percentage_change_in_tax
                    ! to find a progressive_wealth_tax for which net govt revenues are greater than the constraint
                    progressive_wealth_tax=lower_bound*(1+percentage_change_in_tax)
                                        
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                    
                    ! As long as net govt revenues are greater than the constraint, 
                    ! the program keeps increasing the subsidy
                    do while ((net_govt_revenues(time_period)<net_govt_revenue_constraint) .AND. &
                        (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5)))
                
!                        write(*,*) "time_period=", time_period
!                        write(*,*) "progressive_wealth_tax=", &
!                            progressive_wealth_tax
!                        write(*,*) "keep increasing the progressive_wealth_tax, revenues minus constraint=", &
!                            net_govt_revenues(time_period)-net_govt_revenue_constraint
                            
                        if (progressive_wealth_tax>0) then
                    
                            ! Increases the progressive_wealth_tax
                            progressive_wealth_tax=&
                                progressive_wealth_tax*&
                                (1+percentage_change_in_tax)
                                
                        else
                        
                            ! Increases the progressive_wealth_tax
                            progressive_wealth_tax=&
                                progressive_wealth_tax+&
                                0.0000001
                        
                        end if
                                                                            
                        ! Computes net govt revenues
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                                
                    end do
                
                    ! Computes the difference between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the lower bound equal to the progressive_wealth_tax
                    upper_bound=progressive_wealth_tax
                
!                    write(*,*) "upper_bound=", lower_bound
!                    write(*,*) "start to slice"
                
                    ! Cpmputes a new subsidy
                    progressive_wealth_tax=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                                        
                    ! Keeps looping until the upper and lower bounds are close
                    do while (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5))
                    
                        ! Computes net govt revenues
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                
                        if (net_govt_revenues(time_period)>net_govt_revenue_constraint) then
                    
                            upper_bound=progressive_wealth_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                        
                        else
                    
                            lower_bound=progressive_wealth_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                            
                        end if
                    
                        ! Cpmputes a new progressive_wealth_tax
                        progressive_wealth_tax=&
                            equal_weights*(lower_bound+upper_bound)/2+&
                            (1-equal_weights)*&
                            ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                            (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                                                
                    end do
                    
!                    write(*,*) "progressive_wealth_tax=", &
!                        progressive_wealth_tax
!                    write(*,*) "upper_bound=", upper_bound
!                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "abs(upper_bound-lower_bound)=", &
!                        abs(upper_bound-lower_bound)
            
                end if
                
                progressive_wealth_tax=&
                    weight*previous_progressive_wealth_tax+&
                    (1-weight)*progressive_wealth_tax
                                    
                call govt_revenues_calc(time_period,1)
            
                write(*,*) "slicing net_govt_revenues=", net_govt_revenues(time_period)
                write(*,*) "distance=", abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                write(*,*) "progressive_wealth_tax=", progressive_wealth_tax
                
            elseif (which_tax_system_to_solve==3) then
            
                ! Computing net govt revenues 
                call govt_revenues_calc(time_period,1)
                
                percentage_change_in_tax=percent_change*&
                    min(abs(net_govt_revenues(time_period)-net_govt_revenue_constraint),1.d0)
        
!                write(*,*) "original financial_tax=", &
!                    financial_tax
!                write(*,*) "original net revenues minus constraint=", &
!                    net_govt_revenues(time_period)-net_govt_revenue_constraint
!                write(*,*) "percentage_change_in_tax=", &
!                    percentage_change_in_tax

                previous_financial_tax=&
                    financial_tax
        
                ! net govt revenues are larger than the constraint
                if (net_govt_revenues(time_period)>net_govt_revenue_constraint) then
            
                    ! Sets the upper bound to the financial_tax
                    upper_bound=financial_tax
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                    
                    ! Decreases the financial_tax by percentage_change_in_tax
                    ! to find a financial_tax for which net government revenues are smaller than the constraint
                    financial_tax=&
                        upper_bound*(1-percentage_change_in_tax)
                        
                    business_income_tax=financial_tax
                    investment_income_tax=financial_tax
                    
                    if (uniform_wealth_tax==1) then
                    
                        property_tax(time_period)=benchmark_property_tax+financial_tax
                    
                    end if
                    
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                
                    ! As long as net govt revenues are still larger than the constraint, 
                    ! the program keeps reducing the financial_tax
                    do while ((net_govt_revenues(time_period)>net_govt_revenue_constraint) .AND. &
                        (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5)))
                
!                        write(*,*) "time_period=", time_period
!                        write(*,*) "financial_tax=", &
!                            financial_tax
!                        write(*,*) "keep reducing financial_tax, revenues minus constraint=", &
!                            net_govt_revenues(time_period)-net_govt_revenue_constraint
                            
                        if (financial_tax>0) then
                    
                            ! Reduces the financial_tax
                            financial_tax=&
                                financial_tax*&
                                (1-percentage_change_in_tax)
                                
                        else
                        
                            ! Reduces the financial_tax
                            financial_tax=&
                                financial_tax-&
                                0.0000001
                        
                        end if
                        
                        business_income_tax=financial_tax
                        investment_income_tax=financial_tax
                        
                        if (uniform_wealth_tax==1) then
                    
                            property_tax(time_period)=benchmark_property_tax+financial_tax
                    
                        end if
                                                 
                        ! Computes net govt revenues for that financial_tax
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                                
                    end do
                                    
                    ! Computes the difference between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the lower bound equal to the current financial_tax
                    lower_bound=financial_tax
                
!                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "start to slice"
                
                    ! Computes a new financial_tax
                    financial_tax=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                    
                    business_income_tax=financial_tax
                    investment_income_tax=financial_tax
                    
                    if (uniform_wealth_tax==1) then
                    
                        property_tax(time_period)=benchmark_property_tax+financial_tax
                    
                    end if
                
                    ! Keeps looping until the lower and upper bounds are very clsoe
                    do while (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5))
                
                        ! Computes net govt revenues for that financial_tax
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
            
                        if (net_govt_revenues(time_period)<net_govt_revenue_constraint) then
                        
                            lower_bound=financial_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                       
                        else
                    
                            upper_bound=financial_tax
                            
                            ! Computes the distance between net govt revenues and the constraint
                            distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                        
                        end if
                    
                        ! Computes a new financial_tax
                        financial_tax=&
                            equal_weights*(lower_bound+upper_bound)/2+&
                            (1-equal_weights)*&
                            ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                            (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                            
                        business_income_tax=financial_tax
                        investment_income_tax=financial_tax
                        
                        if (uniform_wealth_tax==1) then
                    
                            property_tax(time_period)=benchmark_property_tax+financial_tax
                    
                        end if
                        
                    end do
                    
!                    write(*,*) "financial_tax=", &
!                            financial_tax
!                    write(*,*) "upper_bound=", upper_bound
!                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "abs(upper_bound-lower_bound) low side=", &
!                        abs(upper_bound-lower_bound)
                
                ! here net govt revenues are smaller than the constraint
                else
            
                    ! Sets the lower bound to the financial_tax
                    lower_bound=financial_tax
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                                
                    ! Increase the financial_tax by percentage_change_in_tax
                    ! to find a financial_tax for which net govt revenues are greater than the constraint
                    financial_tax=lower_bound*(1+percentage_change_in_tax)
                    
                    business_income_tax=financial_tax
                    investment_income_tax=financial_tax
                    
                    if (uniform_wealth_tax==1) then
                    
                        property_tax(time_period)=benchmark_property_tax+financial_tax
                    
                    end if
                    
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                    
                    ! As long as net govt revenues are greater than the constraint, 
                    ! the program keeps increasing the subsidy
                    do while ((net_govt_revenues(time_period)<net_govt_revenue_constraint) .AND. &
                        (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5)))
                
!                        write(*,*) "time_period=", time_period
!                        write(*,*) "financial_tax=", &
!                            financial_tax
!                        write(*,*) "keep increasing the financial_tax, revenues minus constraint=", &
!                            net_govt_revenues(time_period)-net_govt_revenue_constraint
                            
                        if (financial_tax>0) then
                    
                            ! Increases the financial_tax
                            financial_tax=&
                                financial_tax*&
                                (1+percentage_change_in_tax)
                                
                        else
                        
                            ! Increases the financial_tax
                            financial_tax=&
                                financial_tax+&
                                0.0000001
                        
                        end if
                        
                        business_income_tax=financial_tax
                        investment_income_tax=financial_tax
                        
                        if (uniform_wealth_tax==1) then
                    
                            property_tax(time_period)=benchmark_property_tax+financial_tax
                    
                        end if
                                                    
                        ! Computes net govt revenues
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                                
                    end do
                
                    ! Computes the difference between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the lower bound equal to the financial_tax
                    upper_bound=financial_tax
                
!                    write(*,*) "upper_bound=", lower_bound
!                    write(*,*) "start to slice"
                
                    ! Cpmputes a new subsidy
                    financial_tax=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                        
                    business_income_tax=financial_tax
                    investment_income_tax=financial_tax
                    
                    if (uniform_wealth_tax==1) then
                    
                        property_tax(time_period)=benchmark_property_tax+financial_tax
                    
                    end if
                
                    ! Keeps looping until the upper and lower bounds are close
                    do while (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5))
                    
                        ! Computes net govt revenues
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                
                        if (net_govt_revenues(time_period)>net_govt_revenue_constraint) then
                    
                            upper_bound=financial_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                        
                        else
                    
                            lower_bound=financial_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                            
                        end if
                    
                        ! Cpmputes a new financial_tax
                        financial_tax=&
                            equal_weights*(lower_bound+upper_bound)/2+&
                            (1-equal_weights)*&
                            ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                            (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                            
                        business_income_tax=financial_tax
                        investment_income_tax=financial_tax
                        
                        if (uniform_wealth_tax==1) then
                    
                            property_tax(time_period)=benchmark_property_tax+financial_tax
                    
                        end if
                    
                    end do
                    
!                    write(*,*) "financial_tax=", &
!                        financial_tax
!                    write(*,*) "upper_bound=", upper_bound
!                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "abs(upper_bound-lower_bound)=", &
!                        abs(upper_bound-lower_bound)
            
                end if
                
                financial_tax=&
                    weight*previous_financial_tax+&
                    (1-weight)*financial_tax
                    
                business_income_tax=financial_tax
                investment_income_tax=financial_tax
                
                if (uniform_wealth_tax==1) then
                    
                    property_tax(time_period)=benchmark_property_tax+financial_tax
                    
                end if
                
                call govt_revenues_calc(time_period,1)
            
                write(*,*) "slicing net_govt_revenues=", net_govt_revenues(time_period)
                write(*,*) "distance=", abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                write(*,*) "financial_tax=", financial_tax
                write(*,*) "business_income_tax=", business_income_tax
                write(*,*) "investment_income_tax=", investment_income_tax
                
                if (uniform_wealth_tax==1) then
                    
                    write(*,*) "property_tax=", property_tax(time_period)
                    
                end if
                
            ! Taxing capital income and housing or imputed rents
            elseif ((which_tax_system_to_solve==2) .OR. (which_tax_system_to_solve==5)) then
            
                ! Computing net govt revenues 
                call govt_revenues_calc(time_period,1)
                
                percentage_change_in_tax=percent_change*&
                    min(abs(net_govt_revenues(time_period)-net_govt_revenue_constraint),1.d0)

                previous_business_income_tax=&
                    business_income_tax
        
                ! net govt revenues are larger than the constraint
                if (net_govt_revenues(time_period)>net_govt_revenue_constraint) then
            
                    ! Sets the upper bound to the business_income_tax
                    upper_bound=business_income_tax
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                    
                    ! Decreases the business_income_tax by percentage_change_in_tax
                    ! to find a business_income_tax for which net government revenues are smaller than the constraint
                    business_income_tax=&
                        upper_bound*(1-percentage_change_in_tax)
                    
                    investment_income_tax=business_income_tax
                    
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                
                    ! As long as net govt revenues are still larger than the constraint, 
                    ! the program keeps reducing the business_income_tax
                    do while ((net_govt_revenues(time_period)>net_govt_revenue_constraint) .AND. &
                        (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5)))
                                            
                        if (business_income_tax>0) then
                    
                            ! Reduces the financial_tax
                            business_income_tax=&
                                business_income_tax*&
                                (1-percentage_change_in_tax)
                                
                        else
                        
                            ! Reduces the business_income_tax
                            business_income_tax=&
                                business_income_tax-&
                                0.0000001
                        
                        end if
                        
                        investment_income_tax=business_income_tax
                                                                         
                        ! Computes net govt revenues for that business_income_tax
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                                
                    end do
                                    
                    ! Computes the difference between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the lower bound equal to the current business_income_tax
                    lower_bound=business_income_tax
                
!                    write(*,*) "lower_bound=", lower_bound
!                    write(*,*) "start to slice"
                
                    ! Computes a new business_income_tax
                    business_income_tax=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                    
                    investment_income_tax=business_income_tax

                    ! Keeps looping until the lower and upper bounds are very clsoe
                    do while (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5))
                
                        ! Computes net govt revenues for that business_income_tax
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
            
                        if (net_govt_revenues(time_period)<net_govt_revenue_constraint) then
                        
                            lower_bound=business_income_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                       
                        else
                    
                            upper_bound=business_income_tax
                            
                            ! Computes the distance between net govt revenues and the constraint
                            distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                        
                        end if
                    
                        ! Computes a new business_income_tax
                        business_income_tax=&
                            equal_weights*(lower_bound+upper_bound)/2+&
                            (1-equal_weights)*&
                            ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                            (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                            
                        investment_income_tax=business_income_tax
                                                
                    end do
                    
                ! here net govt revenues are smaller than the constraint
                else
            
                    ! Sets the lower bound to the business_income_tax
                    lower_bound=business_income_tax
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                                
                    ! Increase the business_income_tax by percentage_change_in_tax
                    ! to find a business_income_tax for which net govt revenues are greater than the constraint
                    business_income_tax=lower_bound*(1+percentage_change_in_tax)
                    
                    investment_income_tax=business_income_tax
                      
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                    
                    ! As long as net govt revenues are greater than the constraint, 
                    ! the program keeps increasing the subsidy
                    do while ((net_govt_revenues(time_period)<net_govt_revenue_constraint) .AND. &
                        (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5)))
                                            
                        if (business_income_tax>0) then
                    
                            ! Increases the business_income_tax
                            business_income_tax=&
                                business_income_tax*&
                                (1+percentage_change_in_tax)
                                
                        else
                        
                            ! Increases the business_income_tax
                            business_income_tax=&
                                business_income_tax+&
                                0.0000001
                        
                        end if
                        
                        investment_income_tax=business_income_tax
                                           
                        ! Computes net govt revenues
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                                
                    end do
                
                    ! Computes the difference between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the lower bound equal to the business_income_tax
                    upper_bound=business_income_tax
                
!                    write(*,*) "upper_bound=", lower_bound
!                    write(*,*) "start to slice"
                
                    ! Cpmputes a new subsidy
                    business_income_tax=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                        
                    investment_income_tax=business_income_tax
                            
                    ! Keeps looping until the upper and lower bounds are close
                    do while (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-5))
                    
                        ! Computes net govt revenues
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                
                        if (net_govt_revenues(time_period)>net_govt_revenue_constraint) then
                    
                            upper_bound=business_income_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                        
                        else
                    
                            lower_bound=business_income_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                            
                        end if
                    
                        ! Cpmputes a new business_income_tax
                        business_income_tax=&
                            equal_weights*(lower_bound+upper_bound)/2+&
                            (1-equal_weights)*&
                            ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                            (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                            
                        investment_income_tax=business_income_tax
                        
                    end do
                                
                end if
                
                business_income_tax=&
                    weight*previous_business_income_tax+&
                    (1-weight)*business_income_tax
                    
                investment_income_tax=business_income_tax
                        
                call govt_revenues_calc(time_period,1)
            
                write(*,*) "slicing net_govt_revenues=", net_govt_revenues(time_period)
                write(*,*) "distance=", abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                write(*,*) "financial_tax=", financial_tax
                write(*,*) "business_income_tax=", business_income_tax
                write(*,*) "investment_income_tax=", investment_income_tax
                
                if (uniform_wealth_tax==1) then
                    
                    write(*,*) "property_tax=", property_tax(time_period)
                    
                end if
                                
            elseif (which_tax_system_to_solve==1) then
            
                ! Computing net govt revenues 
                call govt_revenues_calc(time_period,1)
        
                write(*,*) "using slicing method 2"
    
                previous_income_tax_increase=increase_in_labour_income_tax
        
                ! net govt revenues are smaller than the constraint
                if (net_govt_revenues(time_period)<net_govt_revenue_constraint) then
            
                    ! Sets the lower bound to the increase in labor income tax
                    lower_bound=increase_in_labour_income_tax
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                    
                    ! Increases the income tax by percentage_change_in_tax
                    ! to find an increase in income tax for which net government revenues are greater than the constraint
                    increase_in_labour_income_tax=lower_bound+0.000002
                                        
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                
                    ! As long as net govt revenues are still smaller than the constraint, 
                    ! the program keeps raising the income tax
                    do while (net_govt_revenues(time_period)<net_govt_revenue_constraint)
                
                        ! Reduces the property tax reduction more
                        increase_in_labour_income_tax=&
                            increase_in_labour_income_tax+0.000002
                    
                        ! Computes net govt revenues for that property tax reduction
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                        
!                        write(*,*) "increase_in_labour_income_tax=", increase_in_labour_income_tax
!                        write(*,*) "net_govt_revenues(time_period)=", &
!                            net_govt_revenues(time_period)
!                        write(*,*) "net_govt_revenue_constraint=", net_govt_revenue_constraint
                                                        
                    end do
                                    
                    ! Computes the difference between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the upper bound equal to the increase income tax
                    upper_bound=increase_in_labour_income_tax
                
                    ! Cpmputes a property tax reduction
                    increase_in_labour_income_tax=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                
                    ! Keeps looping until the lower and upper bounds are very clsoe
                    do while (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-4))
                
                        ! Computes net govt revenues for that property tax reduction
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
            
                        if (net_govt_revenues(time_period)>net_govt_revenue_constraint) then
                        
                            lower_bound=increase_in_labour_income_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                       
                        else
                    
                            upper_bound=increase_in_labour_income_tax
                            
                            ! Computes the distance between net govt revenues and the constraint
                            distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                        
                        end if
                    
                        ! Computes a new property tax reduction
                        increase_in_labour_income_tax=&
                            equal_weights*(lower_bound+upper_bound)/2+&
                            (1-equal_weights)*&
                            ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                            (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                            
!                        write(*,*) "increase_in_labour_income_tax=", increase_in_labour_income_tax
                        
                    end do
                                    
                ! here net govt revenues are larger than the constraint
                else
            
                    ! Sets the upper bound to the labor income tax
                    upper_bound=increase_in_labour_income_tax
                
                    ! Computes the distance between net govt revenues and the constraint
                    distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                                
                    ! Decrease the labor income tax by percentage_change_in_tax
                    ! to find a tax for which net govt revenues are smaller than the constraint
                    increase_in_labour_income_tax=upper_bound-0.000002
                    
                    ! Computes net govt revenues
                    call govt_revenues_calc(time_period,1)
                
                    loop_count_iterations=loop_count_iterations+1
                    
                    ! As long as net govt revenues are greater than the constraint, 
                    ! the program keeps increasing the increase in labor income tax
                    do while (net_govt_revenues(time_period)>net_govt_revenue_constraint)
                                    
                        increase_in_labour_income_tax=&
                            increase_in_labour_income_tax-0.000002
                        
                        ! Computes net govt revenues
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                        
!                        write(*,*) "increase_in_labour_income_tax=", increase_in_labour_income_tax
!                        write(*,*) "net_govt_revenues(time_period)-net_govt_revenue_constraint=", &
!                            net_govt_revenues(time_period)-net_govt_revenue_constraint
                                
                    end do
                
                    ! Computes the difference between net govt revenues and the constraint
                    distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                
                    ! Sets the lower bound equal to the increase_in_labour_income_tax
                    lower_bound=increase_in_labour_income_tax
                
                    write(*,*) "start to slice"
                
                    ! Cpmputes a new increase_in_labour_income_tax
                    increase_in_labour_income_tax=&
                        equal_weights*(lower_bound+upper_bound)/2+&
                        (1-equal_weights)*&
                        ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                        (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                
                    ! Keeps looping until the upper and lower bounds are close
                    do while (abs(net_govt_revenues(time_period)-&
                        net_govt_revenue_constraint)>10.d0**(-4))
                    
                        ! Computes net govt revenues
                        call govt_revenues_calc(time_period,1)
                    
                        loop_count_iterations=loop_count_iterations+1
                
                        if (net_govt_revenues(time_period)<net_govt_revenue_constraint) then
                    
                            lower_bound=increase_in_labour_income_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_lower_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                        
                        else
                    
                            upper_bound=increase_in_labour_income_tax
                        
                            ! Computes the distance between net govt revenues and the constraint
                            distance_upper_bound=abs(net_govt_revenues(time_period)-net_govt_revenue_constraint)
                            
                        end if
                    
                        ! Cpmputes a new increase_in_labour_income_tax
                        increase_in_labour_income_tax=&
                            equal_weights*(lower_bound+upper_bound)/2+&
                            (1-equal_weights)*&
                            ((distance_lower_bound/(distance_lower_bound+distance_upper_bound))*lower_bound+&
                            (distance_upper_bound/(distance_lower_bound+distance_upper_bound))*upper_bound)
                            
!                        write(*,*) "increase_in_labour_income_tax=", &
!                            increase_in_labour_income_tax
                    
                    end do
                                
                end if
                
                increase_in_labour_income_tax=&
                weight*previous_income_tax_increase+&
                (1-weight)*increase_in_labour_income_tax
                
                call govt_revenues_calc(time_period,1)
            
                write(*,*) "slicing net_govt_revenues=", net_govt_revenues(time_period)
                write(*,*) "increase_in_labour_income_tax=", &
                    increase_in_labour_income_tax
                    
            end if
                                                       
        end if
    
    end subroutine
    
    subroutine write_outputs(time_period,solving_transition)
    
        use Wealth_Tax_Global_Vars  
        
        implicit none
        
        integer :: time_period,solving_transition
                
        ! Saves the simulation number
		open(unit=1,file="simulation_number.txt",action="write",status="replace")
		write(1,*) file_number
		close(1) 
        
        ! Saving main simulation statistics
        open(unit=2,file="welfare_tax_code_output"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
        
            write(2,*) "period=", j
            write(2,*) "hours to finish simulaion=", (simulation_stop_time-simulation_start_time)/3600
            write(2,*) "is it counter factual?", what_is_the_program_solving
            write(2,*) "shut_down_housing_market=", shut_down_housing_market
            write(2,*) "exogenous_wages=", exogenous_wages
            write(2,*) "partial_eqilibrium=", partial_eqilibrium
            write(2,*) "wealth_tax_system_type=", wealth_tax_system_type
            write(2,*) "max_debt_to_income_ratio=", max_debt_to_income_ratio
            write(2,*) "robustness_check=", robustness_check
            write(2,*) "higher_nu=", higher_nu
            write(2,*) "lower_nu=", lower_nu
            write(2,*) "looser_lambda=", looser_lambda
            write(2,*) "lump_sum_construction_profits=", lump_sum_construction_profits
            write(2,*) "use_average_rental_size=", use_average_rental_size
            write(2,*) "is_there_mortgage_debt_premium=", is_there_mortgage_debt_premium
            write(2,*) "bequests_to_net_wealth_nishiyama=", bequests_to_net_wealth_nishiyama
            write(2,*) "chi=", chi
            write(2,*) "curv_intrmdte_prod=", curv_intrmdte_prod
            write(2,*) "endogenous_rental_market=", endogenous_rental_market
            write(2,*) "multiple_household_members=", multiple_household_members
            write(2,*) "readjust_financial_position=", readjust_financial_position
            write(2,*) "use_alternative_lenders=", use_alternative_lenders
            write(2,*) "re_do_simulation_with_fixed_parameters=", re_do_simulation_with_fixed_parameters
            write(2,*) "financial_grid_expander=", financial_grid_expander
            write(2,*) "housing_status_grid_expander=", housing_status_grid_expander
            write(2,*) "do_internal_computations=", do_internal_computations
            write(2,*) "add_utility_from_child=", add_utility_from_child
            write(2,*) "bequest_risk_aversion=", bequest_risk_aversion
            write(2,*) "weight_on_bequest=", weight_on_bequest
            write(2,*) "property_tax_is_paid_on_current_period_tax=", &
                property_tax_is_paid_on_current_period_tax
            write(2,*) "disutility_of_landlords_function_of_total_supply=", &
                disutility_of_landlords_function_of_total_supply
            write(2,*) "power_to_raise_to_disutility_to=", power_to_raise_to_disutility_to
            write(2,*) "rebate_construction_profits_lump_sum=", rebate_construction_profits_lump_sum
            write(2,*) "can_get_mortgage_in_retirement=", can_get_mortgage_in_retirement
            write(2,*) "target_net_wealth_to_GDP=", target_net_wealth_to_GDP
            write(2,*) "max_debt_to_income_ratio=", max_debt_to_income_ratio
            write(2,*) "file number=", file_number
            write(2,*) "benchmark_simulation=", benchmark_simulation
            write(2,*) "long_run_simulation=", long_run_simulation
            write(2,*) "loop_count=", loop_count
            write(2,*) "FRED_housing_services_to_GDP=", FRED_housing_services_to_GDP
            write(2,*) "SCF_homeownership_rate=", SCF_homeownership_rate
            write(2,*) "(housing_price(j)*model_median_owner_occupied_unit_size(j))/&
                model_GDP_per_household(j)=", &
                (housing_price(j)*model_median_owner_occupied_unit_size(j))/&
                model_GDP_per_household(j)
            write(2,*) "SW_hmowners_with_mrtgage_spend_over_X_on_hous=", SW_hmowners_with_mrtgage_spend_over_X_on_hous
            write(2,*) "SW_renters_spend_over_X_on_hous=", SW_renters_spend_over_X_on_hous
            write(2,*) "rent_fraction_of_housing_costs=", rent_fraction_of_housing_costs
            write(2,*) "standard_net_wealth_to_GDP=", standard_net_wealth_to_GDP
            write(2,*) "SCF_homeowners_with_mortgage=", SCF_homeowners_with_mortgage
            write(2,*) "aftr_how_mny_lps_start_update=", aftr_how_mny_lps_start_update
            write(2,*) "negative_consumption=", negative_consumption
            write(2,*) "a_large_multiple_of_income=", a_large_multiple_of_income
            write(2,*) "weight_housing_price=", weight_housing_price
            write(2,*) "unemploy_bene_frac_of_lowest_employ=", unemploy_bene_frac_of_lowest_employ
            write(2,*) "average_welfare_of_youngest_cohort=", average_welfare_of_youngest_cohort(j)
            write(2,*) "frac_in_support_youngest=", frac_in_support_youngest(j)
            write(2,*) "average_welfare_of_all_cohorts=", average_welfare_of_all_cohorts(j)
            write(2,*) "frac_in_support=", frac_in_support(j)
            write(2,*) "utility_from_public_consumption_bench(1)=", &
                utility_from_public_consumption_bench(j)
            write(2,*) "utility_from_public_consumption_average=", &
                utility_from_public_consumption_average_bench
            write(2,*) "utility_from_public_consumption_counter(1,j)=", &
                utility_from_public_consumption_counter(1,j)
            write(2,*) "utility_from_public_consumption_average_counter=", &
                utility_from_public_consumption_average_counter
            write(2,*) "housing_price=", housing_price(j)
            write(2,*) "housing_price/calibrated_stationary_housing_price=", &
                housing_price(j)/calibrated_stationary_housing_price
            write(2,*) "calibrated_stationary_housing_price=", calibrated_stationary_housing_price
            write(2,*) "long_run_stationary_housing_price=", long_run_stationary_housing_price
            write(2,*) "model_homeownership_rate=", model_homeownership_rate(j)
            write(2,*) "total_rental_demand=", total_rental_demand(j)
            write(2,*) "total_rental_supply=", total_rental_supply(j)
            write(2,*) "rent_to_housing_price=", rent_to_housing_price
            write(2,*) "rent=", rent(j)
            write(2,*) "rent_calibrated=", rent_calibrated
            write(2,*) "rent/rent_calibrated=", rent(j)/rent_calibrated 
            write(2,*) "rent/housing_price=", rent(j)/housing_price(j)
            write(2,*) "c_1=", c_1
            write(2,*) "c_1_calibrated=", c_1_calibrated
            write(2,*) "c_min=", c_min
            write(2,*) "c_min_calibrated=", c_min_calibrated
            write(2,*) "rental_management_costs=", rental_management_costs
            write(2,*) "rental_management_costs_calibrated=", rental_management_costs_calibrated
            write(2,*) "cutoff_housing_investment=", cutoff_housing_investment
            write(2,*) "housing_investment=", housing_investment(j)
            write(2,*) "cutoff_housing_investment_calibrated=", cutoff_housing_investment_calibrated
            write(2,*) "housing_stock=", housing_stock(j)
            write(2,*) "calibrated_housing_stock=", calibrated_housing_stock 
            write(2,*) "long_run_housing_stock=", long_run_housing_stock
            write(2,*) "wage_calibrated=", wage_calibrated
            write(2,*) "wage_long_run=", wage_long_run
            write(2,*) "total_housing_demand=", total_housing_demand(j)
            write(2,*) "housing_price/model_GDP_per_household=", housing_price(j)/model_GDP_per_household(j)
            write(2,*) "total_housing_demand=", total_housing_demand(j)
            write(2,*) "empirical housing_stock_elasticity=", empirical_housing_supplpy_elasticity
            write(2,*) "total_constrcution_profits=", total_constrcution_profits(j)
            write(2,*) "model_construction_company_profits_verified=", model_construction_company_profits_verified(j)
            write(2,*) "construction_company_profits_per_household=", construction_company_profits_per_household(j)
            write(2,*) "model_homeownership rate youngest cohort=", model_homeownership_rate_young(j)
            write(2,*) "net housing wealth out of net wealth youngest cohort=", &
                model_net_housing_wealth_young(j)/&
                (model_net_housing_wealth_young(j)+model_financial_young(j))
            write(2,*) "maximum mortgage as percentage of house value=", mortgage_grid(mortgage_grid_size)
            write(2,*) "model_total_income=", &                
                model_total_investment_income(j)+&
                (1-exogenous_wages)*&
                (wage(j)*model_total_efficiency_units(j)+&
                model_total_business_income(j))+&
                exogenous_wages*model_output(j)+&
                (1-shut_down_housing_market)*&
                construction_company_profits(j)
            write(2,*) "model_total_investment_income=", &                
                model_total_investment_income(j)
            write(2,*) "wage*model_total_efficiency_units=", &
                wage(j)*model_total_efficiency_units(j)
            write(2,*) "model_total_business_income=", &
                model_total_business_income(j)
            write(2,*) "model_total_expenditures=", &
                aggregate_consumption(j)+&
                net_govt_revenues(j)+&
                (1-shut_down_housing_market)*&
                ((aggregate_housing_consumption(j)+&
                aggregate_mortgage_consumption(j))+&
                (1-endogenous_rental_market)*&
                (aggregate_rent_spending(j)-&
                govt_revenues_from_property_tax_rental(j)))
            write(2,*) "aggregate_consumption=", &
                aggregate_consumption(j)
            write(2,*) "net_govt_revenues=", &
                net_govt_revenues(j)
            write(2,*) "aggregate_rental_income-aggregate_rent_spending=", &
                aggregate_rental_income(j)-aggregate_rent_spending(j)
            write(2,*) "aggregate_rental_income=", aggregate_rental_income(j)
            write(2,*) "rental_income_tax*aggregate_rental_income=", rental_income_tax*aggregate_rental_income(j)
            write(2,*) "aggregate_rental_profits(j)=", aggregate_rental_profits(j)
            write(2,*) "rental_income_tax*aggregate_rental_profits(j)=", rental_income_tax*aggregate_rental_profits(j)
            write(2,*) "govt_revenues_from_rental_income(j)=", govt_revenues_from_rental_income(j)
            write(2,*) "output=", model_output(j)
            write(2,*) "GDP=", model_GDP(j)
            write(2,*) "model_total_investment_income=", model_total_investment_income(j)
            write(2,*) "model_total_business_income=", model_total_business_income(j)
            write(2,*) "model_total_efficiency_units=", model_total_efficiency_units(j)
            write(2,*) "model_total_efficiency_units_calibrated=", model_total_efficiency_units_calibrated
            write(2,*) "model_total_efficiency_units_long_run=", model_total_efficiency_units_long_run
            write(2,*) "wage=", wage(j)
            write(2,*) "wage/wage_calibrated=", wage(j)/wage_calibrated
            write(2,*) "aggregate_production_times_labour=", aggregate_production_times_labour(j)
            write(2,*) "aggregation_of_tot_intermdte_gds=", aggregation_of_tot_intermdte_gds(j)
            write(2,*) "corporate_capital=", corporate_capital(j)
            write(2,*) "wage to output=", &
                (wage(j)*model_total_efficiency_units(j))/model_output(j)
            write(2,*) "model_GDP_including_rent=", model_GDP_including_rent(j)
            write(2,*) "model_GDP_incl_imput_rent=", model_GDP_incl_imput_rent(j)
            write(2,*) "total_housing_services=", total_housing_services(j)
            write(2,*) "total_imputed_rents(j)=", total_imputed_rents(j)
            write(2,*) "total_housing_services to total GDP including imputed rent=", &
                (total_housing_services(j)+total_imputed_rents(j))/model_GDP_incl_imput_rent(j)
            write(2,*) "total_housing_services to total output=", &
                (total_housing_services(j)+total_imputed_rents(j))/model_output(j)
            write(2,*) "total_housing_services/total_renter_household_income=", &
                total_housing_services(j)/total_renter_household_income(j)
            do i=1,life_span
                write(2,*) "labour_deterministic_efficiency(",i,")=", labour_deterministic_efficiency(i)
            end do
            do i=1,employment_grid_size
                write(2,*) "distribution_stationary(",j,":,:,",i,",:)=", &
                    sum(distribution_stationary(j,1:life_span-retirement_span,:,i,:,:))/&
                    sum(distribution_stationary(j,1:life_span-retirement_span,:,:,:,:))
            end do 
            do i=1,productivity_grid_size
                write(2,*) "distribution_stationary(",j,":,:,",i,",:)=", &
                    sum(distribution_stationary(j,1:life_span-retirement_span,:,:,:,i))/&
                    sum(distribution_stationary(j,1:life_span-retirement_span,:,:,:,:))
            end do
            do i=1,productivity_shock_grid_size
                write(2,*) "fraction with productivity_shock_index(",i,")=", &
                sum(distribution_stationary(1,:,:,:,i,:))/sum(distribution_stationary)
            end do
            do i=1,productivity_grid_size
                write(2,*) "productivity_grid(",i,")=", &
                    productivity_grid(i)
            end do
            do i=1,productivity_shock_grid_size
                write(2,*) "productivity_shock_grid(",i,")=", &
                    productivity_shock_grid(i)
            end do
            do i=1,employment_grid_size
                write(2,*) "employment_grid(",i,")=", &
                    employment_grid(i)
            end do
            do i=1,employment_grid_size
                write(2,*) "labour income tax=",i,"=", labour_income_tax(i)
            end do   
            do i=1,mortgage_grid_size
                write(2,*) "mortgage grid=",i,"=", mortgage_grid(i)
            end do
            write(2,*) "mortgage grid size=", mortgage_grid_size
            do i=1,productivity_shock_grid_size
                write(2,*) "productivity_shock_grid(i)=", &
                    productivity_shock_grid(i)
            end do
            do i=1,productivity_shock_grid_size
                do productivity_shock_index=1,productivity_shock_grid_size
                    write(2,*) "productivity_shock_process(",i,",",productivity_shock_index,")=", &
                        productivity_shock_process(i,productivity_shock_index)
                end do
            end do                
            write(2,*) "model_average_lowest_labor_income=", model_average_lowest_labor_income
            write(2,*) "model_average_labour_income_tax=", model_average_labour_income_tax(j)
            write(2,*) "model_GDP_per_household=", model_GDP_per_household(j)
            write(2,*) "model_median_net_wealth=", model_median_net_wealth
            write(2,*) "model_average_net_wealth=", &
                model_average_net_wealth(j)
            write(2,*) "total financial wealth=", model_financial(j)
            write(2,*) "model_financial_per_household=", model_financial_per_household(j)
            write(2,*) "model_net_wealth_per_household=", model_net_wealth_per_household(j)
            write(2,*) "total net housing wealth=", model_net_housing_wealth(j)
            write(2,*) "model_gross_housing_wealth=", model_gross_housing_wealth(j)
            write(2,*) "value of rental housing=", housing_price(j)*total_rental_demand(j)
            write(2,*) "total mortgage debt=", model_mortgages(j)
            write(2,*) "mortgage+rental housing to total net wealth=", &
                (model_mortgages(j)+housing_price(j)*total_rental_demand(j))/&
                model_total_net_wealth(j)
            write(2,*) "total net wealth=", model_total_net_wealth(j)
            write(2,*) "effectiency units of labour=", model_total_efficiency_units(j)
            write(2,*) "model_total_workers=", model_total_workers(j)
            write(2,*) "fraction of hhlds who make it to the highest net wealth=", &
                sum(distribution_stationary(j,:,financial_grid_size,:,:,:))/&
                sum(distribution_stationary(j,:,:,:,:,:))
            write(2,*) "consumption tax=", consumption_tax
            write(2,*) "business_income_tax=", business_income_tax
            write(2,*) "financial_tax=", financial_tax
            write(2,*) "progressive_wealth_tax=", progressive_wealth_tax
            write(2,*) "progressive_financial_tax=", progressive_financial_tax
            write(2,*) "threshold_financial=", threshold_financial
            write(2,*) "progressive_housing_tax=", progressive_housing_tax
            write(2,*) "threshold_housing=", threshold_housing
            write(2,*) "progressive_wealth_tax_threshold=", progressive_wealth_tax_threshold
            write(2,*) "threshold_financial=", threshold_financial
            write(2,*) "threshold_housing=", threshold_housing
            write(2,*) "investment_income_tax=", investment_income_tax
            write(2,*) "property_tax=", property_tax(j)
            write(2,*) "net_govt_revenue_constraint=", net_govt_revenue_constraint
            write(2,*) "net_govt_revenue_long_run=", net_govt_revenue_long_run
            write(2,*) "net housing wealth to total wealth=", model_net_housing_wealth(j)/model_total_net_wealth(j)
            write(2,*) "chi=", chi
            write(2,*) "NPV of gross govt revenues=", total_govt_revenues(j)
            write(2,*) "NPV of net govt revenues=", net_govt_revenues(j)
            write(2,*) "% of GDP raised in net govt revenues=", 100*(net_govt_revenues(j)/model_GDP(j))
            write(2,*) "% of GDP raised in gross govt revenues=", 100*(total_govt_revenues(j)/model_GDP(j))
            write(2,*) "% of gross govt revenues from labour income tax=", &
                100*(govt_revenues_from_labour_income(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt revenues from consumption tax=", &
                100*(govt_revenues_from_consumption(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt revenues from investment income tax=", &
                100*(govt_revenues_from_investment_income(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt revenues from business income tax=", &
                100*(govt_revenues_from_business_income(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt revenues from imputed rents tax=", &
                100*(govt_revenues_from_imputed_rents(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt revenues from wealth=", &
                100*(govt_revenues_from_wealth(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt revenues from progressive wealth tax=", &
                100*(govt_revenues_from_progressive_wealth_tax(j)/total_govt_revenues(j))
            write(2,*) "govt_revenues_from_progressive_housing_tax=", &
                100*(govt_revenues_from_progressive_housing_tax(j)/total_govt_revenues(j))
            write(2,*) "govt_revenues_from_progressive_financial_tax", &
                100*(govt_revenues_from_progressive_financial_tax(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt revenues from rental income=", &
                100*(govt_revenues_from_rental_income(j)/total_govt_revenues(j))
            write(2,*) "% of gross govt revenues from property tax=", &
                100*((govt_revenues_from_property_tax(j)+&
                (1-endogenous_rental_market)*govt_revenues_from_property_tax_rental(j))/&
                total_govt_revenues(j))
            write(2,*) "% of gross govt revenues spent on social security=", &
                100*(govt_spending_on_ss(j)/total_govt_revenues(j))
            write(2,*) "% of gross_govt revenues spent on welfare_subusidiies=", &
                100*(govt_spending_welfare_subsidies(j)/total_govt_revenues(j))
            write(2,*) "min_welf_sub_as_frac_of_low_wage=", &
                min_welf_sub_as_frac_of_low_wage
            write(2,*) "govt_spending_on_unemployment_benefits(j)=", &
                govt_spending_on_unemployment_benefits(j)
            write(2,*) "gross govt revenues from labour income tax=", &
                govt_revenues_from_labour_income(j)
            write(2,*) "gross govt revenues from consumption tax=", &
                govt_revenues_from_consumption(j)
            write(2,*) "gross govt revenues from investment income tax=", &
                govt_revenues_from_investment_income(j)
            write(2,*) "gross govt revenues from business income tax=", &
                govt_revenues_from_business_income(j)
            write(2,*) "gross govt revenues from imputed rent tax=", &
                govt_revenues_from_imputed_rents(j)
            write(2,*) "gross govt revenues from wealth=", &
                govt_revenues_from_wealth(j)
            write(2,*) "govt_revenues_from_progressive_wealth_tax", &
                govt_revenues_from_progressive_wealth_tax(j)
            write(2,*) "govt_revenues_from_progressive_financial_tax", &
                govt_revenues_from_progressive_financial_tax(j)
            write(2,*) "govt_revenues_from_progressive_housing_tax=", &
                govt_revenues_from_progressive_housing_tax(j)
            write(2,*) "gross govt revenues from rental income=", &
                govt_revenues_from_rental_income(j)
            write(2,*) "gross govt revenues from property tax=", &
                govt_revenues_from_property_tax(j)+&
                (1-endogenous_rental_market)*govt_revenues_from_property_tax_rental(j)
            write(2,*) "gross govt revenues spent on social security=", &
                govt_spending_on_ss(j)
            write(2,*) "govt_spending_on_unemployment_benefits(j)=", &
                govt_spending_on_unemployment_benefits(j)
            write(2,*) "model_unemployment_benefits(j)=", &
                model_unemployment_benefits(j)
            write(2,*) "% of gross govt revenues spent on bailouts=", &
                100*(govt_spending_on_bailouts(j)/total_govt_revenues(j))
            write(2,*) "% govt spending on mortgage interest deductions/model GDP=", &
                100*(govt_spending_on_mortgage_interest_deductions(j)/model_GDP(j))
            write(2,*) "model_fraction_paying_progressive_wealth_tax=", &
                model_fraction_paying_progressive_wealth_tax(j)  
            write(2,*) "model_fraction_paying_progressive_housing_tax=", &
                model_fraction_paying_progressive_housing_tax(j)  
            write(2,*) "model_fraction_paying_progressive_financial_tax=", &
                model_fraction_paying_progressive_financial_tax(j)  
            write(2,*) "model_fraction_paying_both_progressive_taxes=", &
                model_fraction_paying_both_progressive_taxes(j)
            write(2,*) "frac_bailedout=", frac_bailedout(j)
            write(2,*) "model_bequests=", model_bequests(j)
            write(2,*) "model_bequests/model_net_wealth=", &
                model_bequests(j)/model_total_net_wealth(j)
            write(2,*) "risk_free_rate=", risk_free_rate(j)
            write(2,*) "wages to output=", &
                (model_total_efficiency_units(j)*wage(j))/&
                model_output(j)
            write(2,*) "labor share of income=", &
                share_of_labour
            write(2,*) "profits to output=", &
                model_total_gross_enrepreneurial_income(j)/&
                model_output(j)
            write(2,*) "capital share of income=", &
                share_of_capital
            if (share_of_corporate_profits>0) then
                write(2,*) "corporate profits to output=", &
                    ((risk_free_rate(j)+financial_wealth_depreciation)*&
                    corporate_capital(j))/model_output(j)
            end if
            write(2,*) "model_fin_debt to gross assets=", &
                model_fin_debt(j)/(model_financial(j)+model_gross_housing_wealth(j))
            write(2,*) "model average labour income=", model_average_labour_income(j)
            write(2,*) "model_ss_benefits=", &
                model_ss_benefits
            write(2,*) "calibrated_soc_secrty=", calibrated_soc_secrty
            write(2,*) "increase_in_labour_income_tax=", increase_in_labour_income_tax
            do i=0,2
                write(2,*) "mass_by_ownership_status=", &
                    sum(mass_by_ownership_status(j,i,:))/&
                    sum(distribution_stationary(j,1,:,:,:,:))           
            end do
            write(2,*) "advantage_to_owning=", advantage_to_owning
            write(2,*) "discount factor=", discount_factor
            write(2,*) "disutility_of_landlords=", disutility_of_landlords
            write(2,*) "relative_share_of_housing=", relative_share_of_housing
            write(2,*) "risk_aversion_share_of_cons=", risk_aversion_share_of_cons
            write(2,*) "sd_epsilon_log_productivity=", sd_epsilon_log_productivity
            write(2,*) "probability_of_staying_in_fast_lane=", probability_of_staying_in_fast_lane
            write(2,*) "max_debt_to_assets=", max_debt_to_assets
            write(2,*) "multiple_max_debt_to_assets=", multiple_max_debt_to_assets
            write(2,*) "cond_max_debt_to_assets_on_prod=", cond_max_debt_to_assets_on_prod
            write(2,*) "housing grid size=", housing_status_grid_size
            write(2,*) "smallest_house_size=", smallest_house_size
            write(2,*) "mass_of_renters_at_housing_spending(1,1)=", mass_of_renters_at_housing_spending(1,1)
            write(2,*) "mass_of_renters_at_housing_spending(1,2)=", mass_of_renters_at_housing_spending(1,2)
            write(2,*) "mass_of_renters_at_housing_spending(1,3)=", mass_of_renters_at_housing_spending(1,3)
            write(2,*) "mass_of_renters_at_housing_spending(1,4)=", mass_of_renters_at_housing_spending(1,4)
            write(2,*) "mass_of_owners_at_housing_spending(1,1)=", mass_of_homeowners_at_housing_spending(1,1)
            write(2,*) "mass_of_owners_at_housing_spending(1,2)=", mass_of_homeowners_at_housing_spending(1,2)
            write(2,*) "mass_of_owners_at_housing_spending(1,3)=", mass_of_homeowners_at_housing_spending(1,3)
            write(2,*) "mass_of_owners_at_housing_spending(1,4)=", mass_of_homeowners_at_housing_spending(1,4)
            write(2,*) "largest_house_size=", largest_house_size
            write(2,*) "index_of_smallest_house_hhld_can_buy=", index_of_smallest_house_hhld_can_buy
            write(2,*) "housing_size(index_of_smallest_house_hhld_can_buy)=", &
                housing_size(index_of_smallest_house_hhld_can_buy)
            write(2,*) "largest_house_size_hhld_can_rent=", largest_house_size_hhld_can_rent
            write(2,*) "target_rent_to_price_ratio=", target_rent_to_price_ratio
            write(2,*) "himmelberg_etal_rent_to_price=", himmelberg_etal_rent_to_price
            write(2,*) "model_average_rental_unit_size(j)=",&
                model_average_rental_unit_size(j)
            write(2,*) "model_average_owner_occupied_unit_size(j)=",&
                model_average_owner_occupied_unit_size(j)
            write(2,*) "housing_price*model_average_owner_occupied_unit_size/GDP per household=",&
                (housing_price(j)*model_average_owner_occupied_unit_size(j))/&
                (model_output/sum(distribution_stationary))
            write(2,*) "model_median_owner_occupied_unit_size(j)=", &
                model_median_owner_occupied_unit_size(j)
            write(2,*) "model_average_rental_unit_size(j)/model_average_owner_occupied_unit_size(j)=", &
                model_average_rental_unit_size(j)/model_average_owner_occupied_unit_size(j)
            write(2,*) "largest_housing_size_consumed_in_equilibrium=", &
                largest_housing_size_consumed_in_equilibrium
            write(2,*) "largest_financial_chosen_in_equilibrium=", &
                largest_financial_chosen_in_equilibrium
            write(2,*) "model_fraction_of_landlords=", model_fraction_of_landlords(j)
            write(2,*) "model_average_landlord_house_size=", &
                model_average_landlord_house_size(j)
            write(2,*) "model_average_landlord_space_rented_out=", &
                model_average_landlord_space_rented_out(j)
            write(2,*) "fraction of hhlds who make it to the highest net wealth=", &
                sum(distribution_stationary(1,:,financial_grid_size,:,:,:))/&
                sum(distribution_stationary(1,:,:,:,:,:))
            write(2,*) "largest income grid=", max_times_labour_income_saved
            write(2,*) "financial grid points=", financial_grid_size
            write(2,*) "financial grid points internal=", fin_num_of_internal
            write(2,*) "space_lived_in_num_of_internal=", space_lived_in_num_of_internal
            write(2,*) "multiples of income=", max_times_labour_income_saved
            write(2,*) "housing depreciation rate=", housing_depreciation
            write(2,*) "housing depreciation expenditures=", housing_price(j)*housing_depreciation
            write(2,*) "model_fraction_of_homeowners_with_mortgage=", &
                model_fraction_of_homeowners_with_mortgage(j)
            write(2,*) "model fraction of households with mortgage=", &
                model_fraction_of_homeowners_with_mortgage(transition_length)*&
                model_homeownership_rate(transition_length)
            write(2,*) "model_fraction_of_mortgage_holders_using_alternative_lenders=", &
                model_fraction_of_mortgage_holders_using_alternative_lenders(j)     
            write(2,*) "model fraction of households with alternative lenders=", &
                model_fraction_of_mortgage_holders_using_alternative_lenders(j)*&
                model_fraction_of_homeowners_with_mortgage(j)*&
                model_homeownership_rate(j)
            write(2,*) "model_fraction_of_homeowners_with_mortgage_over_80_perc=", &
                model_fraction_of_homeowners_with_mortgage_over_80_perc(j)
            write(2,*) "fraction of households with mortgage ober 80 perc=", &
                model_fraction_of_homeowners_with_mortgage_over_80_perc(j)*&
                model_fraction_of_homeowners_with_mortgage(j)*&
                model_homeownership_rate(j)
            write(2,*) "total population=", total_population
            write(2,*) "fraction of retired households in popualtoin=", &
                sum(distribution_stationary(j,life_span-retirement_span+1:life_span,:,:,:,:))/&
                sum(distribution_stationary(j,:,:,:,:,:))
            write(2,*) "mortgage_interest_rate=", mortgage_interest_rate(j)
            write(2,*) "mortgage_insurance_premium=", mortgage_insurance_premium
            write(2,*) "stress_test=", stress_test(j)
            write(2,*) "total efficiency units=", model_total_efficiency_units(j)
            write(2,*) "model financial wealth to output=", model_financial(j)/model_output(j)
            write(2,*) "model net housing wealth to output=", model_net_housing_wealth(j)/model_output(j)
            write(2,*) "model total net wealth to output=", model_total_net_wealth(j)/model_output(j)
            write(2,*) "model_net_housing_wealth/model_total_net_wealth=", &
                model_net_housing_wealth(j)/model_total_net_wealth(j)
            write(2,*) "financial_lower_bound=", financial_lower_bound
            write(2,*) "financial_lower_bound_adjuster=", financial_lower_bound
            write(2,*) "model mortgage debt to gross housing wealth=", model_mortgages(j)/model_gross_housing_wealth(j)
            write(2,*) "life span=", life_span
            write(2,*) "retirement_span=", retirement_span
            write(2,*) "model_GDP_including_imputed_rents=", model_GDP_incl_imput_rent(j)
            write(2,*) "wealth to GDP=", model_total_net_wealth(j)/model_GDP(j)
            write(2,*) "aggregate_consumption=", aggregate_consumption(j)
            write(2,*) "aggregate_housing_consumption=", aggregate_housing_consumption(j)
            write(2,*) "aggregate_mortgage_consumption=", aggregate_mortgage_consumption(j)
            write(2,*) "financial wealth to GDP=", model_financial(j)/model_GDP(j)
            write(2,*) "net housing wealth to GDP=", model_net_housing_wealth(j)/model_GDP(j)
            write(2,*) "model_total_net_wealth/model_GDP_incl_imput_rent=", &
                (model_total_net_wealth(j)/model_GDP_incl_imput_rent(j))
            write(2,*) "model total net wealth to GDP with rents=", model_total_net_wealth(j)/model_GDP_including_rent(j)
            write(2,*) "model total net wealth to output=", model_total_net_wealth(j)/model_output(j)
            write(2,*) "gross housing wealth to GDP=", model_gross_housing_wealth(j)/model_GDP(j)
            write(2,*) "minimum_downpayment=", minimum_downpayment
            write(2,*) "minimum_downpayment_below_20_perc=", minimum_downpayment_below_20_perc
            write(2,*) "consumption risk aversion=", risk_aversion
            write(2,*) "permanent labour_deterministic_efficiency slope=", life_cycle_component_a
            write(2,*) "stopping_rule_stationary_distribution=", stopping_rule_stationary_distribution
            write(2,*) "stopping_rule_cutoff_housing_investment=", stopping_rule_cutoff_housing_investment
            write(2,*) "stopping_rule_value_function=", stopping_rule_value_function
            write(2,*) "stopping_rule_housing_market=", stopping_rule_housing_market
            write(2,*) "stopping_rule_rental_market=", stopping_rule_housing_market
            write(2,*) "stopping_rule_discount_factor=", stopping_rule_discount_factor
            write(2,*) "stopping_rule_disutility_of_landlords=", stopping_rule_disutility_of_landlords
            write(2,*) "stopping_rule_relative_share_of_housing=", stopping_rule_relative_share_of_housing
            write(2,*) "stopping_rule_govt_budget=", stopping_rule_govt_budget
            write(2,*) "stopping_rule_risk_free_rate=", stopping_rule_risk_free_rate
            write(2,*) "stopping_rule_max_debt_to_assets=", stopping_rule_max_debt_to_assets
            write(2,*) "stopping_rule_advantage_to_owning=", stopping_rule_advantage_to_owning
            write(2,*) "stopping_rule_probability_of_staying_in_fast_lane=", stopping_rule_probability_of_staying_in_fast_lane
            write(2,*) "stopping_rule_weight_on_bequest=", stopping_rule_weight_on_bequest
            write(2,*) "distance_value_function=", distance_value_function
            write(2,*) "distance_housing_market=", distance_housing_market(j)
            write(2,*) "distance_rental_market=", distance_rental_market(j)
            write(2,*) "distance_advantage_to_owning=", distance_advantage_to_owning
            write(2,*) "distance_discount_factor=", distance_discount_factor
            write(2,*) "distance_disutility_of_landlords=", distance_disutility_of_landlords
            write(2,*) "distance_multiple_max_debt_to_assets=", distance_multiple_max_debt_to_assets
            write(2,*) "distance_wealth_by_top_1_perc=", distance_wealth_by_top_1_perc
            write(2,*) "distance_govt_budget=", distance_govt_budget
            write(2,*) "distance_rental_market=", distance_rental_market(j)
            write(2,*) "distance_risk_free_rate=",distance_risk_free_rate(j)
            write(2,*) "distance_probability_of_staying_in_fast_lane=", &
                distance_probability_of_staying_in_fast_lane
            write(2,*) "distance_weight_on_bequest=", distance_weight_on_bequest
            write(2,*) "aggregate_borrowing_or_lending=", aggregate_borrowing_or_lending
            write(2,*) "gini_coefficient=", gini_coefficient(j)
            do wealth_of_top_x_perc_index=1,wealth_brackets
                write(2,*) "top", &
                    100*(pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/&
                    sum(distribution_stationary)), "% hold", &
                    100*(model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)/&
                    (model_total_net_wealth(j))), "% of total wealth"
                write(2,*) "top", &
                    100*(pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/&
                    sum(distribution_stationary)), "% hold ", &
                    100*(model_net_hous_wealth_top_x_perc(wealth_of_top_x_perc_index))/&
                    (model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)), &
                    "% of their net wealth in housing"
                write(2,*) "top", &
                    100*(pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/&
                    sum(distribution_stationary)), "% have ", &
                    model_net_hous_wealth_top_x_perc(wealth_of_top_x_perc_index),&
                    "net wealth in housing"
                write(2,*) "top", &
                    100*(pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/&
                    sum(distribution_stationary)), "% have ", &
                    model_net_hous_wealth_top_x_perc(wealth_of_top_x_perc_index)/&
                    pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index), &
                    "per household net wealth in housing"
                write(2,*) "top", &
                    100*(pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/&
                    sum(distribution_stationary)), "% hold ", &
                    100*(model_financial_wealth_top_x_perc(wealth_of_top_x_perc_index))/&
                    (model_wealth_of_top_x_perc(wealth_of_top_x_perc_index)), &
                    "% of their net wealth in financial wealth"
                write(2,*) "top", &
                    100*(pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/&
                    sum(distribution_stationary)), "% have ", &
                    model_financial_wealth_top_x_perc(wealth_of_top_x_perc_index),&
                    "financial wealth"
                write(2,*) "top", &
                    100*(pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/&
                    sum(distribution_stationary)), "% have ", &
                    model_financial_wealth_top_x_perc(wealth_of_top_x_perc_index)/&
                    pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index), &
                    "per household financial wealth"
                write(2,*) model_homeonwership_rate_top_x_perc(wealth_of_top_x_perc_index), &
                    "in the top", 100*(pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/&
                    sum(distribution_stationary)), "own a home"
                write(2,*) "Homeowners in the top", &
                    100*(pop_of_top_wealth_x_perc(wealth_of_top_x_perc_index)/&
                    sum(distribution_stationary)), " % have mortgage debt of ", &
                    model_mortg_debt_wealth_top_perc(wealth_of_top_x_perc_index)/&
                    (model_mortg_debt_wealth_top_perc(wealth_of_top_x_perc_index)+&
                    model_net_hous_wealth_top_x_perc(wealth_of_top_x_perc_index)), " % of their home value"
            end do
            write(2,*) "bottom", 100*(pop_of_bot_wealth_50_perc/&
                sum(distribution_stationary)), "% hold", &
                100*(model_wealth_of_bot_50_perc/&
                (model_total_net_wealth(j))), "% of total wealth"
            write(2,*) "bottom", 100*(pop_of_bot_wealth_50_perc/&
                sum(distribution_stationary)), "% hold ", &
                100*(model_net_hous_wealth_bot_50_perc/&
                model_wealth_of_bot_50_perc), &
                "% of their net wealth in housing"
            write(2,*) "bottom", 100*(pop_of_bot_wealth_50_perc)/&
                sum(distribution_stationary), "% have ", &
                model_net_hous_wealth_bot_50_perc,&
                "net wealth in housing"
            write(2,*) "bottom", 100*(pop_of_bot_wealth_50_perc/&
                sum(distribution_stationary)), "% have ", &
                model_net_hous_wealth_bot_50_perc/&
                pop_of_bot_wealth_50_perc, &
                "per household net wealth in housing"
            write(2,*) "bottom", 100*(pop_of_bot_wealth_50_perc/&
                sum(distribution_stationary)), "% hold ", &
                100*(model_financial_wealth_bot_50_perc)/&
                (model_wealth_of_bot_50_perc), &
                "% of their net wealth in financial wealth"
            write(2,*) "bottom", 100*(pop_of_bot_wealth_50_perc/&
                sum(distribution_stationary)), "% have ", &
                model_financial_wealth_bot_50_perc,&
                "financial wealth"
            write(2,*) "bottom", 100*(pop_of_bot_wealth_50_perc/&
                sum(distribution_stationary)), "% have ", &
                model_financial_wealth_bot_50_perc/&
                pop_of_bot_wealth_50_perc, &
                "per household financial wealth"
            write(2,*) model_homeownership_rate_bot_50_perc, &
                "in the bottom", 100*(pop_of_bot_wealth_50_perc/sum(distribution_stationary)), &
                "own a home"
            write(2,*) "Homeowners in the bottom", 100*(pop_of_bot_wealth_50_perc&
                    /sum(distribution_stationary)), " % have mortgage debt of ", &
                    model_mortg_debt_bot_50_perc/&
                    (model_mortg_debt_bot_50_perc+model_net_hous_wealth_bot_50_perc)&
                    , " % of their home value"
            do i=1,productivity_grid_size
                write(2,*) "households with productivity_index=", i, " have on average ", &
                    financial_by_productivity(j,i), " financial assets"
                write(2,*) "households with productivity_index=", i, " have on average ", &
                    net_housing_wealth_by_productivity(j,i), " net housing wealth assets"
                write(2,*) "households with productivity_index=", i, " have on average ", &
                    mortgage_debt_by_productivity(j,i), " mortgage debt"
                write(2,*) "households with productivity_inedx=", i, "have a house of size", &
                    housing_size_by_productivity(j,i)
                write(2,*) "households with productivity_index=", i, " have on average ", &
                    mortgage_debt_by_productivity(j,i)/&
                    (mortgage_debt_by_productivity(j,i)+net_housing_wealth_by_productivity(j,i)), " &
                    mortgage debt to total housing wealth"
            end do
            do i=1,productivity_grid_size
        
                if (productivity_grid(i)<=1) then
                            
                    can_have_best_productivity_shock=0
                    
                else
                
                    can_have_best_productivity_shock=1
                
                end if
            
                do k=&
                    have_fixed_productivity*2+&
                    (1-have_fixed_productivity)*&
                    (can_have_best_productivity_shock*1+&
                    (1-can_have_best_productivity_shock)*&
                    ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                    (1-all_low_z_households_get_into_0_lane)*2)),&
                    have_fixed_productivity*2+&
                    (1-have_fixed_productivity)*&
                    productivity_shock_grid_size
                    
                    write(2,*) "households with productivity_index=", i, " and "&
                        "shock ", k, "have on average ", &
                        financial_by_productivity_and_shock&
                        (j,k,i), " financial assets"
                    
                end do
            end do
            do i=1,productivity_grid_size
        
                if (productivity_grid(i)<=1) then
                            
                    can_have_best_productivity_shock=0
                    
                else
                
                    can_have_best_productivity_shock=1
                
                end if
            
                do k=&
                    have_fixed_productivity*2+&
                    (1-have_fixed_productivity)*&
                    (can_have_best_productivity_shock*1+&
                    (1-can_have_best_productivity_shock)*&
                    ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                    (1-all_low_z_households_get_into_0_lane)*2)),&
                    have_fixed_productivity*2+&
                    (1-have_fixed_productivity)*&
                    productivity_shock_grid_size
                    
                    write(2,*) "fraction of households with productivity_index=", i, " and "&
                        "shock ", k,"=", &
                        fraction_of_population_by_productivity_and_shock&
                        (j,k,i)
                    
                end do
            end do
            
        end do
        
        close(2)
        
        ! Saving main simulation statistics
        open(unit=2,file="welfare_by_age_and_productivity"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
            
            do age_index=1,((life_span-1)/10)
                            
                do productivity_index=1,productivity_grid_size
                
                        write(2,*) welfare_by_age_and_productivity&
                            (j,age_index,productivity_index)
                
                end do
                                    
            end do
                
        end do
            
        close(2)

        ! Saving main simulation statistics
        open(unit=2,file="welfare_by_employment_and_productivity"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
            
            do employment_index=1,employment_grid_size
                
                do productivity_index=1,productivity_grid_size
                            
                        write(2,*) welfare_by_employment_and_productivity&
                            (j,employment_index,productivity_index)
                                                                
                end do
                
            end do
                
        end do
            
        close(2)
        
        ! Saving main simulation statistics
        open(unit=2,file="welfare_by_ownership_status"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
            
            do i=0,&
                endogenous_rental_market*2+&
                (1-endogenous_rental_market)*1
                            
                do employment_index=1,employment_grid_size
                                                            
                    write(2,*) welfare_by_ownership_status&
                        (j,i,employment_index)
                                
                end do
        
            end do
                
        end do
            
        close(2)
        
        ! Saving main simulation statistics
        open(unit=2,file="wealth_by_ownership_status"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
        
            do i=0,2
                    
                do employment_index=1,employment_grid_size
                                                        
                    write(2,*) model_wealth_by_ownership_and_employment&
                        (j,i,employment_index)
                
                end do
        
            end do
                
        end do
            
        close(2)
        
        ! Saving main simulation statistics
        open(unit=2,file="mass_by_ownership_status"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
        
            do i=0,2
                
                do employment_index=1,employment_grid_size
                                                    
                        write(2,*) mass_by_ownership_status&
                            (j,i,employment_index)
                
                end do
        
            end do
                
        end do
            
        close(2)
        
        ! Saving main simulation statistics
        open(unit=2,file="homeownership_by_employment_and_productivity"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                                        
            do employment_index=1,employment_grid_size
                
                do productivity_index=1,productivity_grid_size
                            
                    write(2,*) homeownership_by_employment_and_productivity&
                        (j,employment_index,productivity_index)
                                                    
                end do
                    
            end do
                
        end do
            
        close(2)
        
        ! Saving main simulation statistics
        open(unit=2,file="housing_size_by_employment_and_productivity"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                                
            do employment_index=1,employment_grid_size
            
                do productivity_index=1,productivity_grid_size
            
                    write(2,*) housing_size_by_employment_and_productivity&
                        (j,employment_index,productivity_index)
                                                
                end do
                    
            end do
                
        end do
            
        close(2)
        
        ! Saving main simulation statistics
        open(unit=2,file="homeownership_by_age_and_productivity"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                        
            do age_index=1,((life_span-1)/10)
                            
                do productivity_index=1,productivity_grid_size
                            
                    write(2,*) homeownership_by_age_and_productivity&
                        (j,age_index,productivity_index)
                                            
                end do
                    
            end do
                
        end do
            
        close(2)
        
        ! Saving main simulation statistics
        open(unit=2,file="housing_size_by_age_and_productivity"//trim(file_number)//".txt",&
            action="write",status="replace")
        
        do j=time_period,time_period
                        
            do age_index=1,((life_span-1)/10)
                            
                do productivity_index=1,productivity_grid_size
            
                    write(2,*) housing_size_by_age_and_productivity&
                        (j,age_index,productivity_index)
                            
                end do
                    
            end do
                
        end do
            
        close(2)
                        
    end subroutine
    
    subroutine draw_policy_functions(time_period)
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: time_period
        
        do i=1,productivity_grid_size
            
            ! Checks the life cycle savings decisions of a household who starts with 0 financial
            ! the highest employment productivity, the highest productivity and the middle productivity shock 
            call life_cycle_savings_decisions(time_period,1,1,1,i)
                                    
            ! Draws the borrowing_or_lending for the highest productivity households in the fast lane at each level of wealth
            call borrowing_or_lending_decisions(time_period,1,1,1,i)
        
            ! Draws the borrowing_or_lending for the highest productivity households in the fast lane at each level of wealth
            call business_income_decisions(time_period,1,1,1,i)
            
        end do
    
    end subroutine
    
    subroutine calibrating_model()
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        call cpu_time(simulation_start_time)
                
        policy_function_loss_on_house=0

        loop_count=0
        
        wage_guess(1,1)=wage_calibrated
        wage(1)=wage_guess(1,1)
        
        if (exogenous_wages==1) then
        
            wage(1)=1
            
        end if
        
        housing_price(1)=wage(1)
            
        rent(1)=rent_to_housing_price*housing_price(1)
        risk_free_rate(1)=calibrated_risk_free_rate
        
        if (risk_free_rate(1)<0) then
        
            investment_income_tax=0
            
        else
        
            if (exogenous_wages==0) then
        
                investment_income_tax=business_income_tax
                
            else
            
                investment_income_tax=0.15
            
            end if
            
        end if
        
        mortgage_interest_rate(1)=risk_free_rate(1)+mortgage_interest_gap
        
        if (shut_down_housing_market==1) then
        
            relative_share_of_housing=0
            
        end if
        
        risk_aversion_share_of_cons=(1-relative_share_of_housing)*(1-risk_aversion)
                  
        disutility_of_landlords=&
            disutility_of_landlords*&
            (wage(1)**(risk_aversion_share_of_cons))
                
        model_average_labour_income(1)=average_labor_income_calibrated
        total_housing_demand(1)=calibrated_housing_stock
        
        model_total_efficiency_units(1)=model_total_efficiency_units_calibrated
        
        if (share_of_corporate_profits>0) then
        
            corporate_capital(1)=model_corporate_capital_calibrated
            
        else
        
            corporate_capital(1)=1
            
        end if
        
        aggregation_of_tot_intermdte_gds(1)=&
            (wage(1)/(aggregate_productivity*share_of_labour*&
            ((corporate_capital(1))**&
            (share_of_corporate_profits))*&
            ((model_total_efficiency_units(1))**&
            (share_of_labour-1))))**(1/(max(share_of_capital,0.01)))
            
        aggregate_production_times_labour(1)=&
            aggregate_productivity*share_of_capital*&
            (aggregation_of_tot_intermdte_gds(1)**(share_of_capital-curv_intrmdte_prod))*&
            (corporate_capital(1)**(share_of_corporate_profits))*&
            (model_total_efficiency_units(1))**(share_of_labour)
            
        if (exogenous_wages==1) then
        
            corporate_capital(1)=1
            aggregation_of_tot_intermdte_gds(1)=1
            aggregate_production_times_labour(1)=1
            
        end if
                 
        model_output(1)=&
            aggregate_productivity*&
            (aggregation_of_tot_intermdte_gds(1))**(share_of_capital)*&
            (corporate_capital(1)**(share_of_corporate_profits))*&
            (model_total_efficiency_units(1))**(share_of_labour)
        
        call initialize_variables_and_grids(1)
        
        call initialize_feasible_distribution(1)
        call set_SS_benefits()
        
        call function_of_utility_advantage_from_homeowning(1)
        call initialize_financial_grid(1)
                
!        call calculate_mortgage_default_probability(1)

        if (multiple_household_members==1) then

            model_average_lowest_labor_income=8.0633792843442298E-002
                            
        else
            
            model_average_lowest_labor_income=&
                wage(1)*employment_grid(employment_grid_size)*&
                (maxval(labour_deterministic_efficiency)+1)/2
        
        end if
                
        model_financial_per_household(1)=&
            financial_grid(financial_grid_size)/total_population
        
        distance_wage=1
        distance_risk_free_rate(1)=1
        distance_value_function=1
        distance_discount_factor=1
        distance_advantage_to_owning=1
        distance_relative_share_of_housing=1
        distance_multiple_max_debt_to_assets=1
        distance_wealth_by_top_1_perc=1
        distance_disutility_of_landlords=1
        distance_size_of_smallest_house_hhld_can_buy=1
        distance_smallest_house_size=1
        distance_rental_market=1
        distance_probability_of_staying_in_fast_lane=1
        distance_weight_on_bequest=1
    
        value_function_guess(:,:,:,:)=0
        value_function(1,:,:,:,:,:)=0
                
        write(*,*) "can_get_mortgage_in_retirement=", can_get_mortgage_in_retirement
        write(*,*) "total_population=", total_population
        write(*,*) "calibrate_housing_status_grid_expander=", calibrate_housing_status_grid_expander
        write(*,*) "mortgage_deductibility=", mortgage_deductibility
        write(*,*) "mortgage_grid_size=", mortgage_grid_size
        write(*,*) "endogenous_rental_market=", endogenous_rental_market
        write(*,*) "probability_of_bad_shock_continuing(1)=", probability_of_bad_shock_continuing(1)
        write(*,*) "mortgage_interest_rate=", mortgage_interest_rate(1)
        write(*,*) "risk_free_rate=", risk_free_rate(1)
        write(*,*) "is_there_mortgage_debt_premium=", is_there_mortgage_debt_premium
        write(*,*) "property_tax(1)=", property_tax(1)
        write(*,*) "multiple_household_members", multiple_household_members
        write(*,*) "model_average_lowest_labor_income=", model_average_lowest_labor_income
        write(*,*) "model_output(1)=", model_output(1)
        write(*,*) "wage=", wage(1)
        write(*,*) "exogenous_wages=", exogenous_wages
        write(*,*) "shut_down_housing_market=", shut_down_housing_market
        write(*,*) "business_income_tax=", business_income_tax
        write(*,*) "investment_income_tax=", investment_income_tax
        write(*,*) "progressive_wealth_tax=", progressive_wealth_tax
        write(*,*) "progressive_fincial_tax=", progressive_financial_tax
        write(*,*) "progressive_housing_tax=", progressive_housing_tax
        write(*,*) "financial_tax=", financial_tax
        write(*,*) "bequest_risk_aversion=", bequest_risk_aversion
        write(*,*) "weight_on_bequest=", weight_on_bequest
        write(*,*) "add_utility_from_child=", add_utility_from_child
        write(*,*) "calibrate_weight_on_bequests=", calibrate_weight_on_bequests
        write(*,*) "robustness_check=", robustness_check
        write(*,*) "higher_nu=", higher_nu
        write(*,*) "lower_nu=", lower_nu
        write(*,*) "looser_lambda=", looser_lambda
        write(*,*) "lump_sum_construction_profits=", lump_sum_construction_profits
        write(*,*) "smaller_rental=", smaller_rental
        write(*,*) "re_do_simulation_with_fixed_parameters=", re_do_simulation_with_fixed_parameters 
        write(*,*) "curv_intrmdte_prod=", curv_intrmdte_prod
        write(*,*) "calibration"
        
        do while((distance_wage>stopping_rule_wage) .OR. &
            (distance_risk_free_rate(1)>stopping_rule_risk_free_rate) .OR. &
            (distance_value_function>(stopping_rule_value_function*(1+abs(largest_value_function_value)))) .OR. &
            (distance_rental_market(1)>stopping_rule_rental_market) .OR. &
            (distance_discount_factor>stopping_rule_discount_factor) .OR. &
            (distance_advantage_to_owning>stopping_rule_advantage_to_owning) .OR. &
            (distance_multiple_max_debt_to_assets>stopping_rule_max_debt_to_assets) .OR. &
            (distance_wealth_by_top_1_perc>stopping_rule_wealth_by_top_1_perc) .OR. &
            (distance_relative_share_of_housing>stopping_rule_relative_share_of_housing) .OR. &
            (distance_disutility_of_landlords>stopping_rule_disutility_of_landlords) .OR. &
            (distance_probability_of_staying_in_fast_lane>stopping_rule_probability_of_staying_in_fast_lane) .OR. & 
            (distance_size_of_smallest_house_hhld_can_buy>stopping_rule_size_of_smallest_house_hhld_can_buy) .OR. &
            (distance_smallest_house_size>stopping_rule_smallest_house_size) .OR. &
            (distance_weight_on_bequest>stopping_rule_weight_on_bequest))
        
            call solve_value_function_and_policy_functions(1,0)
            
            call draw_policy_functions(1)
            
            ! No need to converge on value function
            if (add_utility_from_child==0) then
            
                ! Sets the distance to 0
                distance_value_function=0
                
            ! Converge on value function only for age 1
            elseif (add_utility_from_child==1) then
            
                distance_value_function=&
                    maxval(abs(value_function_guess(:,:,:,:)-&
                    value_function(1,1,:,:,:,:)))
                
                ! Finding the index of the largest distance
                distance_value_function_indeces_youngest=&
                    maxloc(abs(value_function_guess(:,:,:,:)-&
                    value_function(1,1,:,:,:,:)),&
                    mask=abs(value_function_guess(:,:,:,:)-&
                    value_function(1,1,:,:,:,:))>=0)
                
                ! Finding the value of the value function at that index
                largest_value_function_value=&
                    value_function&
                    (1,1,&
                    distance_value_function_indeces_youngest(1),&
                    distance_value_function_indeces_youngest(2),&
                    distance_value_function_indeces_youngest(3),&
                    distance_value_function_indeces_youngest(4))
                                                           
                value_function_guess(:,:,:,:)=&
                    value_function(1,1,:,:,:,:)            
                            
                ! Sets the distance to 0
                distance_value_function=0
                
            end if
                
            call converge_to_stationary_equilibrium(1,0)
            call stationary_equilibrium_statistics(1)
            
            if (exogenous_wages==0) then
            
                call stationary_eqlibrium_intermediate_inputs(1)
                
                write(*,*) "model net wealth to model_output=", &
                    (model_financial(1)+&
                    model_net_housing_wealth(1))/model_output(1)
                
            else
            
                wage(1)=1
                aggregation_of_tot_intermdte_gds(1)=1
                aggregate_production_times_labour(1)=1
                corporate_capital(1)=1
            
            end if
            
            call stationary_equilibirum_homeownership_rate(1)
            call govt_revenues_calc(1,0)
            call calculate_aggregate_consumption(1)
            call calculate_welfare(1)
            call calculate_welfare_by_characteristics(1)
            
            if (exogenous_wages==0) then
            
                if (shut_down_housing_market==0) then
            
                    call calculate_household_housing_spending(1)
                    call calculate_homeownership_by_characteristics(1)
                    
                end if
                
                call stationary_equilibrium_top_wealth_distribution_stats(1)
                call stationary_equilibrium_bot_wealth_distribution_stats(1) 
                
            end if
             
            if (re_do_simulation_with_fixed_parameters==1) then
            
                distance_discount_factor=0
                distance_size_of_smallest_house_hhld_can_buy=0
                distance_smallest_house_size=0
                distance_advantage_to_owning=0
                distance_relative_share_of_housing=0
                distance_disutility_of_landlords=0
                distance_multiple_max_debt_to_assets=0
                distance_wealth_by_top_1_perc=0
                distance_probability_of_staying_in_fast_lane=0
                distance_weight_on_bequest=0
                        
            else
            
                if (loop_count>aftr_how_mny_lps_start_update) then
            
                    write(*,*) "discount_factor=", discount_factor
                    
                    if (target_net_wealth_to_GDP==2) then
                    
                        if ((endogenous_rental_market==1) .OR. (endogenous_rental_market==0)) then
                    
                            discount_factor=&
                                min(max(discount_factor-discount_factor_adjuster*&
                                (model_homeownership_rate(1)-&
                                SCF_homeownership_rate),0.8),1.3)  ! Standard
                            
                            distance_discount_factor=&
                                abs(model_homeownership_rate(1)-&
                                SCF_homeownership_rate)
                                
                        else
                        
                            discount_factor=&
                                min(max(discount_factor+discount_factor_adjuster*&
                                (model_fraction_of_homeowners_with_mortgage(1)-&
                                SCF_homeowners_with_mortgage),0.8),1.3)  ! Standard
                        
                            distance_discount_factor=&
                                abs(model_fraction_of_homeowners_with_mortgage(1)-&
                                SCF_homeowners_with_mortgage)
                        
                        end if
                    
                    elseif (target_net_wealth_to_GDP==1) then
                    
                        discount_factor=&
                            min(max(discount_factor-discount_factor_adjuster*&
                            ((model_total_net_wealth(1)/model_output(1))-&
                            standard_net_wealth_to_GDP),0.8),1.3)  ! Standard
                        
                        distance_discount_factor=&
                            abs((model_total_net_wealth(1)/model_output(1))-&
                            standard_net_wealth_to_GDP)
                            
                    elseif (target_net_wealth_to_GDP==0) then
                    
                        discount_factor=&
                            min(max(discount_factor+discount_factor_adjuster*&
                            (model_fraction_of_homeowners_with_mortgage(1)-&
                            SCF_homeowners_with_mortgage),0.8),1.3)  ! Standard
                        
                        distance_discount_factor=&
                            abs(model_fraction_of_homeowners_with_mortgage(1)-&
                            SCF_homeowners_with_mortgage)
                            
                    elseif (target_net_wealth_to_GDP==-1) then
                    
                        discount_factor=&
                            min(max(discount_factor+discount_factor_adjuster*&
                            (model_fraction_of_homeowners_with_mortgage_over_80_perc(1)*&
                            model_fraction_of_homeowners_with_mortgage(1)*&
                            model_homeownership_rate(1)-&
                            fraction_hhlds_with_over_80_perc),0.8),1.3) 
                            
                        distance_discount_factor=&
                            abs(model_fraction_of_homeowners_with_mortgage_over_80_perc(1)*&
                            model_fraction_of_homeowners_with_mortgage(1)*&
                            model_homeownership_rate(1)-&
                            fraction_hhlds_with_over_80_perc)
                    
                    end if
                                        
                    write(*,*) "discount_factor=", discount_factor
                    write(*,*) "distance_discount_factor=", distance_discount_factor
                    write(*,*) "model_total_net_wealth(1)/model_output(1)=", &
                        model_total_net_wealth(1)/model_output(1)
                                                
                    if (calibrate_probability_of_fast_lane==1) then
                    
                        write(*,*) "probability_of_staying_in_fast_lane=", &
                            probability_of_staying_in_fast_lane
                    
                        distance_probability_of_staying_in_fast_lane=&
                            abs(risk_free_rate(1)-target_risk_free_rate)
                            
                        probability_of_staying_in_fast_lane=&
                            min(max(probability_of_staying_in_fast_lane-&
                            probability_of_staying_in_fast_lane_adjuster*&
                            (risk_free_rate(1)-target_risk_free_rate),0.d0),1.d0)
                            
                        write(*,*) "probability_of_staying_in_fast_lane=", &
                            probability_of_staying_in_fast_lane
                        write(*,*) "distance_probability_of_staying_in_fast_lane=", &
                            distance_probability_of_staying_in_fast_lane
                    
                    else
                    
                        distance_probability_of_staying_in_fast_lane=0
                        
                    end if
                                        
                    if (((target_net_wealth_to_GDP==0) .OR. (endogenous_rental_market==0)) .AND. &
                        (shut_down_housing_market==0)) then
                    
                        write(*,*) "advantage_to_owning=", advantage_to_owning
                    
                        advantage_to_owning=&
                            min(max(advantage_to_owning-advantage_to_owning_adjuster*&
                            (model_homeownership_rate(1)-&
                            SCF_homeownership_rate),0.d0),5.d0) 
                                                                    
                        distance_advantage_to_owning=&
                            abs(model_homeownership_rate(1)-SCF_homeownership_rate)
                        
                        write(*,*) "advantage_to_owning=", advantage_to_owning
                        write(*,*) "distance_advantage_to_owning=", distance_advantage_to_owning
                        write(*,*) "model_homeownership_rate(1)=", model_homeownership_rate(1)
                        
                    else
                        
                        distance_advantage_to_owning=0
                            
                    end if
                        
                    write(*,*) "relative_share_of_housing=", relative_share_of_housing 
                        
                    if ((target_homeownership_rate==1) .AND. &
                       (shut_down_housing_market==0)) then
                        
                        relative_share_of_housing=&
                            min(max(relative_share_of_housing+relative_share_of_housing_adjuster*&
                            (model_homeownership_rate(1)-&
                            SCF_homeownership_rate),0.01),0.9) 
                                                                     
                        distance_relative_share_of_housing=&
                            abs(model_homeownership_rate(1)-&
                            SCF_homeownership_rate)
                                
                        write(*,*) "model_homeownership_rate(1)=", &
                            model_homeownership_rate(1)
                    
                    elseif ((target_homeownership_rate==2) .AND. &
                        (shut_down_housing_market==0)) then
                
                        relative_share_of_housing=&
                            min(max(relative_share_of_housing-relative_share_of_housing_adjuster*&
                            ((total_housing_services(1)+&
                            total_imputed_rents(1))/&
                            model_GDP_incl_imput_rent(1)-&
                            FRED_housing_services_to_GDP),0.01),0.9) 
                                                                     
                        distance_relative_share_of_housing=&
                            abs((total_housing_services(1)+&
                            total_imputed_rents(1))/&
                            model_GDP_incl_imput_rent(1)-&
                            FRED_housing_services_to_GDP)
                                
                        write(*,*) "(total_housing_services(1)+total_imputed_rents(1))/model_GDP_incl_imput_rent(1))=", &
                            (total_housing_services(1)+&
                            total_imputed_rents(1))/&
                            model_GDP_incl_imput_rent(1)
                            
                    else
                    
                        distance_relative_share_of_housing=0
                                
                    end if
                    
                    if (shut_down_housing_market==1) then
                    
                        relative_share_of_housing=0
                        distance_relative_share_of_housing=0
                        
                    end if
                        
                    write(*,*) "relative_share_of_housing=", relative_share_of_housing 
                    write(*,*) "distance_relative_share_of_housing=", distance_relative_share_of_housing
                            
                    risk_aversion_share_of_cons=(1-relative_share_of_housing)*(1-risk_aversion)
                    
                    if ((endogenous_rental_market==1) .AND. (shut_down_housing_market==0)) then
                    
                        disutility_of_landlords=&
                            disutility_of_landlords*&
                            (wage(1)**(risk_aversion_share_of_cons))
                        
                        if (loop_count==1) then
                        
                            disutility_of_landlords_adjuster=&
                                disutility_of_landlords_adjuster*&
                                (wage(1)**(risk_aversion_share_of_cons))
                            
                        end if
                    
                        write(*,*) "disutility_of_landlords=", &
                            disutility_of_landlords
                        
                        if (target_rent_to_price_ratio==1) then
                        
                            disutility_of_landlords_adjuster=10.d0**(-3)
                        
                            disutility_of_landlords=&
                                max(min(disutility_of_landlords-&
                                disutility_of_landlords_adjuster*&
                                (total_rental_supply(1)-total_rental_demand(1)),0.0),-5.d0) 
                                                                         
                            distance_housing_status_grid_expander=&
                                abs(rent(1)/housing_price(1)-&
                                himmelberg_etal_rent_to_price)
                        
                        else
                        
                            disutility_of_landlords=&
                                max(min(disutility_of_landlords-&
                                disutility_of_landlords_adjuster*&
                                (model_fraction_of_landlords(1)-&
                                fraction_of_landlords),0.0),-5.d0) 
                                                                         
                            distance_housing_status_grid_expander=&
                                abs(model_fraction_of_landlords(1)-&
                                fraction_of_landlords)
                                
                        end if
                                    
                        write(*,*) "disutility_of_landlords=", &
                            disutility_of_landlords
                        write(*,*) "model_fraction_of_landlords(1)=", &
                            model_fraction_of_landlords(1)
                            
                    else
                    
                        disutility_of_landlords=0
                        distance_disutility_of_landlords=0
                    
                    end if
                        
                    write(*,*) "size_of_smallest_house_hhld_can_buy=", &
                        size_of_smallest_house_hhld_can_buy
                        
                    if ((calibrate_size_of_smallest_house_hhld_can_buy==1) .AND. &
                        (shut_down_housing_market==0)) then
                    
                        size_of_smallest_house_hhld_can_buy=&
                            min(max(size_of_smallest_house_hhld_can_buy+&
                            size_of_smallest_house_hhld_can_buy_adjuster*&
                            (model_fraction_of_homeowners_with_mortgage(1)-&
                            SCF_homeowners_with_mortgage),0.0),5.d0) 
                                                                     
                        distance_size_of_smallest_house_hhld_can_buy=&
                            abs(model_fraction_of_homeowners_with_mortgage(1)-&
                            SCF_homeowners_with_mortgage)
                            
                    elseif ((calibrate_size_of_smallest_house_hhld_can_buy==2) .AND. &
                        (shut_down_housing_market==0)) then
                    
                        size_of_smallest_house_hhld_can_buy=&
                            min(max(size_of_smallest_house_hhld_can_buy-&
                            size_of_smallest_house_hhld_can_buy_adjuster*&
                            (100*(govt_spending_on_mortgage_interest_deductions(1)/model_GDP(1))-&
                            JCT_MID_to_GDP),0.0),2.d0) 
                                                                     
                        distance_size_of_smallest_house_hhld_can_buy=&
                            abs(100*(govt_spending_on_mortgage_interest_deductions(1)/model_GDP(1))-&
                            JCT_MID_to_GDP)
                    
                    else
                    
                        distance_size_of_smallest_house_hhld_can_buy=0
                        
                    end if
                    
                    write(*,*) "size_of_smallest_house_hhld_can_buy=", &
                        size_of_smallest_house_hhld_can_buy
                    write(*,*) "model_fraction_of_homeowners_with_mortgage(1)=", &
                        model_fraction_of_homeowners_with_mortgage(1)
                    write(*,*) "govt_spending_on_mortgage_interest_deductions(1)/&
                            model_GDP_incl_imput_rent(1)=", &
                            100*(govt_spending_on_mortgage_interest_deductions(1)/model_GDP(1))
                    
                    write(*,*) "smallest_house_size=", smallest_house_size                    
                    
                    if ((calibrate_smallest_house_size==1) .AND. (shut_down_housing_market==0)) then
                    
                        smallest_house_size=&
                            min(max(smallest_house_size-&
                            smallest_house_size_adjuster*&
                            (mass_of_renters_at_housing_spending(1,1)-&
                            SW_renters_spend_over_X_on_hous),0.d0),10.d0) 
                                                                     
                        distance_smallest_house_size=&
                            abs(mass_of_renters_at_housing_spending(1,1)-&
                            SW_renters_spend_over_X_on_hous)
                            
                    else
                    
                        distance_smallest_house_size=0
                    
                    end if
                    
                    write(*,*) "smallest_house_size=", smallest_house_size
                    write(*,*) "mass_of_renters_at_housing_spending(1,1)=", &
                        mass_of_renters_at_housing_spending(1,1)
                        
                    if (cond_max_debt_to_assets_on_prod==1) then
                        
                        if ((calibrate_multiple_max_debt_to_assets==1) .AND. &
                            (looser_lambda==0)) then
                                                
                            write(*,*) "multiple_max_debt_to_assets=", multiple_max_debt_to_assets
                        
                            multiple_max_debt_to_assets=&
                                min(max(multiple_max_debt_to_assets-&
                                multiple_max_debt_to_assets_adjuster*&
                                ((model_fin_debt(1)/(model_financial(1)+model_gross_housing_wealth(1)))-&
                                asker_et_al_debt_to_assets),&
                                real(0.05)/real(8)),real(16)/real(8)) ! From Asker et al. (2011)
                            
                            distance_multiple_max_debt_to_assets=&
                                abs((model_fin_debt(1)/(model_financial(1)+model_gross_housing_wealth(1)))-&
                                asker_et_al_debt_to_assets)
                                
                            write(*,*) "multiple_max_debt_to_assets=", multiple_max_debt_to_assets
                            write(*,*) "distance_multiple_max_debt_to_assets=", distance_multiple_max_debt_to_assets
                                
                        elseif ((calibrate_multiple_max_debt_to_assets==0) .OR. &
                            (looser_lambda==1)) then
                            
                            distance_multiple_max_debt_to_assets=0
                                
                            write(*,*) "distance_multiple_max_debt_to_assets=", &
                                distance_multiple_max_debt_to_assets
                            write(*,*) "calibrate_multiple_max_debt_to_assets=", &
                                calibrate_multiple_max_debt_to_assets
                            
                        end if
                            
                    else
                        
                        write(*,*) "max_debt_to_assets=", max_debt_to_assets
                        
                        max_debt_to_assets=&
                            min(max(max_debt_to_assets-multiple_max_debt_to_assets_adjuster*&
                            ((model_fin_debt(1)/(model_financial(1)+model_gross_housing_wealth(1)))-&
                            asker_et_al_debt_to_assets),real(0.05)/real(8)),real(16)/real(8)) ! From Asker et al. (2011)
                            
                        distance_multiple_max_debt_to_assets=&
                            abs((model_fin_debt(1)/(model_financial(1)+model_gross_housing_wealth(1)))-&
                            asker_et_al_debt_to_assets)
                            
                        write(*,*) "multiple_max_debt_to_assets=", max_debt_to_assets
                        write(*,*) "distance_multiple_max_debt_to_assets=", distance_multiple_max_debt_to_assets
                        write(*,*) "multiple_max_debt_to_assets*productivity_grid_size=", &
                            multiple_max_debt_to_assets*real(productivity_grid_size)
                      
                    end if
                        
                    write(*,*) "model_fin_debt(1)/(model_financial(1)+model_gross_housing_wealth(1))=", &
                        model_fin_debt(1)/(model_financial(1)+model_gross_housing_wealth(1))
                            
                    write(*,*) "sd_epsilon_log_productivity=", sd_epsilon_log_productivity
                                                
                    ! Targets the net wealth held by the top 1% of households
                    if ((target_wealth_of_top_1_perc==1) .AND. &
                        (looser_lambda==0)) then
                        
                        sd_epsilon_log_productivity=&
                            min(max(sd_epsilon_log_productivity-&
                            sd_epsilon_log_productivity_adjuster*&
                            ((model_wealth_of_top_x_perc(1)/&
                            model_total_net_wealth(1))-&
                            SCF_fraction_of_wealth_of_top_1_perc),0.0),3.0) ! From SCF
                            
                        distance_wealth_by_top_1_perc=&
                            abs((model_wealth_of_top_x_perc(1)/&
                            model_total_net_wealth(1))-&
                            SCF_fraction_of_wealth_of_top_1_perc) 
                            
                    else 
                    
                        distance_wealth_by_top_1_perc=0
                        
                    end if
                        
                    write(*,*) "sd_epsilon_log_productivity=", sd_epsilon_log_productivity
                    write(*,*) "distance_wealth_by_top_1_perc=", distance_wealth_by_top_1_perc
                            
                    write(*,*) "model_wealth_of_top_x_perc(1)/model_total_net_wealth(1)=", &
                        model_wealth_of_top_x_perc(1)/&
                        model_total_net_wealth(1)
                        
                    if ((add_utility_from_child==1) .AND. &
                        (calibrate_weight_on_bequests==1)) then
                        
                        write(*,*) "weight_on_bequest=", weight_on_bequest
                        
                        weight_on_bequest=&
                            min(max(weight_on_bequest-&
                            weight_on_bequest_adjuster*&
                            ((model_bequests(1)/&
                            model_total_net_wealth(1))-&
                            bequests_to_net_wealth_nishiyama),0.0),1.d0) ! From Nishiyama 2000
                            
                        distance_weight_on_bequest=&
                            abs((model_bequests(1)/&
                            model_total_net_wealth(1))-&
                            bequests_to_net_wealth_nishiyama) 
                            
                        write(*,*) "weight_on_bequest=", weight_on_bequest
                        write(*,*) "model_bequests(1)/model_total_net_wealth(1)=", &
                            (model_bequests(1)/model_total_net_wealth(1))
                        write(*,*) "distance_weight_on_bequest=", &
                            distance_weight_on_bequest
                    
                    else
                    
                        distance_weight_on_bequest=0
                    
                    end if
                                                                                
                else
                    
                    distance_smallest_house_size=0
                    distance_size_of_smallest_house_hhld_can_buy=0
                    distance_discount_factor=0
                    distance_advantage_to_owning=0
                    distance_relative_share_of_housing=0
                    distance_disutility_of_landlords=0
                    distance_multiple_max_debt_to_assets=0
                    distance_wealth_by_top_1_perc=0
                    distance_probability_of_staying_in_fast_lane=0
                    distance_weight_on_bequest=0
                    
                end if
                                        
            end if
            
            write(*,*) "model_homeownership_rate(1)=", model_homeownership_rate(1)
                    
            if (exogenous_interest_rate==0) then
            
                if (loop_count>0) then
                        
                    ! Solving the risk free rate (includes the distance)
                    call solve_risk_free_rate(1)
                    
                else
                
                    distance_risk_free_rate=1
                
                end if
                
            else
            
                mortgage_interest_rate(1)=risk_free_rate(1)+mortgage_interest_gap
                distance_risk_free_rate=0
                
            end if
                        
            if (risk_free_rate(1)<0) then
        
                investment_income_tax=0
            
            else
            
                if (exogenous_wages==0) then
        
                    investment_income_tax=business_income_tax
                    
                else
                    
                    investment_income_tax=0.15
                
                end if
            
            end if
            
            if (exogenous_wages==0) then
                        
                distance_wage=abs(wage(1)-wage_guess(1,2))
                                           
                wage_guess(1,1)=&
                    (1-weight_wage)*wage(1)+&
                    weight_wage*wage_guess(1,2)
                        
                write(*,*) "wage(1)=", wage(1)
                    
                wage(1)=wage_guess(1,1)
                            
                ! updating the guess for aggregate capital
                aggregation_of_tot_intermdte_gds(1)=&
                    (wage(1)/(aggregate_productivity*share_of_labour*&
                    (corporate_capital(1)**&
                    (share_of_corporate_profits))*&
                    ((model_total_efficiency_units(1))**&
                    (share_of_labour-1))))**(1/(max(share_of_capital,0.01)))
                
                ! Updates the guess for corporate capital
                if (share_of_corporate_profits>0) then
            
                    corporate_capital(1)=&
                        ((share_of_corporate_profits*&
                        (aggregation_of_tot_intermdte_gds(1)**(share_of_capital)*&
                        model_total_efficiency_units(1)**(share_of_labour)))/&
                        (risk_free_rate(1)+financial_wealth_depreciation))**&
                        (1/(share_of_capital+share_of_labour))
                                
                else
                
                    corporate_capital(1)=1    
                    
                end if
                    
                aggregate_production_times_labour(1)=&
                    aggregate_productivity*share_of_capital*&
                    ((aggregation_of_tot_intermdte_gds(1))**(share_of_capital-curv_intrmdte_prod))*&
                    ((corporate_capital(1))**(share_of_corporate_profits))*&
                    ((model_total_efficiency_units(1))**(share_of_labour))
                
            else
            
                wage(1)=1
                distance_wage=0
                aggregation_of_tot_intermdte_gds(1)=1
                aggregate_production_times_labour(1)=1
                corporate_capital(1)=1
                
            end if
                                
            write(*,*) "wage(1) updated=", wage(1)
                        
            write(*,*) "wages to output=", &
                (model_total_efficiency_units(1)*wage(1))/&
                model_output(1)
                
            write(*,*) "labor share of income=", &
                share_of_labour
                
            write(*,*) "profits to output=", &
                model_total_gross_enrepreneurial_income(1)/&
                model_output(1)
                
            write(*,*) "cpital share of income=", &
                share_of_capital
                
            if (share_of_corporate_profits>0) then
                
                write(*,*) "corporate profits to output=", &
                    ((risk_free_rate(1)+financial_wealth_depreciation)*&
                    corporate_capital(1))/model_output(1)
                    
            end if
            
            write(*,*) "model net wealth to output=", &
                (model_financial(1)+model_net_housing_wealth(1))/model_output(1)
                
            write(*,*) "model_fin_debt to gross assets=", &
                model_fin_debt(1)/(model_financial(1)+model_gross_housing_wealth(1))
                           
            housing_price(1)=wage(1)
            
            if (endogenous_rental_market==1) then
            
                ! Checks the distance between supply and demand
                distance_rental_market(1)=&
                    abs(total_rental_demand(1)-total_rental_supply(1))
                
                write(*,*) "rent(1)=", rent(1)
                write(*,*) "rental_supply(1)=", total_rental_supply(1)
                write(*,*) "rental_demand(1)=", total_rental_demand(1)
                write(*,*) "distance_rental_market(1)=", distance_rental_market(1)
        
                if (loop_count>aftr_how_mny_lps_start_update) then
                
                    if (distance_rental_market(1)<0.04) then
            
                        rental_market_adjuster=10.d0**(-4)*wage(1)
                    
                    elseif (distance_rental_market(1)<3) then
                
                        rental_market_adjuster=10.d0**(-4)*wage(1)
                
                    elseif (distance_rental_market(1)<10) then
            
                        rental_market_adjuster=10.d0**(-5)*wage(1)
                        
                    else
                    
                        rental_market_adjuster=10.d0**(-5)*wage(1)
                                            
                    end if
                
                else
            
                    rental_market_adjuster=0
            
                end if
            
                write(*,*) "rental_market_adjuster=", rental_market_adjuster
                
                if (re_do_simulation_with_fixed_parameters==1) then
        
                    ! Adjusting the rental price
                    rent(1)=rent(1)+&
                        rental_market_adjuster*&
                        (total_rental_demand(1)-total_rental_supply(1))
                
                    write(*,*) "rent(1)=", rent(1)
                    
                else
                    
                    distance_rental_market(1)=0
                
                end if
                
            else
            
                distance_rental_market(1)=0
                rent(1)=rent_to_housing_price*housing_price(1)
                
            end if
            
            if (shut_down_housing_market==0) then
                             
    !            write(*,*) "housing_price(1)=", housing_price(1)
        !           write(*,*) "model_GDP_per_household(1)=", model_GDP_per_household(1)
                write(*,*) "housing_price(1)*model_median_owner_occupied_unit_size(1)/model_GDP_per_household(1)=", &
                    (housing_price(1)*model_median_owner_occupied_unit_size(1))/&
                    model_GDP_per_household(1)
                    
            end if
                                                                                                           
            write(*,*) "model net wealth to model_output=", &
                (model_financial(1)+&
                model_net_housing_wealth(1))/model_output(1)
                             
            if (shut_down_housing_market==0) then
            
                write(*,*) "(total_housing_services(1)+total_imputed_rents(1))/model_GDP_incl_imput_rent(1))=", &
                    (total_housing_services(1)+total_imputed_rents(1))/model_GDP_incl_imput_rent(1)
                
                write(*,*) "model_mortgages(1)/model_gross_housing_wealth(1)=", &
                    model_mortgages(1)/model_gross_housing_wealth(1)
                    
                write(*,*) "model_average_rental_unit_size(1)=", &
                    model_average_rental_unit_size(1)
                
                write(*,*) "model_average_owner_occupied_unit_size(1)=", &
                    model_average_owner_occupied_unit_size(1)
                
                write(*,*) "model_median_owner_occupied_unit_size(1)=", &
                    model_median_owner_occupied_unit_size(1)
                
    !            write(*,*) "model_mass_of_households_with_below_housing_size(1)=", &
    !                model_mass_of_households_with_below_housing_size(1)
                                
                write(*,*) "model_average_rental_unit_size(1)/model_average_owner_occupied_unit_size(1)=", &
                    model_average_rental_unit_size(1)/model_average_owner_occupied_unit_size(1)
                
                write(*,*) "model_fraction_of_homeowners_with_mortgage(1)=", &
                    model_fraction_of_homeowners_with_mortgage(1)
                
                if (mortgage_deductibility>0) then
                
                    write(*,*) "% govt spending on mortgage interest deductions(1)/model GDP(1)=", &
                        100*(govt_spending_on_mortgage_interest_deductions(1)/model_GDP(1))
                
                end if
                
                write(*,*) "model_homeownership_rate(1)=", &
                    model_homeownership_rate(1)
            end if
                            
            write(*,*) "sum(distribution_stationary(1,:,:,:,:))=", &
                sum(distribution_stationary(1,:,:,:,:,:))
                
            if (add_utility_from_child==1) then
                
                write(*,*) "distance_value_function=", distance_value_function
                    
            end if
                        
            call cpu_time(simulation_stop_time)
            
    !            write(*,*) "running for", (simulation_stop_time-simulation_start_time)/3600
            write(*,*) "re_do_simulation_with_fixed_parameters=", re_do_simulation_with_fixed_parameters
            
            if (shut_down_housing_market==0) then
            
                write(*,*) "largest_house_size_hhld_can_rent=", &
                    largest_house_size_hhld_can_rent
                write(*,*) "smallest_house_size=", smallest_house_size
                write(*,*) "largest_house_size=", largest_house_size
                write(*,*) "housing_size(largest_house_size_hhld_can_rent)=", &
                    housing_size(largest_house_size_hhld_can_rent)
                write(*,*) "housing_size(index_of_smallest_house_hhld_can_buy)=", &
                    housing_size(index_of_smallest_house_hhld_can_buy)
                write(*,*) "index_of_smallest_house_hhld_can_buy=", &
                    index_of_smallest_house_hhld_can_buy
    !            write(*,*) "do_internal_computations=", do_internal_computations
    !            write(*,*) "model_construction_company_profits_verified(1)=", &
    !                model_construction_company_profits_verified(1)
                write(*,*) "total_constrcution_profits(1)=", &
                    total_constrcution_profits(1)
                write(*,*) "relative_share_of_housing=", relative_share_of_housing
                write(*,*) "advantage_to_owning=", advantage_to_owning
                write(*,*) "disutility_of_landlords=", disutility_of_landlords
                write(*,*) "distance_relative_share_of_housing=", distance_relative_share_of_housing
                write(*,*) "distance_advantage_to_owning=", distance_advantage_to_owning
                write(*,*) "distance_disutility_of_landlords=", distance_disutility_of_landlords
                write(*,*) "distance_rental_market=", distance_rental_market(1)
                write(*,*) "mass_of_renters_at_housing_spending(1,1)=", mass_of_renters_at_housing_spending(1,1)
                write(*,*) "mass_of_renters_at_housing_spending(1,2)=", mass_of_renters_at_housing_spending(1,2)
                write(*,*) "mass_of_renters_at_housing_spending(1,3)=", mass_of_renters_at_housing_spending(1,3)
                write(*,*) "mass_of_renters_at_housing_spending(1,4)=", mass_of_renters_at_housing_spending(1,4)
                write(*,*) "model_total_net_wealth(1)/model_output(1)=", &
                    model_total_net_wealth(1)/model_output(1)
            
            end if
            
            write(*,*) "discount_factor=", discount_factor
            write(*,*) "multiple_max_debt_to_assets=", multiple_max_debt_to_assets
            write(*,*) "multiple_max_debt_to_assets*productivity_grid_size=", &
                multiple_max_debt_to_assets*real(productivity_grid_size)
            write(*,*) "sd_epsilon_log_productivity=", sd_epsilon_log_productivity
            write(*,*) "probability_of_staying_in_fast_lane=", &
                probability_of_staying_in_fast_lane
            write(*,*) "cond_max_debt_to_assets_on_prod=", cond_max_debt_to_assets_on_prod
            write(*,*) "distance_discount_factor=", distance_discount_factor
            write(*,*) "distance_multiple_max_debt_to_assets=", distance_multiple_max_debt_to_assets
            write(*,*) "distance_wealth_by_top_1_perc=", distance_wealth_by_top_1_perc
            write(*,*) "distance_risk_free_rate=", distance_risk_free_rate(1)
            write(*,*) "distance_wage=", distance_wage
            write(*,*) "distance_probability_of_staying_in_fast_lane=", &
                distance_probability_of_staying_in_fast_lane
            write(*,*) "model_wealth_of_top_x_perc(1)/model_total_net_wealth(1)=", &
                        model_wealth_of_top_x_perc(1)/&
                        model_total_net_wealth(1)
            write(*,*) "stopping_rule_wealth_dist(1)=", stopping_rule_wealth_dist(1) 
            
    !           write(*,*) "rent_to_housing_price=", rent_to_housing_price
    !           write(*,*) "what_is_the_program_solving=", what_is_the_program_solving
    !           write(*,*) "wealth_tax_system_type=", wealth_tax_system_type
    !            write(*,*) "stopping_rule_value_function*(1+abs(largest_value_function_value))=", &
    !                   stopping_rule_value_function*(1+abs(largest_value_function_value))
    !            write(*,*) "stopping_rule_value_function=", &
    !                   stopping_rule_value_function
            write(*,*) "fraction of hhlds who make it to the highest net wealth=", &
                sum(distribution_stationary(1,:,financial_grid_size,:,:,:))/&
                sum(distribution_stationary(1,:,:,:,:,:))
                
            if (shut_down_housing_market==0) then

                write(*,*) "largest_housing_size_consumed_in_equilibrium=", &
                    largest_housing_size_consumed_in_equilibrium
                write(*,*) "largest_financial_chosen_in_equilibrium=", &
                    largest_financial_chosen_in_equilibrium
                write(*,*) "model_fraction_of_landlords(1)=", model_fraction_of_landlords(1)
                write(*,*) "model_average_landlord_house_size(1)=", &
                    model_average_landlord_house_size(1)
                write(*,*) "model_average_landlord_space_rented_out(1)=", &
                    model_average_landlord_space_rented_out(1)
                write(*,*) "rent(1)/housing_price(1)=", rent(1)/housing_price(1)
                write(*,*) "housing_price(1)=", housing_price(1)
    !            write(*,*) "model_average_net_wealth=", model_average_net_wealth(1)
    
            end if
            
            write(*,*) "model_total_efficiency_units(1)=", model_total_efficiency_units(1)
            write(*,*) "model_output(1)=", model_output(1)
            write(*,*) "model_GDP_incl_imput_rent(1)=", model_GDP_incl_imput_rent(1)
            write(*,*) "total_imputed_rents(1)=", total_imputed_rents(1)
            write(*,*) "model_average_labour_income(1)=", model_average_labour_income(1)
            write(*,*) "exogenous_wages=", exogenous_wages
            write(*,*) "shut_down_housing_market=", shut_down_housing_market
            
            if (loop_count<=1) then
            
                do i=1,productivity_grid_size
                    write(*,*) "fraction with productivity_grid(",i,")=", &
                    sum(distribution_stationary(1,:,:,:,:,i))/sum(distribution_stationary)
                end do
                
                do i=1,employment_grid_size
                    write(*,*) "fraction with income(",i,")=", &
                    sum(distribution_stationary(1,:,:,i,:,:))/sum(distribution_stationary)
                end do
                
                do i=1,productivity_shock_grid_size
                    write(*,*) "fraction with productivity_shock_index(",i,")=", &
                    sum(distribution_stationary(1,:,:,:,i,:))/sum(distribution_stationary)
                end do
             
            end if
                                                                            
            call initialize_variables_and_grids(1)
            call initialize_financial_grid(1)
            call function_of_utility_advantage_from_homeowning(1)
            call govt_revenues_calc(1,0)
                        
            if (minimum_downpayment_below_20_perc==1) then
            
                write(*,*) "model_fraction_of_homeowners_with_mortgage_over_80_perc(1)=", &
                    model_fraction_of_homeowners_with_mortgage_over_80_perc(1)
                write(*,*) "fraction of households with mortgage ober 80 perc=", &
                    model_fraction_of_homeowners_with_mortgage_over_80_perc(1)*&
                    model_fraction_of_homeowners_with_mortgage(1)*&
                    model_homeownership_rate(1)            
                write(*,*) "model_fraction_of_mortgage_holders_using_alternative_lenders(1)=", &
                    model_fraction_of_mortgage_holders_using_alternative_lenders(1)
                        
            end if
            
!            write(*,*) "add_utility_from_child=", add_utility_from_child

            if (shut_down_housing_market==0) then
            
                write(*,*) "mortgage_deductibility=", mortgage_deductibility
                write(*,*) "mortgage_grid_size=", mortgage_grid_size
    !            write(*,*) "can_get_mortgage_in_retirement=", can_get_mortgage_in_retirement
    
            end if
            
            write(*,*) "loop_count=", loop_count
!            write(*,*) "fin_num_of_internal=", fin_num_of_internal
!            write(*,*) "space_lived_in_num_of_internal=", space_lived_in_num_of_internal

            if (shut_down_housing_market==0) then
            
                write(*,*) "housing_status_grid_expander=", housing_status_grid_expander
                write(*,*) "calibrate_housing_status_grid_expander=", calibrate_housing_status_grid_expander
                write(*,*) "endogenous_rental_market=", endogenous_rental_market
                write(*,*) "rental_management_costs=", rental_management_costs
                write(*,*) "c_1=", c_1
                write(*,*) "c_min=", c_min
                write(*,*) "cutoff_housing_investment=", cutoff_housing_investment
                write(*,*) "housing_stock=", housing_stock(1)
                write(*,*) "max_debt_to_income_ratio=", max_debt_to_income_ratio
                
            end if
            
!            write(*,*) "model_output=", model_output(1)
!            write(*,*) "model_financial_per_household(1)=", model_financial_per_household(1)
!            write(*,*) "construction_company_profits(1)=", construction_company_profits(1)
            write(*,*) "model average labour income=", model_average_labour_income(1)
            write(*,*) "model_total_income=", &
                model_total_investment_income(1)+&
                (1-exogenous_wages)*&
                (wage(1)*model_total_efficiency_units(1)+&
                model_total_business_income(1))+&
                exogenous_wages*model_output(1)+&
                (1-shut_down_housing_market)*&
                construction_company_profits(1)
            write(*,*) "model_total_expenditures=", &
                aggregate_consumption(1)+&
                net_govt_revenues(1)+&
                (1-shut_down_housing_market)*&
                ((aggregate_housing_consumption(1)+&
                aggregate_mortgage_consumption(1))+&
                (1-endogenous_rental_market)*&
                (aggregate_rent_spending(1)-&
                govt_revenues_from_property_tax_rental(1)))
            write(*,*) "multiple_household_members=", multiple_household_members
            write(*,*) "mortgage_interest_rate=", mortgage_interest_rate(1)
            write(*,*) "risk_free_rate=", risk_free_rate(1)
            write(*,*) "is_there_mortgage_debt_premium=", is_there_mortgage_debt_premium
            write(*,*) "add_utility_from_child=", add_utility_from_child
            write(*,*) "model_bequests/model_total_net_wealth=", &
                100*(model_bequests(1)/model_total_net_wealth(1))
                                
            write(*,*) "file_number=", file_number
            write(*,*) "robustness_check=", robustness_check
        
            if (robustness_check==1) then
        
                write(*,*) "higher_nu=", higher_nu
                write(*,*) "lower_nu=", lower_nu
                write(*,*) "looser_lambda=", looser_lambda
                write(*,*) "lump_sum_construction_profits=", lump_sum_construction_profits
                write(*,*) "smaller_rental=", smaller_rental
                write(*,*) "curv_intrmdte_prod=", curv_intrmdte_prod
                
            end if
                                
        end do
        
        simulation_ended=1
        
        call stationary_equilibrium_statistics(1)
        
        call calculate_gini_coefficient(1)
        call stationary_equilibrium_top_wealth_distribution_stats(1)
        call stationary_equilibrium_bot_wealth_distribution_stats(1) 
        call calculate_welfare_by_characteristics(1)
        
        if (shut_down_housing_market==0) then
        
            call calculate_homeownership_by_characteristics(1)
            call calculate_household_housing_spending(1)
            
        end if
        
        call frac_of_households_in_support_of_policy(1)
        call compute_portfolio_by_productivity(1)
                            
        call calculate_aggregate_consumption(1)
                            
        call cpu_time(simulation_stop_time)
    
        open(UNIT=9,file="value_function"//trim(file_number)//".dat",status='replace')
            write(9,'(F20.8)') value_function(1,:,:,:,:,:)
        close(9)
        
        open(UNIT=10,file="distribution_stationary"//trim(file_number)//".dat",status='replace')
            write(10,'(F20.8)') distribution_stationary(1,:,:,:,:,:)
        close(10)
        
        open(UNIT=11,file="policy_function_financial"//trim(file_number)//".dat",status='replace')
            write(11,'(I4)') policy_function_financial(1,:,:,:,:,:)
        close(11)
        
        open(UNIT=12,file="fin_index_frac_mov_to_optimal"//trim(file_number)//".dat",status='replace')
            write(12,'(I3)') fin_index_frac_mov_to_optimal(1,:,:,:,:,:)
        close(12)
        
        open(UNIT=10,file="frac_mov_optimal_1"//trim(file_number)//".dat",status='replace')
            write(10,'(F10.8)') frac_mov_optimal_1(1,:,:,:,:,:)
        close(10)
        
        open(UNIT=13,file="policy_function_housing_status"//trim(file_number)//".dat",status='replace')
            write(13,'(I3)') policy_function_housing_status(1,:,:,:,:,:)
        close(13)
        
        open(UNIT=14,file="policy_function_mortgage"//trim(file_number)//".dat",status='replace')
            write(14,'(I3)') policy_function_mortgage(1,:,:,:,:,:)
        close(14)
        
        open(UNIT=15,file="policy_function_ownership_status"//trim(file_number)//".dat",status='replace')
            write(15,'(I3)') policy_function_ownership_status(1,:,:,:,:,:)
        close(15)
        
        open(UNIT=16,file="policy_function_space_lived_in_size"//trim(file_number)//".dat",status='replace')
            write(16,'(F15.8)') policy_function_space_lived_in_size(1,:,:,:,:,:)
        close(16)
    
    end subroutine
    
    subroutine long_run_counter_factual()
    
        use Wealth_Tax_Global_Vars
        
        implicit none
                        
        call cpu_time(simulation_start_time)
        
        policy_function_loss_on_house=0
        
        wage_guess(transition_length,1)=wage_calibrated
        
        ! Optimize progressive taxes given cutoff
        if ((exogenous_wages==0) .AND. &
            ((wealth_tax_system_type==6) .OR. (wealth_tax_system_type==7))) then
        
            property_tax(transition_length)=benchmark_property_tax
            
            financial_tax=0
            business_income_tax=financial_tax
            investment_income_tax=financial_tax
            progressive_wealth_tax=financial_tax
                    
            wage_guess(transition_length,1)=wage_calibrated !1.9684712011032015 !1.9685519901701034
        
        ! Taxing imputed rents
        elseif ((exogenous_wages==0) .AND. (wealth_tax_system_type==5)) then
        
            financial_tax=0
            progressive_wealth_tax=0
            property_tax(transition_length)=benchmark_property_tax
            
            business_income_tax=0.30351060979120392 
            investment_income_tax=financial_tax
                    
            wage_guess(transition_length,1)=1.7933097533758278
        
        ! Taxing wealth progressively
        elseif ((exogenous_wages==0) .AND. (wealth_tax_system_type==4)) then
        
            progressive_wealth_tax=&
               (1-shut_down_housing_market)*4.8045553773852001E-002+&
               shut_down_housing_market*6.0653799115795680E-002 !1.3083862451867118E-002
            financial_tax=0
            business_income_tax=financial_tax
            investment_income_tax=financial_tax
                        
            property_tax(transition_length)=&
                benchmark_property_tax+&
                (1-shut_down_housing_market)*&
                uniform_wealth_tax*financial_tax
            wage_guess(transition_length,1)=&
                (1-shut_down_housing_market)*1.9476143983661747+& ! 1.8050023790924006
                shut_down_housing_market*2.3537681895587830 !2.0009202017287482
        
        ! Taxing financial wealth and housing
        elseif ((exogenous_wages==0) .AND. (wealth_tax_system_type==3)) then
        
            financial_tax=5.9140330077138432E-002   !0.014 !4.4772195962808382E-002
            business_income_tax=financial_tax
            investment_income_tax=financial_tax
                        
            property_tax(transition_length)=&
                benchmark_property_tax+&
                (1-shut_down_housing_market)*&
                uniform_wealth_tax*financial_tax
            wage_guess(transition_length,1)=1.8405374673688233 !1.7 !1.7713123339873882
            
        ! Taxing housing and capital income
        elseif ((exogenous_wages==0) .AND. (wealth_tax_system_type==2)) then
        
            financial_tax=0
            business_income_tax=0.2 !0.27601580939511944
            investment_income_tax=business_income_tax
            property_tax(transition_length)=benchmark_property_tax
            wage_guess(transition_length,1)=1.8396800757859999 ! 1.7299021672121255 ! 1.8372807761980632
                        
        end if            
            
        wage(transition_length)=wage_guess(transition_length,1)
        
        if (exogenous_wages==1) then
        
            wage(transition_length)=1
            
        end if
        
        housing_price(transition_length)=&
            (1-shut_down_housing_market)*&
            calibrated_stationary_housing_price
                
        if (use_average_rental_size==1) then
        
            model_average_rental_unit_size(transition_length)=calibrated_average_rental_size
        
        end if
        
        loop_count=0
        
        if (shut_down_housing_market==0) then

            c_1=c_1_calibrated
            c_min=c_min_calibrated
        
            housing_price(transition_length)=calibrated_stationary_housing_price*1.0593718178576481
        
            rent(transition_length)=rent_calibrated*0.93764897625603627
            
            if (wealth_tax_system_type==4) then
            
                housing_price(transition_length)=calibrated_stationary_housing_price*0.98967445566197543
        
                rent(transition_length)=rent_calibrated*0.98997520459666566
                
            end if
            
        end if
        
        if ((wealth_tax_system_type==6) .OR. (wealth_tax_system_type==7)) then
        
            housing_price(transition_length)=calibrated_stationary_housing_price*1.076884054848835 !0.77018114675467486
            rent(transition_length)=rent_calibrated*0.97061563535340223 !0.77687612004269491
            
        end if
                
        risk_free_rate(transition_length)=shut_down_housing_market*calibrated_risk_free_rate+&
                                          (1-shut_down_housing_market)*calibrated_risk_free_rate
                
        if (risk_free_rate(transition_length)<0) then
        
            investment_income_tax=0
            
        else
        
            if (exogenous_wages==0) then
        
                investment_income_tax=business_income_tax
                
            else
            
                investment_income_tax=0.15
            
            end if
            
        end if
        
        mortgage_interest_rate(transition_length)=risk_free_rate(transition_length)+mortgage_interest_gap
        
        if (shut_down_housing_market==1) then
        
            relative_share_of_housing=0
        
        end if
        
        risk_aversion_share_of_cons=(1-relative_share_of_housing)*(1-risk_aversion)
        
        if ((shut_down_housing_market==0) .AND. (endogenous_rental_market==1)) then
        
            disutility_of_landlords=&
                disutility_of_landlords*&
                (wage(transition_length)**(risk_aversion_share_of_cons))
            
        else
        
            disutility_of_landlords=0
            
        end if
                
        model_average_labour_income(transition_length)=average_labor_income_calibrated
        
        model_total_efficiency_units(transition_length)=model_total_efficiency_units_calibrated
        
        if (share_of_corporate_profits>0) then
        
            corporate_capital(transition_length)=model_corporate_capital_calibrated
            
        else
        
            corporate_capital(transition_length)=1
            
        end if
        
        aggregation_of_tot_intermdte_gds(transition_length)=&
            (wage(transition_length)/(aggregate_productivity*share_of_labour*&
            ((corporate_capital(transition_length))**&
            (share_of_corporate_profits))*&
            ((model_total_efficiency_units(transition_length))**&
            (share_of_labour-1))))**(1/(max(share_of_capital,0.01)))
            
        aggregate_production_times_labour(transition_length)=&
            aggregate_productivity*share_of_capital*&
            (aggregation_of_tot_intermdte_gds(transition_length)**(share_of_capital-curv_intrmdte_prod))*&
            (corporate_capital(transition_length)**(share_of_corporate_profits))*&
            (model_total_efficiency_units(transition_length))**(share_of_labour)
            
        if (exogenous_wages==1) then
        
            corporate_capital(transition_length)=1
            aggregation_of_tot_intermdte_gds(transition_length)=1
            aggregate_production_times_labour(transition_length)=1
            
        end if
                 
        model_output(transition_length)=&
            aggregate_productivity*&
            (aggregation_of_tot_intermdte_gds(transition_length))**(share_of_capital)*&
            (corporate_capital(transition_length)**(share_of_corporate_profits))*&
            (model_total_efficiency_units(transition_length))**(share_of_labour)
                
        call initialize_variables_and_grids(transition_length)
        
        call set_SS_benefits()
        
        model_ss_benefits=calibrated_soc_secrty
        
        call initialize_feasible_distribution(transition_length)
        
        total_housing_demand(transition_length)=calibrated_housing_stock
        
        if (which_wealth_tax_to_do==6) then
        
            total_housing_demand(transition_length)=54.5
            
        end if
        
        call function_of_utility_advantage_from_homeowning(transition_length)
        call initialize_financial_grid(transition_length)
        
        if (multiple_household_members==1) then

            model_average_lowest_labor_income=8.0633792843442298E-002
                            
        else
            
            model_average_lowest_labor_income=&
                wage(transition_length)*employment_grid(employment_grid_size)*&
                (maxval(labour_deterministic_efficiency)+1)/2
        
        end if
                
        model_financial_per_household(transition_length)=&
            financial_grid(financial_grid_size)/total_population
                    
        distance_wage=1
        distance_risk_free_rate(transition_length)=1
        distance_value_function=1
        distance_rental_market(transition_length)=1
        distance_housing_market(transition_length)=1
        distance_govt_budget=1
        
        value_function_guess(:,:,:,:)=0
        value_function(transition_length,:,:,:,:,:)=0
        
        if (partial_eqilibrium==1) then
        
            wage(transition_length)=1.9729292834134522
            model_average_labour_income(transition_length)=0.93205030323507077
            housing_price(transition_length)=1.8103279384777047
            rent(transition_length)=0.10868054464125643
            aggregate_production_times_labour(transition_length)=0.13113401968467037
            aggregation_of_tot_intermdte_gds(transition_length)=363.62941635390911
            business_income_tax=0
            investment_income_tax=0
            property_tax=0.01
            progressive_wealth_tax=2.2998142343193941E-002
            stopping_rule_stationary_distribution=10.d0**(-11)
        
        end if
                
        write(*,*) "re_do_simulation_with_fixed_parameters=", re_do_simulation_with_fixed_parameters
        write(*,*) "stress_test=", stress_test(transition_length)
        write(*,*) "add_utility_from_child=", add_utility_from_child
        write(*,*) "can_get_mortgage_in_retirement=", can_get_mortgage_in_retirement
        write(*,*) "endogenous_rental_market=", endogenous_rental_market
        write(*,*) "rental_management_costs=", rental_management_costs
        write(*,*) "calibrated_soc_secrty=", calibrated_soc_secrty
        write(*,*) "mortgage_interest_rate=", mortgage_interest_rate(transition_length)
        write(*,*) "risk_free_rate=", risk_free_rate(transition_length)
        write(*,*) "financial_tax=", financial_tax
        write(*,*) "business_income_tax=", business_income_tax
        write(*,*) "investment_income_tax=", investment_income_tax
        write(*,*) "property_tax=", property_tax(transition_length)
        write(*,*) "progressive_wealth_tax=", progressive_wealth_tax
        write(*,*) "progressive_fincial_tax=", progressive_financial_tax
        write(*,*) "progressive_housing_tax=", progressive_housing_tax
        write(*,*) "progressive_wealth_tax_threshold=", progressive_wealth_tax_threshold
        write(*,*) "threshold_financial=", threshold_financial
        write(*,*) "threshold_housing=", threshold_housing
        write(*,*) "wage=", wage(transition_length)
        write(*,*) "tax_imputed_rent=", tax_imputed_rent
        write(*,*) "file_number=", file_number
        write(*,*) "net_govt_revenue_constraint=", net_govt_revenue_constraint
        write(*,*) "rent=", rent(transition_length)
        write(*,*) "housing_price=", housing_price(transition_length)
        write(*,*) "aggregation_of_tot_intermdte_gds=", &
            aggregation_of_tot_intermdte_gds(transition_length)
        write(*,*) "partial_eqilibrium=", partial_eqilibrium
        write(*,*) "robustness_check=", robustness_check
        write(*,*) "higher_nu=", higher_nu
        write(*,*) "lower_nu=", lower_nu
        write(*,*) "looser_lambda=", looser_lambda
        write(*,*) "lump_sum_construction_profits=", lump_sum_construction_profits
        write(*,*) "smaller_rental=", smaller_rental
        write(*,*) "wealth_tax_system_type=", wealth_tax_system_type
        write(*,*) "curv_intrmdte_prod=", curv_intrmdte_prod
        write(*,*) "stopping_rule_housing_market=", stopping_rule_housing_market
        write(*,*) "stopping_rule_govt_budget=", stopping_rule_govt_budget
                    
        write(*,*) "counter_factual"
        
        do while((distance_wage>stopping_rule_wage) .OR. &
            (distance_risk_free_rate(transition_length)>stopping_rule_risk_free_rate) .OR. &
            (distance_rental_market(transition_length)>stopping_rule_rental_market) .OR. &
            (distance_value_function>(stopping_rule_value_function*(1+abs(largest_value_function_value)))) .OR. &
            (distance_housing_market(transition_length)>stopping_rule_housing_market) .OR. &
            (distance_govt_budget>stopping_rule_govt_budget))
        
            call solve_value_function_and_policy_functions(transition_length,0)
            
            ! No need to converge on value function
            if (add_utility_from_child==0) then
            
                ! Sets the distance to 0
                distance_value_function=0
                
            ! Converge on value function only for age 1
            elseif (add_utility_from_child==1) then
            
                distance_value_function=&
                    maxval(abs(value_function_guess(:,:,:,:)-&
                    value_function(1,1,:,:,:,:)))
                
                ! Finding the index of the largest distance
                distance_value_function_indeces_youngest=&
                    maxloc(abs(value_function_guess(:,:,:,:)-&
                    value_function(1,1,:,:,:,:)),&
                    mask=abs(value_function_guess(:,:,:,:)-&
                    value_function(1,1,:,:,:,:))>=0)
                
                ! Finding the value of the value function at that index
                largest_value_function_value=&
                    value_function&
                    (1,1,&
                    distance_value_function_indeces_youngest(1),&
                    distance_value_function_indeces_youngest(2),&
                    distance_value_function_indeces_youngest(3),&
                    distance_value_function_indeces_youngest(4))
                                                           
                value_function_guess(:,:,:,:)=&
                    value_function(1,1,:,:,:,:)  
                    
                ! Sets the distance to 0
                distance_value_function=0
            
            end if
        
            call converge_to_stationary_equilibrium(transition_length,0)
            
            if (exogenous_wages==0) then
            
                call stationary_eqlibrium_intermediate_inputs(transition_length)
                
            else
            
                wage(transition_length)=1
                aggregation_of_tot_intermdte_gds(transition_length)=1
                aggregate_production_times_labour(transition_length)=1
                corporate_capital(transition_length)=1
            
            end if
                                    
            call calculate_welfare_by_characteristics(transition_length)
            call stationary_equilibrium_statistics(transition_length)   
            
             if (exogenous_wages==0) then
            
                call stationary_equilibrium_top_wealth_distribution_stats(transition_length)
!                call stationary_equilibrium_bot_wealth_distribution_stats(transition_length) 
                
            end if
            
            if (shut_down_housing_market==0) then
            
                call stationary_equilibirum_homeownership_rate(transition_length)
                call calculate_homeownership_by_characteristics(transition_length)
                
            end if
            
            call govt_revenues_calc(transition_length,0)
            
            if ((wealth_tax_system_type>=2) .AND. (partial_eqilibrium==0)) then
            
                distance_govt_budget=&
                    abs(net_govt_revenues(transition_length)-net_govt_revenue_constraint)
                    
            else
                
                distance_govt_budget=0
            
            end if
            
            call calculate_aggregate_consumption(transition_length)
            
            if ((distance_rental_market(transition_length)<0) .AND. &
                (abs(housing_stock(transition_length)-total_housing_demand(transition_length))<0) .AND. &
                (distance_govt_budget<stopping_rule_govt_budget)) then
                
                stopping_rule_housing_market=0.005*(housing_stock(transition_length))
                stopping_rule_rental_market=0.005*(total_rental_supply(transition_length))
                
                distance_housing_market(transition_length)=&
                    abs(housing_stock(transition_length)-total_housing_demand(transition_length))
                    
                if (endogenous_rental_market==1) then
                    
                    distance_rental_market(transition_length)=&
                        abs(total_rental_supply(transition_length)-total_rental_demand(transition_length))
                        
                else
                
                    distance_rental_market(transition_length)=0
                    
                end if
                
                write(*,*) "distance_housing_market(transition_length)=", &
                    distance_housing_market(transition_length)
                write(*,*) "distance_rental_market(transition_length)=", &
                    distance_rental_market(transition_length)
                
                if (distance_housing_market(transition_length)>stopping_rule_housing_market) then
                
                    ! solving the housing price
                    call solve_prices(transition_length,1)
                    
                end if
                
                if ((distance_rental_market(transition_length)>stopping_rule_rental_market) .AND. &
                   (endogenous_rental_market==1)) then
                
                    ! solving the rental price
                    call solve_prices(transition_length,0)
                    
                end if
                
                call converge_to_stationary_equilibrium(transition_length,0)
                call stationary_equilibrium_statistics(transition_length)
                call stationary_equilibirum_homeownership_rate(transition_length)
                
                distance_housing_market(transition_length)=&
                    abs(housing_stock(transition_length)-total_housing_demand(transition_length))
                    
                if (endogenous_rental_market==1) then
                
                    distance_rental_market(transition_length)=&
                        abs(total_rental_supply(transition_length)-total_rental_demand(transition_length))
                        
                else
                
                    distance_rental_market(transition_length)=0
                
                end if
                                    
                write(*,*) "distance_housing_market(transition_length)=", &
                    distance_housing_market(transition_length)
                write(*,*) "distance_rental_market(transition_length)=", &
                    distance_rental_market(transition_length)                    
            
            else
            
                if ((endogenous_rental_market==1) .AND. &
                   (shut_down_housing_market==0)) then
            
                    ! Checks the distance between supply and demand
                    distance_rental_market(transition_length)=&
                        abs(total_rental_demand(transition_length)-total_rental_supply(transition_length))
                
                    write(*,*) "rent(transition_length)=", rent(transition_length)
                    write(*,*) "rental_supply(transition_length)=", total_rental_supply(transition_length)
                    write(*,*) "rental_demand(transition_length)=", total_rental_demand(transition_length)
                    write(*,*) "distance_rental_market(transition_length)=", distance_rental_market(transition_length)
            
                    if (loop_count>aftr_how_mny_lps_start_update) then
            
                        if (distance_rental_market(1)<0.04) then
                
                            rental_market_adjuster=5*10.d0**(-5)*wage(transition_length)
                    
                        elseif (distance_rental_market(1)<2) then
                
                            rental_market_adjuster=10.d0**(-4)*wage(transition_length)
                
                        else
            
                            rental_market_adjuster=10.d0**(-4)*wage(transition_length)
                    
                        end if
            
                    else
            
                        rental_market_adjuster=0
                        distance_rental_market(transition_length)=1
                
                    end if
            
                    write(*,*) "rental_market_adjuster=", rental_market_adjuster
                    
                    if (re_do_simulation_with_fixed_parameters==1) then
            
                        ! Adjusting the rental price
                        rent(transition_length)=&
                            rent(transition_length)+&
                            rental_market_adjuster*&
                            (total_rental_demand(transition_length)-&
                            total_rental_supply(transition_length))
                            
                    else
                    
                        distance_rental_market(1)=0
                    
                    end if
                    
                else
                        
                    distance_rental_market(transition_length)=0
                    
                    if (shut_down_housing_market==0) then
                    
                        write(*,*) "endogenous_rental_market=", endogenous_rental_market
                        write(*,*) "rental_management_costs=", rental_management_costs_calibrated
                        
                    end if
                
                end if
                
                if (shut_down_housing_market==1) then
                
                    distance_rental_market(transition_length)=0
                    rent(transition_length)=0
                
                end if
                
                if ((shut_down_housing_market==0) .AND. (partial_eqilibrium==0)) then
                
!                    write(*,*) "rent(transition_length)=", rent(transition_length)
!                    write(*,*) "rent(transition_length)/rent_calibrated=", rent(transition_length)/rent_calibrated
!                                    
!                    write(*,*) "loop_count=", loop_count
!                            
!                    write(*,*) "housing_price(transition_length)=", housing_price(transition_length)
                    
                    distance_housing_market(transition_length)=&
                        abs(housing_price(transition_length)-&
                        (c_1_calibrated)*&
                        (housing_depreciation*total_housing_demand(transition_length))**&
                        (1/empirical_housing_supplpy_elasticity))
                                            
                    weight_housing_price=0.05
                                                                    
                    ! Updates the house price
                    housing_price(transition_length)=&
                        (1-weight_housing_price)*housing_price(transition_length)+&
                        weight_housing_price*&
                        (c_1_calibrated)*&
                        (housing_depreciation*total_housing_demand(transition_length))**&
                        (1/empirical_housing_supplpy_elasticity)
                    
!                    write(*,*) "distance_housing_market(transition_length)=", distance_housing_market(transition_length)
                    write(*,*) "total_housing_demand(transition_length)=", total_housing_demand(transition_length)
                    write(*,*) "housing_stock(transition_length)=", housing_stock(transition_length)
!                    write(*,*) "updated housing_price(transition_length)=", housing_price(transition_length)
!                    write(*,*) "updated housing_price(transition_length)/calibrated_stationary_housing_price=", &
!                        housing_price(transition_length)/calibrated_stationary_housing_price
                    
                else
                
                    if (shut_down_housing_market==1) then
                    
                        housing_price(transition_length)=0
                        
                    end if
                    
                    distance_housing_market(transition_length)=0
                
                end if
                    
            end if
            
            if ((exogenous_interest_rate==0) .AND. (partial_eqilibrium==0)) then
            
                if (loop_count>0) then
                        
                    ! Solving the risk free rate (includes the distance)
                    call solve_risk_free_rate(transition_length)
                    
                else
                
                    distance_risk_free_rate=1
                
                end if
                
            else
            
                mortgage_interest_rate(transition_length)=&
                    risk_free_rate(transition_length)+&
                    mortgage_interest_gap
                    
                distance_risk_free_rate=0
                
            end if
            
            if (risk_free_rate(transition_length)<0) then
        
                investment_income_tax=0
            
            else
            
                if (exogenous_wages==0) then
        
                    investment_income_tax=business_income_tax
                    
                else
                    
                    investment_income_tax=0.15
                
                end if
            
            end if
            
            if (exogenous_wages==0) then
               
                if (partial_eqilibrium==0) then
               
                    distance_wage=abs(wage(transition_length)-wage_guess(transition_length,2))
                                               
                    wage_guess(transition_length,1)=&
                        (1-weight_wage)*wage(transition_length)+&
                        weight_wage*wage_guess(transition_length,2)
                            
                    write(*,*) "wage(transition_length)=", wage(transition_length)
                        
                    wage(transition_length)=wage_guess(transition_length,1)
                                
                    ! updating the guess for aggregate capital
                    aggregation_of_tot_intermdte_gds(transition_length)=&
                        (wage(transition_length)/(aggregate_productivity*share_of_labour*&
                        (corporate_capital(transition_length)**&
                        (share_of_corporate_profits))*&
                        ((model_total_efficiency_units(transition_length))**&
                        (share_of_labour-1))))**(1/(max(share_of_capital,0.01)))
                    
                    ! Updates the guess for corporate capital
                    if (share_of_corporate_profits>0) then
                
                        corporate_capital(transition_length)=&
                            ((share_of_corporate_profits*&
                            (aggregation_of_tot_intermdte_gds(transition_length)**(share_of_capital)*&
                            model_total_efficiency_units(transition_length)**(share_of_labour)))/&
                            (risk_free_rate(transition_length)+financial_wealth_depreciation))**&
                            (1/(share_of_capital+share_of_labour))
                                    
                    else
                    
                        corporate_capital(transition_length)=1    
                        
                    end if
                        
                    aggregate_production_times_labour(transition_length)=&
                        aggregate_productivity*share_of_capital*&
                        ((aggregation_of_tot_intermdte_gds(transition_length))**(share_of_capital-curv_intrmdte_prod))*&
                        ((corporate_capital(transition_length))**(share_of_corporate_profits))*&
                        ((model_total_efficiency_units(transition_length))**(share_of_labour))
                        
                else
                
                    distance_wage=0
                
                end if
                
            else
            
                wage(transition_length)=1
                distance_wage=0
                aggregation_of_tot_intermdte_gds(transition_length)=1
                aggregate_production_times_labour(transition_length)=1
                corporate_capital(transition_length)=1
                
            end if
                                
            write(*,*) "wage updated=", wage(transition_length)
                        
            write(*,*) "wages to output=", &
                (model_total_efficiency_units(transition_length)*wage(transition_length))/&
                model_output(transition_length)
                
!            write(*,*) "labor share of income=", &
!                share_of_labour
                
            write(*,*) "profits to output=", &
                model_total_gross_enrepreneurial_income(transition_length)/&
                model_output(transition_length)
                
!            write(*,*) "cpital share of income=", &
!                share_of_capital
                
            if (share_of_corporate_profits>0) then
                
                write(*,*) "corporate profits to output=", &
                    ((risk_free_rate(transition_length)+financial_wealth_depreciation)*&
                    corporate_capital(transition_length))/model_output(transition_length)
                    
            end if
            
!            write(*,*) "model net wealth to output=", &
!                (model_financial(transition_length)+model_net_housing_wealth(1))/&
!                model_output(transition_length)
                
!            write(*,*) "model_fin_debt to gross assets=", &
!                model_fin_debt(transition_length)/&
!                (model_financial(transition_length)+&
!                model_gross_housing_wealth(transition_length))
                                    
            call govt_revenues_calc(transition_length,0)
            call calculate_welfare(transition_length)
            
            if (shut_down_housing_market==0) then
            
                call calculate_household_housing_spending(transition_length)
                
            end if
                        
            call frac_of_households_in_support_of_policy(transition_length)
            
            if (partial_eqilibrium==0) then
            
                ! This function updates the tax system
                call update_tax_system(transition_length,wealth_tax_system_type)
                
            end if
            
            write(*,*) "net_govt_revenue_constraint=", net_govt_revenue_constraint
            write(*,*) "net_govt_revenues=", net_govt_revenues(transition_length)
!            write(*,*) "% of gross govt revenues spent on bailouts=", &
!                govt_spending_on_bailouts(transition_length)
                                                                        
            if (shut_down_housing_market==0) then
                
                write(*,*) "model_average_rental_unit_size(transition_length)=", &
                    model_average_rental_unit_size(transition_length)
                    
                write(*,*) "model_average_owner_occupied_unit_size(transition_length)=", &
                    model_average_owner_occupied_unit_size(transition_length)
                    
!                write(*,*) "model_median_owner_occupied_unit_size(transition_length)=",&
!                    model_median_owner_occupied_unit_size(transition_length)
                
!                write(*,*) "model_average_rental_unit_size(transition_length)/&
!                    model_average_owner_occupied_unit_size(transition_length)=", &
!                    model_average_rental_unit_size(transition_length)/&
!                    model_average_owner_occupied_unit_size(transition_length)
                    
            end if
        
!            write(*,*) "sum(distribution_stationary(transition_length,:,:,:,:))=", &
!                sum(distribution_stationary(transition_length,:,:,:,:,:))
                
            if (shut_down_housing_market==0) then
            
                write(*,*) "distance_housing_market=", distance_housing_market(transition_length)
                
                if (endogenous_rental_market==1) then
                
                    write(*,*) "distance_rental_market=", distance_rental_market(transition_length)
            
                end if
            
            end if
            
            call cpu_time(simulation_stop_time)
            
            write(*,*) "running for", (simulation_stop_time-simulation_start_time)/3600
            
            if (shut_down_housing_market==0) then
            
                write(*,*) "model_homeownership_rate(transition_length)=", &
                    model_homeownership_rate(transition_length)
                write(*,*) "largest_house_size_hhld_can_rent=", &
                    largest_house_size_hhld_can_rent
                write(*,*) "index_of_smallest_house_hhld_can_buy=", &
                    index_of_smallest_house_hhld_can_buy 
                write(*,*) "can_get_mortgage_in_retirement=", can_get_mortgage_in_retirement
                write(*,*) "relative_share_of_housing=", relative_share_of_housing
                write(*,*) "advantage_to_owning=", advantage_to_owning
!                write(*,*) "% govt spending on mortgage interest deductions/model GDP=", &
!                        100*(govt_spending_on_mortgage_interest_deductions(transition_length)/&
!                        model_GDP(transition_length))
                        
            end if
                    
            write(*,*) "do_internal_computations=", do_internal_computations
            write(*,*) "add_utility_from_child=", add_utility_from_child
            write(*,*) "what_is_the_program_solving=", what_is_the_program_solving
            write(*,*) "wealth_tax_system_type=", wealth_tax_system_type
            write(*,*) "file_number=", file_number
            write(*,*) "benchmark_simulation=", benchmark_simulation
            
            if (add_utility_from_child==1) then
            
                write(*,*) "stopping_rule_value_function*(1+abs(largest_value_function_value))=", &
                    stopping_rule_value_function*(1+abs(largest_value_function_value))
                write(*,*) "stopping_rule_value_function=", &
                    stopping_rule_value_function
                    
            end if
                                    
            call function_of_utility_advantage_from_homeowning(transition_length)
            
            if (shut_down_housing_market==0) then
            
!                write(*,*) "stress_test=", stress_test
!                write(*,*) "re_do_simulation_with_fixed_parameters=", re_do_simulation_with_fixed_parameters
!                write(*,*) "model_median_net_wealth=", &
!                    model_median_net_wealth
!                write(*,*) "model_fraction_of_landlords(transition_length)=", &
!                    model_fraction_of_landlords(transition_length)
!                write(*,*) "model_average_landlord_house_size(transition_length)=", &
!                    model_average_landlord_house_size(transition_length)
!                write(*,*) "model_average_landlord_space_rented_out(transition_length)=", &
!                    model_average_landlord_space_rented_out(transition_length)
!                write(*,*) "model_mortgages=", model_mortgages(transition_length)
                
            end if
            
!            write(*,*) "model_average_net_wealth=", &
!                    model_average_net_wealth(transition_length)
            write(*,*) "model_total_income=", &
                model_total_investment_income(transition_length)+&
                (1-exogenous_wages)*&
                (wage(transition_length)*&
                model_total_efficiency_units(transition_length)+&
                model_total_business_income(transition_length))+&
                exogenous_wages*model_output(transition_length)+&
                (1-shut_down_housing_market)*&
                construction_company_profits(transition_length)
            write(*,*) "model_total_expenditures=", &
                aggregate_consumption(transition_length)+&
                net_govt_revenues(transition_length)+&
                (1-shut_down_housing_market)*&
                ((aggregate_housing_consumption(transition_length)+&
                aggregate_mortgage_consumption(transition_length))+&
                (1-endogenous_rental_market)*&
                (aggregate_rent_spending(transition_length)-&
                govt_revenues_from_property_tax_rental(transition_length)))
                
            if (wealth_tax_system_type<6) then
            
                write(*,*) "financial_tax=", financial_tax
                
            end if
            
            if (wealth_tax_system_type==4) then
            
                write(*,*) "progressive_wealth_tax=", progressive_wealth_tax
                write(*,*) "progressive_wealth_tax_threshold=", progressive_wealth_tax_threshold
                
            end if
            
            write(*,*) "progressive_fincial_tax=", progressive_financial_tax
            write(*,*) "progressive_housing_tax=", progressive_housing_tax
            write(*,*) "threshold_financial=", threshold_financial
            write(*,*) "threshold_housing=", threshold_housing
            
            if (wealth_tax_system_type<6) then
            
                write(*,*) "business_income_tax=", business_income_tax
                write(*,*) "investment_income_tax=", investment_income_tax
                
            end if
            
            if (shut_down_housing_market==0) then
            
                write(*,*) "property_tax=", property_tax(transition_length)
                
            end if
            
!            write(*,*) "consumption_tax=", consumption_tax
            write(*,*) "distance_wage=", distance_wage            
            write(*,*) "distance_risk_free_rate=", distance_risk_free_rate(transition_length)
            write(*,*) "distance_govt_budget=", distance_govt_budget
            write(*,*) "model_average_labour_income=", model_average_labour_income(transition_length)
            
            if (wealth_tax_system_type==4) then
            
                write(*,*) "model_fraction_paying_progressive_wealth_tax=", &
                    model_fraction_paying_progressive_wealth_tax(transition_length)
                    
            elseif ((wealth_tax_system_type==6) .OR. (wealth_tax_system_type==7)) then
            
                write(*,*) "model_fraction_paying_progressive_housing_tax=", &
                    model_fraction_paying_progressive_housing_tax(transition_length)
                write(*,*) "govt_revenues_from_progressive_housing_tax=", &
                    govt_revenues_from_progressive_housing_tax(transition_length)
                    
                write(*,*) "model_fraction_paying_progressive_financial_tax=", &
                    model_fraction_paying_progressive_financial_tax(transition_length)
                    
                write(*,*) "model_fraction_paying_both_progressive_taxes=", &
                    model_fraction_paying_both_progressive_taxes(transition_length)
                
            end if
            
!            write(*,*) "govt_revenues_from_imputed_rents=", &
!                govt_revenues_from_imputed_rents(transition_length)
            
            if (wealth_tax_system_type==8) then

                write(*,*) "tax_imputed_rent=", tax_imputed_rent
                
            end if
            
            write(*,*) "loop_count=", loop_count
            
            if (add_utility_from_child==1) then
            
                write(*,*) "weight_on_bequest=", weight_on_bequest
                
            end if
                
            if (shut_down_housing_market==0) then
            
!                write(*,*) "total_rental_supply=", total_rental_supply(transition_length)
!                write(*,*) "total_rental_demand=", total_rental_demand(transition_length)
!                write(*,*) "housing_stock=", housing_stock(transition_length)
!                write(*,*) "total_housing_demand=", total_housing_demand(transition_length)
!                write(*,*) "housing_price/calibrated_stationary_housing_price=", &
!                    housing_price(transition_length)/calibrated_stationary_housing_price
!                write(*,*) "rent/rent_calibrated=", rent(transition_length)/rent_calibrated
!                write(*,*) "max_debt_to_income_ratio=", max_debt_to_income_ratio
!                write(*,*) "model_average_rental_unit_size=", &
!                    model_average_rental_unit_size(transition_length)
                    
            end if
            
            if (minimum_downpayment_below_20_perc==1) then
                
                write(*,*) "model_fraction_of_homeowners_with_mortgage(transition_length)=", &
                    model_fraction_of_homeowners_with_mortgage(transition_length)
                write(*,*) "fraction of households with mortgage=", &
                    model_fraction_of_homeowners_with_mortgage(transition_length)*&
                    model_homeownership_rate(transition_length)
                write(*,*) "model_fraction_of_homeowners_with_mortgage_over_80_perc(transition_length)=", &
                    model_fraction_of_homeowners_with_mortgage_over_80_perc(transition_length)
                write(*,*) "fraction of households with mortgage over 80 perc=", &
                    model_fraction_of_homeowners_with_mortgage_over_80_perc(transition_length)*&
                    model_fraction_of_homeowners_with_mortgage(transition_length)*&
                    model_homeownership_rate(transition_length)
                write(*,*) "model_fraction_of_mortgage_holders_using_alternative_lenders(transition_length)=", &
                    model_fraction_of_mortgage_holders_using_alternative_lenders(transition_length)
                    
            end if
            
            write(*,*) "robustness_check=", robustness_check
            
            if (robustness_check==1) then
            
                write(*,*) "higher_nu=", higher_nu
                write(*,*) "lower_nu=", lower_nu
                write(*,*) "looser_lambda=", looser_lambda
                write(*,*) "smaller_rental=", smaller_rental
                write(*,*) "lump_sum_construction_profits=", lump_sum_construction_profits
                write(*,*) "curv_intrmdte_prod=", curv_intrmdte_prod
                write(*,*) "stopping_rule_housing_market=", stopping_rule_housing_market
                write(*,*) "stopping_rule_govt_budget=", stopping_rule_govt_budget
                
            end if
            
        end do
        
        simulation_ended=1
        
        call stationary_equilibrium_statistics(transition_length)
        call calculate_welfare_by_characteristics(transition_length)
        
        if (shut_down_housing_market==0) then
        
            call calculate_homeownership_by_characteristics(transition_length)
            call calculate_household_housing_spending(transition_length)
            
        end if
        
        call stationary_equilibrium_top_wealth_distribution_stats(transition_length)
        call stationary_equilibrium_bot_wealth_distribution_stats(transition_length)
        call calculate_gini_coefficient(transition_length)
        
        call frac_of_households_in_support_of_policy(transition_length)
        call compute_portfolio_by_productivity(transition_length)
        
        call calculate_aggregate_consumption(transition_length)
        
        open(UNIT=9,file="value_function"//trim(file_number)//".dat",status='replace')
            write(9,'(F20.8)') value_function(transition_length,:,:,:,:,:)
        close(9)
        
        open(UNIT=10,file="distribution_stationary"//trim(file_number)//".dat",status='replace')
            write(10,'(F20.8)') distribution_stationary(transition_length,:,:,:,:,:)
        close(10)
    
    end subroutine
    
    subroutine transition_simulation()
    
        use Wealth_Tax_Global_Vars
        
        implicit none
        
        integer :: financial_index
        
        if (use_average_rental_size==1) then
        
            model_average_rental_unit_size(:)=calibrated_average_rental_size
        
        end if
        
        loop_count=0
        
        policy_function_loss_on_house=0
        
        model_average_labour_income(:)=average_labor_income_calibrated
        
        net_govt_revenues(1)=net_govt_revenue_constraint
        net_govt_revenues(transition_length)=net_govt_revenue_long_run
        
        if (have_unemployment==1) then
        
            high_unemployment(1)=0
            high_unemployment(2)=1
            high_unemployment(3:transition_length)=0
        
            probability_of_bad_shock_continuing(1)=0
            probability_of_bad_shock_continuing(2)=0
            probability_of_bad_shock_continuing(3)=&
                high_unemployment(2)*&
                probability_of_bad_shock_continuing(2)*&
                probability_of_bad_shock_continuing(2)
            probability_of_bad_shock_continuing(4:transition_length)=high_unemployment(3)
            
        else
        
            high_unemployment(:)=0
            probability_of_bad_shock_continuing(:)=0
        
        end if
        
        property_tax(1:(policy_will_be_implemented_in_x_years-1))=0.01
            
        housing_stock(1)=calibrated_housing_stock
        housing_stock(transition_length)=long_run_housing_stock
                            
        housing_price(1)=&
            calibrated_stationary_housing_price
            
        housing_price(transition_length)=&
            long_run_stationary_housing_price
            
        if (high_unemployment(1)==0) then
        
            housing_price(2)=&
                calibrated_stationary_housing_price+&
                3.3*(long_run_stationary_housing_price-&
                calibrated_stationary_housing_price)
                        
        else
        
            housing_price(2)=&
                0.85*calibrated_stationary_housing_price
        
        end if
        
        slope_of_housing_price_guess=&
            (long_run_stationary_housing_price-&
            housing_price(2))/&
            max((transition_length-1),1)
            
        ! initializing the housing price
        do time_index=3,transition_length-1
        
            ! Calculate a trend for the house price
            housing_price(time_index)=&
                housing_price(time_index-1)+&
                slope_of_housing_price_guess
                    
        end do
                            
        risk_free_rate(:)=calibrated_risk_free_rate
        mortgage_interest_rate(:)=risk_free_rate+mortgage_interest_gap
        
        if (shut_down_housing_market==1) then
        
            relative_share_of_housing=0
            
        end if
        
        risk_aversion_share_of_cons=(1-relative_share_of_housing)*(1-risk_aversion)
        
        disutility_of_landlords=&
            disutility_of_landlords*&
            (wage(1)**(risk_aversion_share_of_cons))
                                    
        largest_housing_market_distance=1
        largest_rental_market_distance=1
                
        do time_index=1,transition_length
        
            call initialize_variables_and_grids(time_index)
            
        end do
        
        call set_SS_benefits()
                
        model_ss_benefits=calibrated_soc_secrty
        
        write(*,*) "model_ss_benefits=", model_ss_benefits
         
        total_housing_demand(1)=calibrated_housing_stock
        total_housing_demand(transition_length)=long_run_housing_stock
        
        rent(1)=&
            rent_calibrated
            
        rent(transition_length)=long_run_rent
            
        if (high_unemployment(1)==0) then
            
            rent(2)=&
                rent_calibrated+&
                0.8*(long_run_rent-&
                rent_calibrated)
                
        else
        
            rent(2)=&
                0.95*rent_calibrated
        
        end if
        
        slope_of_rent_guess=&
            (long_run_rent-&
            rent(2))/&
            max((transition_length-1),1)
            
        do time_index=3,transition_length-1
                                            
            ! Calculate a trend for the house price
            rent(time_index)=&
                rent(time_index-1)+&
                slope_of_rent_guess
                            
            call function_of_utility_advantage_from_homeowning(time_index)
            
        end do 
        
        call initialize_financial_grid(1)
        
        open(UNIT=10,file="distribution_stationary"//trim(benchmark_simulation)//".dat",action='read')
            read(10,'(F20.8)') distribution_stationary_benchmark(:,:,:,:,:)
        close(10)
        
        open(UNIT=10,file="distribution_stationary"//trim(long_run_simulation)//".dat",action='read')
            read(10,'(F20.8)') distribution_stationary(transition_length,:,:,:,:,:)
        close(10)
        
        open(UNIT=10,file="distribution_stationary"//trim(benchmark_simulation)//".dat",action='read')
            read(10,'(F20.8)') distribution_stationary(1,:,:,:,:,:)
        close(10)
        
        open(UNIT=13,file="policy_function_financial"//trim(benchmark_simulation)//".dat",action='read')
            read(13,'(I4)') policy_function_financial(1,:,:,:,:,:)
        close(13)
        
        open(UNIT=13,file="policy_function_housing_status"//trim(benchmark_simulation)//".dat",action='read')
            read(13,'(I3)') policy_function_housing_status(1,:,:,:,:,:)
        close(13)
        
        open(UNIT=14,file="policy_function_mortgage"//trim(benchmark_simulation)//".dat",action='read')
            read(14,'(I3)') policy_function_mortgage(1,:,:,:,:,:)
        close(14)
        
        open(UNIT=15,file="policy_function_ownership_status"//trim(benchmark_simulation)//".dat",action='read')
            read(15,'(I3)') policy_function_ownership_status(1,:,:,:,:,:)
        close(15)
        
        open(UNIT=16,file="policy_function_space_lived_in_size"//trim(benchmark_simulation)//".dat",action='read')
            read(16,'(F15.8)') policy_function_space_lived_in_size(1,:,:,:,:,:)
        close(16)
        
        ! Computing financial per household
        model_financial(1)=0
        
        do age_index=1,life_span
            
            do financial_index=1,financial_grid_size
                            
                do employment_index=1,employment_grid_size
                
                    ! Loops over all possible productivities
                    do productivity_index=1,productivity_grid_size  
    
                        if (productivity_grid(productivity_index)<=1) then
                    
                            can_have_best_productivity_shock=0
                        
                        else
                    
                            can_have_best_productivity_shock=1
                    
                        end if
                
                        do productivity_shock_index=&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            (can_have_best_productivity_shock*1+&
                            (1-can_have_best_productivity_shock)*&
                            ((all_low_z_households_get_into_0_lane)*productivity_shock_grid_size+&
                            (1-all_low_z_households_get_into_0_lane)*2)),&
                            have_fixed_productivity*2+&
                            (1-have_fixed_productivity)*&
                            productivity_shock_grid_size
                
                            if (endogenous_rental_market==1) then
            
                                model_financial(1)=&
                                    model_financial(1)+&
                                    (financial_grid(financial_index)-&
                                    policy_function_ownership_status&
                                    (1,age_index,financial_index,&
                                    employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)*&
                                    housing_price(1)*&
                                    housing_size&
                                    (policy_function_housing_status&
                                    (1,age_index,financial_index,&
                                    employment_index,&
                                    productivity_shock_index,&
                                    productivity_index))*&
                                    (1-mortgage_grid&
                                    (policy_function_mortgage&
                                    (1,age_index,financial_index,&
                                    employment_index,&
                                    productivity_shock_index,&
                                    productivity_index))))*&
                                    distribution_stationary_benchmark&
                                    (age_index,financial_index,&
                                    employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)
                                
                            else
                            
                                model_financial(1)=&
                                    model_financial(1)+&
                                    (financial_grid(financial_index)-&
                                    policy_function_ownership_status&
                                    (1,age_index,financial_index,&
                                    employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)*&
                                    housing_price(1)*&
                                    policy_function_space_lived_in_size&
                                    (1,age_index,financial_index,&
                                    employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)*&
                                    (1-mortgage_grid&
                                    (policy_function_mortgage&
                                    (1,age_index,financial_index,&
                                    employment_index,&
                                    productivity_shock_index,&
                                    productivity_index))))*&
                                    distribution_stationary_benchmark&
                                    (age_index,financial_index,&
                                    employment_index,&
                                    productivity_shock_index,&
                                    productivity_index)
                        
                            end if
                            
                        end do
                    
                    end do
                        
                end do
                                    
            end do
        
        end do
        
        if (multiple_household_members==1) then

            model_average_lowest_labor_income=8.0633792843442298E-002
                            
        else
            
            model_average_lowest_labor_income=&
                wage(1)*employment_grid(employment_grid_size)*&
                (maxval(labour_deterministic_efficiency)+1)/2
        
        end if
        
        model_financial_per_household(:)=&
            model_financial(1)/sum(distribution_stationary_benchmark)
                
        write(*,*) "investment_income_tax=", investment_income_tax
        write(*,*) "property_tax=", property_tax(1:2)
        write(*,*) "property_tax(transition_length-1:transition_length)=", &
            property_tax(transition_length-1:transition_length)
        write(*,*) "stress_test=", stress_test(1:2)
        write(*,*) "property_tax_is_paid_on_current_period_tax=", property_tax_is_paid_on_current_period_tax

        if (use_old_transition_results==1) then
                                
            open(UNIT=1,file="housing_price_in_transition"//trim(old_transition_resuls)//".txt",action='read')
                read(1,'(F15.8)') housing_price
            close(1)
            open(UNIT=1,file="rent_in_transition"//trim(old_transition_resuls)//".txt",action='read')
                read(1,'(F15.8)') rent
            close(1)
                
            do time_index=1,transition_length
        
                ! Computes construction company profits
                call function_of_utility_advantage_from_homeowning(time_index)
                    
            end do
                                        
        end if
               
        write(*,*) "can_get_mortgage_in_retirement=", can_get_mortgage_in_retirement
        write(*,*) "endogenous_rental_market=", endogenous_rental_market
        write(*,*) "high_unemployment(1:5)=", high_unemployment(1:5)
        write(*,*) "probability_of_bad_shock_continuing(1:5)=", probability_of_bad_shock_continuing(1:5)
        write(*,*) "bailout_household_if_net_equity_is_negative=", &
            bailout_household_if_net_equity_is_negative
        write(*,*) "wealth_tax_system_type=", wealth_tax_system_type
        write(*,*) "computing tranition"
        
        do time_index=1,transition_length
        
!            write(*,*) rent(time_index)
!            write(*,*) housing_price(time_index)
        
        end do
        
        simulation_ended=0
        saved_stats_for_end_of_transition=0
                                                           
        ! Loops until the wage and ubi converge
        do while ((largest_housing_market_distance>&
            stopping_rule_housing_market) .OR. &
            (largest_rental_market_distance>&
            stopping_rule_rental_market))
                        
            ! Loops over all the time periods working backwards
            do time_index=(transition_length-1),2,-1
            
                ! Solves the value function
                call solve_value_function_and_policy_functions&
                    (time_index,solve_transition_dynamics)
                
                value_function_guess(:,:,:,:)=value_function(time_index,1,:,:,:,:)
                            
            end do
            
            do time_index=2,(transition_length-1)
            
                ! Solves the evolution of the distribution
                call converge_to_stationary_equilibrium(time_index,solve_transition_dynamics)
                                                            
            end do
            
            do time_index=2,(transition_length-1)
                                        
                call stationary_equilibrium_statistics(time_index)
                
                call stationary_equilibirum_homeownership_rate(time_index)
                                
            end do
            
            largest_housing_market_distance=0
                        
            do time_index=2,transition_length-1
                
                ! Computes 
                housing_stock(time_index)=&
                    (1-housing_depreciation)*housing_stock(time_index-1)+&
                    (housing_price(time_index)/c_1_calibrated)**&
                    (empirical_housing_supplpy_elasticity)
                    
                distance_housing_market(time_index)=&
                    abs(housing_stock(time_index)-total_housing_demand(time_index))
                                        
                if (distance_housing_market(time_index)>&
                    largest_housing_market_distance) then
                
                    largest_housing_market_distance=&
                        distance_housing_market(time_index)
                
                end if
                                                    
            end do
            
            largest_housing_market_distance=0
            
            do time_index=2,transition_length-1
                                                                
                distance_housing_market(time_index)=&
                    abs(housing_price(time_index)-&
                    (c_1_calibrated)*&
                    (max(total_housing_demand(time_index)-&
                    (1-housing_depreciation)*housing_stock(time_index-1),0.d0))**&
                    (1/empirical_housing_supplpy_elasticity))
                        
                ! creates an adjuster for each point
                if (distance_housing_market(time_index)>3) then
                
                    weight_housing_price=0.001
                
                elseif ((distance_housing_market(time_index)>1) .AND. &
                        (distance_housing_market(time_index)<=3)) then
                    
                    weight_housing_price=0.001
                        
                elseif ((distance_housing_market(time_index)>0.5) .AND. &
                        (distance_housing_market(time_index)<=1)) then
                        
                    weight_housing_price=0.001
                        
                elseif ((distance_housing_market(time_index)>0.1) .AND. &
                        (distance_housing_market(time_index)<=0.5)) then
                    
                    weight_housing_price=0.001
                        
                elseif ((distance_housing_market(time_index)<=0.1)) then
                        
                    weight_housing_price=0.001
                                        
                end if
                
                if (distance_housing_market(time_index)>&
                    largest_housing_market_distance) then
                
                    largest_housing_market_distance=&
                        distance_housing_market(time_index)
                
                end if
                    
                ! Updates the house price
                housing_price(time_index)=&
                    (1-weight_housing_price)*housing_price(time_index)+&
                    weight_housing_price*&
                    (c_1_calibrated)*&
                    (max(total_housing_demand(time_index)-&
                    (1-housing_depreciation)*housing_stock(time_index-1),0.d0))**&
                    (1/empirical_housing_supplpy_elasticity)
            
            end do
            
            largest_rental_market_distance=&
                maxval(abs(total_rental_demand(:)-&
                total_rental_supply(:)))
            
            largest_rental_market_distance=0
            
            do time_index=2,transition_length-1
            
                if ((endogenous_rental_market==1)) then
                
                    ! Checks the distance between supply and demand
                    distance_rental_market(time_index)=&
                        abs(total_rental_demand(time_index)-&
                        total_rental_supply(time_index))
                        
                    if (distance_rental_market(time_index)>&
                        largest_rental_market_distance) then
                
                        largest_rental_market_distance=&
                            distance_rental_market(time_index)
                
                    end if
                
                    if (distance_rental_market(time_index)<0.1) then
                    
                        rental_market_adjuster=10.d0**(-5)*wage(1) !10.d0**(-5)*wage
                    
                    elseif (distance_rental_market(time_index)<2) then
            
                        rental_market_adjuster=5*10.d0**(-5)*wage(1) ! 5*10.d0**(-5)*wage
            
                    else
            
                        rental_market_adjuster=5*10.d0**(-5)*wage(1) ! 5*10.d0**(-5)*wage
                    
                    end if
                                                            
                    ! Adjusting the rental price
                    rent(time_index)=&
                        rent(time_index)+&
                        rental_market_adjuster*&
                        (total_rental_demand(time_index)-&
                        total_rental_supply(time_index))
                                                                
                else
                                
                    largest_rental_market_distance=0
                    
                end if
                
                ! Updates rents
                call function_of_utility_advantage_from_homeowning(time_index)
                
                ! Calculates all the statistics
                call govt_revenues_calc(time_index,0)
                
            end do
                                    
            write(*,*) "largest_housing_market_distance=", largest_housing_market_distance
            write(*,*) "largest_rental_market_distance=", largest_rental_market_distance
                                            
            open(unit=1,file="housing_price_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                ! Saves the simulation number
                write(1,'(F15.8)') housing_price
            close(1)
                            
            open(unit=1,file="rent_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                ! Saves the simulation number
                write(1,'(F15.8)') rent
            close(1)
                
            open(unit=1,file="housing_supply_minus_housing_demand_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(1,'(F15.8)') housing_stock-total_housing_demand
            close(1)
            
            open(unit=1,file="rental_supply_minus_rental_demand_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(1,'(F15.8)') total_rental_supply-total_rental_demand
            close(1)
            
            open(unit=1,file="construction_company_profits_per_household_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(1,'(F15.8)') construction_company_profits_per_household
            close(1)
            
            open(unit=1,file="construction_company_profitsin_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(1,'(F15.8)') total_constrcution_profits
            close(1)
                                          
            open(unit=3,file="distance"//trim(file_number)//".txt",action="write",status="replace")
            
                write(3,*) "loop_count=", loop_count
                write(3,*) "largest_housing_market_distance=", &
                    largest_housing_market_distance
                write(3,*) "largest_rental_market_distance=", &
                    largest_rental_market_distance
                write(3,*) "govt_spending_on_bailouts(2:3)=",&
                    govt_spending_on_bailouts(2:3)
                write(3,*) "frac_bailedout(2:3)=", frac_bailedout(2:3)
                write(3,*) "high_unemployment(1:5)=", high_unemployment(1:5)
                write(3,*) "bailout_household_if_net_equity_is_negative=", &
                    bailout_household_if_net_equity_is_negative
                write(3,*) "readjust_financial_position=", &
                    readjust_financial_position
                write(3,*) "sum(distribution_stationary&
                    (2,1:life_span-retirement_span,:,employment_grid_size,:,:))/&
                    sum(distribution_stationary(2,1:life_span-retirement_span,:,:,:))=", &
                    sum(distribution_stationary&
                    (2,1:life_span-retirement_span,:,employment_grid_size,:,:))/&
                    sum(distribution_stationary(2,1:life_span-retirement_span,:,:,:,:))
                write(3,*) "wealth_tax_system_type=", wealth_tax_system_type
                write(3,*) "chi=", chi
                                
            close(3)
                            
            loop_count=loop_count+1
            
            write(*,*) "loop_count=", loop_count
            write(*,*) "property_tax_is_paid_on_current_period_tax=", &
                property_tax_is_paid_on_current_period_tax

            ! Calculating various statistics
            do time_index=2,transition_length-1
        
                call calculate_welfare(time_index)
                call frac_of_households_in_support_of_policy(time_index)
            
            end do
            
            ! Saves the simulation number
            open(unit=3,file="net_govt_rev_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                write(3,'(F10.8)') net_govt_revenues
            close(3)
            
            ! Saves the simulation number
            open(unit=3,file="govt_revenues_from_cons_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                write(3,'(F10.8)') govt_revenues_from_consumption
            close(3)
            
            ! Saves the simulation number
            open(unit=3,file="govt_revenues_from_investment_income_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(3,'(F10.8)') govt_revenues_from_investment_income
            close(3)
            
            ! Saves the simulation number
            open(unit=3,file="govt_revenues_from_labour_income_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(3,'(F10.8)') govt_revenues_from_labour_income
            close(3)
            
            ! Saves the simulation number
            open(unit=3,file="govt_revenues_from_property_tax_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(3,'(F10.8)') govt_revenues_from_property_tax+&
                (1-endogenous_rental_market)*govt_revenues_from_property_tax_rental
            close(3)
            
            ! Saves the simulation number
            open(unit=3,file="govt_revenues_from_rental_income_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(3,'(F10.8)') govt_revenues_from_rental_income
            close(3)
            
            ! Saves the simulation number
            open(unit=3,file="govt_spending_on_mortgage_interest_deductions_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(3,'(F10.8)') govt_spending_on_mortgage_interest_deductions
            close(3)
            
            ! Saves the simulation number
            open(unit=3,file="govt_spending_on_ss_in_transition"&
                //trim(file_number)//".txt",action="write",status="replace")
                write(3,'(F10.8)') govt_spending_on_ss
            close(3)
                    
            ! Saves the simulation number
            open(unit=2,file="support_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                write(2,'(F10.8)') frac_in_support
            close(2)
            
            ! Saves the simulation number
            open(unit=2,file="homeownership_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                write(2,'(F10.8)') model_homeownership_rate
            close(2)
                    
            ! Saves the simulation number
            open(unit=1,file="welfare_in_transition"//trim(file_number)//".txt",action="write",status="replace")
                write(1,'(F15.8)') average_welfare_of_youngest_cohort
            close(1)
            
        end do
        
        simulation_ended=2
        
!        call create_outputs_for_transition()
        
    end subroutine
    
    subroutine create_outputs_for_transition()
    
        use Wealth_Tax_Global_Vars
        
        implicit none
                
        ! Calculating various statistics
        do time_index=1,transition_length
        
            call calculate_welfare(time_index)
            call frac_of_households_in_support_of_policy(time_index)
            
            write(*,*) "time_index=", time_index
            write(*,*) "frac_in_support(time_index)=", frac_in_support(time_index)
            write(*,*) "average_welfare_of_youngest_cohort(time_index)=", average_welfare_of_youngest_cohort(time_index)
                        
!            call calculate_gini_coefficient(time_index)
            
        end do
        
        write(*,*) "writing outputs"
        
        ! Saves the simulation number
        open(unit=4,file="support_in_transition"//trim(file_number)//".txt",action="write",status="replace")
            write(4,'(F10.8)') frac_in_support
        close(4)
        
        ! Saves the simulation number
        open(unit=6,file="welfare_in_transition"//trim(file_number)//".txt",action="write",status="replace")
            write(6,'(F15.8)') average_welfare_of_youngest_cohort
        close(6)
        
        write(*,*) "finished writing outputs"
                        
    end subroutine